<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Quantum GIS API Documentation: src/gui/qgsprojectionselector.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Quantum GIS API Documentation
   &#160;<span id="projectnumber">1.7.4</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">src/gui/qgsprojectionselector.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="qgsprojectionselector_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/***************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> *   qgsprojectionselector.cpp                                             *</span>
<a name="l00003"></a>00003 <span class="comment"> *   Copyright (C) 2005 by Tim Sutton                                      *</span>
<a name="l00004"></a>00004 <span class="comment"> *   tim@linfiniti.com                                                     *</span>
<a name="l00005"></a>00005 <span class="comment"> *                                                                         *</span>
<a name="l00006"></a>00006 <span class="comment"> *   This program is free software; you can redistribute it and/or modify  *</span>
<a name="l00007"></a>00007 <span class="comment"> *   it under the terms of the GNU General Public License as published by  *</span>
<a name="l00008"></a>00008 <span class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</span>
<a name="l00009"></a>00009 <span class="comment"> *   (at your option) any later version.                                   *</span>
<a name="l00010"></a>00010 <span class="comment"> ***************************************************************************/</span>
<a name="l00011"></a>00011 <span class="comment">/* $Id$ */</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;<a class="code" href="qgsprojectionselector_8h.html">qgsprojectionselector.h</a>&gt;</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="comment">//standard includes</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;cassert&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;sqlite3.h&gt;</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="comment">//qgis includes</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="qgis_8h.html">qgis.h</a>&quot;</span> <span class="comment">//magic numbers here</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="qgsapplication_8h.html">qgsapplication.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="qgslogger_8h.html">qgslogger.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;<a class="code" href="qgscoordinatereferencesystem_8h.html">qgscoordinatereferencesystem.h</a>&gt;</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="comment">//qt includes</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;QDir&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;QFileInfo&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;QTextStream&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;QHeaderView&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;QResizeEvent&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;QMessageBox&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;QSettings&gt;</span>
<a name="l00032"></a>00032 
<a name="l00033"></a><a class="code" href="qgsprojectionselector_8cpp.html#a9461e51ea1bb718109e3cc1547979a77">00033</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="qgsprojectionselector_8cpp.html#a9461e51ea1bb718109e3cc1547979a77">NAME_COLUMN</a> = 0;
<a name="l00034"></a><a class="code" href="qgsprojectionselector_8cpp.html#a1209e4815c130efb36a48ef8bccf4c3b">00034</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="qgsprojectionselector_8cpp.html#a1209e4815c130efb36a48ef8bccf4c3b">AUTHID_COLUMN</a> = 1;
<a name="l00035"></a><a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">00035</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a> = 2;
<a name="l00036"></a>00036 
<a name="l00037"></a><a class="code" href="classQgsProjectionSelector.html#a3672700dcf0c984d6949b0e96463a8bc">00037</a> <a class="code" href="classQgsProjectionSelector.html#a3672700dcf0c984d6949b0e96463a8bc">QgsProjectionSelector::QgsProjectionSelector</a>( QWidget* parent, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, Qt::WFlags fl )
<a name="l00038"></a>00038     : QWidget( parent, fl )
<a name="l00039"></a>00039     , mProjListDone( false )
<a name="l00040"></a>00040     , mUserProjListDone( false )
<a name="l00041"></a>00041     , mRecentProjListDone( false )
<a name="l00042"></a>00042     , mCRSNameSelectionPending( false )
<a name="l00043"></a>00043     , mCRSIDSelectionPending( false )
<a name="l00044"></a>00044     , mAuthIDSelectionPending( false )
<a name="l00045"></a>00045 {
<a name="l00046"></a>00046   Q_UNUSED( name );
<a name="l00047"></a>00047   setupUi( <span class="keyword">this</span> );
<a name="l00048"></a>00048   connect( lstCoordinateSystems, SIGNAL( currentItemChanged( QTreeWidgetItem*, QTreeWidgetItem* ) ),
<a name="l00049"></a>00049            <span class="keyword">this</span>, SLOT( <a class="code" href="classQgsProjectionSelector.html#a36fb863b785bfd9ff7dbf29b78df1431" title="private handler for when user selects a cs it will cause wktSelected and sridSelected events to be sp...">coordinateSystemSelected</a>( QTreeWidgetItem* ) ) );
<a name="l00050"></a>00050 
<a name="l00051"></a>00051   <span class="comment">// Get the full path name to the sqlite3 spatial reference database.</span>
<a name="l00052"></a>00052   <a class="code" href="classQgsProjectionSelector.html#a84ad55874a294af72104e457cc378498" title="File name of the sqlite3 database.">mSrsDatabaseFileName</a> = <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>();
<a name="l00053"></a>00053   lstCoordinateSystems-&gt;header()-&gt;setResizeMode( <a class="code" href="qgsprojectionselector_8cpp.html#a1209e4815c130efb36a48ef8bccf4c3b">AUTHID_COLUMN</a>, QHeaderView::Stretch );
<a name="l00054"></a>00054   lstCoordinateSystems-&gt;header()-&gt;resizeSection( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a>, 0 );
<a name="l00055"></a>00055   lstCoordinateSystems-&gt;header()-&gt;setResizeMode( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a>, QHeaderView::Fixed );
<a name="l00056"></a>00056 
<a name="l00057"></a>00057   lstRecent-&gt;header()-&gt;setResizeMode( <a class="code" href="qgsprojectionselector_8cpp.html#a1209e4815c130efb36a48ef8bccf4c3b">AUTHID_COLUMN</a>, QHeaderView::Stretch );
<a name="l00058"></a>00058   lstRecent-&gt;header()-&gt;resizeSection( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a>, 0 );
<a name="l00059"></a>00059   lstRecent-&gt;header()-&gt;setResizeMode( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a>, QHeaderView::Fixed );
<a name="l00060"></a>00060 
<a name="l00061"></a>00061   cbxAuthority-&gt;addItem( tr( <span class="stringliteral">&quot;All&quot;</span> ) );
<a name="l00062"></a>00062   cbxAuthority-&gt;addItems( <a class="code" href="classQgsProjectionSelector.html#af8632f0ce7f4475d19d7c6e8a848ae2f" title="get list of authorities">authorities</a>() );
<a name="l00063"></a>00063 
<a name="l00064"></a>00064   <span class="comment">// Read settings from persistent storage</span>
<a name="l00065"></a>00065   QSettings settings;
<a name="l00066"></a>00066   <a class="code" href="classQgsProjectionSelector.html#a3d1c58a471a879ac7c847d82c780f0b0" title="Most recently used projections (trimmed at 25 entries)">mRecentProjections</a> = settings.value( <span class="stringliteral">&quot;/UI/recentProjections&quot;</span> ).toStringList();
<a name="l00067"></a>00067   <span class="comment">/*** The reading (above) of internal id from persistent storage should be removed sometime in the future */</span>
<a name="l00068"></a>00068   <span class="comment">/*** This is kept now for backwards compatibility */</span>
<a name="l00069"></a>00069 
<a name="l00070"></a>00070   QStringList projectionsProj4  = settings.value( <span class="stringliteral">&quot;/UI/recentProjectionsProj4&quot;</span> ).toStringList();
<a name="l00071"></a>00071   QStringList projectionsAuthId = settings.value( <span class="stringliteral">&quot;/UI/recentProjectionsAuthId&quot;</span> ).toStringList();
<a name="l00072"></a>00072   <span class="keywordflow">if</span> ( projectionsAuthId.size() &gt;= <a class="code" href="classQgsProjectionSelector.html#a3d1c58a471a879ac7c847d82c780f0b0" title="Most recently used projections (trimmed at 25 entries)">mRecentProjections</a>.size() )
<a name="l00073"></a>00073   {
<a name="l00074"></a>00074     <span class="comment">// We had saved state with AuthId and Proj4. Use that instead</span>
<a name="l00075"></a>00075     <span class="comment">// to find out the crs id</span>
<a name="l00076"></a>00076     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Use popular projection list from AuthId/Proj4 saved state&quot;</span> );
<a name="l00077"></a>00077     <a class="code" href="classQgsProjectionSelector.html#a3d1c58a471a879ac7c847d82c780f0b0" title="Most recently used projections (trimmed at 25 entries)">mRecentProjections</a>.clear();
<a name="l00078"></a>00078     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt;  projectionsAuthId.size(); i++ )
<a name="l00079"></a>00079     {
<a name="l00080"></a>00080       <span class="comment">// Create a crs from the EPSG</span>
<a name="l00081"></a>00081       <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> crs;
<a name="l00082"></a>00082       crs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a5789a11684af1415ffc74d7ce9ab91f0" title="Set up this CRS from the given OGC CRS.">createFromOgcWmsCrs</a>( projectionsAuthId.at( i ) );
<a name="l00083"></a>00083       <span class="keywordflow">if</span> ( ! crs.<a class="code" href="classQgsCoordinateReferenceSystem.html#aa88613351434eeefdbdfbbd77ff33025">isValid</a>() )
<a name="l00084"></a>00084       {
<a name="l00085"></a>00085         <span class="comment">// Couldn&#39;t create from EPSG, try the Proj4 string instead</span>
<a name="l00086"></a>00086         <span class="keywordflow">if</span> ( ! crs.<a class="code" href="classQgsCoordinateReferenceSystem.html#acf5ccd2750d310c725937a82a700ecdb">createFromProj4</a>( projectionsProj4.at( i ) ) )
<a name="l00087"></a>00087         {
<a name="l00088"></a>00088           <span class="comment">// No? Skip this entry</span>
<a name="l00089"></a>00089           <span class="keywordflow">continue</span>;
<a name="l00090"></a>00090         }
<a name="l00091"></a>00091       }
<a name="l00092"></a>00092       <a class="code" href="classQgsProjectionSelector.html#a3d1c58a471a879ac7c847d82c780f0b0" title="Most recently used projections (trimmed at 25 entries)">mRecentProjections</a> &lt;&lt; QString::number( crs.<a class="code" href="classQgsCoordinateReferenceSystem.html#add285911972f1facfe30388ab0eba01a">srsid</a>() );
<a name="l00093"></a>00093     }
<a name="l00094"></a>00094   }
<a name="l00095"></a>00095 }
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="classQgsProjectionSelector.html#ae7cb639b4728c35a44c190ac89c6f7f2">00098</a> <a class="code" href="classQgsProjectionSelector.html#ae7cb639b4728c35a44c190ac89c6f7f2">QgsProjectionSelector::~QgsProjectionSelector</a>()
<a name="l00099"></a>00099 {
<a name="l00100"></a>00100   <span class="comment">// Save persistent list of projects</span>
<a name="l00101"></a>00101   QSettings settings;
<a name="l00102"></a>00102   <span class="keywordtype">long</span> crsId;
<a name="l00103"></a>00103 
<a name="l00104"></a>00104   <span class="comment">// Push current projection to front, only if set</span>
<a name="l00105"></a>00105   crsId = <a class="code" href="classQgsProjectionSelector.html#a1032346d0b096da456d4cb2ba084e8a9" title="Gets the current QGIS projection identfier.">selectedCrsId</a>();
<a name="l00106"></a>00106   <span class="keywordflow">if</span> ( crsId )
<a name="l00107"></a>00107   {
<a name="l00108"></a>00108     <a class="code" href="classQgsProjectionSelector.html#a3d1c58a471a879ac7c847d82c780f0b0" title="Most recently used projections (trimmed at 25 entries)">mRecentProjections</a>.removeAll( QString::number( crsId ) );
<a name="l00109"></a>00109     <a class="code" href="classQgsProjectionSelector.html#a3d1c58a471a879ac7c847d82c780f0b0" title="Most recently used projections (trimmed at 25 entries)">mRecentProjections</a>.prepend( QString::number( crsId ) );
<a name="l00110"></a>00110     <span class="comment">// Prune size of list</span>
<a name="l00111"></a>00111     <span class="keywordflow">while</span> ( <a class="code" href="classQgsProjectionSelector.html#a3d1c58a471a879ac7c847d82c780f0b0" title="Most recently used projections (trimmed at 25 entries)">mRecentProjections</a>.size() &gt; 4 )
<a name="l00112"></a>00112     {
<a name="l00113"></a>00113       <a class="code" href="classQgsProjectionSelector.html#a3d1c58a471a879ac7c847d82c780f0b0" title="Most recently used projections (trimmed at 25 entries)">mRecentProjections</a>.removeLast();
<a name="l00114"></a>00114     }
<a name="l00115"></a>00115     <span class="comment">// Save to file *** Should be removed sometims in the future ***</span>
<a name="l00116"></a>00116     settings.setValue( <span class="stringliteral">&quot;/UI/recentProjections&quot;</span>, <a class="code" href="classQgsProjectionSelector.html#a3d1c58a471a879ac7c847d82c780f0b0" title="Most recently used projections (trimmed at 25 entries)">mRecentProjections</a> );
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     <span class="comment">// Convert to EPSG and proj4, and save those values also</span>
<a name="l00119"></a>00119 
<a name="l00120"></a>00120     QStringList projectionsProj4;
<a name="l00121"></a>00121     QStringList projectionsAuthId;
<a name="l00122"></a>00122     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt;  <a class="code" href="classQgsProjectionSelector.html#a3d1c58a471a879ac7c847d82c780f0b0" title="Most recently used projections (trimmed at 25 entries)">mRecentProjections</a>.size(); i++ )
<a name="l00123"></a>00123     {
<a name="l00124"></a>00124       <span class="comment">// Create a crs from the crsId</span>
<a name="l00125"></a>00125       <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> crs( <a class="code" href="classQgsProjectionSelector.html#a3d1c58a471a879ac7c847d82c780f0b0" title="Most recently used projections (trimmed at 25 entries)">mRecentProjections</a>.at( i ).toLong(), <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cfabc92b4ee3c6be188b5dfe000ddac415e">QgsCoordinateReferenceSystem::InternalCrsId</a> );
<a name="l00126"></a>00126       <span class="keywordflow">if</span> ( ! crs.isValid() )
<a name="l00127"></a>00127       {
<a name="l00128"></a>00128         <span class="comment">// No? Skip this entry</span>
<a name="l00129"></a>00129         <span class="keywordflow">continue</span>;
<a name="l00130"></a>00130       }
<a name="l00131"></a>00131       projectionsProj4 &lt;&lt; crs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>();
<a name="l00132"></a>00132       projectionsAuthId &lt;&lt; crs.authid();
<a name="l00133"></a>00133     }
<a name="l00134"></a>00134     settings.setValue( <span class="stringliteral">&quot;/UI/recentProjectionsProj4&quot;</span>, projectionsProj4 );
<a name="l00135"></a>00135     settings.setValue( <span class="stringliteral">&quot;/UI/recentProjectionsAuthId&quot;</span>, projectionsAuthId );
<a name="l00136"></a>00136   }
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 
<a name="l00140"></a><a class="code" href="classQgsProjectionSelector.html#ac4f7804e9310da7ad70dd734d09585c8">00140</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#ac4f7804e9310da7ad70dd734d09585c8" title="Used to manage column sizes.">QgsProjectionSelector::resizeEvent</a>( QResizeEvent * theEvent )
<a name="l00141"></a>00141 {
<a name="l00142"></a>00142   lstCoordinateSystems-&gt;header()-&gt;resizeSection( <a class="code" href="qgsprojectionselector_8cpp.html#a9461e51ea1bb718109e3cc1547979a77">NAME_COLUMN</a>, theEvent-&gt;size().width() - 240 );
<a name="l00143"></a>00143   lstCoordinateSystems-&gt;header()-&gt;resizeSection( <a class="code" href="qgsprojectionselector_8cpp.html#a1209e4815c130efb36a48ef8bccf4c3b">AUTHID_COLUMN</a>, 240 );
<a name="l00144"></a>00144   lstCoordinateSystems-&gt;header()-&gt;resizeSection( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a>, 0 );
<a name="l00145"></a>00145 
<a name="l00146"></a>00146   lstRecent-&gt;header()-&gt;resizeSection( <a class="code" href="qgsprojectionselector_8cpp.html#a9461e51ea1bb718109e3cc1547979a77">NAME_COLUMN</a>, theEvent-&gt;size().width() - 240 );
<a name="l00147"></a>00147   lstRecent-&gt;header()-&gt;resizeSection( <a class="code" href="qgsprojectionselector_8cpp.html#a1209e4815c130efb36a48ef8bccf4c3b">AUTHID_COLUMN</a>, 240 );
<a name="l00148"></a>00148   lstRecent-&gt;header()-&gt;resizeSection( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a>, 0 );
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 
<a name="l00151"></a><a class="code" href="classQgsProjectionSelector.html#a8410abce704b34616cb47857b21d253c">00151</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#a8410abce704b34616cb47857b21d253c" title="Used to ensure the projection list view is actually populated.">QgsProjectionSelector::showEvent</a>( QShowEvent * theEvent )
<a name="l00152"></a>00152 {
<a name="l00153"></a>00153   <span class="comment">// ensure the projection list view is actually populated</span>
<a name="l00154"></a>00154   <span class="comment">// before we show this widget</span>
<a name="l00155"></a>00155 
<a name="l00156"></a>00156   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsProjectionSelector.html#ac0a7346c47d33cb996ad272bc5f326d7" title="Has the Projection List been populated?">mProjListDone</a> )
<a name="l00157"></a>00157   {
<a name="l00158"></a>00158     <a class="code" href="classQgsProjectionSelector.html#a1bb002fb20806dd66fb66bd0179a0e9a" title="Populate the proj tree view with system projection names...">loadCrsList</a>( &amp;<a class="code" href="classQgsProjectionSelector.html#a68e175a6e8f41f1d6e877d486b297e5c" title="The set of OGC WMS CRSs that want to be applied to this widget.">mCrsFilter</a> );
<a name="l00159"></a>00159   }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsProjectionSelector.html#a514fdf6729994c106e518594df9aa935" title="Has the User Projection List been populated?">mUserProjListDone</a> )
<a name="l00162"></a>00162   {
<a name="l00163"></a>00163     <a class="code" href="classQgsProjectionSelector.html#a26f2da62808f40c7bce476ab1eac9c4b" title="Populate the proj tree view with user defined projection names...">loadUserCrsList</a>( &amp;<a class="code" href="classQgsProjectionSelector.html#a68e175a6e8f41f1d6e877d486b297e5c" title="The set of OGC WMS CRSs that want to be applied to this widget.">mCrsFilter</a> );
<a name="l00164"></a>00164   }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166   <span class="comment">// check if a paricular projection is waiting</span>
<a name="l00167"></a>00167   <span class="comment">// to be pre-selected, and if so, to select it now.</span>
<a name="l00168"></a>00168   <span class="keywordflow">if</span> ( <a class="code" href="classQgsProjectionSelector.html#a52cd11745ba99aad339ddb58e8278647" title="Is there a pending selection to be made by CRS Name?">mCRSNameSelectionPending</a> || <a class="code" href="classQgsProjectionSelector.html#a323d66117d4ef5ef76a36c69a6424492" title="Is there a pending selection to be made by CRS ID?">mCRSIDSelectionPending</a> || <a class="code" href="classQgsProjectionSelector.html#a9a130cbc3a60a8b46dbc8d69eedb5b67" title="Is there a pending selection to be made by Authority ID?">mAuthIDSelectionPending</a> )
<a name="l00169"></a>00169   {
<a name="l00170"></a>00170     <a class="code" href="classQgsProjectionSelector.html#ab4e052dcf2b7e355808abea61c19f401" title="does the legwork of applying CRS Selection">applySelection</a>();
<a name="l00171"></a>00171   }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsProjectionSelector.html#ace56df737313d7b8f576eb56fcff3fcb" title="Has the Recent Projection List been populated?">mRecentProjListDone</a> )
<a name="l00174"></a>00174   {
<a name="l00175"></a>00175     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = <a class="code" href="classQgsProjectionSelector.html#a3d1c58a471a879ac7c847d82c780f0b0" title="Most recently used projections (trimmed at 25 entries)">mRecentProjections</a>.size() - 1; i &gt;= 0; i-- )
<a name="l00176"></a>00176       <a class="code" href="classQgsProjectionSelector.html#a68b8e2675e93232c9d77319e6d68a9b4" title="add recently used CRS">insertRecent</a>( <a class="code" href="classQgsProjectionSelector.html#a3d1c58a471a879ac7c847d82c780f0b0" title="Most recently used projections (trimmed at 25 entries)">mRecentProjections</a>.at( i ).toLong() );
<a name="l00177"></a>00177     <a class="code" href="classQgsProjectionSelector.html#ace56df737313d7b8f576eb56fcff3fcb" title="Has the Recent Projection List been populated?">mRecentProjListDone</a> = <span class="keyword">true</span>;
<a name="l00178"></a>00178   }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180   <span class="comment">// Pass up the inheritance hierarchy</span>
<a name="l00181"></a>00181   <a class="code" href="classQgsProjectionSelector.html#a8410abce704b34616cb47857b21d253c" title="Used to ensure the projection list view is actually populated.">QWidget::showEvent</a>( theEvent );
<a name="l00182"></a>00182 }
<a name="l00183"></a>00183 
<a name="l00184"></a><a class="code" href="classQgsProjectionSelector.html#a0ff8eb3acf7182adea4e7bce7f411c31">00184</a> QString <a class="code" href="classQgsProjectionSelector.html#a0ff8eb3acf7182adea4e7bce7f411c31" title="converts the CRS group to a SQL expression fragment">QgsProjectionSelector::ogcWmsCrsFilterAsSqlExpression</a>( QSet&lt;QString&gt; * crsFilter )
<a name="l00185"></a>00185 {
<a name="l00186"></a>00186   QString sqlExpression = <span class="stringliteral">&quot;1&quot;</span>;             <span class="comment">// it&#39;s &quot;SQL&quot; for &quot;true&quot;</span>
<a name="l00187"></a>00187   QMap&lt;QString, QStringList&gt; authParts;
<a name="l00188"></a>00188 
<a name="l00189"></a>00189   <span class="keywordflow">if</span> ( !crsFilter )
<a name="l00190"></a>00190   {
<a name="l00191"></a>00191     <span class="keywordflow">return</span> sqlExpression;
<a name="l00192"></a>00192   }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194   <span class="comment">/*</span>
<a name="l00195"></a>00195 <span class="comment">     Ref: WMS 1.3.0, section 6.7.3 &quot;Layer CRS&quot;:</span>
<a name="l00196"></a>00196 <span class="comment"></span>
<a name="l00197"></a>00197 <span class="comment">     Every Layer CRS has an identifier that is a character string. Two types of</span>
<a name="l00198"></a>00198 <span class="comment">     Layer CRS identifiers are permitted: &quot;label&quot; and &quot;URL&quot; identifiers:</span>
<a name="l00199"></a>00199 <span class="comment"></span>
<a name="l00200"></a>00200 <span class="comment">     Label: The identifier includes a namespace prefix, a colon, a numeric or</span>
<a name="l00201"></a>00201 <span class="comment">        string code, and in some instances a comma followed by additional</span>
<a name="l00202"></a>00202 <span class="comment">        parameters. This International Standard defines three namespaces:</span>
<a name="l00203"></a>00203 <span class="comment">        CRS, EpsgCrsId and AUTO2 [...]</span>
<a name="l00204"></a>00204 <span class="comment"></span>
<a name="l00205"></a>00205 <span class="comment">     URL: The identifier is a fully-qualified Uniform Resource Locator that</span>
<a name="l00206"></a>00206 <span class="comment">        references a publicly-accessible file containing a definition of the CRS</span>
<a name="l00207"></a>00207 <span class="comment">        that is compliant with ISO 19111.</span>
<a name="l00208"></a>00208 <span class="comment">  */</span>
<a name="l00209"></a>00209 
<a name="l00210"></a>00210   <span class="comment">// iterate through all incoming CRSs</span>
<a name="l00211"></a>00211 
<a name="l00212"></a>00212   <span class="keywordflow">foreach</span>( QString auth_id, crsFilter-&gt;values() )
<a name="l00213"></a>00213   {
<a name="l00214"></a>00214     QStringList parts = auth_id.split( <span class="stringliteral">&quot;:&quot;</span> );
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="keywordflow">if</span> ( parts.size() &lt; 2 )
<a name="l00217"></a>00217       <span class="keywordflow">continue</span>;
<a name="l00218"></a>00218 
<a name="l00219"></a>00219     authParts[ parts.at( 0 ).toUpper()].append( parts.at( 1 ).toUpper() );
<a name="l00220"></a>00220   }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222   <span class="keywordflow">if</span> ( authParts.isEmpty() )
<a name="l00223"></a>00223     <span class="keywordflow">return</span> sqlExpression;
<a name="l00224"></a>00224 
<a name="l00225"></a>00225   <span class="keywordflow">if</span> ( authParts.size() &gt; 0 )
<a name="l00226"></a>00226   {
<a name="l00227"></a>00227     QString prefix = <span class="stringliteral">&quot; AND (&quot;</span>;
<a name="l00228"></a>00228     <span class="keywordflow">foreach</span>( QString auth_name, authParts.keys() )
<a name="l00229"></a>00229     {
<a name="l00230"></a>00230       sqlExpression += QString( <span class="stringliteral">&quot;%1(upper(auth_name)=&#39;%2&#39; AND upper(auth_id) IN (&#39;%3&#39;))&quot;</span> )
<a name="l00231"></a>00231                        .arg( prefix )
<a name="l00232"></a>00232                        .arg( auth_name )
<a name="l00233"></a>00233                        .arg( authParts[auth_name].join( <span class="stringliteral">&quot;&#39;,&#39;&quot;</span> ) );
<a name="l00234"></a>00234       prefix = <span class="stringliteral">&quot; OR &quot;</span>;
<a name="l00235"></a>00235     }
<a name="l00236"></a>00236     sqlExpression += <span class="stringliteral">&quot;)&quot;</span>;
<a name="l00237"></a>00237   }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;exiting with &#39;&quot;</span> + sqlExpression + <span class="stringliteral">&quot;&#39;.&quot;</span> );
<a name="l00240"></a>00240 
<a name="l00241"></a>00241   <span class="keywordflow">return</span> sqlExpression;
<a name="l00242"></a>00242 }
<a name="l00243"></a>00243 
<a name="l00244"></a>00244 
<a name="l00245"></a><a class="code" href="classQgsProjectionSelector.html#a8b94413941d2887c38ddb7f9498e77c9">00245</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#a8b94413941d2887c38ddb7f9498e77c9">QgsProjectionSelector::setSelectedCrsName</a>( QString theCRSName )
<a name="l00246"></a>00246 {
<a name="l00247"></a>00247   <a class="code" href="classQgsProjectionSelector.html#ac8fe747bcd2880c74a4cb9000302428d" title="The CRS Name that wants to be selected on this widget.">mCRSNameSelection</a> = theCRSName;
<a name="l00248"></a>00248   <a class="code" href="classQgsProjectionSelector.html#a52cd11745ba99aad339ddb58e8278647" title="Is there a pending selection to be made by CRS Name?">mCRSNameSelectionPending</a> = <span class="keyword">true</span>;
<a name="l00249"></a>00249   <a class="code" href="classQgsProjectionSelector.html#a323d66117d4ef5ef76a36c69a6424492" title="Is there a pending selection to be made by CRS ID?">mCRSIDSelectionPending</a> = <span class="keyword">false</span>;  <span class="comment">// only one type can be pending at a time</span>
<a name="l00250"></a>00250   <a class="code" href="classQgsProjectionSelector.html#a9a130cbc3a60a8b46dbc8d69eedb5b67" title="Is there a pending selection to be made by Authority ID?">mAuthIDSelectionPending</a> = <span class="keyword">true</span>;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252   <span class="keywordflow">if</span> ( isVisible() )
<a name="l00253"></a>00253   {
<a name="l00254"></a>00254     <a class="code" href="classQgsProjectionSelector.html#ab4e052dcf2b7e355808abea61c19f401" title="does the legwork of applying CRS Selection">applySelection</a>();
<a name="l00255"></a>00255   }
<a name="l00256"></a>00256   <span class="comment">// else we will wait for the projection selector to</span>
<a name="l00257"></a>00257   <span class="comment">// become visible (with the showEvent()) and set the</span>
<a name="l00258"></a>00258   <span class="comment">// selection there</span>
<a name="l00259"></a>00259 }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261 
<a name="l00262"></a><a class="code" href="classQgsProjectionSelector.html#aeb54a075f8275a8e6c652d899f65db51">00262</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#aeb54a075f8275a8e6c652d899f65db51">QgsProjectionSelector::setSelectedCrsId</a>( <span class="keywordtype">long</span> theCRSID )
<a name="l00263"></a>00263 {
<a name="l00264"></a>00264   <a class="code" href="classQgsProjectionSelector.html#a261f804596f5311c589f3851a27a0f3c" title="The CRS ID that wants to be selected on this widget.">mCRSIDSelection</a> = theCRSID;
<a name="l00265"></a>00265   <a class="code" href="classQgsProjectionSelector.html#a323d66117d4ef5ef76a36c69a6424492" title="Is there a pending selection to be made by CRS ID?">mCRSIDSelectionPending</a> = <span class="keyword">true</span>;
<a name="l00266"></a>00266   <a class="code" href="classQgsProjectionSelector.html#a52cd11745ba99aad339ddb58e8278647" title="Is there a pending selection to be made by CRS Name?">mCRSNameSelectionPending</a> = <span class="keyword">false</span>;  <span class="comment">// only one type can be pending at a time</span>
<a name="l00267"></a>00267   <a class="code" href="classQgsProjectionSelector.html#a9a130cbc3a60a8b46dbc8d69eedb5b67" title="Is there a pending selection to be made by Authority ID?">mAuthIDSelectionPending</a> = <span class="keyword">false</span>;
<a name="l00268"></a>00268 
<a name="l00269"></a>00269   <span class="keywordflow">if</span> ( isVisible() )
<a name="l00270"></a>00270   {
<a name="l00271"></a>00271     <a class="code" href="classQgsProjectionSelector.html#ab4e052dcf2b7e355808abea61c19f401" title="does the legwork of applying CRS Selection">applySelection</a>();
<a name="l00272"></a>00272   }
<a name="l00273"></a>00273   <span class="comment">// else we will wait for the projection selector to</span>
<a name="l00274"></a>00274   <span class="comment">// become visible (with the showEvent()) and set the</span>
<a name="l00275"></a>00275   <span class="comment">// selection there</span>
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a><a class="code" href="classQgsProjectionSelector.html#adf30be72613c181809abd8049f3a853c">00278</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#adf30be72613c181809abd8049f3a853c" title="Get the selected coordinate system.">QgsProjectionSelector::setSelectedEpsg</a>( <span class="keywordtype">long</span> <span class="keywordtype">id</span> )
<a name="l00279"></a>00279 {
<a name="l00280"></a>00280   <a class="code" href="classQgsProjectionSelector.html#ae9743d9161df77ed762178c4ec7b38d4">setSelectedAuthId</a>( QString( <span class="stringliteral">&quot;EPSG:%1&quot;</span> ).arg( <span class="keywordtype">id</span> ) );
<a name="l00281"></a>00281 }
<a name="l00282"></a>00282 
<a name="l00283"></a><a class="code" href="classQgsProjectionSelector.html#ae9743d9161df77ed762178c4ec7b38d4">00283</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#ae9743d9161df77ed762178c4ec7b38d4">QgsProjectionSelector::setSelectedAuthId</a>( QString <span class="keywordtype">id</span> )
<a name="l00284"></a>00284 {
<a name="l00285"></a>00285   <a class="code" href="classQgsProjectionSelector.html#ab1d615d80f8992634bbd751a18ca1ddd" title="The Authority ID that wants to be selected on this widget.">mAuthIDSelection</a> = id;
<a name="l00286"></a>00286   <a class="code" href="classQgsProjectionSelector.html#a323d66117d4ef5ef76a36c69a6424492" title="Is there a pending selection to be made by CRS ID?">mCRSIDSelectionPending</a> = <span class="keyword">false</span>;
<a name="l00287"></a>00287   <a class="code" href="classQgsProjectionSelector.html#a9a130cbc3a60a8b46dbc8d69eedb5b67" title="Is there a pending selection to be made by Authority ID?">mAuthIDSelectionPending</a> = <span class="keyword">true</span>;
<a name="l00288"></a>00288   <a class="code" href="classQgsProjectionSelector.html#a52cd11745ba99aad339ddb58e8278647" title="Is there a pending selection to be made by CRS Name?">mCRSNameSelectionPending</a> = <span class="keyword">false</span>;  <span class="comment">// only one type can be pending at a time</span>
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00291"></a><a class="code" href="classQgsProjectionSelector.html#ab4e052dcf2b7e355808abea61c19f401">00291</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#ab4e052dcf2b7e355808abea61c19f401" title="does the legwork of applying CRS Selection">QgsProjectionSelector::applySelection</a>()
<a name="l00292"></a>00292 {
<a name="l00293"></a>00293   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsProjectionSelector.html#ac0a7346c47d33cb996ad272bc5f326d7" title="Has the Projection List been populated?">mProjListDone</a> || !<a class="code" href="classQgsProjectionSelector.html#a514fdf6729994c106e518594df9aa935" title="Has the User Projection List been populated?">mUserProjListDone</a> )
<a name="l00294"></a>00294     <span class="keywordflow">return</span>;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296   QList&lt;QTreeWidgetItem*&gt; nodes;
<a name="l00297"></a>00297   <span class="keywordflow">if</span> ( <a class="code" href="classQgsProjectionSelector.html#a52cd11745ba99aad339ddb58e8278647" title="Is there a pending selection to be made by CRS Name?">mCRSNameSelectionPending</a> )
<a name="l00298"></a>00298   {
<a name="l00299"></a>00299     <span class="comment">//get the srid given the wkt so we can pick the correct list item</span>
<a name="l00300"></a>00300     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;called with &quot;</span> + <a class="code" href="classQgsProjectionSelector.html#ac8fe747bcd2880c74a4cb9000302428d" title="The CRS Name that wants to be selected on this widget.">mCRSNameSelection</a> );
<a name="l00301"></a>00301     nodes = lstCoordinateSystems-&gt;findItems( <a class="code" href="classQgsProjectionSelector.html#ac8fe747bcd2880c74a4cb9000302428d" title="The CRS Name that wants to be selected on this widget.">mCRSNameSelection</a>, Qt::MatchExactly | Qt::MatchRecursive, 0 );
<a name="l00302"></a>00302 
<a name="l00303"></a>00303     <a class="code" href="classQgsProjectionSelector.html#a52cd11745ba99aad339ddb58e8278647" title="Is there a pending selection to be made by CRS Name?">mCRSNameSelectionPending</a> = <span class="keyword">false</span>;
<a name="l00304"></a>00304   }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306   <span class="keywordflow">if</span> ( <a class="code" href="classQgsProjectionSelector.html#a9a130cbc3a60a8b46dbc8d69eedb5b67" title="Is there a pending selection to be made by Authority ID?">mAuthIDSelectionPending</a> )
<a name="l00307"></a>00307   {
<a name="l00308"></a>00308     <span class="comment">//get the srid given the wkt so we can pick the correct list item</span>
<a name="l00309"></a>00309     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;called with &quot;</span> + <a class="code" href="classQgsProjectionSelector.html#ab1d615d80f8992634bbd751a18ca1ddd" title="The Authority ID that wants to be selected on this widget.">mAuthIDSelection</a> );
<a name="l00310"></a>00310     nodes = lstCoordinateSystems-&gt;findItems( <a class="code" href="classQgsProjectionSelector.html#ab1d615d80f8992634bbd751a18ca1ddd" title="The Authority ID that wants to be selected on this widget.">mAuthIDSelection</a>, Qt::MatchExactly | Qt::MatchRecursive, <a class="code" href="qgsprojectionselector_8cpp.html#a1209e4815c130efb36a48ef8bccf4c3b">AUTHID_COLUMN</a> );
<a name="l00311"></a>00311 
<a name="l00312"></a>00312     <a class="code" href="classQgsProjectionSelector.html#a9a130cbc3a60a8b46dbc8d69eedb5b67" title="Is there a pending selection to be made by Authority ID?">mAuthIDSelectionPending</a> = <span class="keyword">false</span>;
<a name="l00313"></a>00313   }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315   <span class="keywordflow">if</span> ( <a class="code" href="classQgsProjectionSelector.html#a323d66117d4ef5ef76a36c69a6424492" title="Is there a pending selection to be made by CRS ID?">mCRSIDSelectionPending</a> )
<a name="l00316"></a>00316   {
<a name="l00317"></a>00317     QString myCRSIDString = QString::number( <a class="code" href="classQgsProjectionSelector.html#a261f804596f5311c589f3851a27a0f3c" title="The CRS ID that wants to be selected on this widget.">mCRSIDSelection</a> );
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     nodes = lstCoordinateSystems-&gt;findItems( myCRSIDString, Qt::MatchExactly | Qt::MatchRecursive, <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a> );
<a name="l00320"></a>00320 
<a name="l00321"></a>00321     <a class="code" href="classQgsProjectionSelector.html#a323d66117d4ef5ef76a36c69a6424492" title="Is there a pending selection to be made by CRS ID?">mCRSIDSelectionPending</a> = <span class="keyword">false</span>;
<a name="l00322"></a>00322   }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324   <span class="keywordflow">if</span> ( nodes.count() &gt; 0 )
<a name="l00325"></a>00325   {
<a name="l00326"></a>00326     lstCoordinateSystems-&gt;setCurrentItem( nodes.first() );
<a name="l00327"></a>00327     lstCoordinateSystems-&gt;scrollToItem( lstCoordinateSystems-&gt;currentItem(), QAbstractItemView::PositionAtCenter );
<a name="l00328"></a>00328   }
<a name="l00329"></a>00329   <span class="keywordflow">else</span> <span class="comment">// unselect the selected item to avoid confusing the user</span>
<a name="l00330"></a>00330   {
<a name="l00331"></a>00331     lstCoordinateSystems-&gt;clearSelection();
<a name="l00332"></a>00332     teProjection-&gt;setText( <span class="stringliteral">&quot;&quot;</span> );
<a name="l00333"></a>00333   }
<a name="l00334"></a>00334 }
<a name="l00335"></a>00335 
<a name="l00336"></a><a class="code" href="classQgsProjectionSelector.html#a68b8e2675e93232c9d77319e6d68a9b4">00336</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#a68b8e2675e93232c9d77319e6d68a9b4" title="add recently used CRS">QgsProjectionSelector::insertRecent</a>( <span class="keywordtype">long</span> theCrsId )
<a name="l00337"></a>00337 {
<a name="l00338"></a>00338   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsProjectionSelector.html#ac0a7346c47d33cb996ad272bc5f326d7" title="Has the Projection List been populated?">mProjListDone</a> || !<a class="code" href="classQgsProjectionSelector.html#a514fdf6729994c106e518594df9aa935" title="Has the User Projection List been populated?">mUserProjListDone</a> )
<a name="l00339"></a>00339     <span class="keywordflow">return</span>;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341   QList&lt;QTreeWidgetItem*&gt; nodes = lstCoordinateSystems-&gt;findItems( QString::number( theCrsId ), Qt::MatchExactly | Qt::MatchRecursive, <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a> );
<a name="l00342"></a>00342 
<a name="l00343"></a>00343   <span class="keywordflow">if</span> ( nodes.count() == 0 )
<a name="l00344"></a>00344     <span class="keywordflow">return</span>;
<a name="l00345"></a>00345 
<a name="l00346"></a>00346   lstRecent-&gt;insertTopLevelItem( 0, <span class="keyword">new</span> QTreeWidgetItem( lstRecent, QStringList()
<a name="l00347"></a>00347                                  &lt;&lt; nodes.first()-&gt;text( <a class="code" href="qgsprojectionselector_8cpp.html#a9461e51ea1bb718109e3cc1547979a77">NAME_COLUMN</a> )
<a name="l00348"></a>00348                                  &lt;&lt; nodes.first()-&gt;text( <a class="code" href="qgsprojectionselector_8cpp.html#a1209e4815c130efb36a48ef8bccf4c3b">AUTHID_COLUMN</a> )
<a name="l00349"></a>00349                                  &lt;&lt; nodes.first()-&gt;text( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a> ) ) );
<a name="l00350"></a>00350 }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352 <span class="comment">//note this line just returns the projection name!</span>
<a name="l00353"></a><a class="code" href="classQgsProjectionSelector.html#ab728c3150f29717e163f7783806e1fb1">00353</a> QString <a class="code" href="classQgsProjectionSelector.html#ab728c3150f29717e163f7783806e1fb1">QgsProjectionSelector::selectedName</a>()
<a name="l00354"></a>00354 {
<a name="l00355"></a>00355   <span class="comment">// return the selected wkt name from the list view</span>
<a name="l00356"></a>00356   QTreeWidgetItem *lvi = lstCoordinateSystems-&gt;currentItem();
<a name="l00357"></a>00357   <span class="keywordflow">if</span> ( lvi )
<a name="l00358"></a>00358   {
<a name="l00359"></a>00359     <span class="keywordflow">return</span> lvi-&gt;text( 0 );
<a name="l00360"></a>00360   }
<a name="l00361"></a>00361   <span class="keywordflow">else</span>
<a name="l00362"></a>00362   {
<a name="l00363"></a>00363     <span class="keywordflow">return</span> QString::null;
<a name="l00364"></a>00364   }
<a name="l00365"></a>00365 }
<a name="l00366"></a>00366 <span class="comment">// Returns the whole proj4 string for the selected projection node</span>
<a name="l00367"></a><a class="code" href="classQgsProjectionSelector.html#af7c0a33345056d505f10573a311d2c23">00367</a> QString <a class="code" href="classQgsProjectionSelector.html#af7c0a33345056d505f10573a311d2c23">QgsProjectionSelector::selectedProj4String</a>()
<a name="l00368"></a>00368 {
<a name="l00369"></a>00369   <span class="comment">// Only return the projection if there is a node in the tree</span>
<a name="l00370"></a>00370   <span class="comment">// selected that has an srid. This prevents error if the user</span>
<a name="l00371"></a>00371   <span class="comment">// selects a top-level node rather than an actual coordinate</span>
<a name="l00372"></a>00372   <span class="comment">// system</span>
<a name="l00373"></a>00373   <span class="comment">//</span>
<a name="l00374"></a>00374   <span class="comment">// Get the selected node</span>
<a name="l00375"></a>00375   QTreeWidgetItem *myItem = lstCoordinateSystems-&gt;currentItem();
<a name="l00376"></a>00376   <span class="keywordflow">if</span> ( myItem )
<a name="l00377"></a>00377   {
<a name="l00378"></a>00378 
<a name="l00379"></a>00379     <span class="keywordflow">if</span> ( myItem-&gt;text( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a> ).length() &gt; 0 )
<a name="l00380"></a>00380     {
<a name="l00381"></a>00381       QString myDatabaseFileName;
<a name="l00382"></a>00382       QString mySrsId = myItem-&gt;text( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a> );
<a name="l00383"></a>00383 
<a name="l00384"></a>00384       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;mySrsId = &quot;</span> + mySrsId );
<a name="l00385"></a>00385       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;USER_CRS_START_ID = &quot;</span> + QString::number( <a class="code" href="qgis_8h.html#ad8794344628fad7031cceb6b8ab2b8ec" title="Magick number that determines whether a projection crsid is a system (srs.db) or user (~/...">USER_CRS_START_ID</a> ) );
<a name="l00386"></a>00386       <span class="comment">//</span>
<a name="l00387"></a>00387       <span class="comment">// Determine if this is a user projection or a system on</span>
<a name="l00388"></a>00388       <span class="comment">// user projection defs all have srs_id &gt;= 100000</span>
<a name="l00389"></a>00389       <span class="comment">//</span>
<a name="l00390"></a>00390       <span class="keywordflow">if</span> ( mySrsId.toLong() &gt;= <a class="code" href="qgis_8h.html#ad8794344628fad7031cceb6b8ab2b8ec" title="Magick number that determines whether a projection crsid is a system (srs.db) or user (~/...">USER_CRS_START_ID</a> )
<a name="l00391"></a>00391       {
<a name="l00392"></a>00392         myDatabaseFileName = <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>();
<a name="l00393"></a>00393         QFileInfo myFileInfo;
<a name="l00394"></a>00394         myFileInfo.setFile( myDatabaseFileName );
<a name="l00395"></a>00395         <span class="keywordflow">if</span> ( !myFileInfo.exists( ) ) <span class="comment">//its unlikely that this condition will ever be reached</span>
<a name="l00396"></a>00396         {
<a name="l00397"></a>00397           <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;users qgis.db not found&quot;</span> );
<a name="l00398"></a>00398           <span class="keywordflow">return</span> QString( <span class="stringliteral">&quot;&quot;</span> );
<a name="l00399"></a>00399         }
<a name="l00400"></a>00400         <span class="keywordflow">else</span>
<a name="l00401"></a>00401         {
<a name="l00402"></a>00402           <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;users qgis.db found&quot;</span> );
<a name="l00403"></a>00403         }
<a name="l00404"></a>00404       }
<a name="l00405"></a>00405       <span class="keywordflow">else</span> <span class="comment">//must be  a system projection then</span>
<a name="l00406"></a>00406       {
<a name="l00407"></a>00407         myDatabaseFileName =  <a class="code" href="classQgsProjectionSelector.html#a84ad55874a294af72104e457cc378498" title="File name of the sqlite3 database.">mSrsDatabaseFileName</a>;
<a name="l00408"></a>00408       }
<a name="l00409"></a>00409       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;db = &quot;</span> + myDatabaseFileName );
<a name="l00410"></a>00410 
<a name="l00411"></a>00411 
<a name="l00412"></a>00412       <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a> *db;
<a name="l00413"></a>00413       <span class="keywordtype">int</span> rc;
<a name="l00414"></a>00414       rc = sqlite3_open( myDatabaseFileName.toUtf8().data(), &amp;db );
<a name="l00415"></a>00415       <span class="keywordflow">if</span> ( rc )
<a name="l00416"></a>00416       {
<a name="l00417"></a>00417         <a class="code" href="classQgsProjectionSelector.html#a8be0820409bb75747ae85b60e197389c" title="Show the user a warning if the srs database could not be found.">showDBMissingWarning</a>( myDatabaseFileName );
<a name="l00418"></a>00418         <span class="keywordflow">return</span> QString( <span class="stringliteral">&quot;&quot;</span> );
<a name="l00419"></a>00419       }
<a name="l00420"></a>00420       <span class="comment">// prepare the sql statement</span>
<a name="l00421"></a>00421       <span class="keyword">const</span> <span class="keywordtype">char</span> *pzTail;
<a name="l00422"></a>00422       sqlite3_stmt *ppStmt;
<a name="l00423"></a>00423       QString sql = QString( <span class="stringliteral">&quot;select parameters from tbl_srs where srs_id = %1&quot;</span> ).arg( mySrsId );
<a name="l00424"></a>00424 
<a name="l00425"></a>00425       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Selection sql: &quot;</span> + sql );
<a name="l00426"></a>00426 
<a name="l00427"></a>00427       rc = sqlite3_prepare( db, sql.toUtf8(), sql.toUtf8().length(), &amp;ppStmt, &amp;pzTail );
<a name="l00428"></a>00428       <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l00429"></a>00429       QString myProjString;
<a name="l00430"></a>00430       <span class="keywordflow">if</span> ( rc == SQLITE_OK )
<a name="l00431"></a>00431       {
<a name="l00432"></a>00432         <span class="keywordflow">if</span> ( sqlite3_step( ppStmt ) == SQLITE_ROW )
<a name="l00433"></a>00433         {
<a name="l00434"></a>00434           myProjString = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( ppStmt, 0 ) );
<a name="l00435"></a>00435         }
<a name="l00436"></a>00436       }
<a name="l00437"></a>00437       <span class="comment">// close the statement</span>
<a name="l00438"></a>00438       sqlite3_finalize( ppStmt );
<a name="l00439"></a>00439       <span class="comment">// close the database</span>
<a name="l00440"></a>00440       sqlite3_close( db );
<a name="l00441"></a>00441       assert( myProjString.length() &gt; 0 );
<a name="l00442"></a>00442       <span class="keywordflow">return</span> myProjString;
<a name="l00443"></a>00443     }
<a name="l00444"></a>00444     <span class="keywordflow">else</span>
<a name="l00445"></a>00445     {
<a name="l00446"></a>00446       <span class="comment">// No node is selected, return null</span>
<a name="l00447"></a>00447       <span class="keywordflow">return</span> QString( <span class="stringliteral">&quot;&quot;</span> );
<a name="l00448"></a>00448     }
<a name="l00449"></a>00449   }
<a name="l00450"></a>00450   <span class="keywordflow">else</span>
<a name="l00451"></a>00451   {
<a name="l00452"></a>00452     <span class="comment">// No node is selected, return null</span>
<a name="l00453"></a>00453     <span class="keywordflow">return</span> QString( <span class="stringliteral">&quot;&quot;</span> );
<a name="l00454"></a>00454   }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456 }
<a name="l00457"></a>00457 
<a name="l00458"></a><a class="code" href="classQgsProjectionSelector.html#a06158211cd066ba7332a100e3de8c66c">00458</a> QString <a class="code" href="classQgsProjectionSelector.html#a06158211cd066ba7332a100e3de8c66c" title="gets an arbitrary sqlite3 expression from the selection">QgsProjectionSelector::getSelectedExpression</a>( QString expression )
<a name="l00459"></a>00459 {
<a name="l00460"></a>00460   <span class="comment">// Only return the attribute if there is a node in the tree</span>
<a name="l00461"></a>00461   <span class="comment">// selected that has an srs_id.  This prevents error if the user</span>
<a name="l00462"></a>00462   <span class="comment">// selects a top-level node rather than an actual coordinate</span>
<a name="l00463"></a>00463   <span class="comment">// system</span>
<a name="l00464"></a>00464   <span class="comment">//</span>
<a name="l00465"></a>00465   <span class="comment">// Get the selected node</span>
<a name="l00466"></a>00466   QTreeWidgetItem *lvi = lstCoordinateSystems-&gt;currentItem();
<a name="l00467"></a>00467   <span class="keywordflow">if</span> ( lvi )
<a name="l00468"></a>00468   {
<a name="l00469"></a>00469     <span class="comment">// Make sure the selected node is a srs and not a top-level projection node</span>
<a name="l00470"></a>00470     <span class="keywordflow">if</span> ( lvi-&gt;text( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a> ).length() &gt; 0 )
<a name="l00471"></a>00471     {
<a name="l00472"></a>00472       QString myDatabaseFileName;
<a name="l00473"></a>00473       <span class="comment">//</span>
<a name="l00474"></a>00474       <span class="comment">// Determine if this is a user projection or a system on</span>
<a name="l00475"></a>00475       <span class="comment">// user projection defs all have srs_id &gt;= 100000</span>
<a name="l00476"></a>00476       <span class="comment">//</span>
<a name="l00477"></a>00477       <span class="keywordflow">if</span> ( lvi-&gt;text( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a> ).toLong() &gt;= <a class="code" href="qgis_8h.html#ad8794344628fad7031cceb6b8ab2b8ec" title="Magick number that determines whether a projection crsid is a system (srs.db) or user (~/...">USER_CRS_START_ID</a> )
<a name="l00478"></a>00478       {
<a name="l00479"></a>00479         myDatabaseFileName = <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>();
<a name="l00480"></a>00480         QFileInfo myFileInfo;
<a name="l00481"></a>00481         myFileInfo.setFile( myDatabaseFileName );
<a name="l00482"></a>00482         <span class="keywordflow">if</span> ( !myFileInfo.exists( ) )
<a name="l00483"></a>00483         {
<a name="l00484"></a>00484           <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot; Projection selector :  users qgis.db not found&quot;</span> );
<a name="l00485"></a>00485           <span class="keywordflow">return</span> 0;
<a name="l00486"></a>00486         }
<a name="l00487"></a>00487       }
<a name="l00488"></a>00488       <span class="keywordflow">else</span> <span class="comment">//must be  a system projection then</span>
<a name="l00489"></a>00489       {
<a name="l00490"></a>00490         myDatabaseFileName = <a class="code" href="classQgsProjectionSelector.html#a84ad55874a294af72104e457cc378498" title="File name of the sqlite3 database.">mSrsDatabaseFileName</a>;
<a name="l00491"></a>00491       }
<a name="l00492"></a>00492       <span class="comment">//</span>
<a name="l00493"></a>00493       <span class="comment">// set up the database</span>
<a name="l00494"></a>00494       <span class="comment">// XXX We could probabaly hold the database open for the life of this object,</span>
<a name="l00495"></a>00495       <span class="comment">// assuming that it will never be used anywhere else. Given the low overhead,</span>
<a name="l00496"></a>00496       <span class="comment">// opening it each time seems to be a reasonable approach at this time.</span>
<a name="l00497"></a>00497       <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a> *db;
<a name="l00498"></a>00498       <span class="keywordtype">int</span> rc;
<a name="l00499"></a>00499       rc = sqlite3_open( myDatabaseFileName.toUtf8().data(), &amp;db );
<a name="l00500"></a>00500       <span class="keywordflow">if</span> ( rc )
<a name="l00501"></a>00501       {
<a name="l00502"></a>00502         <a class="code" href="classQgsProjectionSelector.html#a8be0820409bb75747ae85b60e197389c" title="Show the user a warning if the srs database could not be found.">showDBMissingWarning</a>( myDatabaseFileName );
<a name="l00503"></a>00503         <span class="keywordflow">return</span> 0;
<a name="l00504"></a>00504       }
<a name="l00505"></a>00505       <span class="comment">// prepare the sql statement</span>
<a name="l00506"></a>00506       <span class="keyword">const</span> <span class="keywordtype">char</span> *pzTail;
<a name="l00507"></a>00507       sqlite3_stmt *ppStmt;
<a name="l00508"></a>00508       QString sql = QString( <span class="stringliteral">&quot;select %1 from tbl_srs where srs_id=%2&quot;</span> )
<a name="l00509"></a>00509                     .arg( expression )
<a name="l00510"></a>00510                     .arg( lvi-&gt;text( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a> ) );
<a name="l00511"></a>00511 
<a name="l00512"></a>00512       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;Finding selected attribute using : %1&quot;</span> ).arg( sql ) );
<a name="l00513"></a>00513       rc = sqlite3_prepare( db, sql.toUtf8(), sql.toUtf8().length(), &amp;ppStmt, &amp;pzTail );
<a name="l00514"></a>00514       <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l00515"></a>00515       QString myAttributeValue;
<a name="l00516"></a>00516       <span class="keywordflow">if</span> ( rc == SQLITE_OK )
<a name="l00517"></a>00517       {
<a name="l00518"></a>00518         <span class="comment">// get the first row of the result set</span>
<a name="l00519"></a>00519         <span class="keywordflow">if</span> ( sqlite3_step( ppStmt ) == SQLITE_ROW )
<a name="l00520"></a>00520         {
<a name="l00521"></a>00521           <span class="comment">// get the attribute</span>
<a name="l00522"></a>00522           myAttributeValue = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( ppStmt, 0 ) );
<a name="l00523"></a>00523         }
<a name="l00524"></a>00524       }
<a name="l00525"></a>00525       <span class="comment">// close the statement</span>
<a name="l00526"></a>00526       sqlite3_finalize( ppStmt );
<a name="l00527"></a>00527       <span class="comment">// close the database</span>
<a name="l00528"></a>00528       sqlite3_close( db );
<a name="l00529"></a>00529       <span class="comment">// return the srs</span>
<a name="l00530"></a>00530       <span class="keywordflow">return</span> myAttributeValue;
<a name="l00531"></a>00531     }
<a name="l00532"></a>00532   }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534   <span class="comment">// No node is selected, return null</span>
<a name="l00535"></a>00535   <span class="keywordflow">return</span> 0;
<a name="l00536"></a>00536 }
<a name="l00537"></a>00537 
<a name="l00538"></a><a class="code" href="classQgsProjectionSelector.html#aed23193c2a2c1423e694e690f10ac36a">00538</a> <span class="keywordtype">long</span> <a class="code" href="classQgsProjectionSelector.html#aed23193c2a2c1423e694e690f10ac36a" title="Gets the current EpsgCrsId-style projection identifier.">QgsProjectionSelector::selectedEpsg</a>()
<a name="l00539"></a>00539 {
<a name="l00540"></a>00540   <span class="keywordflow">if</span> ( <a class="code" href="classQgsProjectionSelector.html#a06158211cd066ba7332a100e3de8c66c" title="gets an arbitrary sqlite3 expression from the selection">getSelectedExpression</a>( <span class="stringliteral">&quot;auth_name&quot;</span> ).compare( <span class="stringliteral">&quot;EPSG&quot;</span>, Qt::CaseInsensitive ) == 0 )
<a name="l00541"></a>00541   {
<a name="l00542"></a>00542     <span class="keywordflow">return</span> <a class="code" href="classQgsProjectionSelector.html#a06158211cd066ba7332a100e3de8c66c" title="gets an arbitrary sqlite3 expression from the selection">getSelectedExpression</a>( <span class="stringliteral">&quot;auth_id&quot;</span> ).toLong();
<a name="l00543"></a>00543   }
<a name="l00544"></a>00544   <span class="keywordflow">else</span>
<a name="l00545"></a>00545   {
<a name="l00546"></a>00546     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;selected projection is NOT EPSG&quot;</span> );
<a name="l00547"></a>00547     <span class="keywordflow">return</span> 0;
<a name="l00548"></a>00548   }
<a name="l00549"></a>00549 }
<a name="l00550"></a>00550 
<a name="l00551"></a><a class="code" href="classQgsProjectionSelector.html#a74584939334555688962593a7f668b8f">00551</a> <span class="keywordtype">long</span> <a class="code" href="classQgsProjectionSelector.html#a74584939334555688962593a7f668b8f" title="Gets the current PostGIS-style projection identifier.">QgsProjectionSelector::selectedPostgresSrId</a>()
<a name="l00552"></a>00552 {
<a name="l00553"></a>00553   <span class="keywordflow">return</span> <a class="code" href="classQgsProjectionSelector.html#a06158211cd066ba7332a100e3de8c66c" title="gets an arbitrary sqlite3 expression from the selection">getSelectedExpression</a>( <span class="stringliteral">&quot;srid&quot;</span> ).toLong();
<a name="l00554"></a>00554 }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556 
<a name="l00557"></a><a class="code" href="classQgsProjectionSelector.html#a260dba8c8ace10e2d79e159384962974">00557</a> QString <a class="code" href="classQgsProjectionSelector.html#a260dba8c8ace10e2d79e159384962974" title="Gets the current authority-style projection identifier.">QgsProjectionSelector::selectedAuthId</a>()
<a name="l00558"></a>00558 {
<a name="l00559"></a>00559   <span class="keywordtype">int</span> srid = <a class="code" href="classQgsProjectionSelector.html#a06158211cd066ba7332a100e3de8c66c" title="gets an arbitrary sqlite3 expression from the selection">getSelectedExpression</a>( <span class="stringliteral">&quot;srs_id&quot;</span> ).toLong();
<a name="l00560"></a>00560   <span class="keywordflow">if</span> ( srid &gt;= <a class="code" href="qgis_8h.html#ad8794344628fad7031cceb6b8ab2b8ec" title="Magick number that determines whether a projection crsid is a system (srs.db) or user (~/...">USER_CRS_START_ID</a> )
<a name="l00561"></a>00561     <span class="keywordflow">return</span> QString( <span class="stringliteral">&quot;USER:%1&quot;</span> ).arg( srid );
<a name="l00562"></a>00562   <span class="keywordflow">else</span>
<a name="l00563"></a>00563     <span class="keywordflow">return</span> <a class="code" href="classQgsProjectionSelector.html#a06158211cd066ba7332a100e3de8c66c" title="gets an arbitrary sqlite3 expression from the selection">getSelectedExpression</a>( <span class="stringliteral">&quot;upper(auth_name||&#39;:&#39;||auth_id)&quot;</span> );
<a name="l00564"></a>00564 }
<a name="l00565"></a>00565 
<a name="l00566"></a>00566 
<a name="l00567"></a><a class="code" href="classQgsProjectionSelector.html#a1032346d0b096da456d4cb2ba084e8a9">00567</a> <span class="keywordtype">long</span> <a class="code" href="classQgsProjectionSelector.html#a1032346d0b096da456d4cb2ba084e8a9" title="Gets the current QGIS projection identfier.">QgsProjectionSelector::selectedCrsId</a>()
<a name="l00568"></a>00568 {
<a name="l00569"></a>00569   QTreeWidgetItem* item = lstCoordinateSystems-&gt;currentItem();
<a name="l00570"></a>00570 
<a name="l00571"></a>00571   <span class="keywordflow">if</span> ( item != NULL &amp;&amp; item-&gt;text( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a> ).length() &gt; 0 )
<a name="l00572"></a>00572   {
<a name="l00573"></a>00573     <span class="keywordflow">return</span> lstCoordinateSystems-&gt;currentItem()-&gt;text( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a> ).toLong();
<a name="l00574"></a>00574   }
<a name="l00575"></a>00575   <span class="keywordflow">else</span>
<a name="l00576"></a>00576   {
<a name="l00577"></a>00577     <span class="keywordflow">return</span> 0;
<a name="l00578"></a>00578   }
<a name="l00579"></a>00579 }
<a name="l00580"></a>00580 
<a name="l00581"></a>00581 
<a name="l00582"></a><a class="code" href="classQgsProjectionSelector.html#a6665181b76bc38f653ec6650738ed60f">00582</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#a6665181b76bc38f653ec6650738ed60f" title="filters this widget by the given CRSs">QgsProjectionSelector::setOgcWmsCrsFilter</a>( QSet&lt;QString&gt; crsFilter )
<a name="l00583"></a>00583 {
<a name="l00584"></a>00584   <a class="code" href="classQgsProjectionSelector.html#a68e175a6e8f41f1d6e877d486b297e5c" title="The set of OGC WMS CRSs that want to be applied to this widget.">mCrsFilter</a> = crsFilter;
<a name="l00585"></a>00585   <a class="code" href="classQgsProjectionSelector.html#ac0a7346c47d33cb996ad272bc5f326d7" title="Has the Projection List been populated?">mProjListDone</a> = <span class="keyword">false</span>;
<a name="l00586"></a>00586   <a class="code" href="classQgsProjectionSelector.html#a514fdf6729994c106e518594df9aa935" title="Has the User Projection List been populated?">mUserProjListDone</a> = <span class="keyword">false</span>;
<a name="l00587"></a>00587   lstCoordinateSystems-&gt;clear();
<a name="l00588"></a>00588 }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 
<a name="l00591"></a><a class="code" href="classQgsProjectionSelector.html#a26f2da62808f40c7bce476ab1eac9c4b">00591</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#a26f2da62808f40c7bce476ab1eac9c4b" title="Populate the proj tree view with user defined projection names...">QgsProjectionSelector::loadUserCrsList</a>( QSet&lt;QString&gt; * crsFilter )
<a name="l00592"></a>00592 {
<a name="l00593"></a>00593   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Fetching user projection list...&quot;</span> );
<a name="l00594"></a>00594 
<a name="l00595"></a>00595   <span class="comment">// convert our Coordinate Reference System filter into the SQL expression</span>
<a name="l00596"></a>00596   QString sqlFilter = <a class="code" href="classQgsProjectionSelector.html#a0ff8eb3acf7182adea4e7bce7f411c31" title="converts the CRS group to a SQL expression fragment">ogcWmsCrsFilterAsSqlExpression</a>( crsFilter );
<a name="l00597"></a>00597 
<a name="l00598"></a>00598   <span class="comment">// User defined coordinate system node</span>
<a name="l00599"></a>00599   <span class="comment">// Make in an italic font to distinguish them from real projections</span>
<a name="l00600"></a>00600   <a class="code" href="classQgsProjectionSelector.html#a63761301949f3e012088ab7b05c450b0" title="User defined projections node.">mUserProjList</a> = <span class="keyword">new</span> QTreeWidgetItem( lstCoordinateSystems, QStringList( tr( <span class="stringliteral">&quot;User Defined Coordinate Systems&quot;</span> ) ) );
<a name="l00601"></a>00601 
<a name="l00602"></a>00602   QFont fontTemp = <a class="code" href="classQgsProjectionSelector.html#a63761301949f3e012088ab7b05c450b0" title="User defined projections node.">mUserProjList</a>-&gt;font( 0 );
<a name="l00603"></a>00603   fontTemp.setItalic( <span class="keyword">true</span> );
<a name="l00604"></a>00604   fontTemp.setBold( <span class="keyword">true</span> );
<a name="l00605"></a>00605   <a class="code" href="classQgsProjectionSelector.html#a63761301949f3e012088ab7b05c450b0" title="User defined projections node.">mUserProjList</a>-&gt;setFont( 0, fontTemp );
<a name="l00606"></a>00606   <a class="code" href="classQgsProjectionSelector.html#a63761301949f3e012088ab7b05c450b0" title="User defined projections node.">mUserProjList</a>-&gt;setIcon( 0, QIcon( <a class="code" href="classQgsApplication.html#a29d8cdc3a25ac133c9a759a8c406435e" title="Returns the path to the currently active theme directory.">QgsApplication::activeThemePath</a>() + <span class="stringliteral">&quot;user.png&quot;</span> ) );
<a name="l00607"></a>00607 
<a name="l00608"></a>00608   <span class="comment">//determine where the user proj database lives for this user. If none is found an empty</span>
<a name="l00609"></a>00609   <span class="comment">//now only will be shown</span>
<a name="l00610"></a>00610   QString myDatabaseFileName = <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>();
<a name="l00611"></a>00611   <span class="comment">// first we look for ~/.qgis/qgis.db</span>
<a name="l00612"></a>00612   <span class="comment">// if it doesnt exist we copy it in from the global resources dir</span>
<a name="l00613"></a>00613   QFileInfo myFileInfo;
<a name="l00614"></a>00614   myFileInfo.setFile( myDatabaseFileName );
<a name="l00615"></a>00615   <span class="comment">//return straight away if the user has not created any custom projections</span>
<a name="l00616"></a>00616   <span class="keywordflow">if</span> ( !myFileInfo.exists( ) )
<a name="l00617"></a>00617   {
<a name="l00618"></a>00618     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Users qgis.db not found...skipping&quot;</span> );
<a name="l00619"></a>00619 
<a name="l00620"></a>00620     <a class="code" href="classQgsProjectionSelector.html#a514fdf6729994c106e518594df9aa935" title="Has the User Projection List been populated?">mUserProjListDone</a> = <span class="keyword">true</span>;
<a name="l00621"></a>00621     <span class="keywordflow">return</span>;
<a name="l00622"></a>00622   }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a>      *myDatabase;
<a name="l00625"></a>00625   <span class="keyword">const</span> <span class="keywordtype">char</span>   *myTail;
<a name="l00626"></a>00626   sqlite3_stmt *myPreparedStatement;
<a name="l00627"></a>00627   <span class="keywordtype">int</span>           myResult;
<a name="l00628"></a>00628   <span class="comment">//check the db is available</span>
<a name="l00629"></a>00629   myResult = sqlite3_open( QString( myDatabaseFileName ).toUtf8().data(), &amp;myDatabase );
<a name="l00630"></a>00630   <span class="keywordflow">if</span> ( myResult )
<a name="l00631"></a>00631   {
<a name="l00632"></a>00632     <span class="comment">// XXX This will likely never happen since on open, sqlite creates the</span>
<a name="l00633"></a>00633     <span class="comment">//     database if it does not exist. But we checked earlier for its existance</span>
<a name="l00634"></a>00634     <span class="comment">//     and aborted in that case. This is because we may be runnig from read only</span>
<a name="l00635"></a>00635     <span class="comment">//     media such as live cd and don&#39;t want to force trying to create a db.</span>
<a name="l00636"></a>00636     <a class="code" href="classQgsProjectionSelector.html#a8be0820409bb75747ae85b60e197389c" title="Show the user a warning if the srs database could not be found.">showDBMissingWarning</a>( myDatabaseFileName );
<a name="l00637"></a>00637     <span class="keywordflow">return</span>;
<a name="l00638"></a>00638   }
<a name="l00639"></a>00639 
<a name="l00640"></a>00640   <span class="comment">// Set up the query to retrieve the projection information needed to populate the list</span>
<a name="l00641"></a>00641   QString mySql = QString( <span class="stringliteral">&quot;select description, srs_id from vw_srs where %1&quot;</span> ).arg( sqlFilter );
<a name="l00642"></a>00642 
<a name="l00643"></a>00643   myResult = sqlite3_prepare( myDatabase, mySql.toUtf8(), mySql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l00644"></a>00644   <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l00645"></a>00645   <span class="keywordflow">if</span> ( myResult == SQLITE_OK )
<a name="l00646"></a>00646   {
<a name="l00647"></a>00647     QTreeWidgetItem *newItem;
<a name="l00648"></a>00648     <span class="keywordflow">while</span> ( sqlite3_step( myPreparedStatement ) == SQLITE_ROW )
<a name="l00649"></a>00649     {
<a name="l00650"></a>00650       newItem = <span class="keyword">new</span> QTreeWidgetItem( <a class="code" href="classQgsProjectionSelector.html#a63761301949f3e012088ab7b05c450b0" title="User defined projections node.">mUserProjList</a>, QStringList( QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 0 ) ) ) );
<a name="l00651"></a>00651       <span class="comment">// EpsgCrsId for user projections is not always defined in some dbases.</span>
<a name="l00652"></a>00652       <span class="comment">// It&#39;s also not written from customprojections dialog.</span>
<a name="l00653"></a>00653       <span class="comment">// display the epsg (field 2) in the second column of the list view</span>
<a name="l00654"></a>00654       <span class="comment">// newItem-&gt;setText( EPSG_COLUMN, QString::fromUtf8(( char * )sqlite3_column_text( myPreparedStatement, 2 ) ) );</span>
<a name="l00655"></a>00655       <span class="comment">// display the qgis srs_id (field 1) in the third column of the list view</span>
<a name="l00656"></a>00656       newItem-&gt;setText( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a>, QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 1 ) ) );
<a name="l00657"></a>00657     }
<a name="l00658"></a>00658   }
<a name="l00659"></a>00659   <span class="comment">// close the sqlite3 statement</span>
<a name="l00660"></a>00660   sqlite3_finalize( myPreparedStatement );
<a name="l00661"></a>00661   sqlite3_close( myDatabase );
<a name="l00662"></a>00662 
<a name="l00663"></a>00663   <a class="code" href="classQgsProjectionSelector.html#a514fdf6729994c106e518594df9aa935" title="Has the User Projection List been populated?">mUserProjListDone</a> = <span class="keyword">true</span>;
<a name="l00664"></a>00664 }
<a name="l00665"></a>00665 
<a name="l00666"></a><a class="code" href="classQgsProjectionSelector.html#a1bb002fb20806dd66fb66bd0179a0e9a">00666</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#a1bb002fb20806dd66fb66bd0179a0e9a" title="Populate the proj tree view with system projection names...">QgsProjectionSelector::loadCrsList</a>( QSet&lt;QString&gt; *crsFilter )
<a name="l00667"></a>00667 {
<a name="l00668"></a>00668   <span class="comment">// convert our Coordinate Reference System filter into the SQL expression</span>
<a name="l00669"></a>00669   QString sqlFilter = <a class="code" href="classQgsProjectionSelector.html#a0ff8eb3acf7182adea4e7bce7f411c31" title="converts the CRS group to a SQL expression fragment">ogcWmsCrsFilterAsSqlExpression</a>( crsFilter );
<a name="l00670"></a>00670 
<a name="l00671"></a>00671   <span class="comment">// Create the top-level nodes for the list view of projections</span>
<a name="l00672"></a>00672   <span class="comment">// Make in an italic font to distinguish them from real projections</span>
<a name="l00673"></a>00673   <span class="comment">//</span>
<a name="l00674"></a>00674   <span class="comment">// Geographic coordinate system node</span>
<a name="l00675"></a>00675   <a class="code" href="classQgsProjectionSelector.html#aa4af21ef3d2d3fa4e722880d27efc098" title="GEOGCS node.">mGeoList</a> = <span class="keyword">new</span> QTreeWidgetItem( lstCoordinateSystems, QStringList( tr( <span class="stringliteral">&quot;Geographic Coordinate Systems&quot;</span> ) ) );
<a name="l00676"></a>00676 
<a name="l00677"></a>00677   QFont fontTemp = <a class="code" href="classQgsProjectionSelector.html#aa4af21ef3d2d3fa4e722880d27efc098" title="GEOGCS node.">mGeoList</a>-&gt;font( 0 );
<a name="l00678"></a>00678   fontTemp.setItalic( <span class="keyword">true</span> );
<a name="l00679"></a>00679   fontTemp.setBold( <span class="keyword">true</span> );
<a name="l00680"></a>00680   <a class="code" href="classQgsProjectionSelector.html#aa4af21ef3d2d3fa4e722880d27efc098" title="GEOGCS node.">mGeoList</a>-&gt;setFont( 0, fontTemp );
<a name="l00681"></a>00681   <a class="code" href="classQgsProjectionSelector.html#aa4af21ef3d2d3fa4e722880d27efc098" title="GEOGCS node.">mGeoList</a>-&gt;setIcon( 0, QIcon( <a class="code" href="classQgsApplication.html#a29d8cdc3a25ac133c9a759a8c406435e" title="Returns the path to the currently active theme directory.">QgsApplication::activeThemePath</a>() + <span class="stringliteral">&quot;geographic.png&quot;</span> ) );
<a name="l00682"></a>00682 
<a name="l00683"></a>00683   <span class="comment">// Projected coordinate system node</span>
<a name="l00684"></a>00684   <a class="code" href="classQgsProjectionSelector.html#a9ddb7d6e4e85fd636574eeb952fa1170" title="PROJCS node.">mProjList</a> = <span class="keyword">new</span> QTreeWidgetItem( lstCoordinateSystems, QStringList( tr( <span class="stringliteral">&quot;Projected Coordinate Systems&quot;</span> ) ) );
<a name="l00685"></a>00685 
<a name="l00686"></a>00686   fontTemp = <a class="code" href="classQgsProjectionSelector.html#a9ddb7d6e4e85fd636574eeb952fa1170" title="PROJCS node.">mProjList</a>-&gt;font( 0 );
<a name="l00687"></a>00687   fontTemp.setItalic( <span class="keyword">true</span> );
<a name="l00688"></a>00688   fontTemp.setBold( <span class="keyword">true</span> );
<a name="l00689"></a>00689   <a class="code" href="classQgsProjectionSelector.html#a9ddb7d6e4e85fd636574eeb952fa1170" title="PROJCS node.">mProjList</a>-&gt;setFont( 0, fontTemp );
<a name="l00690"></a>00690   <a class="code" href="classQgsProjectionSelector.html#a9ddb7d6e4e85fd636574eeb952fa1170" title="PROJCS node.">mProjList</a>-&gt;setIcon( 0, QIcon( <a class="code" href="classQgsApplication.html#a29d8cdc3a25ac133c9a759a8c406435e" title="Returns the path to the currently active theme directory.">QgsApplication::activeThemePath</a>() + <span class="stringliteral">&quot;transformed.png&quot;</span> ) );
<a name="l00691"></a>00691 
<a name="l00692"></a>00692   <span class="comment">//bail out in case the projections db does not exist</span>
<a name="l00693"></a>00693   <span class="comment">//this is necessary in case the pc is running linux with a</span>
<a name="l00694"></a>00694   <span class="comment">//read only filesystem because otherwise sqlite will try</span>
<a name="l00695"></a>00695   <span class="comment">//to create the db file on the fly</span>
<a name="l00696"></a>00696 
<a name="l00697"></a>00697   QFileInfo myFileInfo;
<a name="l00698"></a>00698   myFileInfo.setFile( <a class="code" href="classQgsProjectionSelector.html#a84ad55874a294af72104e457cc378498" title="File name of the sqlite3 database.">mSrsDatabaseFileName</a> );
<a name="l00699"></a>00699   <span class="keywordflow">if</span> ( !myFileInfo.exists( ) )
<a name="l00700"></a>00700   {
<a name="l00701"></a>00701     <a class="code" href="classQgsProjectionSelector.html#ac0a7346c47d33cb996ad272bc5f326d7" title="Has the Projection List been populated?">mProjListDone</a> = <span class="keyword">true</span>;
<a name="l00702"></a>00702     <span class="keywordflow">return</span>;
<a name="l00703"></a>00703   }
<a name="l00704"></a>00704 
<a name="l00705"></a>00705   <span class="comment">// open the database containing the spatial reference data</span>
<a name="l00706"></a>00706   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a> *db;
<a name="l00707"></a>00707   <span class="keywordtype">int</span> rc;
<a name="l00708"></a>00708   rc = sqlite3_open( <a class="code" href="classQgsProjectionSelector.html#a84ad55874a294af72104e457cc378498" title="File name of the sqlite3 database.">mSrsDatabaseFileName</a>.toUtf8().data(), &amp;db );
<a name="l00709"></a>00709   <span class="keywordflow">if</span> ( rc )
<a name="l00710"></a>00710   {
<a name="l00711"></a>00711     <span class="comment">// XXX This will likely never happen since on open, sqlite creates the</span>
<a name="l00712"></a>00712     <span class="comment">//     database if it does not exist.</span>
<a name="l00713"></a>00713     <a class="code" href="classQgsProjectionSelector.html#a8be0820409bb75747ae85b60e197389c" title="Show the user a warning if the srs database could not be found.">showDBMissingWarning</a>( <a class="code" href="classQgsProjectionSelector.html#a84ad55874a294af72104e457cc378498" title="File name of the sqlite3 database.">mSrsDatabaseFileName</a> );
<a name="l00714"></a>00714     return ;
<a name="l00715"></a>00715   }
<a name="l00716"></a>00716   <span class="comment">// prepare the sql statement</span>
<a name="l00717"></a>00717   <span class="keyword">const</span> <span class="keywordtype">char</span> *pzTail;
<a name="l00718"></a>00718   sqlite3_stmt *ppStmt;
<a name="l00719"></a>00719   <span class="comment">// get total count of records in the projection table</span>
<a name="l00720"></a>00720   QString sql = <span class="stringliteral">&quot;select count(*) from tbl_srs&quot;</span>;
<a name="l00721"></a>00721 
<a name="l00722"></a>00722   rc = sqlite3_prepare( db, sql.toUtf8(), sql.toUtf8().length(), &amp;ppStmt, &amp;pzTail );
<a name="l00723"></a>00723   assert( rc == SQLITE_OK );
<a name="l00724"></a>00724   sqlite3_step( ppStmt );
<a name="l00725"></a>00725 
<a name="l00726"></a>00726   sqlite3_finalize( ppStmt );
<a name="l00727"></a>00727 
<a name="l00728"></a>00728   <span class="comment">// Set up the query to retrieve the projection information needed to populate the list</span>
<a name="l00729"></a>00729   <span class="comment">//note I am giving the full field names for clarity here and in case someone</span>
<a name="l00730"></a>00730   <span class="comment">//changes the underlying view TS</span>
<a name="l00731"></a>00731   sql = QString( <span class="stringliteral">&quot;select description, srs_id, upper(auth_name||&#39;:&#39;||auth_id), is_geo, name, parameters, deprecated from vw_srs where %1 order by name,description&quot;</span> )
<a name="l00732"></a>00732         .arg( sqlFilter );
<a name="l00733"></a>00733 
<a name="l00734"></a>00734   rc = sqlite3_prepare( db, sql.toUtf8(), sql.toUtf8().length(), &amp;ppStmt, &amp;pzTail );
<a name="l00735"></a>00735   <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l00736"></a>00736   <span class="keywordflow">if</span> ( rc == SQLITE_OK )
<a name="l00737"></a>00737   {
<a name="l00738"></a>00738     QTreeWidgetItem *newItem;
<a name="l00739"></a>00739     <span class="comment">// Cache some stuff to speed up creating of the list of projected</span>
<a name="l00740"></a>00740     <span class="comment">// spatial reference systems</span>
<a name="l00741"></a>00741     QString previousSrsType( <span class="stringliteral">&quot;&quot;</span> );
<a name="l00742"></a>00742     QTreeWidgetItem* previousSrsTypeNode = NULL;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     <span class="keywordflow">while</span> ( sqlite3_step( ppStmt ) == SQLITE_ROW )
<a name="l00745"></a>00745     {
<a name="l00746"></a>00746       <span class="comment">// check to see if the srs is geographic</span>
<a name="l00747"></a>00747       <span class="keywordtype">int</span> isGeo = sqlite3_column_int( ppStmt, 3 );
<a name="l00748"></a>00748       <span class="keywordflow">if</span> ( isGeo )
<a name="l00749"></a>00749       {
<a name="l00750"></a>00750         <span class="comment">// this is a geographic coordinate system</span>
<a name="l00751"></a>00751         <span class="comment">// Add it to the tree (field 0)</span>
<a name="l00752"></a>00752         newItem = <span class="keyword">new</span> QTreeWidgetItem( <a class="code" href="classQgsProjectionSelector.html#aa4af21ef3d2d3fa4e722880d27efc098" title="GEOGCS node.">mGeoList</a>, QStringList( QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( ppStmt, 0 ) ) ) );
<a name="l00753"></a>00753 
<a name="l00754"></a>00754         <span class="comment">// display the authority name (field 2) in the second column of the list view</span>
<a name="l00755"></a>00755         newItem-&gt;setText( <a class="code" href="qgsprojectionselector_8cpp.html#a1209e4815c130efb36a48ef8bccf4c3b">AUTHID_COLUMN</a>, QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( ppStmt, 2 ) ) );
<a name="l00756"></a>00756 
<a name="l00757"></a>00757         <span class="comment">// display the qgis srs_id (field 1) in the third column of the list view</span>
<a name="l00758"></a>00758         newItem-&gt;setText( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a>, QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( ppStmt, 1 ) ) );
<a name="l00759"></a>00759       }
<a name="l00760"></a>00760       <span class="keywordflow">else</span>
<a name="l00761"></a>00761       {
<a name="l00762"></a>00762         <span class="comment">// This is a projected srs</span>
<a name="l00763"></a>00763         QTreeWidgetItem *node;
<a name="l00764"></a>00764         QString srsType = QString::fromUtf8(( <span class="keywordtype">char</span>* )sqlite3_column_text( ppStmt, 4 ) );
<a name="l00765"></a>00765         <span class="comment">// Find the node for this type and add the projection to it</span>
<a name="l00766"></a>00766         <span class="comment">// If the node doesn&#39;t exist, create it</span>
<a name="l00767"></a>00767         <span class="keywordflow">if</span> ( srsType == previousSrsType )
<a name="l00768"></a>00768         {
<a name="l00769"></a>00769           node = previousSrsTypeNode;
<a name="l00770"></a>00770         }
<a name="l00771"></a>00771         <span class="keywordflow">else</span>
<a name="l00772"></a>00772         { <span class="comment">// Different from last one, need to search</span>
<a name="l00773"></a>00773           QList&lt;QTreeWidgetItem*&gt; nodes = lstCoordinateSystems-&gt;findItems( srsType, Qt::MatchExactly | Qt::MatchRecursive, 0 );
<a name="l00774"></a>00774           <span class="keywordflow">if</span> ( nodes.count() == 0 )
<a name="l00775"></a>00775           {
<a name="l00776"></a>00776             <span class="comment">// the node doesn&#39;t exist -- create it</span>
<a name="l00777"></a>00777             <span class="comment">// Make in an italic font to distinguish them from real projections</span>
<a name="l00778"></a>00778             node = <span class="keyword">new</span> QTreeWidgetItem( <a class="code" href="classQgsProjectionSelector.html#a9ddb7d6e4e85fd636574eeb952fa1170" title="PROJCS node.">mProjList</a>, QStringList( srsType ) );
<a name="l00779"></a>00779 
<a name="l00780"></a>00780             QFont fontTemp = node-&gt;font( 0 );
<a name="l00781"></a>00781             fontTemp.setItalic( <span class="keyword">true</span> );
<a name="l00782"></a>00782             node-&gt;setFont( 0, fontTemp );
<a name="l00783"></a>00783           }
<a name="l00784"></a>00784           <span class="keywordflow">else</span>
<a name="l00785"></a>00785           {
<a name="l00786"></a>00786             node = nodes.first();
<a name="l00787"></a>00787           }
<a name="l00788"></a>00788           <span class="comment">// Update the cache.</span>
<a name="l00789"></a>00789           previousSrsType = srsType;
<a name="l00790"></a>00790           previousSrsTypeNode = node;
<a name="l00791"></a>00791         }
<a name="l00792"></a>00792         <span class="comment">// add the item, setting the projection name in the first column of the list view</span>
<a name="l00793"></a>00793         newItem = <span class="keyword">new</span> QTreeWidgetItem( node, QStringList( QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( ppStmt, 0 ) ) ) );
<a name="l00794"></a>00794         <span class="comment">// display the authority id (field 2) in the second column of the list view</span>
<a name="l00795"></a>00795         newItem-&gt;setText( <a class="code" href="qgsprojectionselector_8cpp.html#a1209e4815c130efb36a48ef8bccf4c3b">AUTHID_COLUMN</a>, QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( ppStmt, 2 ) ) );
<a name="l00796"></a>00796         <span class="comment">// display the qgis srs_id (field 1) in the third column of the list view</span>
<a name="l00797"></a>00797         newItem-&gt;setText( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a>, QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( ppStmt, 1 ) ) );
<a name="l00798"></a>00798 
<a name="l00799"></a>00799       }
<a name="l00800"></a>00800 
<a name="l00801"></a>00801       <span class="comment">// display the qgis deprecated in the user data of the item</span>
<a name="l00802"></a>00802       newItem-&gt;setData( 0, Qt::UserRole, QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( ppStmt, 6 ) ) );
<a name="l00803"></a>00803       newItem-&gt;setHidden( cbxHideDeprecated-&gt;isChecked() );
<a name="l00804"></a>00804     }
<a name="l00805"></a>00805     <a class="code" href="classQgsProjectionSelector.html#a9ddb7d6e4e85fd636574eeb952fa1170" title="PROJCS node.">mProjList</a>-&gt;setExpanded( <span class="keyword">true</span> );
<a name="l00806"></a>00806   }
<a name="l00807"></a>00807   <span class="comment">// close the sqlite3 statement</span>
<a name="l00808"></a>00808   sqlite3_finalize( ppStmt );
<a name="l00809"></a>00809   <span class="comment">// close the database</span>
<a name="l00810"></a>00810   sqlite3_close( db );
<a name="l00811"></a>00811 
<a name="l00812"></a>00812   <a class="code" href="classQgsProjectionSelector.html#ac0a7346c47d33cb996ad272bc5f326d7" title="Has the Projection List been populated?">mProjListDone</a> = <span class="keyword">true</span>;
<a name="l00813"></a>00813 }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815 
<a name="l00816"></a>00816 <span class="comment">// New coordinate system selected from the list</span>
<a name="l00817"></a><a class="code" href="classQgsProjectionSelector.html#a36fb863b785bfd9ff7dbf29b78df1431">00817</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#a36fb863b785bfd9ff7dbf29b78df1431" title="private handler for when user selects a cs it will cause wktSelected and sridSelected events to be sp...">QgsProjectionSelector::coordinateSystemSelected</a>( QTreeWidgetItem * theItem )
<a name="l00818"></a>00818 {
<a name="l00819"></a>00819   <span class="comment">// If the item has children, it&#39;s not an end node in the tree, and</span>
<a name="l00820"></a>00820   <span class="comment">// hence is just a grouping thingy, not an actual CRS.</span>
<a name="l00821"></a>00821   <span class="keywordflow">if</span> ( theItem &amp;&amp; theItem-&gt;childCount() == 0 )
<a name="l00822"></a>00822   {
<a name="l00823"></a>00823     <span class="comment">// Found a real CRS</span>
<a name="l00824"></a>00824     QString myDescription;
<a name="l00825"></a>00825     emit <a class="code" href="classQgsProjectionSelector.html#a41f31a17186d424c1202d67f064215a4">sridSelected</a>( QString::number( <a class="code" href="classQgsProjectionSelector.html#a1032346d0b096da456d4cb2ba084e8a9" title="Gets the current QGIS projection identfier.">selectedCrsId</a>() ) );
<a name="l00826"></a>00826     QString myProjString = <a class="code" href="classQgsProjectionSelector.html#af7c0a33345056d505f10573a311d2c23">selectedProj4String</a>();
<a name="l00827"></a>00827     lstCoordinateSystems-&gt;scrollToItem( theItem );
<a name="l00828"></a>00828     teProjection-&gt;setText( myProjString );
<a name="l00829"></a>00829 
<a name="l00830"></a>00830     lstRecent-&gt;clearSelection();
<a name="l00831"></a>00831   }
<a name="l00832"></a>00832   <span class="keywordflow">else</span>
<a name="l00833"></a>00833   {
<a name="l00834"></a>00834     <span class="comment">// Not an CRS - remove the highlight so the user doesn&#39;t get too confused</span>
<a name="l00835"></a>00835     <span class="keywordflow">if</span> ( theItem )
<a name="l00836"></a>00836       theItem-&gt;setSelected( <span class="keyword">false</span> );
<a name="l00837"></a>00837     teProjection-&gt;setText( <span class="stringliteral">&quot;&quot;</span> );
<a name="l00838"></a>00838   }
<a name="l00839"></a>00839 }
<a name="l00840"></a>00840 
<a name="l00841"></a><a class="code" href="classQgsProjectionSelector.html#a3b9f14f01196f0bdade13f29d68e22fb">00841</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#a3b9f14f01196f0bdade13f29d68e22fb" title="hide deprecated CRSes">QgsProjectionSelector::hideDeprecated</a>( QTreeWidgetItem *item )
<a name="l00842"></a>00842 {
<a name="l00843"></a>00843   <span class="keywordflow">if</span> ( item-&gt;data( 0, Qt::UserRole ).toBool() )
<a name="l00844"></a>00844   {
<a name="l00845"></a>00845     item-&gt;setHidden( cbxHideDeprecated-&gt;isChecked() );
<a name="l00846"></a>00846     <span class="keywordflow">if</span> ( item-&gt;isSelected() &amp;&amp; item-&gt;isHidden() )
<a name="l00847"></a>00847     {
<a name="l00848"></a>00848       item-&gt;setSelected( <span class="keyword">false</span> );
<a name="l00849"></a>00849       teProjection-&gt;setText( <span class="stringliteral">&quot;&quot;</span> );
<a name="l00850"></a>00850     }
<a name="l00851"></a>00851   }
<a name="l00852"></a>00852 
<a name="l00853"></a>00853   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; item-&gt;childCount(); i++ )
<a name="l00854"></a>00854     <a class="code" href="classQgsProjectionSelector.html#a3b9f14f01196f0bdade13f29d68e22fb" title="hide deprecated CRSes">hideDeprecated</a>( item-&gt;child( i ) );
<a name="l00855"></a>00855 }
<a name="l00856"></a>00856 
<a name="l00857"></a><a class="code" href="classQgsProjectionSelector.html#a7dc52e836d87487973760561ce41756e">00857</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#a7dc52e836d87487973760561ce41756e">QgsProjectionSelector::on_cbxHideDeprecated_stateChanged</a>()
<a name="l00858"></a>00858 {
<a name="l00859"></a>00859   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; lstCoordinateSystems-&gt;topLevelItemCount(); i++ )
<a name="l00860"></a>00860     <a class="code" href="classQgsProjectionSelector.html#a3b9f14f01196f0bdade13f29d68e22fb" title="hide deprecated CRSes">hideDeprecated</a>( lstCoordinateSystems-&gt;topLevelItem( i ) );
<a name="l00861"></a>00861 }
<a name="l00862"></a>00862 
<a name="l00863"></a><a class="code" href="classQgsProjectionSelector.html#a8ee43a0037123769ec97c64f4bab9b77">00863</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#a8ee43a0037123769ec97c64f4bab9b77">QgsProjectionSelector::on_lstRecent_currentItemChanged</a>( QTreeWidgetItem *current, QTreeWidgetItem *previous )
<a name="l00864"></a>00864 {
<a name="l00865"></a>00865   Q_UNUSED( previous );
<a name="l00866"></a>00866   <span class="keywordflow">if</span> ( current )
<a name="l00867"></a>00867     <a class="code" href="classQgsProjectionSelector.html#aeb54a075f8275a8e6c652d899f65db51">setSelectedCrsId</a>( current-&gt;text( <a class="code" href="qgsprojectionselector_8cpp.html#aa3533b5e7eb52cb4be8e18cf7df21b89">QGIS_CRS_ID_COLUMN</a> ).toLong() );
<a name="l00868"></a>00868 }
<a name="l00869"></a>00869 
<a name="l00870"></a><a class="code" href="classQgsProjectionSelector.html#aff2efd09504b4db00e2d6504bf09be39">00870</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#aff2efd09504b4db00e2d6504bf09be39">QgsProjectionSelector::on_pbnFind_clicked</a>()
<a name="l00871"></a>00871 {
<a name="l00872"></a>00872   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;pbnFind...&quot;</span> );
<a name="l00873"></a>00873 
<a name="l00874"></a>00874   QString mySearchString( <a class="code" href="classQgsProjectionSelector.html#a7f9531610bd8aa59ea032cd65eb5f8be" title="Make the string safe for use in SQL statements. This involves escaping single quotes, double quotes, backslashes, and optionally, percentage symbols. Percentage symbols are used as wildcards sometimes and so when using the string as part of the LIKE phrase of a select statement, should be escaped.">sqlSafeString</a>( leSearch-&gt;text() ) );
<a name="l00875"></a>00875 
<a name="l00876"></a>00876   <span class="comment">// Set up the query to retrieve the projection information needed to populate the list</span>
<a name="l00877"></a>00877   QString mySql = <span class="stringliteral">&quot;select srs_id from tbl_srs where &quot;</span>;
<a name="l00878"></a>00878   <span class="keywordflow">if</span> ( cbxAuthority-&gt;currentIndex() &gt; 0 )
<a name="l00879"></a>00879   {
<a name="l00880"></a>00880     mySql += QString( <span class="stringliteral">&quot;auth_name=&#39;%1&#39; AND &quot;</span> ).arg( cbxAuthority-&gt;currentText() );
<a name="l00881"></a>00881   }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883   <span class="keywordflow">if</span> ( cbxHideDeprecated-&gt;isChecked() )
<a name="l00884"></a>00884   {
<a name="l00885"></a>00885     mySql += <span class="stringliteral">&quot;not deprecated AND &quot;</span>;
<a name="l00886"></a>00886   }
<a name="l00887"></a>00887 
<a name="l00888"></a>00888   <span class="keywordflow">if</span> ( cbxMode-&gt;currentIndex() == 0 )
<a name="l00889"></a>00889   {
<a name="l00890"></a>00890     mySql += QString( <span class="stringliteral">&quot;auth_id=&#39;%1&#39;&quot;</span> ).arg( mySearchString );
<a name="l00891"></a>00891   }
<a name="l00892"></a>00892   <span class="keywordflow">else</span>
<a name="l00893"></a>00893   {
<a name="l00894"></a>00894     mySql += <span class="stringliteral">&quot;upper(description) like &#39;%&quot;</span> + mySearchString.toUpper() + <span class="stringliteral">&quot;%&#39; &quot;</span>;
<a name="l00895"></a>00895 
<a name="l00896"></a>00896     <span class="keywordtype">long</span> myLargestSrsId = <a class="code" href="classQgsProjectionSelector.html#ad386da4e3d5369d4771c0e457a36f1d7" title="Utility method used in conjunction with name based searching tool.">getLargestCRSIDMatch</a>( QString( <span class="stringliteral">&quot;%1 order by srs_id desc limit 1&quot;</span> ).arg( mySql ) );
<a name="l00897"></a>00897     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;Largest CRSID%1&quot;</span> ).arg( myLargestSrsId ) );
<a name="l00898"></a>00898 
<a name="l00899"></a>00899     <span class="comment">//a name search is ambiguous, so we find the first srsid after the current selected srsid</span>
<a name="l00900"></a>00900     <span class="comment">// each time the find button is pressed. This means we can loop through all matches.</span>
<a name="l00901"></a>00901     <span class="keywordflow">if</span> ( myLargestSrsId &lt;= <a class="code" href="classQgsProjectionSelector.html#a1032346d0b096da456d4cb2ba084e8a9" title="Gets the current QGIS projection identfier.">selectedCrsId</a>() )
<a name="l00902"></a>00902     {
<a name="l00903"></a>00903       mySql = QString( <span class="stringliteral">&quot;%1 order by srs_id limit 1&quot;</span> ).arg( mySql );
<a name="l00904"></a>00904     }
<a name="l00905"></a>00905     <span class="keywordflow">else</span>
<a name="l00906"></a>00906     {
<a name="l00907"></a>00907       <span class="comment">// search ahead of the current position</span>
<a name="l00908"></a>00908       mySql = QString( <span class="stringliteral">&quot;%1 and srs_id &gt; %2 order by srs_id limit 1&quot;</span> ).arg( mySql ).arg( <a class="code" href="classQgsProjectionSelector.html#a1032346d0b096da456d4cb2ba084e8a9" title="Gets the current QGIS projection identfier.">selectedCrsId</a>() );
<a name="l00909"></a>00909     }
<a name="l00910"></a>00910   }
<a name="l00911"></a>00911   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot; Search sql: %1&quot;</span> ).arg( mySql ) );
<a name="l00912"></a>00912 
<a name="l00913"></a>00913   <span class="comment">//</span>
<a name="l00914"></a>00914   <span class="comment">// Now perform the actual search</span>
<a name="l00915"></a>00915   <span class="comment">//</span>
<a name="l00916"></a>00916 
<a name="l00917"></a>00917   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a>      *myDatabase;
<a name="l00918"></a>00918   <span class="keyword">const</span> <span class="keywordtype">char</span>   *myTail;
<a name="l00919"></a>00919   sqlite3_stmt *myPreparedStatement;
<a name="l00920"></a>00920   <span class="keywordtype">int</span>           myResult;
<a name="l00921"></a>00921   <span class="comment">//check the db is available</span>
<a name="l00922"></a>00922   myResult = sqlite3_open( <a class="code" href="classQgsProjectionSelector.html#a84ad55874a294af72104e457cc378498" title="File name of the sqlite3 database.">mSrsDatabaseFileName</a>.toUtf8().data(), &amp;myDatabase );
<a name="l00923"></a>00923   <span class="keywordflow">if</span> ( myResult )
<a name="l00924"></a>00924   {
<a name="l00925"></a>00925     <span class="comment">// XXX This will likely never happen since on open, sqlite creates the</span>
<a name="l00926"></a>00926     <span class="comment">//     database if it does not exist. But we checked earlier for its existance</span>
<a name="l00927"></a>00927     <span class="comment">//     and aborted in that case. This is because we may be runnig from read only</span>
<a name="l00928"></a>00928     <span class="comment">//     media such as live cd and don&#39;t want to force trying to create a db.</span>
<a name="l00929"></a>00929     <a class="code" href="classQgsProjectionSelector.html#a8be0820409bb75747ae85b60e197389c" title="Show the user a warning if the srs database could not be found.">showDBMissingWarning</a>( <a class="code" href="classQgsProjectionSelector.html#a84ad55874a294af72104e457cc378498" title="File name of the sqlite3 database.">mSrsDatabaseFileName</a> );
<a name="l00930"></a>00930     <span class="keywordflow">return</span>;
<a name="l00931"></a>00931   }
<a name="l00932"></a>00932 
<a name="l00933"></a>00933   myResult = sqlite3_prepare( myDatabase, mySql.toUtf8(), mySql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l00934"></a>00934   <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l00935"></a>00935   <span class="keywordflow">if</span> ( myResult == SQLITE_OK )
<a name="l00936"></a>00936   {
<a name="l00937"></a>00937     myResult = sqlite3_step( myPreparedStatement );
<a name="l00938"></a>00938     <span class="keywordflow">if</span> ( myResult == SQLITE_ROW )
<a name="l00939"></a>00939     {
<a name="l00940"></a>00940       QString mySrsId = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 0 ) );
<a name="l00941"></a>00941       <a class="code" href="classQgsProjectionSelector.html#aeb54a075f8275a8e6c652d899f65db51">setSelectedCrsId</a>( mySrsId.toLong() );
<a name="l00942"></a>00942       <span class="comment">// close the sqlite3 statement</span>
<a name="l00943"></a>00943       sqlite3_finalize( myPreparedStatement );
<a name="l00944"></a>00944       sqlite3_close( myDatabase );
<a name="l00945"></a>00945       <span class="keywordflow">return</span>;
<a name="l00946"></a>00946     }
<a name="l00947"></a>00947   }
<a name="l00948"></a>00948   <span class="comment">//search the users db</span>
<a name="l00949"></a>00949   QString myDatabaseFileName = <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>();
<a name="l00950"></a>00950   QFileInfo myFileInfo;
<a name="l00951"></a>00951   myFileInfo.setFile( myDatabaseFileName );
<a name="l00952"></a>00952   <span class="keywordflow">if</span> ( !myFileInfo.exists( ) ) <span class="comment">//its not critical if this happens</span>
<a name="l00953"></a>00953   {
<a name="l00954"></a>00954     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;%1\nUser db does not exist&quot;</span> ).arg( myDatabaseFileName ) );
<a name="l00955"></a>00955     return ;
<a name="l00956"></a>00956   }
<a name="l00957"></a>00957   myResult = sqlite3_open( myDatabaseFileName.toUtf8().data(), &amp;myDatabase );
<a name="l00958"></a>00958   <span class="keywordflow">if</span> ( myResult )
<a name="l00959"></a>00959   {
<a name="l00960"></a>00960     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;Can&#39;t open * user * database: %1&quot;</span> ).arg( sqlite3_errmsg( myDatabase ) ) );
<a name="l00961"></a>00961     <span class="comment">//no need for assert because user db may not have been created yet</span>
<a name="l00962"></a>00962     <span class="keywordflow">return</span>;
<a name="l00963"></a>00963   }
<a name="l00964"></a>00964 
<a name="l00965"></a>00965   myResult = sqlite3_prepare( myDatabase, mySql.toUtf8(), mySql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l00966"></a>00966   <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l00967"></a>00967   <span class="keywordflow">if</span> ( myResult == SQLITE_OK )
<a name="l00968"></a>00968   {
<a name="l00969"></a>00969     myResult = sqlite3_step( myPreparedStatement );
<a name="l00970"></a>00970     <span class="keywordflow">if</span> ( myResult == SQLITE_ROW )
<a name="l00971"></a>00971     {
<a name="l00972"></a>00972       QString mySrsId = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 0 ) );
<a name="l00973"></a>00973       <a class="code" href="classQgsProjectionSelector.html#aeb54a075f8275a8e6c652d899f65db51">setSelectedCrsId</a>( mySrsId.toLong() );
<a name="l00974"></a>00974       <span class="comment">// close the sqlite3 statement</span>
<a name="l00975"></a>00975       sqlite3_finalize( myPreparedStatement );
<a name="l00976"></a>00976       sqlite3_close( myDatabase );
<a name="l00977"></a>00977       <span class="keywordflow">return</span>;
<a name="l00978"></a>00978     }
<a name="l00979"></a>00979   }
<a name="l00980"></a>00980 
<a name="l00981"></a>00981   QMessageBox::information( <span class="keyword">this</span>, tr( <span class="stringliteral">&quot;Find projection&quot;</span> ), tr( <span class="stringliteral">&quot;No matching projection found.&quot;</span> ) );
<a name="l00982"></a>00982   lstCoordinateSystems-&gt;clearSelection();
<a name="l00983"></a>00983   teProjection-&gt;setText( <span class="stringliteral">&quot;&quot;</span> );
<a name="l00984"></a>00984 }
<a name="l00985"></a>00985 
<a name="l00986"></a><a class="code" href="classQgsProjectionSelector.html#ad386da4e3d5369d4771c0e457a36f1d7">00986</a> <span class="keywordtype">long</span> <a class="code" href="classQgsProjectionSelector.html#ad386da4e3d5369d4771c0e457a36f1d7" title="Utility method used in conjunction with name based searching tool.">QgsProjectionSelector::getLargestCRSIDMatch</a>( QString theSql )
<a name="l00987"></a>00987 {
<a name="l00988"></a>00988   <span class="keywordtype">long</span> mySrsId = 0;
<a name="l00989"></a>00989   <span class="comment">//</span>
<a name="l00990"></a>00990   <span class="comment">// Now perform the actual search</span>
<a name="l00991"></a>00991   <span class="comment">//</span>
<a name="l00992"></a>00992 
<a name="l00993"></a>00993   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a>      *myDatabase;
<a name="l00994"></a>00994   <span class="keyword">const</span> <span class="keywordtype">char</span>   *myTail;
<a name="l00995"></a>00995   sqlite3_stmt *myPreparedStatement;
<a name="l00996"></a>00996   <span class="keywordtype">int</span>           myResult;
<a name="l00997"></a>00997 
<a name="l00998"></a>00998   <span class="comment">// first we search the users db as any srsid there will be definition be greater than in sys db</span>
<a name="l00999"></a>00999 
<a name="l01000"></a>01000   <span class="comment">//check the db is available</span>
<a name="l01001"></a>01001   QString myDatabaseFileName = <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>();
<a name="l01002"></a>01002   QFileInfo myFileInfo;
<a name="l01003"></a>01003   myFileInfo.setFile( myDatabaseFileName );
<a name="l01004"></a>01004   <span class="keywordflow">if</span> ( myFileInfo.exists( ) ) <span class="comment">//only bother trying to open if the file exists</span>
<a name="l01005"></a>01005   {
<a name="l01006"></a>01006     myResult = sqlite3_open( myDatabaseFileName.toUtf8().data(), &amp;myDatabase );
<a name="l01007"></a>01007     <span class="keywordflow">if</span> ( myResult )
<a name="l01008"></a>01008     {
<a name="l01009"></a>01009       <span class="comment">// XXX This will likely never happen since on open, sqlite creates the</span>
<a name="l01010"></a>01010       <span class="comment">//     database if it does not exist. But we checked earlier for its existance</span>
<a name="l01011"></a>01011       <span class="comment">//     and aborted in that case. This is because we may be runnig from read only</span>
<a name="l01012"></a>01012       <span class="comment">//     media such as live cd and don&#39;t want to force trying to create a db.</span>
<a name="l01013"></a>01013       <a class="code" href="classQgsProjectionSelector.html#a8be0820409bb75747ae85b60e197389c" title="Show the user a warning if the srs database could not be found.">showDBMissingWarning</a>( myDatabaseFileName );
<a name="l01014"></a>01014       <span class="keywordflow">return</span> 0;
<a name="l01015"></a>01015     }
<a name="l01016"></a>01016     <span class="keywordflow">else</span>
<a name="l01017"></a>01017     {
<a name="l01018"></a>01018       myResult = sqlite3_prepare( myDatabase, theSql.toUtf8(), theSql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l01019"></a>01019       <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l01020"></a>01020       <span class="keywordflow">if</span> ( myResult == SQLITE_OK )
<a name="l01021"></a>01021       {
<a name="l01022"></a>01022         myResult = sqlite3_step( myPreparedStatement );
<a name="l01023"></a>01023         <span class="keywordflow">if</span> ( myResult == SQLITE_ROW )
<a name="l01024"></a>01024         {
<a name="l01025"></a>01025           QString mySrsIdString = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 0 ) );
<a name="l01026"></a>01026           mySrsId = mySrsIdString.toLong();
<a name="l01027"></a>01027           <span class="comment">// close the sqlite3 statement</span>
<a name="l01028"></a>01028           sqlite3_finalize( myPreparedStatement );
<a name="l01029"></a>01029           sqlite3_close( myDatabase );
<a name="l01030"></a>01030           <span class="keywordflow">return</span> mySrsId;
<a name="l01031"></a>01031         }
<a name="l01032"></a>01032       }
<a name="l01033"></a>01033     }
<a name="l01034"></a>01034   }
<a name="l01035"></a>01035 
<a name="l01036"></a>01036   <span class="comment">//only bother looking in srs.db if it wasnt found above</span>
<a name="l01037"></a>01037 
<a name="l01038"></a>01038   myResult = sqlite3_open( <a class="code" href="classQgsProjectionSelector.html#a84ad55874a294af72104e457cc378498" title="File name of the sqlite3 database.">mSrsDatabaseFileName</a>.toUtf8().data(), &amp;myDatabase );
<a name="l01039"></a>01039   <span class="keywordflow">if</span> ( myResult )
<a name="l01040"></a>01040   {
<a name="l01041"></a>01041     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;Can&#39;t open * user * database: %1&quot;</span> ).arg( sqlite3_errmsg( myDatabase ) ) );
<a name="l01042"></a>01042     <span class="comment">//no need for assert because user db may not have been created yet</span>
<a name="l01043"></a>01043     <span class="keywordflow">return</span> 0;
<a name="l01044"></a>01044   }
<a name="l01045"></a>01045 
<a name="l01046"></a>01046   myResult = sqlite3_prepare( myDatabase, theSql.toUtf8(), theSql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l01047"></a>01047   <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l01048"></a>01048   <span class="keywordflow">if</span> ( myResult == SQLITE_OK )
<a name="l01049"></a>01049   {
<a name="l01050"></a>01050     myResult = sqlite3_step( myPreparedStatement );
<a name="l01051"></a>01051     <span class="keywordflow">if</span> ( myResult == SQLITE_ROW )
<a name="l01052"></a>01052     {
<a name="l01053"></a>01053       QString mySrsIdString = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 0 ) );
<a name="l01054"></a>01054       mySrsId =  mySrsIdString.toLong();
<a name="l01055"></a>01055       <span class="comment">// close the sqlite3 statement</span>
<a name="l01056"></a>01056       sqlite3_finalize( myPreparedStatement );
<a name="l01057"></a>01057       sqlite3_close( myDatabase );
<a name="l01058"></a>01058     }
<a name="l01059"></a>01059   }
<a name="l01060"></a>01060   <span class="keywordflow">return</span> mySrsId;
<a name="l01061"></a>01061 }
<a name="l01062"></a>01062 
<a name="l01063"></a><a class="code" href="classQgsProjectionSelector.html#af8632f0ce7f4475d19d7c6e8a848ae2f">01063</a> QStringList <a class="code" href="classQgsProjectionSelector.html#af8632f0ce7f4475d19d7c6e8a848ae2f" title="get list of authorities">QgsProjectionSelector::authorities</a>()
<a name="l01064"></a>01064 {
<a name="l01065"></a>01065   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a>      *myDatabase;
<a name="l01066"></a>01066   <span class="keyword">const</span> <span class="keywordtype">char</span>   *myTail;
<a name="l01067"></a>01067   sqlite3_stmt *myPreparedStatement;
<a name="l01068"></a>01068   <span class="keywordtype">int</span>           myResult;
<a name="l01069"></a>01069 
<a name="l01070"></a>01070   myResult = sqlite3_open( <a class="code" href="classQgsProjectionSelector.html#a84ad55874a294af72104e457cc378498" title="File name of the sqlite3 database.">mSrsDatabaseFileName</a>.toUtf8().data(), &amp;myDatabase );
<a name="l01071"></a>01071   <span class="keywordflow">if</span> ( myResult )
<a name="l01072"></a>01072   {
<a name="l01073"></a>01073     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;Can&#39;t open * user * database: %1&quot;</span> ).arg( sqlite3_errmsg( myDatabase ) ) );
<a name="l01074"></a>01074     <span class="comment">//no need for assert because user db may not have been created yet</span>
<a name="l01075"></a>01075     <span class="keywordflow">return</span> QStringList();
<a name="l01076"></a>01076   }
<a name="l01077"></a>01077 
<a name="l01078"></a>01078   QString theSql = <span class="stringliteral">&quot;select distinct auth_name from tbl_srs&quot;</span>;
<a name="l01079"></a>01079   myResult = sqlite3_prepare( myDatabase, theSql.toUtf8(), theSql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l01080"></a>01080 
<a name="l01081"></a>01081   QStringList <a class="code" href="classQgsProjectionSelector.html#af8632f0ce7f4475d19d7c6e8a848ae2f" title="get list of authorities">authorities</a>;
<a name="l01082"></a>01082 
<a name="l01083"></a>01083   <span class="keywordflow">if</span> ( myResult == SQLITE_OK )
<a name="l01084"></a>01084   {
<a name="l01085"></a>01085     <span class="keywordflow">while</span> ( sqlite3_step( myPreparedStatement ) == SQLITE_ROW )
<a name="l01086"></a>01086     {
<a name="l01087"></a>01087       authorities &lt;&lt; QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 0 ) );
<a name="l01088"></a>01088     }
<a name="l01089"></a>01089 
<a name="l01090"></a>01090     <span class="comment">// close the sqlite3 statement</span>
<a name="l01091"></a>01091     sqlite3_finalize( myPreparedStatement );
<a name="l01092"></a>01092     sqlite3_close( myDatabase );
<a name="l01093"></a>01093   }
<a name="l01094"></a>01094 
<a name="l01095"></a>01095   <span class="keywordflow">return</span> <a class="code" href="classQgsProjectionSelector.html#af8632f0ce7f4475d19d7c6e8a848ae2f" title="get list of authorities">authorities</a>;
<a name="l01096"></a>01096 }
<a name="l01097"></a>01097 
<a name="l01107"></a><a class="code" href="classQgsProjectionSelector.html#a7f9531610bd8aa59ea032cd65eb5f8be">01107</a> <span class="keyword">const</span> QString <a class="code" href="classQgsProjectionSelector.html#a7f9531610bd8aa59ea032cd65eb5f8be" title="Make the string safe for use in SQL statements. This involves escaping single quotes, double quotes, backslashes, and optionally, percentage symbols. Percentage symbols are used as wildcards sometimes and so when using the string as part of the LIKE phrase of a select statement, should be escaped.">QgsProjectionSelector::sqlSafeString</a>( <span class="keyword">const</span> QString theSQL )
<a name="l01108"></a>01108 {
<a name="l01109"></a>01109   QString myRetval = theSQL;
<a name="l01110"></a>01110   myRetval.replace( <span class="stringliteral">&quot;\\&quot;</span>, <span class="stringliteral">&quot;\\\\&quot;</span> );
<a name="l01111"></a>01111   myRetval.replace( <span class="charliteral">&#39;\&quot;&#39;</span>, <span class="stringliteral">&quot;\\\&quot;&quot;</span> );
<a name="l01112"></a>01112   myRetval.replace( <span class="stringliteral">&quot;\&#39;&quot;</span>, <span class="stringliteral">&quot;\\&#39;&quot;</span> );
<a name="l01113"></a>01113   myRetval.replace( <span class="stringliteral">&quot;%&quot;</span>, <span class="stringliteral">&quot;\\%&quot;</span> );
<a name="l01114"></a>01114   <span class="keywordflow">return</span> myRetval;
<a name="l01115"></a>01115 }
<a name="l01116"></a>01116 
<a name="l01117"></a><a class="code" href="classQgsProjectionSelector.html#a8be0820409bb75747ae85b60e197389c">01117</a> <span class="keywordtype">void</span> <a class="code" href="classQgsProjectionSelector.html#a8be0820409bb75747ae85b60e197389c" title="Show the user a warning if the srs database could not be found.">QgsProjectionSelector::showDBMissingWarning</a>( <span class="keyword">const</span> QString theFileName )
<a name="l01118"></a>01118 {
<a name="l01119"></a>01119 
<a name="l01120"></a>01120   QMessageBox::critical( <span class="keyword">this</span>, tr( <span class="stringliteral">&quot;Resource Location Error&quot;</span> ),
<a name="l01121"></a>01121                          tr( <span class="stringliteral">&quot;Error reading database file from: \n %1\n&quot;</span>
<a name="l01122"></a>01122                              <span class="stringliteral">&quot;Because of this the projection selector will not work...&quot;</span> )
<a name="l01123"></a>01123                          .arg( theFileName ) );
<a name="l01124"></a>01124 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Tue Jun 19 2012 23:25:40 for Quantum GIS API Documentation by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
