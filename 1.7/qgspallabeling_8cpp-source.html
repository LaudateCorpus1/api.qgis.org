<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Quantum GIS API Documentation: src/core/qgspallabeling.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="classes.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li>
      <form action="search.php" method="get">
        <table cellspacing="0" cellpadding="0" border="0">
          <tr>
            <td><label>&nbsp;<u>S</u>earch&nbsp;for&nbsp;</label></td>
            <td><input type="text" name="query" value="" size="20" accesskey="s"/></td>
          </tr>
        </table>
      </form>
    </li>
    </ul>
  </div>
<h1>src/core/qgspallabeling.cpp</h1><a href="qgspallabeling_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/***************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">  qgspallabeling.cpp</span>
<a name="l00003"></a>00003 <span class="comment">  Smart labeling for vector layers</span>
<a name="l00004"></a>00004 <span class="comment">  -------------------</span>
<a name="l00005"></a>00005 <span class="comment">         begin                : June 2009</span>
<a name="l00006"></a>00006 <span class="comment">         copyright            : (C) Martin Dobias</span>
<a name="l00007"></a>00007 <span class="comment">         email                : wonder.sk at gmail.com</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment"> ***************************************************************************</span>
<a name="l00010"></a>00010 <span class="comment"> *                                                                         *</span>
<a name="l00011"></a>00011 <span class="comment"> *   This program is free software; you can redistribute it and/or modify  *</span>
<a name="l00012"></a>00012 <span class="comment"> *   it under the terms of the GNU General Public License as published by  *</span>
<a name="l00013"></a>00013 <span class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</span>
<a name="l00014"></a>00014 <span class="comment"> *   (at your option) any later version.                                   *</span>
<a name="l00015"></a>00015 <span class="comment"> *                                                                         *</span>
<a name="l00016"></a>00016 <span class="comment"> ***************************************************************************/</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include "<a class="code" href="qgspallabeling_8h.html">qgspallabeling.h</a>"</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;list&gt;</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;pal/pal.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;pal/feature.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;pal/layer.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;pal/palgeometry.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;pal/palexception.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;pal/problem.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;pal/labelposition.h&gt;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;geos_c.h&gt;</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;cmath&gt;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;QByteArray&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;QString&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;QFontMetrics&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;QTime&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;QPainter&gt;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include "<a class="code" href="qgsdiagram_8h.html">qgsdiagram.h</a>"</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include "<a class="code" href="qgsdiagramrendererv2_8h.html">qgsdiagramrendererv2.h</a>"</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include "<a class="code" href="qgslabelsearchtree_8h.html">qgslabelsearchtree.h</a>"</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="qgslogger_8h.html">qgslogger.h</a>&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="qgsvectorlayer_8h.html">qgsvectorlayer.h</a>&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;<a class="code" href="qgsmaplayerregistry_8h.html">qgsmaplayerregistry.h</a>&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;<a class="code" href="qgsvectordataprovider_8h.html">qgsvectordataprovider.h</a>&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;<a class="code" href="qgsgeometry_8h.html">qgsgeometry.h</a>&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;<a class="code" href="qgsmaprenderer_8h.html">qgsmaprenderer.h</a>&gt;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="keyword">using namespace </span>pal;
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 
<a name="l00055"></a><a class="code" href="classQgsPalGeometry.html">00055</a> <span class="keyword">class </span><a class="code" href="classQgsPalGeometry.html">QgsPalGeometry</a> : <span class="keyword">public</span> PalGeometry
<a name="l00056"></a>00056 {
<a name="l00057"></a>00057   <span class="keyword">public</span>:
<a name="l00058"></a><a class="code" href="classQgsPalGeometry.html#711c5ebe543f5ea4aa51a446ad00634d">00058</a>     <a class="code" href="classQgsPalGeometry.html#711c5ebe543f5ea4aa51a446ad00634d">QgsPalGeometry</a>( <span class="keywordtype">int</span> <span class="keywordtype">id</span>, QString <a class="code" href="classQgsPalGeometry.html#5e6ae46ca484301925bc81abdf0a05db">text</a>, GEOSGeometry* g ): <a class="code" href="classQgsPalGeometry.html#a4ec6fcc666e04684a5b271c17f3a2e5">mG</a>( g ), <a class="code" href="classQgsPalGeometry.html#0036d1f9c5e948eb8c2872f901cd34ee">mText</a>( text ), <a class="code" href="classQgsPalGeometry.html#79d3a2217ccceca77fbc1539084b0dc5">mId</a>( id ), <a class="code" href="classQgsPalGeometry.html#974eb47b3ad5d7d6fbcf0ae68cfdb131">mInfo</a>( NULL ), <a class="code" href="classQgsPalGeometry.html#7efdee4b4a43a0b7260eec1e70669a48">mIsDiagram</a>( false )
<a name="l00059"></a>00059     {
<a name="l00060"></a>00060       <a class="code" href="classQgsPalGeometry.html#8494add23f61183c30e7dc7be4d30828">mStrId</a> = QByteArray::number( <span class="keywordtype">id</span> );
<a name="l00061"></a>00061     }
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="classQgsPalGeometry.html#f7bebd72a39ef734a34fe7d7c9669210">00063</a>     <a class="code" href="classQgsPalGeometry.html#f7bebd72a39ef734a34fe7d7c9669210">~QgsPalGeometry</a>()
<a name="l00064"></a>00064     {
<a name="l00065"></a>00065       <span class="keywordflow">if</span> ( <a class="code" href="classQgsPalGeometry.html#a4ec6fcc666e04684a5b271c17f3a2e5">mG</a> ) GEOSGeom_destroy( <a class="code" href="classQgsPalGeometry.html#a4ec6fcc666e04684a5b271c17f3a2e5">mG</a> );
<a name="l00066"></a>00066       <span class="keyword">delete</span> <a class="code" href="classQgsPalGeometry.html#974eb47b3ad5d7d6fbcf0ae68cfdb131">mInfo</a>;
<a name="l00067"></a>00067     }
<a name="l00068"></a>00068 
<a name="l00069"></a>00069     <span class="comment">// getGeosGeometry + releaseGeosGeometry is called twice: once when adding, second time when labeling</span>
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="classQgsPalGeometry.html#3023c8b58d2c11626a6fade188a9d93d">00071</a>     GEOSGeometry* <a class="code" href="classQgsPalGeometry.html#3023c8b58d2c11626a6fade188a9d93d">getGeosGeometry</a>()
<a name="l00072"></a>00072     {
<a name="l00073"></a>00073       <span class="keywordflow">return</span> <a class="code" href="classQgsPalGeometry.html#a4ec6fcc666e04684a5b271c17f3a2e5">mG</a>;
<a name="l00074"></a>00074     }
<a name="l00075"></a><a class="code" href="classQgsPalGeometry.html#d536c728318befe2b3f2ef0c315b120c">00075</a>     <span class="keywordtype">void</span> <a class="code" href="classQgsPalGeometry.html#d536c728318befe2b3f2ef0c315b120c">releaseGeosGeometry</a>( GEOSGeometry* <span class="comment">/*geom*/</span> )
<a name="l00076"></a>00076     {
<a name="l00077"></a>00077       <span class="comment">// nothing here - we'll delete the geometry in destructor</span>
<a name="l00078"></a>00078     }
<a name="l00079"></a>00079 
<a name="l00080"></a><a class="code" href="classQgsPalGeometry.html#a051906c05c755d1fdc070174eb4dc73">00080</a>     <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="classQgsPalGeometry.html#a051906c05c755d1fdc070174eb4dc73">strId</a>() { <span class="keywordflow">return</span> <a class="code" href="classQgsPalGeometry.html#8494add23f61183c30e7dc7be4d30828">mStrId</a>.data(); }
<a name="l00081"></a><a class="code" href="classQgsPalGeometry.html#5e6ae46ca484301925bc81abdf0a05db">00081</a>     QString <a class="code" href="classQgsPalGeometry.html#5e6ae46ca484301925bc81abdf0a05db">text</a>() { <span class="keywordflow">return</span> <a class="code" href="classQgsPalGeometry.html#0036d1f9c5e948eb8c2872f901cd34ee">mText</a>; }
<a name="l00082"></a>00082 
<a name="l00083"></a><a class="code" href="classQgsPalGeometry.html#a64c1f9a5be2f8b45b8e875dc32cac63">00083</a>     pal::LabelInfo* <a class="code" href="classQgsPalGeometry.html#a64c1f9a5be2f8b45b8e875dc32cac63">info</a>( QFontMetricsF* fm, <span class="keyword">const</span> <a class="code" href="classQgsMapToPixel.html" title="Perform transforms between map coordinates and device coordinates.">QgsMapToPixel</a>* xform, <span class="keywordtype">double</span> fontScale )
<a name="l00084"></a>00084     {
<a name="l00085"></a>00085       <span class="keywordflow">if</span> ( <a class="code" href="classQgsPalGeometry.html#974eb47b3ad5d7d6fbcf0ae68cfdb131">mInfo</a> ) <span class="keywordflow">return</span> <a class="code" href="classQgsPalGeometry.html#974eb47b3ad5d7d6fbcf0ae68cfdb131">mInfo</a>;
<a name="l00086"></a>00086 
<a name="l00087"></a>00087       <span class="comment">// create label info!</span>
<a name="l00088"></a>00088       <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> ptZero = xform-&gt;<a class="code" href="classQgsMapToPixel.html#9bffa589e03240bc37c8ea9bed45f339">toMapCoordinates</a>( 0, 0 );
<a name="l00089"></a>00089       <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> ptSize = xform-&gt;<a class="code" href="classQgsMapToPixel.html#b2f5b73b051c085da22882bbef144c05">toMapCoordinatesF</a>( 0.0, -fm-&gt;height() / fontScale );
<a name="l00090"></a>00090 
<a name="l00091"></a>00091       <a class="code" href="classQgsPalGeometry.html#974eb47b3ad5d7d6fbcf0ae68cfdb131">mInfo</a> = <span class="keyword">new</span> pal::LabelInfo( <a class="code" href="classQgsPalGeometry.html#0036d1f9c5e948eb8c2872f901cd34ee">mText</a>.count(), ptSize.<a class="code" href="classQgsPoint.html#07bd042b697bab243f4be31358d943ad">y</a>() - ptZero.<a class="code" href="classQgsPoint.html#07bd042b697bab243f4be31358d943ad">y</a>() );
<a name="l00092"></a>00092       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classQgsPalGeometry.html#0036d1f9c5e948eb8c2872f901cd34ee">mText</a>.count(); i++ )
<a name="l00093"></a>00093       {
<a name="l00094"></a>00094         <a class="code" href="classQgsPalGeometry.html#974eb47b3ad5d7d6fbcf0ae68cfdb131">mInfo</a>-&gt;char_info[i].chr = <a class="code" href="classQgsPalGeometry.html#0036d1f9c5e948eb8c2872f901cd34ee">mText</a>[i].unicode();
<a name="l00095"></a>00095         ptSize = xform-&gt;<a class="code" href="classQgsMapToPixel.html#b2f5b73b051c085da22882bbef144c05">toMapCoordinatesF</a>( fm-&gt;width( <a class="code" href="classQgsPalGeometry.html#0036d1f9c5e948eb8c2872f901cd34ee">mText</a>[i] ) / fontScale , 0.0 );
<a name="l00096"></a>00096         <a class="code" href="classQgsPalGeometry.html#974eb47b3ad5d7d6fbcf0ae68cfdb131">mInfo</a>-&gt;char_info[i].width = ptSize.<a class="code" href="classQgsPoint.html#14cf4897a06313074760383398ee95d5">x</a>() - ptZero.<a class="code" href="classQgsPoint.html#14cf4897a06313074760383398ee95d5">x</a>();
<a name="l00097"></a>00097       }
<a name="l00098"></a>00098       <span class="keywordflow">return</span> <a class="code" href="classQgsPalGeometry.html#974eb47b3ad5d7d6fbcf0ae68cfdb131">mInfo</a>;
<a name="l00099"></a>00099     }
<a name="l00100"></a>00100 
<a name="l00101"></a><a class="code" href="classQgsPalGeometry.html#d829eb35c07c88ae71d394d8c44e151f">00101</a>     <span class="keyword">const</span> QMap&lt; QgsPalLayerSettings::DataDefinedProperties, QVariant &gt;&amp; <a class="code" href="classQgsPalGeometry.html#d829eb35c07c88ae71d394d8c44e151f">dataDefinedValues</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="classQgsPalGeometry.html#4634912b0f44e0d9ed4fcaaa5ffc9c2e" title="Stores attribute values for data defined properties.">mDataDefinedValues</a>; }
<a name="l00102"></a><a class="code" href="classQgsPalGeometry.html#be7a5ada06b6aaa3d466072582188cca">00102</a>     <span class="keywordtype">void</span> <a class="code" href="classQgsPalGeometry.html#be7a5ada06b6aaa3d466072582188cca">addDataDefinedValue</a>( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea">QgsPalLayerSettings::DataDefinedProperties</a> p, QVariant v ) { <a class="code" href="classQgsPalGeometry.html#4634912b0f44e0d9ed4fcaaa5ffc9c2e" title="Stores attribute values for data defined properties.">mDataDefinedValues</a>.insert( p, v ); }
<a name="l00103"></a>00103 
<a name="l00104"></a><a class="code" href="classQgsPalGeometry.html#7487bb832af5515a9c5f3e5cf0201b16">00104</a>     <span class="keywordtype">void</span> <a class="code" href="classQgsPalGeometry.html#7487bb832af5515a9c5f3e5cf0201b16">setIsDiagram</a>( <span class="keywordtype">bool</span> d ) { <a class="code" href="classQgsPalGeometry.html#7efdee4b4a43a0b7260eec1e70669a48">mIsDiagram</a> = d; }
<a name="l00105"></a><a class="code" href="classQgsPalGeometry.html#fcd2849e424d1d12c011ef1e039a2422">00105</a>     <span class="keywordtype">bool</span> <a class="code" href="classQgsPalGeometry.html#fcd2849e424d1d12c011ef1e039a2422">isDiagram</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="classQgsPalGeometry.html#7efdee4b4a43a0b7260eec1e70669a48">mIsDiagram</a>; }
<a name="l00106"></a>00106 
<a name="l00107"></a><a class="code" href="classQgsPalGeometry.html#b6fa8d14fa796b2e728dde3894156f62">00107</a>     <span class="keywordtype">void</span> <a class="code" href="classQgsPalGeometry.html#b6fa8d14fa796b2e728dde3894156f62">addDiagramAttribute</a>( <span class="keywordtype">int</span> index, QVariant value ) { <a class="code" href="classQgsPalGeometry.html#a778e71d580c223660f760434064eaba" title="Stores attribute values for diagram rendering.">mDiagramAttributes</a>.insert( index, value ); }
<a name="l00108"></a><a class="code" href="classQgsPalGeometry.html#257a751915ddc4f9e4bc174b1144602d">00108</a>     <span class="keyword">const</span> <a class="code" href="qgsfeature_8h.html#54fb9a5ab4cfae301a0415ce490f08c8">QgsAttributeMap</a>&amp; <a class="code" href="classQgsPalGeometry.html#257a751915ddc4f9e4bc174b1144602d">diagramAttributes</a>() { <span class="keywordflow">return</span> <a class="code" href="classQgsPalGeometry.html#a778e71d580c223660f760434064eaba" title="Stores attribute values for diagram rendering.">mDiagramAttributes</a>; }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110   <span class="keyword">protected</span>:
<a name="l00111"></a><a class="code" href="classQgsPalGeometry.html#a4ec6fcc666e04684a5b271c17f3a2e5">00111</a>     GEOSGeometry* <a class="code" href="classQgsPalGeometry.html#a4ec6fcc666e04684a5b271c17f3a2e5">mG</a>;
<a name="l00112"></a><a class="code" href="classQgsPalGeometry.html#0036d1f9c5e948eb8c2872f901cd34ee">00112</a>     QString <a class="code" href="classQgsPalGeometry.html#0036d1f9c5e948eb8c2872f901cd34ee">mText</a>;
<a name="l00113"></a><a class="code" href="classQgsPalGeometry.html#8494add23f61183c30e7dc7be4d30828">00113</a>     QByteArray <a class="code" href="classQgsPalGeometry.html#8494add23f61183c30e7dc7be4d30828">mStrId</a>;
<a name="l00114"></a><a class="code" href="classQgsPalGeometry.html#79d3a2217ccceca77fbc1539084b0dc5">00114</a>     <span class="keywordtype">int</span> <a class="code" href="classQgsPalGeometry.html#79d3a2217ccceca77fbc1539084b0dc5">mId</a>;
<a name="l00115"></a><a class="code" href="classQgsPalGeometry.html#974eb47b3ad5d7d6fbcf0ae68cfdb131">00115</a>     LabelInfo* <a class="code" href="classQgsPalGeometry.html#974eb47b3ad5d7d6fbcf0ae68cfdb131">mInfo</a>;
<a name="l00116"></a><a class="code" href="classQgsPalGeometry.html#7efdee4b4a43a0b7260eec1e70669a48">00116</a>     <span class="keywordtype">bool</span> <a class="code" href="classQgsPalGeometry.html#7efdee4b4a43a0b7260eec1e70669a48">mIsDiagram</a>;
<a name="l00118"></a><a class="code" href="classQgsPalGeometry.html#4634912b0f44e0d9ed4fcaaa5ffc9c2e">00118</a>     QMap&lt; QgsPalLayerSettings::DataDefinedProperties, QVariant &gt; <a class="code" href="classQgsPalGeometry.html#4634912b0f44e0d9ed4fcaaa5ffc9c2e" title="Stores attribute values for data defined properties.">mDataDefinedValues</a>;
<a name="l00119"></a>00119 
<a name="l00121"></a><a class="code" href="classQgsPalGeometry.html#a778e71d580c223660f760434064eaba">00121</a>     <a class="code" href="qgsfeature_8h.html#54fb9a5ab4cfae301a0415ce490f08c8">QgsAttributeMap</a> <a class="code" href="classQgsPalGeometry.html#a778e71d580c223660f760434064eaba" title="Stores attribute values for diagram rendering.">mDiagramAttributes</a>;
<a name="l00122"></a>00122 };
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 <span class="comment">// -------------</span>
<a name="l00125"></a>00125 
<a name="l00126"></a><a class="code" href="classQgsPalLayerSettings.html#1d69d7b0e9951cc711c8ec266279d4f6">00126</a> <a class="code" href="classQgsPalLayerSettings.html#1d69d7b0e9951cc711c8ec266279d4f6">QgsPalLayerSettings::QgsPalLayerSettings</a>()
<a name="l00127"></a>00127     : palLayer( NULL ), fontMetrics( NULL ), ct( NULL )
<a name="l00128"></a>00128 {
<a name="l00129"></a>00129   <a class="code" href="classQgsPalLayerSettings.html#de0e96125f5d912953b168a736d2e09b">placement</a> = <a class="code" href="classQgsPalLayerSettings.html#5d449d8e9cb89e5d453c6e33fe1c66cc1f573db8056342bdd9ac382bcf14adf9">AroundPoint</a>;
<a name="l00130"></a>00130   <a class="code" href="classQgsPalLayerSettings.html#beb4d081fd4eb7debb30dfcdd5be8d58">placementFlags</a> = 0;
<a name="l00131"></a>00131   <span class="comment">//textFont = QFont();</span>
<a name="l00132"></a>00132   <a class="code" href="classQgsPalLayerSettings.html#cbe45b8cb06f3d0b8f51c18919a744ba">textColor</a> = Qt::black;
<a name="l00133"></a>00133   <a class="code" href="classQgsPalLayerSettings.html#487efd2ca58be0c974cc2e29024cfbbb">enabled</a> = <span class="keyword">false</span>;
<a name="l00134"></a>00134   <a class="code" href="classQgsPalLayerSettings.html#67fba9e271265dddf0e9bb3a28c9e7de">priority</a> = 5;
<a name="l00135"></a>00135   <a class="code" href="classQgsPalLayerSettings.html#10af33e55f923e6ddf3c20f1e51fbb29">obstacle</a> = <span class="keyword">true</span>;
<a name="l00136"></a>00136   <a class="code" href="classQgsPalLayerSettings.html#b0c2d6ce60da3873726f544c7d9ea47a">dist</a> = 0;
<a name="l00137"></a>00137   <a class="code" href="classQgsPalLayerSettings.html#90286fb2699deb8f4032ac91b6318785">scaleMin</a> = 0;
<a name="l00138"></a>00138   <a class="code" href="classQgsPalLayerSettings.html#f2ec6e89aca16eebe643118b6be661aa">scaleMax</a> = 0;
<a name="l00139"></a>00139   <a class="code" href="classQgsPalLayerSettings.html#fbf1adda85087c82e05ba14547774e37">bufferSize</a> = 1;
<a name="l00140"></a>00140   <a class="code" href="classQgsPalLayerSettings.html#0aa38422710279da59e44539b064cbed">bufferColor</a> = Qt::white;
<a name="l00141"></a>00141   <a class="code" href="classQgsPalLayerSettings.html#6bda8893aa13604885edd2be1d1301c9">labelPerPart</a> = <span class="keyword">false</span>;
<a name="l00142"></a>00142   <a class="code" href="classQgsPalLayerSettings.html#ecb8058601826a08976c9f3fbfe5d4ab">mergeLines</a> = <span class="keyword">false</span>;
<a name="l00143"></a>00143   <a class="code" href="classQgsPalLayerSettings.html#477a4aa6642a5e47c6f3c3332b1ef6e5">multiLineLabels</a> = <span class="keyword">false</span>;
<a name="l00144"></a>00144   <a class="code" href="classQgsPalLayerSettings.html#880fbddafb425e4ad77aceeaabd868b5">minFeatureSize</a> = 0.0;
<a name="l00145"></a>00145   <a class="code" href="classQgsPalLayerSettings.html#451e4e4bb95a04422ec5b3f583113297">vectorScaleFactor</a> = 1.0;
<a name="l00146"></a>00146   <a class="code" href="classQgsPalLayerSettings.html#31d35efbd75cb3c342b98300cc1693cf">rasterCompressFactor</a> = 1.0;
<a name="l00147"></a>00147   <a class="code" href="classQgsPalLayerSettings.html#499be91338f5ee41c56f4a88e7247450">addDirectionSymbol</a> = <span class="keyword">false</span>;
<a name="l00148"></a>00148   <a class="code" href="classQgsPalLayerSettings.html#4eb2fc5cc0a37e83669249bccdb43e23">fontSizeInMapUnits</a> = <span class="keyword">false</span>;
<a name="l00149"></a>00149   <a class="code" href="classQgsPalLayerSettings.html#45969f9c95bd9fd7538ca67fc8f4f55c">distInMapUnits</a> = <span class="keyword">false</span>;
<a name="l00150"></a>00150 }
<a name="l00151"></a>00151 
<a name="l00152"></a><a class="code" href="classQgsPalLayerSettings.html#d8e881223f1a7b81d19b26caa059bc77">00152</a> <a class="code" href="classQgsPalLayerSettings.html#1d69d7b0e9951cc711c8ec266279d4f6">QgsPalLayerSettings::QgsPalLayerSettings</a>( <span class="keyword">const</span> <a class="code" href="classQgsPalLayerSettings.html">QgsPalLayerSettings</a>&amp; s )
<a name="l00153"></a>00153 {
<a name="l00154"></a>00154   <span class="comment">// copy only permanent stuff</span>
<a name="l00155"></a>00155   <a class="code" href="classQgsPalLayerSettings.html#c57b3ecf3c052e33c947ed8713e4b48c">fieldName</a> = s.<a class="code" href="classQgsPalLayerSettings.html#c57b3ecf3c052e33c947ed8713e4b48c">fieldName</a>;
<a name="l00156"></a>00156   <a class="code" href="classQgsPalLayerSettings.html#de0e96125f5d912953b168a736d2e09b">placement</a> = s.<a class="code" href="classQgsPalLayerSettings.html#de0e96125f5d912953b168a736d2e09b">placement</a>;
<a name="l00157"></a>00157   <a class="code" href="classQgsPalLayerSettings.html#beb4d081fd4eb7debb30dfcdd5be8d58">placementFlags</a> = s.<a class="code" href="classQgsPalLayerSettings.html#beb4d081fd4eb7debb30dfcdd5be8d58">placementFlags</a>;
<a name="l00158"></a>00158   <a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a> = s.<a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a>;
<a name="l00159"></a>00159   <a class="code" href="classQgsPalLayerSettings.html#cbe45b8cb06f3d0b8f51c18919a744ba">textColor</a> = s.<a class="code" href="classQgsPalLayerSettings.html#cbe45b8cb06f3d0b8f51c18919a744ba">textColor</a>;
<a name="l00160"></a>00160   <a class="code" href="classQgsPalLayerSettings.html#487efd2ca58be0c974cc2e29024cfbbb">enabled</a> = s.<a class="code" href="classQgsPalLayerSettings.html#487efd2ca58be0c974cc2e29024cfbbb">enabled</a>;
<a name="l00161"></a>00161   <a class="code" href="classQgsPalLayerSettings.html#67fba9e271265dddf0e9bb3a28c9e7de">priority</a> = s.<a class="code" href="classQgsPalLayerSettings.html#67fba9e271265dddf0e9bb3a28c9e7de">priority</a>;
<a name="l00162"></a>00162   <a class="code" href="classQgsPalLayerSettings.html#10af33e55f923e6ddf3c20f1e51fbb29">obstacle</a> = s.<a class="code" href="classQgsPalLayerSettings.html#10af33e55f923e6ddf3c20f1e51fbb29">obstacle</a>;
<a name="l00163"></a>00163   <a class="code" href="classQgsPalLayerSettings.html#b0c2d6ce60da3873726f544c7d9ea47a">dist</a> = s.<a class="code" href="classQgsPalLayerSettings.html#b0c2d6ce60da3873726f544c7d9ea47a">dist</a>;
<a name="l00164"></a>00164   <a class="code" href="classQgsPalLayerSettings.html#90286fb2699deb8f4032ac91b6318785">scaleMin</a> = s.<a class="code" href="classQgsPalLayerSettings.html#90286fb2699deb8f4032ac91b6318785">scaleMin</a>;
<a name="l00165"></a>00165   <a class="code" href="classQgsPalLayerSettings.html#f2ec6e89aca16eebe643118b6be661aa">scaleMax</a> = s.<a class="code" href="classQgsPalLayerSettings.html#f2ec6e89aca16eebe643118b6be661aa">scaleMax</a>;
<a name="l00166"></a>00166   <a class="code" href="classQgsPalLayerSettings.html#fbf1adda85087c82e05ba14547774e37">bufferSize</a> = s.<a class="code" href="classQgsPalLayerSettings.html#fbf1adda85087c82e05ba14547774e37">bufferSize</a>;
<a name="l00167"></a>00167   <a class="code" href="classQgsPalLayerSettings.html#0aa38422710279da59e44539b064cbed">bufferColor</a> = s.<a class="code" href="classQgsPalLayerSettings.html#0aa38422710279da59e44539b064cbed">bufferColor</a>;
<a name="l00168"></a>00168   <a class="code" href="classQgsPalLayerSettings.html#6bda8893aa13604885edd2be1d1301c9">labelPerPart</a> = s.<a class="code" href="classQgsPalLayerSettings.html#6bda8893aa13604885edd2be1d1301c9">labelPerPart</a>;
<a name="l00169"></a>00169   <a class="code" href="classQgsPalLayerSettings.html#ecb8058601826a08976c9f3fbfe5d4ab">mergeLines</a> = s.<a class="code" href="classQgsPalLayerSettings.html#ecb8058601826a08976c9f3fbfe5d4ab">mergeLines</a>;
<a name="l00170"></a>00170   <a class="code" href="classQgsPalLayerSettings.html#477a4aa6642a5e47c6f3c3332b1ef6e5">multiLineLabels</a> = s.<a class="code" href="classQgsPalLayerSettings.html#477a4aa6642a5e47c6f3c3332b1ef6e5">multiLineLabels</a>;
<a name="l00171"></a>00171   <a class="code" href="classQgsPalLayerSettings.html#880fbddafb425e4ad77aceeaabd868b5">minFeatureSize</a> = s.<a class="code" href="classQgsPalLayerSettings.html#880fbddafb425e4ad77aceeaabd868b5">minFeatureSize</a>;
<a name="l00172"></a>00172   <a class="code" href="classQgsPalLayerSettings.html#451e4e4bb95a04422ec5b3f583113297">vectorScaleFactor</a> = s.<a class="code" href="classQgsPalLayerSettings.html#451e4e4bb95a04422ec5b3f583113297">vectorScaleFactor</a>;
<a name="l00173"></a>00173   <a class="code" href="classQgsPalLayerSettings.html#31d35efbd75cb3c342b98300cc1693cf">rasterCompressFactor</a> = s.<a class="code" href="classQgsPalLayerSettings.html#31d35efbd75cb3c342b98300cc1693cf">rasterCompressFactor</a>;
<a name="l00174"></a>00174   <a class="code" href="classQgsPalLayerSettings.html#499be91338f5ee41c56f4a88e7247450">addDirectionSymbol</a> = s.<a class="code" href="classQgsPalLayerSettings.html#499be91338f5ee41c56f4a88e7247450">addDirectionSymbol</a>;
<a name="l00175"></a>00175   <a class="code" href="classQgsPalLayerSettings.html#4eb2fc5cc0a37e83669249bccdb43e23">fontSizeInMapUnits</a> = s.<a class="code" href="classQgsPalLayerSettings.html#4eb2fc5cc0a37e83669249bccdb43e23">fontSizeInMapUnits</a>;
<a name="l00176"></a>00176   <a class="code" href="classQgsPalLayerSettings.html#45969f9c95bd9fd7538ca67fc8f4f55c">distInMapUnits</a> = s.<a class="code" href="classQgsPalLayerSettings.html#45969f9c95bd9fd7538ca67fc8f4f55c">distInMapUnits</a>;
<a name="l00177"></a>00177 
<a name="l00178"></a>00178   <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a> = s.<a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>;
<a name="l00179"></a>00179   <a class="code" href="classQgsPalLayerSettings.html#085fcc0331f3f3ca085826a55f41f463">fontMetrics</a> = NULL;
<a name="l00180"></a>00180   <a class="code" href="classQgsPalLayerSettings.html#81f31b83854f9876ad05174ce4bab1da">ct</a> = NULL;
<a name="l00181"></a>00181 }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 
<a name="l00184"></a><a class="code" href="classQgsPalLayerSettings.html#ac1a9d79db6f7a3f0205e9bcd5904dd7">00184</a> <a class="code" href="classQgsPalLayerSettings.html#ac1a9d79db6f7a3f0205e9bcd5904dd7">QgsPalLayerSettings::~QgsPalLayerSettings</a>()
<a name="l00185"></a>00185 {
<a name="l00186"></a>00186   <span class="comment">// pal layer is deleted internally in PAL</span>
<a name="l00187"></a>00187 
<a name="l00188"></a>00188   <span class="keyword">delete</span> <a class="code" href="classQgsPalLayerSettings.html#085fcc0331f3f3ca085826a55f41f463">fontMetrics</a>;
<a name="l00189"></a>00189   <span class="keyword">delete</span> <a class="code" href="classQgsPalLayerSettings.html#81f31b83854f9876ad05174ce4bab1da">ct</a>;
<a name="l00190"></a>00190 }
<a name="l00191"></a>00191 
<a name="l00192"></a><a class="code" href="qgspallabeling_8cpp.html#3c469acfe691d918f5bb5e00965e4607">00192</a> <span class="keyword">static</span> QColor <a class="code" href="qgspallabeling_8cpp.html#3c469acfe691d918f5bb5e00965e4607">_readColor</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* layer, QString property )
<a name="l00193"></a>00193 {
<a name="l00194"></a>00194   <span class="keywordtype">int</span> r = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( property + <span class="stringliteral">"R"</span> ).toInt();
<a name="l00195"></a>00195   <span class="keywordtype">int</span> g = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( property + <span class="stringliteral">"G"</span> ).toInt();
<a name="l00196"></a>00196   <span class="keywordtype">int</span> b = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( property + <span class="stringliteral">"B"</span> ).toInt();
<a name="l00197"></a>00197   <span class="keywordflow">return</span> QColor( r, g, b );
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00200"></a><a class="code" href="qgspallabeling_8cpp.html#32ca127b479b68e6035b346c6538e605">00200</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="qgspallabeling_8cpp.html#32ca127b479b68e6035b346c6538e605">_writeColor</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* layer, QString property, QColor color )
<a name="l00201"></a>00201 {
<a name="l00202"></a>00202   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( property + <span class="stringliteral">"R"</span>, color.red() );
<a name="l00203"></a>00203   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( property + <span class="stringliteral">"G"</span>, color.green() );
<a name="l00204"></a>00204   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( property + <span class="stringliteral">"B"</span>, color.blue() );
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00207"></a><a class="code" href="qgspallabeling_8cpp.html#0b71e0c1c9e6c5dbfdb54415beb9a6e8">00207</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="qgspallabeling_8cpp.html#0b71e0c1c9e6c5dbfdb54415beb9a6e8">_writeDataDefinedPropertyMap</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* layer, <span class="keyword">const</span> QMap&lt; QgsPalLayerSettings::DataDefinedProperties, int &gt;&amp; propertyMap )
<a name="l00208"></a>00208 {
<a name="l00209"></a>00209   <span class="keywordflow">if</span> ( !layer )
<a name="l00210"></a>00210   {
<a name="l00211"></a>00211     <span class="keywordflow">return</span>;
<a name="l00212"></a>00212   }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; 15; ++i )
<a name="l00215"></a>00215   {
<a name="l00216"></a>00216     QMap&lt; QgsPalLayerSettings::DataDefinedProperties, int &gt;::const_iterator it = propertyMap.find(( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea">QgsPalLayerSettings::DataDefinedProperties</a> )i );
<a name="l00217"></a>00217     QVariant propertyValue;
<a name="l00218"></a>00218     <span class="keywordflow">if</span> ( it == propertyMap.constEnd() )
<a name="l00219"></a>00219     {
<a name="l00220"></a>00220       propertyValue = QVariant(); <span class="comment">//we cannot delete properties, so we just insert an invalid variant</span>
<a name="l00221"></a>00221     }
<a name="l00222"></a>00222     <span class="keywordflow">else</span>
<a name="l00223"></a>00223     {
<a name="l00224"></a>00224       propertyValue = *it;
<a name="l00225"></a>00225     }
<a name="l00226"></a>00226     layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/dataDefinedProperty"</span> + QString::number( i ), propertyValue );
<a name="l00227"></a>00227   }
<a name="l00228"></a>00228 }
<a name="l00229"></a>00229 
<a name="l00230"></a><a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">00230</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* layer, <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea">QgsPalLayerSettings::DataDefinedProperties</a> p, \
<a name="l00231"></a>00231                                       QMap&lt; QgsPalLayerSettings::DataDefinedProperties, int &gt;&amp; propertyMap )
<a name="l00232"></a>00232 {
<a name="l00233"></a>00233   QVariant propertyField = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/dataDefinedProperty"</span> + QString::number( p ) );
<a name="l00234"></a>00234   <span class="keywordtype">bool</span> conversionOk;
<a name="l00235"></a>00235   <span class="keywordtype">int</span> <a class="code" href="classQgsPalLayerSettings.html#a2c4b1fb3329602ec2b832a001f5ac38">fieldIndex</a>;
<a name="l00236"></a>00236 
<a name="l00237"></a>00237   <span class="keywordflow">if</span> ( propertyField.isValid() )
<a name="l00238"></a>00238   {
<a name="l00239"></a>00239     fieldIndex = propertyField.toInt( &amp;conversionOk );
<a name="l00240"></a>00240     <span class="keywordflow">if</span> ( conversionOk )
<a name="l00241"></a>00241     {
<a name="l00242"></a>00242       propertyMap.insert( p, fieldIndex );
<a name="l00243"></a>00243     }
<a name="l00244"></a>00244   }
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a><a class="code" href="qgspallabeling_8cpp.html#cbbde136c1b7a60a735f62f0ff8bda2c">00247</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="qgspallabeling_8cpp.html#cbbde136c1b7a60a735f62f0ff8bda2c">_readDataDefinedPropertyMap</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* layer, QMap&lt; QgsPalLayerSettings::DataDefinedProperties, int &gt;&amp; propertyMap )
<a name="l00248"></a>00248 {
<a name="l00249"></a>00249   <span class="keywordflow">if</span> ( !layer )
<a name="l00250"></a>00250   {
<a name="l00251"></a>00251     <span class="keywordflow">return</span>;
<a name="l00252"></a>00252   }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254   <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( layer, <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea7f337404d9060060478e5205de3e84ec">QgsPalLayerSettings::Size</a>, propertyMap );
<a name="l00255"></a>00255   <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( layer, <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3ceab0a05d2726384f314a72bf46cdf900f8">QgsPalLayerSettings::Color</a>, propertyMap );
<a name="l00256"></a>00256   <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( layer, <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea35ab7b17a948c256ba6ca6089e0a5415">QgsPalLayerSettings::Bold</a>, propertyMap );
<a name="l00257"></a>00257   <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( layer, <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea8ed7b53c4acd14091160feb3954da0a3">QgsPalLayerSettings::Italic</a>, propertyMap );
<a name="l00258"></a>00258   <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( layer, <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea2aa75696a4bd40eea9dcb40cfaf44837">QgsPalLayerSettings::Underline</a>, propertyMap );
<a name="l00259"></a>00259   <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( layer, <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea225ff1b41357a4b1e48a897b122ddd45">QgsPalLayerSettings::Strikeout</a>, propertyMap );
<a name="l00260"></a>00260   <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( layer, <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3ceae4a378482d89e27d52b7078a25cd2b8a">QgsPalLayerSettings::Family</a>, propertyMap );
<a name="l00261"></a>00261   <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( layer, <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea46b800f2f7f82bfe1cc28ddcd25b972e">QgsPalLayerSettings::BufferSize</a>, propertyMap );
<a name="l00262"></a>00262   <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( layer, <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea17b8f0a3d267cfd3d448032c13167c7f">QgsPalLayerSettings::BufferColor</a>, propertyMap );
<a name="l00263"></a>00263   <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( layer,  <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea28e1e8cdf1179aace5f18d58e87053d3">QgsPalLayerSettings::PositionX</a>, propertyMap );
<a name="l00264"></a>00264   <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( layer,  <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea1259502d5cc3dd3c06d4f93a74cb8d93">QgsPalLayerSettings::PositionY</a>, propertyMap );
<a name="l00265"></a>00265   <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( layer,  <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea3ad1ca33ed0d27133f4dea2c6b8a47cd">QgsPalLayerSettings::Hali</a>, propertyMap );
<a name="l00266"></a>00266   <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( layer,  <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3ceafc00c9b621833b0c92ac3cd03611a842">QgsPalLayerSettings::Vali</a>, propertyMap );
<a name="l00267"></a>00267   <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( layer, <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea31ec0cb0aecca4a9ebba1f823584cb8e">QgsPalLayerSettings::LabelDistance</a>, propertyMap );
<a name="l00268"></a>00268   <a class="code" href="qgspallabeling_8cpp.html#cfd92026accfee372e61e8ff943e593a">_readDataDefinedProperty</a>( layer, <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea7ff14268884a4277a34606b3ec256f6e">QgsPalLayerSettings::Rotation</a>, propertyMap );
<a name="l00269"></a>00269 }
<a name="l00270"></a>00270 
<a name="l00271"></a><a class="code" href="classQgsPalLayerSettings.html#c4b2c35cf755ef8ea4edfb7beb5d992a">00271</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLayerSettings.html#c4b2c35cf755ef8ea4edfb7beb5d992a">QgsPalLayerSettings::readFromLayer</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* layer )
<a name="l00272"></a>00272 {
<a name="l00273"></a>00273   <span class="keywordflow">if</span> ( layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling"</span> ).toString() != QString( <span class="stringliteral">"pal"</span> ) )
<a name="l00274"></a>00274     <span class="keywordflow">return</span>; <span class="comment">// there's no information available</span>
<a name="l00275"></a>00275 
<a name="l00276"></a>00276   <a class="code" href="classQgsPalLayerSettings.html#c57b3ecf3c052e33c947ed8713e4b48c">fieldName</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/fieldName"</span> ).toString();
<a name="l00277"></a>00277   <a class="code" href="classQgsPalLayerSettings.html#de0e96125f5d912953b168a736d2e09b">placement</a> = ( <a class="code" href="classQgsPalLayerSettings.html#5d449d8e9cb89e5d453c6e33fe1c66cc">Placement</a> ) layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/placement"</span> ).toInt();
<a name="l00278"></a>00278   <a class="code" href="classQgsPalLayerSettings.html#beb4d081fd4eb7debb30dfcdd5be8d58">placementFlags</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/placementFlags"</span> ).toUInt();
<a name="l00279"></a>00279   QString fontFamily = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/fontFamily"</span> ).toString();
<a name="l00280"></a>00280   <span class="keywordtype">double</span> fontSize = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/fontSize"</span> ).toDouble();
<a name="l00281"></a>00281   <span class="keywordtype">int</span> fontWeight = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/fontWeight"</span> ).toInt();
<a name="l00282"></a>00282   <span class="keywordtype">bool</span> fontItalic = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/fontItalic"</span> ).toBool();
<a name="l00283"></a>00283   <a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a> = QFont( fontFamily, fontSize, fontWeight, fontItalic );
<a name="l00284"></a>00284   <a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a>.setUnderline( layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/fontUnderline"</span> ).toBool() );
<a name="l00285"></a>00285   <a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a>.setStrikeOut( layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/fontStrikeout"</span> ).toBool() );
<a name="l00286"></a>00286   <a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a>.setPointSizeF( fontSize ); <span class="comment">//double precision needed because of map units</span>
<a name="l00287"></a>00287   <a class="code" href="classQgsPalLayerSettings.html#cbe45b8cb06f3d0b8f51c18919a744ba">textColor</a> = <a class="code" href="qgspallabeling_8cpp.html#3c469acfe691d918f5bb5e00965e4607">_readColor</a>( layer, <span class="stringliteral">"labeling/textColor"</span> );
<a name="l00288"></a>00288   <a class="code" href="classQgsPalLayerSettings.html#487efd2ca58be0c974cc2e29024cfbbb">enabled</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/enabled"</span> ).toBool();
<a name="l00289"></a>00289   <a class="code" href="classQgsPalLayerSettings.html#67fba9e271265dddf0e9bb3a28c9e7de">priority</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/priority"</span> ).toInt();
<a name="l00290"></a>00290   <a class="code" href="classQgsPalLayerSettings.html#10af33e55f923e6ddf3c20f1e51fbb29">obstacle</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/obstacle"</span> ).toBool();
<a name="l00291"></a>00291   <a class="code" href="classQgsPalLayerSettings.html#b0c2d6ce60da3873726f544c7d9ea47a">dist</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/dist"</span> ).toDouble();
<a name="l00292"></a>00292   <a class="code" href="classQgsPalLayerSettings.html#90286fb2699deb8f4032ac91b6318785">scaleMin</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/scaleMin"</span> ).toInt();
<a name="l00293"></a>00293   <a class="code" href="classQgsPalLayerSettings.html#f2ec6e89aca16eebe643118b6be661aa">scaleMax</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/scaleMax"</span> ).toInt();
<a name="l00294"></a>00294   <a class="code" href="classQgsPalLayerSettings.html#fbf1adda85087c82e05ba14547774e37">bufferSize</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/bufferSize"</span> ).toDouble();
<a name="l00295"></a>00295   <a class="code" href="classQgsPalLayerSettings.html#0aa38422710279da59e44539b064cbed">bufferColor</a> = <a class="code" href="qgspallabeling_8cpp.html#3c469acfe691d918f5bb5e00965e4607">_readColor</a>( layer, <span class="stringliteral">"labeling/bufferColor"</span> );
<a name="l00296"></a>00296   <a class="code" href="classQgsPalLayerSettings.html#6bda8893aa13604885edd2be1d1301c9">labelPerPart</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/labelPerPart"</span> ).toBool();
<a name="l00297"></a>00297   <a class="code" href="classQgsPalLayerSettings.html#ecb8058601826a08976c9f3fbfe5d4ab">mergeLines</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/mergeLines"</span> ).toBool();
<a name="l00298"></a>00298   <a class="code" href="classQgsPalLayerSettings.html#477a4aa6642a5e47c6f3c3332b1ef6e5">multiLineLabels</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/multiLineLabels"</span> ).toBool();
<a name="l00299"></a>00299   <a class="code" href="classQgsPalLayerSettings.html#499be91338f5ee41c56f4a88e7247450">addDirectionSymbol</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/addDirectionSymbol"</span> ).toBool();
<a name="l00300"></a>00300   <a class="code" href="classQgsPalLayerSettings.html#880fbddafb425e4ad77aceeaabd868b5">minFeatureSize</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/minFeatureSize"</span> ).toDouble();
<a name="l00301"></a>00301   <a class="code" href="classQgsPalLayerSettings.html#4eb2fc5cc0a37e83669249bccdb43e23">fontSizeInMapUnits</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/fontSizeInMapUnits"</span> ).toBool();
<a name="l00302"></a>00302   <a class="code" href="classQgsPalLayerSettings.html#45969f9c95bd9fd7538ca67fc8f4f55c">distInMapUnits</a> = layer-&gt;<a class="code" href="classQgsMapLayer.html#59b2217774569df58e7c453ca0212561" title="Read a custom property from layer.">customProperty</a>( <span class="stringliteral">"labeling/distInMapUnits"</span> ).toBool();
<a name="l00303"></a>00303   <a class="code" href="qgspallabeling_8cpp.html#cbbde136c1b7a60a735f62f0ff8bda2c">_readDataDefinedPropertyMap</a>( layer, <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a> );
<a name="l00304"></a>00304 }
<a name="l00305"></a>00305 
<a name="l00306"></a><a class="code" href="classQgsPalLayerSettings.html#21fea2a2718408defe1d946d4481f319">00306</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLayerSettings.html#21fea2a2718408defe1d946d4481f319">QgsPalLayerSettings::writeToLayer</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* layer )
<a name="l00307"></a>00307 {
<a name="l00308"></a>00308   <span class="comment">// this is a mark that labeling information is present</span>
<a name="l00309"></a>00309   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling"</span>, <span class="stringliteral">"pal"</span> );
<a name="l00310"></a>00310 
<a name="l00311"></a>00311   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/fieldName"</span>, <a class="code" href="classQgsPalLayerSettings.html#c57b3ecf3c052e33c947ed8713e4b48c">fieldName</a> );
<a name="l00312"></a>00312   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/placement"</span>, <a class="code" href="classQgsPalLayerSettings.html#de0e96125f5d912953b168a736d2e09b">placement</a> );
<a name="l00313"></a>00313   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/placementFlags"</span>, ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> )<a class="code" href="classQgsPalLayerSettings.html#beb4d081fd4eb7debb30dfcdd5be8d58">placementFlags</a> );
<a name="l00314"></a>00314 
<a name="l00315"></a>00315   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/fontFamily"</span>, <a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a>.family() );
<a name="l00316"></a>00316   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/fontSize"</span>, <a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a>.pointSizeF() );
<a name="l00317"></a>00317   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/fontWeight"</span>, <a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a>.weight() );
<a name="l00318"></a>00318   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/fontItalic"</span>, <a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a>.italic() );
<a name="l00319"></a>00319   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/fontStrikeout"</span>, <a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a>.strikeOut() );
<a name="l00320"></a>00320   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/fontUnderline"</span>, <a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a>.underline() );
<a name="l00321"></a>00321 
<a name="l00322"></a>00322   <a class="code" href="qgspallabeling_8cpp.html#32ca127b479b68e6035b346c6538e605">_writeColor</a>( layer, <span class="stringliteral">"labeling/textColor"</span>, <a class="code" href="classQgsPalLayerSettings.html#cbe45b8cb06f3d0b8f51c18919a744ba">textColor</a> );
<a name="l00323"></a>00323   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/enabled"</span>, <a class="code" href="classQgsPalLayerSettings.html#487efd2ca58be0c974cc2e29024cfbbb">enabled</a> );
<a name="l00324"></a>00324   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/priority"</span>, <a class="code" href="classQgsPalLayerSettings.html#67fba9e271265dddf0e9bb3a28c9e7de">priority</a> );
<a name="l00325"></a>00325   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/obstacle"</span>, <a class="code" href="classQgsPalLayerSettings.html#10af33e55f923e6ddf3c20f1e51fbb29">obstacle</a> );
<a name="l00326"></a>00326   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/dist"</span>, <a class="code" href="classQgsPalLayerSettings.html#b0c2d6ce60da3873726f544c7d9ea47a">dist</a> );
<a name="l00327"></a>00327   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/scaleMin"</span>, <a class="code" href="classQgsPalLayerSettings.html#90286fb2699deb8f4032ac91b6318785">scaleMin</a> );
<a name="l00328"></a>00328   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/scaleMax"</span>, <a class="code" href="classQgsPalLayerSettings.html#f2ec6e89aca16eebe643118b6be661aa">scaleMax</a> );
<a name="l00329"></a>00329   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/bufferSize"</span>, <a class="code" href="classQgsPalLayerSettings.html#fbf1adda85087c82e05ba14547774e37">bufferSize</a> );
<a name="l00330"></a>00330   <a class="code" href="qgspallabeling_8cpp.html#32ca127b479b68e6035b346c6538e605">_writeColor</a>( layer, <span class="stringliteral">"labeling/bufferColor"</span>, <a class="code" href="classQgsPalLayerSettings.html#0aa38422710279da59e44539b064cbed">bufferColor</a> );
<a name="l00331"></a>00331   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/labelPerPart"</span>, <a class="code" href="classQgsPalLayerSettings.html#6bda8893aa13604885edd2be1d1301c9">labelPerPart</a> );
<a name="l00332"></a>00332   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/mergeLines"</span>, <a class="code" href="classQgsPalLayerSettings.html#ecb8058601826a08976c9f3fbfe5d4ab">mergeLines</a> );
<a name="l00333"></a>00333   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/multiLineLabels"</span>, <a class="code" href="classQgsPalLayerSettings.html#477a4aa6642a5e47c6f3c3332b1ef6e5">multiLineLabels</a> );
<a name="l00334"></a>00334   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/addDirectionSymbol"</span>, <a class="code" href="classQgsPalLayerSettings.html#499be91338f5ee41c56f4a88e7247450">addDirectionSymbol</a> );
<a name="l00335"></a>00335   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/minFeatureSize"</span>, <a class="code" href="classQgsPalLayerSettings.html#880fbddafb425e4ad77aceeaabd868b5">minFeatureSize</a> );
<a name="l00336"></a>00336   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/fontSizeInMapUnits"</span>, <a class="code" href="classQgsPalLayerSettings.html#4eb2fc5cc0a37e83669249bccdb43e23">fontSizeInMapUnits</a> );
<a name="l00337"></a>00337   layer-&gt;<a class="code" href="classQgsMapLayer.html#7bf94cfa08abc37b75cc53dc921bb15e" title="Set a custom property for layer.">setCustomProperty</a>( <span class="stringliteral">"labeling/distInMapUnits"</span>, <a class="code" href="classQgsPalLayerSettings.html#45969f9c95bd9fd7538ca67fc8f4f55c">distInMapUnits</a> );
<a name="l00338"></a>00338   <a class="code" href="qgspallabeling_8cpp.html#0b71e0c1c9e6c5dbfdb54415beb9a6e8">_writeDataDefinedPropertyMap</a>( layer, <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a> );
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 
<a name="l00341"></a><a class="code" href="classQgsPalLayerSettings.html#26f12ee6ba2b7766d39ae3ed3f19e5d0">00341</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLayerSettings.html#26f12ee6ba2b7766d39ae3ed3f19e5d0" title="Set a property as data defined.">QgsPalLayerSettings::setDataDefinedProperty</a>( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea">DataDefinedProperties</a> p, <span class="keywordtype">int</span> attributeIndex )
<a name="l00342"></a>00342 {
<a name="l00343"></a>00343   <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.insert( p, attributeIndex );
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00346"></a><a class="code" href="classQgsPalLayerSettings.html#a7263639f1237b4da9e72d5082a55ee5">00346</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLayerSettings.html#a7263639f1237b4da9e72d5082a55ee5" title="Set a property to static instead data defined.">QgsPalLayerSettings::removeDataDefinedProperty</a>( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea">DataDefinedProperties</a> p )
<a name="l00347"></a>00347 {
<a name="l00348"></a>00348   <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.remove( p );
<a name="l00349"></a>00349 }
<a name="l00350"></a>00350 
<a name="l00351"></a><a class="code" href="classQgsPalLayerSettings.html#ba55926e8834010bb309ac8bc394a862">00351</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsPalLayerSettings.html#ba55926e8834010bb309ac8bc394a862" title="Checks if a feature is larger than a minimum size (in mm).">QgsPalLayerSettings::checkMinimumSizeMM</a>( <span class="keyword">const</span> <a class="code" href="classQgsRenderContext.html" title="Contains information about the context of a rendering operation.">QgsRenderContext</a>&amp; <a class="code" href="classQgsPalLayerSettings.html#81f31b83854f9876ad05174ce4bab1da">ct</a>, <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* geom, <span class="keywordtype">double</span> minSize )<span class="keyword"> const</span>
<a name="l00352"></a>00352 <span class="keyword"></span>{
<a name="l00353"></a>00353   <span class="keywordflow">if</span> ( minSize &lt;= 0 )
<a name="l00354"></a>00354   {
<a name="l00355"></a>00355     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00356"></a>00356   }
<a name="l00357"></a>00357 
<a name="l00358"></a>00358   <span class="keywordflow">if</span> ( !geom )
<a name="l00359"></a>00359   {
<a name="l00360"></a>00360     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00361"></a>00361   }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363   <a class="code" href="classQGis.html#09947eb19394302eeeed44d3e81dd74b">QGis::GeometryType</a> featureType = geom-&gt;<a class="code" href="classQgsGeometry.html#d57348e8a59d162a8a24226aa319d7f6" title="Returns type of the vector.">type</a>();
<a name="l00364"></a>00364   <span class="keywordflow">if</span> ( featureType == <a class="code" href="classQGis.html#09947eb19394302eeeed44d3e81dd74b2c6376a16e5f3dc830ffd0a72597c276">QGis::Point</a> ) <span class="comment">//minimum size does not apply to point features</span>
<a name="l00365"></a>00365   {
<a name="l00366"></a>00366     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00367"></a>00367   }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369   <span class="keywordtype">double</span> mapUnitsPerMM = ct.<a class="code" href="classQgsRenderContext.html#be5b3cb445070d6f5343132d6c347e65">mapToPixel</a>().<a class="code" href="classQgsMapToPixel.html#d8c374aa5e47057d4c2f45a5ced78bd0" title="Return current map units per pixel.">mapUnitsPerPixel</a>() * ct.<a class="code" href="classQgsRenderContext.html#f4b93052d1a48544b5cd7103a7596acb">scaleFactor</a>();
<a name="l00370"></a>00370   <span class="keywordflow">if</span> ( featureType == <a class="code" href="classQGis.html#09947eb19394302eeeed44d3e81dd74b84e19f581d8cf4e8855821b21bff0714">QGis::Line</a> )
<a name="l00371"></a>00371   {
<a name="l00372"></a>00372     <span class="keywordtype">double</span> length = geom-&gt;<a class="code" href="classQgsGeometry.html#a5089d1d951bc1f1e27146e3ae536930" title="get length of geometry using GEOS">length</a>();
<a name="l00373"></a>00373     <span class="keywordflow">if</span> ( length &gt;= 0.0 )
<a name="l00374"></a>00374     {
<a name="l00375"></a>00375       <span class="keywordflow">return</span> ( length &gt;= ( minSize * mapUnitsPerMM ) );
<a name="l00376"></a>00376     }
<a name="l00377"></a>00377   }
<a name="l00378"></a>00378   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( featureType == <a class="code" href="classQGis.html#09947eb19394302eeeed44d3e81dd74bb4c5ba16ad4d29832d3abbc6398d195b">QGis::Polygon</a> )
<a name="l00379"></a>00379   {
<a name="l00380"></a>00380     <span class="keywordtype">double</span> area = geom-&gt;<a class="code" href="classQgsGeometry.html#dea877bef54351df8ac96a3f36eefa43" title="get area of geometry using GEOS">area</a>();
<a name="l00381"></a>00381     <span class="keywordflow">if</span> ( area &gt;= 0.0 )
<a name="l00382"></a>00382     {
<a name="l00383"></a>00383       <span class="keywordflow">return</span> ( sqrt( area ) &gt;= ( minSize * mapUnitsPerMM ) );
<a name="l00384"></a>00384     }
<a name="l00385"></a>00385   }
<a name="l00386"></a>00386   <span class="keywordflow">return</span> <span class="keyword">true</span>; <span class="comment">//should never be reached. Return true in this case to label such geometries anyway.</span>
<a name="l00387"></a>00387 }
<a name="l00388"></a>00388 
<a name="l00389"></a><a class="code" href="classQgsPalLayerSettings.html#7fb9f0ac2789188d413d338c56886a40">00389</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLayerSettings.html#7fb9f0ac2789188d413d338c56886a40">QgsPalLayerSettings::calculateLabelSize</a>( <span class="keyword">const</span> QFontMetricsF* fm, QString text, <span class="keywordtype">double</span>&amp; labelX, <span class="keywordtype">double</span>&amp; labelY )
<a name="l00390"></a>00390 {
<a name="l00391"></a>00391   <span class="keywordflow">if</span> ( !fm )
<a name="l00392"></a>00392   {
<a name="l00393"></a>00393     <span class="keywordflow">return</span>;
<a name="l00394"></a>00394   }
<a name="l00395"></a>00395 
<a name="l00396"></a>00396   <span class="keywordflow">if</span> ( <a class="code" href="classQgsPalLayerSettings.html#499be91338f5ee41c56f4a88e7247450">addDirectionSymbol</a> &amp;&amp; !<a class="code" href="classQgsPalLayerSettings.html#477a4aa6642a5e47c6f3c3332b1ef6e5">multiLineLabels</a> &amp;&amp; <a class="code" href="classQgsPalLayerSettings.html#de0e96125f5d912953b168a736d2e09b">placement</a> == <a class="code" href="classQgsPalLayerSettings.html#5d449d8e9cb89e5d453c6e33fe1c66cc4f3d6d88545bf3e32ed488e4a082f471">QgsPalLayerSettings::Line</a> ) <span class="comment">//consider the space needed for the direction symbol</span>
<a name="l00397"></a>00397   {
<a name="l00398"></a>00398     text.append( <span class="stringliteral">"&gt;"</span> );
<a name="l00399"></a>00399   }
<a name="l00400"></a>00400   QRectF labelRect = fm-&gt;boundingRect( text );
<a name="l00401"></a>00401   <span class="keywordtype">double</span> w, h;
<a name="l00402"></a>00402   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsPalLayerSettings.html#477a4aa6642a5e47c6f3c3332b1ef6e5">multiLineLabels</a> )
<a name="l00403"></a>00403   {
<a name="l00404"></a>00404     w = labelRect.width() / <a class="code" href="classQgsPalLayerSettings.html#31d35efbd75cb3c342b98300cc1693cf">rasterCompressFactor</a>;
<a name="l00405"></a>00405     h = labelRect.height() / <a class="code" href="classQgsPalLayerSettings.html#31d35efbd75cb3c342b98300cc1693cf">rasterCompressFactor</a>;
<a name="l00406"></a>00406   }
<a name="l00407"></a>00407   <span class="keywordflow">else</span>
<a name="l00408"></a>00408   {
<a name="l00409"></a>00409     QStringList multiLineSplit = text.split( <span class="stringliteral">"\n"</span> );
<a name="l00410"></a>00410     h = fm-&gt;height() * multiLineSplit.size() / <a class="code" href="classQgsPalLayerSettings.html#31d35efbd75cb3c342b98300cc1693cf">rasterCompressFactor</a>;
<a name="l00411"></a>00411     w = 0;
<a name="l00412"></a>00412     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; multiLineSplit.size(); ++i )
<a name="l00413"></a>00413     {
<a name="l00414"></a>00414       <span class="keywordtype">double</span> width = fm-&gt;width( multiLineSplit.at( i ) );
<a name="l00415"></a>00415       <span class="keywordflow">if</span> ( width &gt; w )
<a name="l00416"></a>00416       {
<a name="l00417"></a>00417         w = width;
<a name="l00418"></a>00418       }
<a name="l00419"></a>00419       w /= <a class="code" href="classQgsPalLayerSettings.html#31d35efbd75cb3c342b98300cc1693cf">rasterCompressFactor</a>;
<a name="l00420"></a>00420     }
<a name="l00421"></a>00421   }
<a name="l00422"></a>00422   <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> ptSize = <a class="code" href="classQgsPalLayerSettings.html#1653b66f7fa353bf9fe9ac39a6f4e028">xform</a>-&gt;<a class="code" href="classQgsMapToPixel.html#b2f5b73b051c085da22882bbef144c05">toMapCoordinatesF</a>( w, h );
<a name="l00423"></a>00423 
<a name="l00424"></a>00424   labelX = qAbs( ptSize.<a class="code" href="classQgsPoint.html#14cf4897a06313074760383398ee95d5">x</a>() - <a class="code" href="classQgsPalLayerSettings.html#7ea465a9e14ac5e2b3939db9c6f27753">ptZero</a>.<a class="code" href="classQgsPoint.html#14cf4897a06313074760383398ee95d5">x</a>() );
<a name="l00425"></a>00425   labelY = qAbs( ptSize.<a class="code" href="classQgsPoint.html#07bd042b697bab243f4be31358d943ad">y</a>() - <a class="code" href="classQgsPalLayerSettings.html#7ea465a9e14ac5e2b3939db9c6f27753">ptZero</a>.<a class="code" href="classQgsPoint.html#07bd042b697bab243f4be31358d943ad">y</a>() );
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a><a class="code" href="classQgsPalLayerSettings.html#c926f9172dd4620ab5a984f9cb96d19d">00428</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLayerSettings.html#c926f9172dd4620ab5a984f9cb96d19d">QgsPalLayerSettings::registerFeature</a>( <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a...">QgsFeature</a>&amp; f, <span class="keyword">const</span> <a class="code" href="classQgsRenderContext.html" title="Contains information about the context of a rendering operation.">QgsRenderContext</a>&amp; context )
<a name="l00429"></a>00429 {
<a name="l00430"></a>00430   QString labelText = f.<a class="code" href="classQgsFeature.html#d80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>()[<a class="code" href="classQgsPalLayerSettings.html#a2c4b1fb3329602ec2b832a001f5ac38">fieldIndex</a>].toString();
<a name="l00431"></a>00431   <span class="keywordtype">double</span> labelX, labelY; <span class="comment">// will receive label size</span>
<a name="l00432"></a>00432   QFont labelFont = <a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a>;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434   <span class="comment">//data defined label size?</span>
<a name="l00435"></a>00435   QMap&lt; DataDefinedProperties, int &gt;::const_iterator it = <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.find( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea7f337404d9060060478e5205de3e84ec">QgsPalLayerSettings::Size</a> );
<a name="l00436"></a>00436   <span class="keywordflow">if</span> ( it != <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.constEnd() )
<a name="l00437"></a>00437   {
<a name="l00438"></a>00438     <span class="comment">//find out size</span>
<a name="l00439"></a>00439     QVariant size = f.<a class="code" href="classQgsFeature.html#d80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>().value( *it );
<a name="l00440"></a>00440     <span class="keywordflow">if</span> ( size.isValid() )
<a name="l00441"></a>00441     {
<a name="l00442"></a>00442       <span class="keywordtype">double</span> sizeDouble = size.toDouble();
<a name="l00443"></a>00443       <span class="keywordflow">if</span> ( sizeDouble &lt;= 0 )
<a name="l00444"></a>00444       {
<a name="l00445"></a>00445         <span class="keywordflow">return</span>;
<a name="l00446"></a>00446       }
<a name="l00447"></a>00447       labelFont.setPixelSize( <a class="code" href="classQgsPalLayerSettings.html#46f2828a8fa0762d880fd864fc26deea" title="Calculates pixel size (considering output size should be in pixel or map units, scale...">sizeToPixel</a>( sizeDouble, context ) );
<a name="l00448"></a>00448     }
<a name="l00449"></a>00449     QFontMetricsF labelFontMetrics( labelFont );
<a name="l00450"></a>00450     <a class="code" href="classQgsPalLayerSettings.html#7fb9f0ac2789188d413d338c56886a40">calculateLabelSize</a>( &amp;labelFontMetrics, labelText, labelX, labelY );
<a name="l00451"></a>00451   }
<a name="l00452"></a>00452   <span class="keywordflow">else</span>
<a name="l00453"></a>00453   {
<a name="l00454"></a>00454     <a class="code" href="classQgsPalLayerSettings.html#7fb9f0ac2789188d413d338c56886a40">calculateLabelSize</a>( <a class="code" href="classQgsPalLayerSettings.html#085fcc0331f3f3ca085826a55f41f463">fontMetrics</a>, labelText, labelX, labelY );
<a name="l00455"></a>00455   }
<a name="l00456"></a>00456 
<a name="l00457"></a>00457   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* geom = f.<a class="code" href="classQgsFeature.html#b0a934a1b173ce5ad8d13363c20ef3c8" title="Get the geometry object associated with this feature.">geometry</a>();
<a name="l00458"></a>00458 
<a name="l00459"></a>00459   <span class="keywordflow">if</span> ( <a class="code" href="classQgsPalLayerSettings.html#81f31b83854f9876ad05174ce4bab1da">ct</a> ) <span class="comment">// reproject the geometry if necessary</span>
<a name="l00460"></a>00460     geom-&gt;<a class="code" href="classQgsGeometry.html#46fd84e518cae4368aadeeac89574dfa" title="Transform this geometry as described by CoordinateTranasform ct.">transform</a>( *<a class="code" href="classQgsPalLayerSettings.html#81f31b83854f9876ad05174ce4bab1da">ct</a> );
<a name="l00461"></a>00461 
<a name="l00462"></a>00462   GEOSGeometry* geos_geom = geom-&gt;<a class="code" href="classQgsGeometry.html#ca7621fa485ec9c0cf5803968e8cb659" title="Returns a geos geomtry.">asGeos</a>();
<a name="l00463"></a>00463   <span class="keywordflow">if</span> ( geos_geom == NULL )
<a name="l00464"></a>00464     <span class="keywordflow">return</span>; <span class="comment">// invalid geometry</span>
<a name="l00465"></a>00465 
<a name="l00466"></a>00466   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsPalLayerSettings.html#ba55926e8834010bb309ac8bc394a862" title="Checks if a feature is larger than a minimum size (in mm).">checkMinimumSizeMM</a>( context, geom, <a class="code" href="classQgsPalLayerSettings.html#880fbddafb425e4ad77aceeaabd868b5">minFeatureSize</a> ) )
<a name="l00467"></a>00467   {
<a name="l00468"></a>00468     <span class="keywordflow">return</span>;
<a name="l00469"></a>00469   }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471   <span class="comment">//data defined position / alignment / rotation?</span>
<a name="l00472"></a>00472   <span class="keywordtype">bool</span> dataDefinedPosition = <span class="keyword">false</span>;
<a name="l00473"></a>00473   <span class="keywordtype">bool</span> dataDefinedRotation = <span class="keyword">false</span>;
<a name="l00474"></a>00474   <span class="keywordtype">double</span> xPos = 0.0, yPos = 0.0, <a class="code" href="namespaceMathUtils.html#d8c3e8d699ab12a55e6883baa6b65c6b" title="Calculates the angle between two segments (in 2 dimension, z-values are ignored)...">angle</a> = 0.0;
<a name="l00475"></a>00475   <span class="keywordtype">bool</span> ddXPos, ddYPos;
<a name="l00476"></a>00476 
<a name="l00477"></a>00477   QMap&lt; DataDefinedProperties, int &gt;::const_iterator dPosXIt = <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.find( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea28e1e8cdf1179aace5f18d58e87053d3">QgsPalLayerSettings::PositionX</a> );
<a name="l00478"></a>00478   <span class="keywordflow">if</span> ( dPosXIt != <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.constEnd() )
<a name="l00479"></a>00479   {
<a name="l00480"></a>00480     QMap&lt; DataDefinedProperties, int &gt;::const_iterator dPosYIt = <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.find( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea1259502d5cc3dd3c06d4f93a74cb8d93">QgsPalLayerSettings::PositionY</a> );
<a name="l00481"></a>00481     <span class="keywordflow">if</span> ( dPosYIt != <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.constEnd() )
<a name="l00482"></a>00482     {
<a name="l00483"></a>00483       <span class="comment">//data defined position. But field values could be NULL -&gt; positions will be generated by PAL</span>
<a name="l00484"></a>00484       xPos = f.<a class="code" href="classQgsFeature.html#d80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>().value( *dPosXIt ).toDouble( &amp;ddXPos );
<a name="l00485"></a>00485       yPos = f.<a class="code" href="classQgsFeature.html#d80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>().value( *dPosYIt ).toDouble( &amp;ddYPos );
<a name="l00486"></a>00486 
<a name="l00487"></a>00487       <span class="keywordflow">if</span> ( ddXPos &amp;&amp; ddYPos )
<a name="l00488"></a>00488       {
<a name="l00489"></a>00489         dataDefinedPosition = <span class="keyword">true</span>;
<a name="l00490"></a>00490         <span class="comment">//x/y shift in case of alignment</span>
<a name="l00491"></a>00491         <span class="keywordtype">double</span> xdiff = 0;
<a name="l00492"></a>00492         <span class="keywordtype">double</span> ydiff = 0;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494         <span class="comment">//horizontal alignment</span>
<a name="l00495"></a>00495         QMap&lt; DataDefinedProperties, int &gt;::const_iterator haliIt = <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.find( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea3ad1ca33ed0d27133f4dea2c6b8a47cd">QgsPalLayerSettings::Hali</a> );
<a name="l00496"></a>00496         <span class="keywordflow">if</span> ( haliIt != <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.end() )
<a name="l00497"></a>00497         {
<a name="l00498"></a>00498           QString haliString = f.<a class="code" href="classQgsFeature.html#d80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>().value( *haliIt ).toString();
<a name="l00499"></a>00499           <span class="keywordflow">if</span> ( haliString.compare( <span class="stringliteral">"Center"</span>, Qt::CaseInsensitive ) == 0 )
<a name="l00500"></a>00500           {
<a name="l00501"></a>00501             xdiff -= labelX / 2.0;
<a name="l00502"></a>00502           }
<a name="l00503"></a>00503           <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( haliString.compare( <span class="stringliteral">"Right"</span>, Qt::CaseInsensitive ) == 0 )
<a name="l00504"></a>00504           {
<a name="l00505"></a>00505             xdiff -= labelX;
<a name="l00506"></a>00506           }
<a name="l00507"></a>00507         }
<a name="l00508"></a>00508 
<a name="l00509"></a>00509         <span class="comment">//vertical alignment</span>
<a name="l00510"></a>00510         QMap&lt; DataDefinedProperties, int &gt;::const_iterator valiIt = <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.find( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3ceafc00c9b621833b0c92ac3cd03611a842">QgsPalLayerSettings::Vali</a> );
<a name="l00511"></a>00511         <span class="keywordflow">if</span> ( valiIt != <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.constEnd() )
<a name="l00512"></a>00512         {
<a name="l00513"></a>00513           QString valiString = f.<a class="code" href="classQgsFeature.html#d80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>().value( *valiIt ).toString();
<a name="l00514"></a>00514           <span class="keywordflow">if</span> ( valiString.compare( <span class="stringliteral">"Bottom"</span>, Qt::CaseInsensitive ) != 0 )
<a name="l00515"></a>00515           {
<a name="l00516"></a>00516             <span class="keywordflow">if</span> ( valiString.compare( <span class="stringliteral">"Top"</span>, Qt::CaseInsensitive ) == 0 || valiString.compare( <span class="stringliteral">"Cap"</span>, Qt::CaseInsensitive ) == 0 )
<a name="l00517"></a>00517             {
<a name="l00518"></a>00518               ydiff -= labelY;
<a name="l00519"></a>00519             }
<a name="l00520"></a>00520             <span class="keywordflow">else</span>
<a name="l00521"></a>00521             {
<a name="l00522"></a>00522               QFontMetrics labelFontMetrics( labelFont );
<a name="l00523"></a>00523               <span class="keywordtype">double</span> descentRatio = labelFontMetrics.descent() / labelFontMetrics.height();
<a name="l00524"></a>00524 
<a name="l00525"></a>00525               <span class="keywordflow">if</span> ( valiString.compare( <span class="stringliteral">"Base"</span>, Qt::CaseInsensitive ) == 0 )
<a name="l00526"></a>00526               {
<a name="l00527"></a>00527                 ydiff -= labelY * descentRatio;
<a name="l00528"></a>00528               }
<a name="l00529"></a>00529               <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( valiString.compare( <span class="stringliteral">"Half"</span>, Qt::CaseInsensitive ) == 0 )
<a name="l00530"></a>00530               {
<a name="l00531"></a>00531                 ydiff -= labelY * descentRatio;
<a name="l00532"></a>00532                 ydiff -= labelY * 0.5 * ( 1 - descentRatio );
<a name="l00533"></a>00533               }
<a name="l00534"></a>00534             }
<a name="l00535"></a>00535           }
<a name="l00536"></a>00536         }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538         <span class="comment">//data defined rotation?</span>
<a name="l00539"></a>00539         QMap&lt; DataDefinedProperties, int &gt;::const_iterator rotIt = <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.find( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea7ff14268884a4277a34606b3ec256f6e">QgsPalLayerSettings::Rotation</a> );
<a name="l00540"></a>00540         <span class="keywordflow">if</span> ( rotIt != <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.constEnd() )
<a name="l00541"></a>00541         {
<a name="l00542"></a>00542           dataDefinedRotation = <span class="keyword">true</span>;
<a name="l00543"></a>00543           <a class="code" href="namespaceMathUtils.html#d8c3e8d699ab12a55e6883baa6b65c6b" title="Calculates the angle between two segments (in 2 dimension, z-values are ignored)...">angle</a> = f.<a class="code" href="classQgsFeature.html#d80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>().value( *rotIt ).toDouble() * <a class="code" href="qgsdistancearea_8cpp.html#e71449b1cc6e6250b91f539153a7a0d3">M_PI</a> / 180;
<a name="l00544"></a>00544           <span class="comment">//adjust xdiff and ydiff because the hali/vali point needs to be the rotation center</span>
<a name="l00545"></a>00545           <span class="keywordtype">double</span> xd = xdiff * cos( <a class="code" href="namespaceMathUtils.html#d8c3e8d699ab12a55e6883baa6b65c6b" title="Calculates the angle between two segments (in 2 dimension, z-values are ignored)...">angle</a> ) - ydiff * sin( <a class="code" href="namespaceMathUtils.html#d8c3e8d699ab12a55e6883baa6b65c6b" title="Calculates the angle between two segments (in 2 dimension, z-values are ignored)...">angle</a> );
<a name="l00546"></a>00546           <span class="keywordtype">double</span> yd = xdiff * sin( <a class="code" href="namespaceMathUtils.html#d8c3e8d699ab12a55e6883baa6b65c6b" title="Calculates the angle between two segments (in 2 dimension, z-values are ignored)...">angle</a> ) + ydiff * cos( <a class="code" href="namespaceMathUtils.html#d8c3e8d699ab12a55e6883baa6b65c6b" title="Calculates the angle between two segments (in 2 dimension, z-values are ignored)...">angle</a> );
<a name="l00547"></a>00547           xdiff = xd;
<a name="l00548"></a>00548           ydiff = yd;
<a name="l00549"></a>00549         }
<a name="l00550"></a>00550 
<a name="l00551"></a>00551         <span class="comment">//project xPos and yPos from layer to map CRS</span>
<a name="l00552"></a>00552         <span class="keywordtype">double</span> z = 0;
<a name="l00553"></a>00553         <span class="keywordflow">if</span> ( <a class="code" href="classQgsPalLayerSettings.html#81f31b83854f9876ad05174ce4bab1da">ct</a> )
<a name="l00554"></a>00554         {
<a name="l00555"></a>00555           <a class="code" href="classQgsPalLayerSettings.html#81f31b83854f9876ad05174ce4bab1da">ct</a>-&gt;<a class="code" href="classQgsCoordinateTransform.html#6b3601d4afae2e004e4bec38339d4102">transformInPlace</a>( xPos, yPos, z );
<a name="l00556"></a>00556         }
<a name="l00557"></a>00557 
<a name="l00558"></a>00558         yPos += ydiff;
<a name="l00559"></a>00559         xPos += xdiff;
<a name="l00560"></a>00560 
<a name="l00561"></a>00561       }
<a name="l00562"></a>00562     }
<a name="l00563"></a>00563   }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565   <a class="code" href="classQgsPalGeometry.html">QgsPalGeometry</a>* lbl = <span class="keyword">new</span> <a class="code" href="classQgsPalGeometry.html">QgsPalGeometry</a>( f.<a class="code" href="classQgsFeature.html#d4ae834f0941bf2578fe8a019f192668" title="Get the feature id for this feature.">id</a>(), labelText, GEOSGeom_clone( geos_geom ) );
<a name="l00566"></a>00566 
<a name="l00567"></a>00567   <span class="comment">// record the created geometry - it will be deleted at the end.</span>
<a name="l00568"></a>00568   <a class="code" href="classQgsPalLayerSettings.html#2cacdf8357f4cce05062ac73506f16ea">geometries</a>.append( lbl );
<a name="l00569"></a>00569 
<a name="l00570"></a>00570   <span class="comment">// register feature to the layer</span>
<a name="l00571"></a>00571   <span class="keywordflow">try</span>
<a name="l00572"></a>00572   {
<a name="l00573"></a>00573     <span class="keywordflow">if</span> ( !<a class="code" href="classQgsPalLayerSettings.html#4b54996e3299b9ecb5f775c2165b0ba4">palLayer</a>-&gt;registerFeature( lbl-&gt;<a class="code" href="classQgsPalGeometry.html#a051906c05c755d1fdc070174eb4dc73">strId</a>(), lbl, labelX, labelY, labelText.toUtf8().constData(),
<a name="l00574"></a>00574                                      xPos, yPos, dataDefinedPosition, <a class="code" href="namespaceMathUtils.html#d8c3e8d699ab12a55e6883baa6b65c6b" title="Calculates the angle between two segments (in 2 dimension, z-values are ignored)...">angle</a>, dataDefinedRotation ) )
<a name="l00575"></a>00575       <span class="keywordflow">return</span>;
<a name="l00576"></a>00576   }
<a name="l00577"></a>00577   <span class="keywordflow">catch</span> ( std::exception* e )
<a name="l00578"></a>00578   {
<a name="l00579"></a>00579     <a class="code" href="qgslogger_8h.html#b273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">"Ignoring feature %1 due PAL exception: "</span> ).arg( f.<a class="code" href="classQgsFeature.html#d4ae834f0941bf2578fe8a019f192668" title="Get the feature id for this feature.">id</a>() ) + QString::fromLatin1( e-&gt;what() ) );
<a name="l00580"></a>00580     <span class="keywordflow">return</span>;
<a name="l00581"></a>00581   }
<a name="l00582"></a>00582 
<a name="l00583"></a>00583   <span class="comment">// TODO: only for placement which needs character info</span>
<a name="l00584"></a>00584   pal::Feature* feat = <a class="code" href="classQgsPalLayerSettings.html#4b54996e3299b9ecb5f775c2165b0ba4">palLayer</a>-&gt;getFeature( lbl-&gt;<a class="code" href="classQgsPalGeometry.html#a051906c05c755d1fdc070174eb4dc73">strId</a>() );
<a name="l00585"></a>00585   feat-&gt;setLabelInfo( lbl-&gt;<a class="code" href="classQgsPalGeometry.html#a64c1f9a5be2f8b45b8e875dc32cac63">info</a>( <a class="code" href="classQgsPalLayerSettings.html#085fcc0331f3f3ca085826a55f41f463">fontMetrics</a>, <a class="code" href="classQgsPalLayerSettings.html#1653b66f7fa353bf9fe9ac39a6f4e028">xform</a>, <a class="code" href="classQgsPalLayerSettings.html#31d35efbd75cb3c342b98300cc1693cf">rasterCompressFactor</a> ) );
<a name="l00586"></a>00586 
<a name="l00587"></a>00587   <span class="comment">// TODO: allow layer-wide feature dist in PAL...?</span>
<a name="l00588"></a>00588 
<a name="l00589"></a>00589   <span class="comment">//data defined label-feature distance?</span>
<a name="l00590"></a>00590   <span class="keywordtype">double</span> distance = <a class="code" href="classQgsPalLayerSettings.html#b0c2d6ce60da3873726f544c7d9ea47a">dist</a>;
<a name="l00591"></a>00591   QMap&lt; DataDefinedProperties, int &gt;::const_iterator dDistIt = <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.find( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea31ec0cb0aecca4a9ebba1f823584cb8e">QgsPalLayerSettings::LabelDistance</a> );
<a name="l00592"></a>00592   <span class="keywordflow">if</span> ( dDistIt != <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.constEnd() )
<a name="l00593"></a>00593   {
<a name="l00594"></a>00594     distance = f.<a class="code" href="classQgsFeature.html#d80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>().value( *dDistIt ).toDouble();
<a name="l00595"></a>00595   }
<a name="l00596"></a>00596 
<a name="l00597"></a>00597   <span class="keywordflow">if</span> ( distance != 0 )
<a name="l00598"></a>00598   {
<a name="l00599"></a>00599     <span class="keywordflow">if</span> ( <a class="code" href="classQgsPalLayerSettings.html#45969f9c95bd9fd7538ca67fc8f4f55c">distInMapUnits</a> ) <span class="comment">//convert distance from mm/map units to pixels</span>
<a name="l00600"></a>00600     {
<a name="l00601"></a>00601       distance /= context.<a class="code" href="classQgsRenderContext.html#be5b3cb445070d6f5343132d6c347e65">mapToPixel</a>().<a class="code" href="classQgsMapToPixel.html#d8c374aa5e47057d4c2f45a5ced78bd0" title="Return current map units per pixel.">mapUnitsPerPixel</a>();
<a name="l00602"></a>00602     }
<a name="l00603"></a>00603     <span class="keywordflow">else</span> <span class="comment">//mm</span>
<a name="l00604"></a>00604     {
<a name="l00605"></a>00605       distance *= <a class="code" href="classQgsPalLayerSettings.html#451e4e4bb95a04422ec5b3f583113297">vectorScaleFactor</a>;
<a name="l00606"></a>00606     }
<a name="l00607"></a>00607     feat-&gt;setDistLabel( qAbs( <a class="code" href="classQgsPalLayerSettings.html#ad85de00fb4eb24da730b950c0da99ac">ptOne</a>.<a class="code" href="classQgsPoint.html#14cf4897a06313074760383398ee95d5">x</a>() - <a class="code" href="classQgsPalLayerSettings.html#7ea465a9e14ac5e2b3939db9c6f27753">ptZero</a>.<a class="code" href="classQgsPoint.html#14cf4897a06313074760383398ee95d5">x</a>() )* distance );
<a name="l00608"></a>00608   }
<a name="l00609"></a>00609 
<a name="l00610"></a>00610   <span class="comment">//add parameters for data defined labeling to QgsPalGeometry</span>
<a name="l00611"></a>00611   QMap&lt; DataDefinedProperties, int &gt;::const_iterator dIt = <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.constBegin();
<a name="l00612"></a>00612   <span class="keywordflow">for</span> ( ; dIt != <a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.constEnd(); ++dIt )
<a name="l00613"></a>00613   {
<a name="l00614"></a>00614     lbl-&gt;<a class="code" href="classQgsPalGeometry.html#be7a5ada06b6aaa3d466072582188cca">addDataDefinedValue</a>( dIt.key(), f.<a class="code" href="classQgsFeature.html#d80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>()[dIt.value()] );
<a name="l00615"></a>00615   }
<a name="l00616"></a>00616 }
<a name="l00617"></a>00617 
<a name="l00618"></a><a class="code" href="classQgsPalLayerSettings.html#46f2828a8fa0762d880fd864fc26deea">00618</a> <span class="keywordtype">int</span> <a class="code" href="classQgsPalLayerSettings.html#46f2828a8fa0762d880fd864fc26deea" title="Calculates pixel size (considering output size should be in pixel or map units, scale...">QgsPalLayerSettings::sizeToPixel</a>( <span class="keywordtype">double</span> size, <span class="keyword">const</span> <a class="code" href="classQgsRenderContext.html" title="Contains information about the context of a rendering operation.">QgsRenderContext</a>&amp; c )<span class="keyword"> const</span>
<a name="l00619"></a>00619 <span class="keyword"></span>{
<a name="l00620"></a>00620   <span class="keywordtype">double</span> pixelSize;
<a name="l00621"></a>00621   <span class="keywordflow">if</span> ( <a class="code" href="classQgsPalLayerSettings.html#4eb2fc5cc0a37e83669249bccdb43e23">fontSizeInMapUnits</a> )
<a name="l00622"></a>00622   {
<a name="l00623"></a>00623     pixelSize = size / c.<a class="code" href="classQgsRenderContext.html#be5b3cb445070d6f5343132d6c347e65">mapToPixel</a>().<a class="code" href="classQgsMapToPixel.html#d8c374aa5e47057d4c2f45a5ced78bd0" title="Return current map units per pixel.">mapUnitsPerPixel</a>() * c.<a class="code" href="classQgsRenderContext.html#499f7c7cb3dad9ea71f0f3e83760fe0b">rasterScaleFactor</a>();
<a name="l00624"></a>00624   }
<a name="l00625"></a>00625   <span class="keywordflow">else</span> <span class="comment">//font size in points</span>
<a name="l00626"></a>00626   {
<a name="l00627"></a>00627     <span class="comment">// set font size from points to output size</span>
<a name="l00628"></a>00628     pixelSize = 0.3527 * size * c.<a class="code" href="classQgsRenderContext.html#f4b93052d1a48544b5cd7103a7596acb">scaleFactor</a>() * c.<a class="code" href="classQgsRenderContext.html#499f7c7cb3dad9ea71f0f3e83760fe0b">rasterScaleFactor</a>();
<a name="l00629"></a>00629   }
<a name="l00630"></a>00630   <span class="keywordflow">return</span> ( <span class="keywordtype">int</span> )( pixelSize + 0.5 );
<a name="l00631"></a>00631 }
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 
<a name="l00634"></a>00634 <span class="comment">// -------------</span>
<a name="l00635"></a>00635 
<a name="l00636"></a><a class="code" href="classQgsPalLabeling.html#add90f8184fad8efb262f44b42dffdbc">00636</a> <a class="code" href="classQgsPalLabeling.html#add90f8184fad8efb262f44b42dffdbc">QgsPalLabeling::QgsPalLabeling</a>()
<a name="l00637"></a>00637     : mMapRenderer( NULL ), mPal( NULL )
<a name="l00638"></a>00638 {
<a name="l00639"></a>00639 
<a name="l00640"></a>00640   <span class="comment">// find out engine defaults</span>
<a name="l00641"></a>00641   Pal p;
<a name="l00642"></a>00642   <a class="code" href="classQgsPalLabeling.html#f2bc6088527baa7f003a2f819232916e">mCandPoint</a> = p.getPointP();
<a name="l00643"></a>00643   <a class="code" href="classQgsPalLabeling.html#26f75105583ca23d283306535f6d9282">mCandLine</a> = p.getLineP();
<a name="l00644"></a>00644   <a class="code" href="classQgsPalLabeling.html#81e516776581bf7d7bb4d7bda1d70d0c">mCandPolygon</a> = p.getPolyP();
<a name="l00645"></a>00645 
<a name="l00646"></a>00646   <span class="keywordflow">switch</span> ( p.getSearch() )
<a name="l00647"></a>00647   {
<a name="l00648"></a>00648     <span class="keywordflow">case</span> CHAIN: <a class="code" href="classQgsPalLabeling.html#b26053e4fced553b3d08f0ebd2582e3c">mSearch</a> = <a class="code" href="classQgsPalLabeling.html#9c65d87be36faf21e0aef681f8bf59f015c214ec63e5a7b6a06ebb26bf5124b5">Chain</a>; <span class="keywordflow">break</span>;
<a name="l00649"></a>00649     <span class="keywordflow">case</span> POPMUSIC_TABU: <a class="code" href="classQgsPalLabeling.html#b26053e4fced553b3d08f0ebd2582e3c">mSearch</a> = <a class="code" href="classQgsPalLabeling.html#9c65d87be36faf21e0aef681f8bf59f0f9385caeeb1563c1383d4604a96813e3">Popmusic_Tabu</a>; <span class="keywordflow">break</span>;
<a name="l00650"></a>00650     <span class="keywordflow">case</span> POPMUSIC_CHAIN: <a class="code" href="classQgsPalLabeling.html#b26053e4fced553b3d08f0ebd2582e3c">mSearch</a> = <a class="code" href="classQgsPalLabeling.html#9c65d87be36faf21e0aef681f8bf59f063203d39e7ebd79a8f0d1be80c321553">Popmusic_Chain</a>; <span class="keywordflow">break</span>;
<a name="l00651"></a>00651     <span class="keywordflow">case</span> POPMUSIC_TABU_CHAIN: <a class="code" href="classQgsPalLabeling.html#b26053e4fced553b3d08f0ebd2582e3c">mSearch</a> = <a class="code" href="classQgsPalLabeling.html#9c65d87be36faf21e0aef681f8bf59f06094fcea0f4abd5b36ab18640a9e0824">Popmusic_Tabu_Chain</a>; <span class="keywordflow">break</span>;
<a name="l00652"></a>00652     <span class="keywordflow">case</span> FALP: <a class="code" href="classQgsPalLabeling.html#b26053e4fced553b3d08f0ebd2582e3c">mSearch</a> = <a class="code" href="classQgsPalLabeling.html#9c65d87be36faf21e0aef681f8bf59f00c5ff0aeaad746569283cfca6a34f477">Falp</a>; <span class="keywordflow">break</span>;
<a name="l00653"></a>00653   }
<a name="l00654"></a>00654 
<a name="l00655"></a>00655   <a class="code" href="classQgsPalLabeling.html#d0490f7f918cd015b27697628c69aecc">mShowingCandidates</a> = <span class="keyword">false</span>;
<a name="l00656"></a>00656   <a class="code" href="classQgsPalLabeling.html#046ccd8f0f06d72c121269db9e035845">mShowingAllLabels</a> = <span class="keyword">false</span>;
<a name="l00657"></a>00657 
<a name="l00658"></a>00658   <a class="code" href="classQgsPalLabeling.html#231decfc7ce4bce893f276d593ddab8c">mLabelSearchTree</a> = <span class="keyword">new</span> <a class="code" href="classQgsLabelSearchTree.html" title="A class to query the labeling structure at a given point (small wraper around pal...">QgsLabelSearchTree</a>();
<a name="l00659"></a>00659 }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661 
<a name="l00662"></a><a class="code" href="classQgsPalLabeling.html#5308207a1756c6cbc787b92ae855803e">00662</a> <a class="code" href="classQgsPalLabeling.html#5308207a1756c6cbc787b92ae855803e">QgsPalLabeling::~QgsPalLabeling</a>()
<a name="l00663"></a>00663 {
<a name="l00664"></a>00664   <span class="comment">// make sure we've freed everything</span>
<a name="l00665"></a>00665   <a class="code" href="classQgsPalLabeling.html#dafa62f4819e957d876754eb6ccc36be" title="called when we&amp;#39;re done with rendering">exit</a>();
<a name="l00666"></a>00666   <span class="keyword">delete</span> <a class="code" href="classQgsPalLabeling.html#231decfc7ce4bce893f276d593ddab8c">mLabelSearchTree</a>;
<a name="l00667"></a>00667   <a class="code" href="classQgsPalLabeling.html#231decfc7ce4bce893f276d593ddab8c">mLabelSearchTree</a> = NULL;
<a name="l00668"></a>00668 }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670 
<a name="l00671"></a><a class="code" href="classQgsPalLabeling.html#52433fc13fe0100c8e98d358d3d39605">00671</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsPalLabeling.html#52433fc13fe0100c8e98d358d3d39605" title="called to find out whether the layer is used for labeling">QgsPalLabeling::willUseLayer</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* <a class="code" href="classQgsPalLabeling.html#6133396353332633645806ec87792242">layer</a> )
<a name="l00672"></a>00672 {
<a name="l00673"></a>00673   <a class="code" href="classQgsPalLayerSettings.html">QgsPalLayerSettings</a> lyrTmp;
<a name="l00674"></a>00674   lyrTmp.<a class="code" href="classQgsPalLayerSettings.html#c4b2c35cf755ef8ea4edfb7beb5d992a">readFromLayer</a>( layer );
<a name="l00675"></a>00675   <span class="keywordflow">return</span> lyrTmp.<a class="code" href="classQgsPalLayerSettings.html#487efd2ca58be0c974cc2e29024cfbbb">enabled</a>;
<a name="l00676"></a>00676 }
<a name="l00677"></a>00677 
<a name="l00678"></a><a class="code" href="classQgsPalLabeling.html#7ea656315c0dce0f5154caf1dac56da5">00678</a> <span class="keywordtype">int</span> <a class="code" href="classQgsPalLabeling.html#7ea656315c0dce0f5154caf1dac56da5" title="hook called when drawing layer before issuing select()">QgsPalLabeling::prepareLayer</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* <a class="code" href="classQgsPalLabeling.html#6133396353332633645806ec87792242">layer</a>, QSet&lt;int&gt;&amp; attrIndices, <a class="code" href="classQgsRenderContext.html" title="Contains information about the context of a rendering operation.">QgsRenderContext</a>&amp; ctx )
<a name="l00679"></a>00679 {
<a name="l00680"></a>00680   Q_ASSERT( <a class="code" href="classQgsPalLabeling.html#5a8eb0bc085fc6ccadf2db7676cd94d6">mMapRenderer</a> != NULL );
<a name="l00681"></a>00681 
<a name="l00682"></a>00682   <span class="comment">// start with a temporary settings class, find out labeling info</span>
<a name="l00683"></a>00683   <a class="code" href="classQgsPalLayerSettings.html">QgsPalLayerSettings</a> lyrTmp;
<a name="l00684"></a>00684   lyrTmp.<a class="code" href="classQgsPalLayerSettings.html#c4b2c35cf755ef8ea4edfb7beb5d992a">readFromLayer</a>( layer );
<a name="l00685"></a>00685 
<a name="l00686"></a>00686   <span class="keywordflow">if</span> ( !lyrTmp.<a class="code" href="classQgsPalLayerSettings.html#487efd2ca58be0c974cc2e29024cfbbb">enabled</a> )
<a name="l00687"></a>00687     <span class="keywordflow">return</span> 0;
<a name="l00688"></a>00688 
<a name="l00689"></a>00689   <span class="comment">// find out which field will be needed</span>
<a name="l00690"></a>00690   <span class="keywordtype">int</span> fldIndex = layer-&gt;<a class="code" href="classQgsVectorLayer.html#59ce270a9e6a773c5bf1ee47c841d078" title="Returns the index of a field name or -1 if the field does not exist.">fieldNameIndex</a>( lyrTmp.<a class="code" href="classQgsPalLayerSettings.html#c57b3ecf3c052e33c947ed8713e4b48c">fieldName</a> );
<a name="l00691"></a>00691   <span class="keywordflow">if</span> ( fldIndex == -1 )
<a name="l00692"></a>00692     <span class="keywordflow">return</span> 0;
<a name="l00693"></a>00693   attrIndices.insert( fldIndex );
<a name="l00694"></a>00694 
<a name="l00695"></a>00695   <span class="comment">//add indices of data defined fields</span>
<a name="l00696"></a>00696   QMap&lt; QgsPalLayerSettings::DataDefinedProperties, int &gt;::const_iterator dIt = lyrTmp.<a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.constBegin();
<a name="l00697"></a>00697   <span class="keywordflow">for</span> ( ; dIt != lyrTmp.<a class="code" href="classQgsPalLayerSettings.html#b8bd00817dd664eb4dd2b8e4f7efff21" title="Stores field indices for data defined layer properties.">dataDefinedProperties</a>.constEnd(); ++dIt )
<a name="l00698"></a>00698   {
<a name="l00699"></a>00699     attrIndices.insert( dIt.value() );
<a name="l00700"></a>00700   }
<a name="l00701"></a>00701 
<a name="l00702"></a>00702   <span class="comment">// add layer settings to the pallabeling hashtable: &lt;QgsVectorLayer*, QgsPalLayerSettings&gt;</span>
<a name="l00703"></a>00703   <a class="code" href="classQgsPalLabeling.html#a1ed04621a8c1dc1056eca5da0ae341e">mActiveLayers</a>.insert( layer, lyrTmp );
<a name="l00704"></a>00704   <span class="comment">// start using the reference to the layer in hashtable instead of local instance</span>
<a name="l00705"></a>00705   <a class="code" href="classQgsPalLayerSettings.html">QgsPalLayerSettings</a>&amp; lyr = <a class="code" href="classQgsPalLabeling.html#a1ed04621a8c1dc1056eca5da0ae341e">mActiveLayers</a>[layer];
<a name="l00706"></a>00706 
<a name="l00707"></a>00707   <span class="comment">// how to place the labels</span>
<a name="l00708"></a>00708   Arrangement arrangement;
<a name="l00709"></a>00709   <span class="keywordflow">switch</span> ( lyr.<a class="code" href="classQgsPalLayerSettings.html#de0e96125f5d912953b168a736d2e09b">placement</a> )
<a name="l00710"></a>00710   {
<a name="l00711"></a>00711     <span class="keywordflow">case</span> <a class="code" href="classQgsPalLayerSettings.html#5d449d8e9cb89e5d453c6e33fe1c66cc1f573db8056342bdd9ac382bcf14adf9">QgsPalLayerSettings::AroundPoint</a>: arrangement = P_POINT; <span class="keywordflow">break</span>;
<a name="l00712"></a>00712     <span class="keywordflow">case</span> <a class="code" href="classQgsPalLayerSettings.html#5d449d8e9cb89e5d453c6e33fe1c66cc14a204dca3551ab64cec4c8e8ece40aa">QgsPalLayerSettings::OverPoint</a>:   arrangement = P_POINT_OVER; <span class="keywordflow">break</span>;
<a name="l00713"></a>00713     <span class="keywordflow">case</span> <a class="code" href="classQgsPalLayerSettings.html#5d449d8e9cb89e5d453c6e33fe1c66cc4f3d6d88545bf3e32ed488e4a082f471">QgsPalLayerSettings::Line</a>:        arrangement = P_LINE; <span class="keywordflow">break</span>;
<a name="l00714"></a>00714     <span class="keywordflow">case</span> <a class="code" href="classQgsPalLayerSettings.html#5d449d8e9cb89e5d453c6e33fe1c66cc0dd48e48f7fc19d7e1a8a371343aaeee">QgsPalLayerSettings::Curved</a>:      arrangement = P_CURVED; <span class="keywordflow">break</span>;
<a name="l00715"></a>00715     <span class="keywordflow">case</span> <a class="code" href="classQgsPalLayerSettings.html#5d449d8e9cb89e5d453c6e33fe1c66cc0e2a423b79e3dda9b063a3905de553ee">QgsPalLayerSettings::Horizontal</a>:  arrangement = P_HORIZ; <span class="keywordflow">break</span>;
<a name="l00716"></a>00716     <span class="keywordflow">case</span> <a class="code" href="classQgsPalLayerSettings.html#5d449d8e9cb89e5d453c6e33fe1c66cc13c2a7c0ef5a8b6767a57eb785a54916">QgsPalLayerSettings::Free</a>:        arrangement = P_FREE; <span class="keywordflow">break</span>;
<a name="l00717"></a>00717     <span class="keywordflow">default</span>: Q_ASSERT( <span class="stringliteral">"unsupported placement"</span> &amp;&amp; 0 ); <span class="keywordflow">return</span> 0; <span class="keywordflow">break</span>;
<a name="l00718"></a>00718   }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720   <span class="comment">// create the pal layer</span>
<a name="l00721"></a>00721   <span class="keywordtype">double</span> priority = 1 - lyr.<a class="code" href="classQgsPalLayerSettings.html#67fba9e271265dddf0e9bb3a28c9e7de">priority</a> / 10.0; <span class="comment">// convert 0..10 --&gt; 1..0</span>
<a name="l00722"></a>00722   <span class="keywordtype">double</span> min_scale = -1, max_scale = -1;
<a name="l00723"></a>00723   <span class="keywordflow">if</span> ( lyr.<a class="code" href="classQgsPalLayerSettings.html#90286fb2699deb8f4032ac91b6318785">scaleMin</a> != 0 &amp;&amp; lyr.<a class="code" href="classQgsPalLayerSettings.html#f2ec6e89aca16eebe643118b6be661aa">scaleMax</a> != 0 )
<a name="l00724"></a>00724   {
<a name="l00725"></a>00725     min_scale = lyr.<a class="code" href="classQgsPalLayerSettings.html#90286fb2699deb8f4032ac91b6318785">scaleMin</a>;
<a name="l00726"></a>00726     max_scale = lyr.<a class="code" href="classQgsPalLayerSettings.html#f2ec6e89aca16eebe643118b6be661aa">scaleMax</a>;
<a name="l00727"></a>00727   }
<a name="l00728"></a>00728 
<a name="l00729"></a>00729   Layer* l = <a class="code" href="classQgsPalLabeling.html#14bcfdc116292ba73a6f67abc635ef2c">mPal</a>-&gt;addLayer( layer-&gt;<a class="code" href="classQgsMapLayer.html#710f27dec806d3bcd5ae14701c2e6fd7" title="Get this layer&amp;#39;s unique ID, this ID is used to access this layer from map layer...">id</a>().toUtf8().data(),
<a name="l00730"></a>00730                              min_scale, max_scale, arrangement,
<a name="l00731"></a>00731                              METER, priority, lyr.<a class="code" href="classQgsPalLayerSettings.html#10af33e55f923e6ddf3c20f1e51fbb29">obstacle</a>, <span class="keyword">true</span>, true );
<a name="l00732"></a>00732 
<a name="l00733"></a>00733   <span class="keywordflow">if</span> ( lyr.<a class="code" href="classQgsPalLayerSettings.html#beb4d081fd4eb7debb30dfcdd5be8d58">placementFlags</a> )
<a name="l00734"></a>00734     l-&gt;setArrangementFlags( lyr.<a class="code" href="classQgsPalLayerSettings.html#beb4d081fd4eb7debb30dfcdd5be8d58">placementFlags</a> );
<a name="l00735"></a>00735 
<a name="l00736"></a>00736   <span class="comment">// set label mode (label per feature is the default)</span>
<a name="l00737"></a>00737   l-&gt;setLabelMode( lyr.<a class="code" href="classQgsPalLayerSettings.html#6bda8893aa13604885edd2be1d1301c9">labelPerPart</a> ? Layer::LabelPerFeaturePart : Layer::LabelPerFeature );
<a name="l00738"></a>00738 
<a name="l00739"></a>00739   <span class="comment">// set whether adjacent lines should be merged</span>
<a name="l00740"></a>00740   l-&gt;setMergeConnectedLines( lyr.<a class="code" href="classQgsPalLayerSettings.html#ecb8058601826a08976c9f3fbfe5d4ab">mergeLines</a> );
<a name="l00741"></a>00741 
<a name="l00742"></a>00742   lyr.<a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a>.setPixelSize( lyr.<a class="code" href="classQgsPalLayerSettings.html#46f2828a8fa0762d880fd864fc26deea" title="Calculates pixel size (considering output size should be in pixel or map units, scale...">sizeToPixel</a>( lyr.<a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a>.pointSizeF(), ctx ) );
<a name="l00743"></a>00743 
<a name="l00744"></a>00744   <span class="comment">//raster and vector scale factors</span>
<a name="l00745"></a>00745   lyr.<a class="code" href="classQgsPalLayerSettings.html#451e4e4bb95a04422ec5b3f583113297">vectorScaleFactor</a> = ctx.<a class="code" href="classQgsRenderContext.html#f4b93052d1a48544b5cd7103a7596acb">scaleFactor</a>();
<a name="l00746"></a>00746   lyr.<a class="code" href="classQgsPalLayerSettings.html#31d35efbd75cb3c342b98300cc1693cf">rasterCompressFactor</a> = ctx.<a class="code" href="classQgsRenderContext.html#499f7c7cb3dad9ea71f0f3e83760fe0b">rasterScaleFactor</a>();
<a name="l00747"></a>00747 
<a name="l00748"></a>00748   <span class="comment">// save the pal layer to our layer context (with some additional info)</span>
<a name="l00749"></a>00749   lyr.<a class="code" href="classQgsPalLayerSettings.html#4b54996e3299b9ecb5f775c2165b0ba4">palLayer</a> = l;
<a name="l00750"></a>00750   lyr.<a class="code" href="classQgsPalLayerSettings.html#a2c4b1fb3329602ec2b832a001f5ac38">fieldIndex</a> = fldIndex;
<a name="l00751"></a>00751   lyr.<a class="code" href="classQgsPalLayerSettings.html#085fcc0331f3f3ca085826a55f41f463">fontMetrics</a> = <span class="keyword">new</span> QFontMetricsF( lyr.<a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a> );
<a name="l00752"></a>00752 
<a name="l00753"></a>00753   lyr.<a class="code" href="classQgsPalLayerSettings.html#1653b66f7fa353bf9fe9ac39a6f4e028">xform</a> = <a class="code" href="classQgsPalLabeling.html#5a8eb0bc085fc6ccadf2db7676cd94d6">mMapRenderer</a>-&gt;<a class="code" href="classQgsMapRenderer.html#66fddb8674563b409dd594e09770fd00">coordinateTransform</a>();
<a name="l00754"></a>00754   <span class="keywordflow">if</span> ( <a class="code" href="classQgsPalLabeling.html#5a8eb0bc085fc6ccadf2db7676cd94d6">mMapRenderer</a>-&gt;<a class="code" href="classQgsMapRenderer.html#e53931870a9b3f25f1bef82e52fa1a2b" title="returns true if projections are enabled for this layer set">hasCrsTransformEnabled</a>() )
<a name="l00755"></a>00755     lyr.<a class="code" href="classQgsPalLayerSettings.html#81f31b83854f9876ad05174ce4bab1da">ct</a> = <span class="keyword">new</span> <a class="code" href="classQgsCoordinateTransform.html" title="Class for doing transforms between two map coordinate systems.">QgsCoordinateTransform</a>( layer-&gt;<a class="code" href="classQgsMapLayer.html#cad1e3a9c10019c9d460021ac0150f37" title="Returns layer&amp;#39;s spatial reference system.">crs</a>(), <a class="code" href="classQgsPalLabeling.html#5a8eb0bc085fc6ccadf2db7676cd94d6">mMapRenderer</a>-&gt;<a class="code" href="classQgsMapRenderer.html#a3854eab85b3b29ef655a839e87529a1" title="returns CRS of destination coordinate reference system">destinationCrs</a>() );
<a name="l00756"></a>00756   <span class="keywordflow">else</span>
<a name="l00757"></a>00757     lyr.<a class="code" href="classQgsPalLayerSettings.html#81f31b83854f9876ad05174ce4bab1da">ct</a> = NULL;
<a name="l00758"></a>00758   lyr.<a class="code" href="classQgsPalLayerSettings.html#7ea465a9e14ac5e2b3939db9c6f27753">ptZero</a> = lyr.<a class="code" href="classQgsPalLayerSettings.html#1653b66f7fa353bf9fe9ac39a6f4e028">xform</a>-&gt;<a class="code" href="classQgsMapToPixel.html#9bffa589e03240bc37c8ea9bed45f339">toMapCoordinates</a>( 0, 0 );
<a name="l00759"></a>00759   lyr.<a class="code" href="classQgsPalLayerSettings.html#ad85de00fb4eb24da730b950c0da99ac">ptOne</a> = lyr.<a class="code" href="classQgsPalLayerSettings.html#1653b66f7fa353bf9fe9ac39a6f4e028">xform</a>-&gt;<a class="code" href="classQgsMapToPixel.html#9bffa589e03240bc37c8ea9bed45f339">toMapCoordinates</a>( 1, 0 );
<a name="l00760"></a>00760 
<a name="l00761"></a>00761   <span class="keywordflow">return</span> 1; <span class="comment">// init successful</span>
<a name="l00762"></a>00762 }
<a name="l00763"></a>00763 
<a name="l00764"></a><a class="code" href="classQgsPalLabeling.html#369d3911123254582f98347df1dc38a0">00764</a> <span class="keywordtype">int</span> <a class="code" href="classQgsPalLabeling.html#369d3911123254582f98347df1dc38a0" title="adds a diagram layer to the labeling engine">QgsPalLabeling::addDiagramLayer</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* <a class="code" href="classQgsPalLabeling.html#6133396353332633645806ec87792242">layer</a>, <a class="code" href="structQgsDiagramLayerSettings.html">QgsDiagramLayerSettings</a> *s )
<a name="l00765"></a>00765 {
<a name="l00766"></a>00766   Layer* l = <a class="code" href="classQgsPalLabeling.html#14bcfdc116292ba73a6f67abc635ef2c">mPal</a>-&gt;addLayer( layer-&gt;<a class="code" href="classQgsMapLayer.html#710f27dec806d3bcd5ae14701c2e6fd7" title="Get this layer&amp;#39;s unique ID, this ID is used to access this layer from map layer...">id</a>().append( <span class="stringliteral">"d"</span> ).toUtf8().data(), -1, -1, pal::Arrangement( s-&gt;<a class="code" href="structQgsDiagramLayerSettings.html#e5a1e3512c468eb7978c5d158ee25668">placement</a> ), METER, s-&gt;<a class="code" href="structQgsDiagramLayerSettings.html#616a55d8a4966c4be7894e2fd0938319">priority</a>, s-&gt;<a class="code" href="structQgsDiagramLayerSettings.html#49faa5dd75e3d884ab09c1f3bbf30577">obstacle</a>, <span class="keyword">true</span>, true );
<a name="l00767"></a>00767   l-&gt;setArrangementFlags( s-&gt;<a class="code" href="structQgsDiagramLayerSettings.html#2eabdd8ae4320a5e90388bd98768f35c">placementFlags</a> );
<a name="l00768"></a>00768 
<a name="l00769"></a>00769   s-&gt;<a class="code" href="structQgsDiagramLayerSettings.html#3908ea2796789c9d07e08aff5ef08183">palLayer</a> = l;
<a name="l00770"></a>00770   <span class="keywordflow">if</span> ( <a class="code" href="classQgsPalLabeling.html#5a8eb0bc085fc6ccadf2db7676cd94d6">mMapRenderer</a>-&gt;<a class="code" href="classQgsMapRenderer.html#e53931870a9b3f25f1bef82e52fa1a2b" title="returns true if projections are enabled for this layer set">hasCrsTransformEnabled</a>() )
<a name="l00771"></a>00771     s-&gt;<a class="code" href="structQgsDiagramLayerSettings.html#7f6a355d9bb7fe19e3a3e4f13b258146">ct</a> = <span class="keyword">new</span> <a class="code" href="classQgsCoordinateTransform.html" title="Class for doing transforms between two map coordinate systems.">QgsCoordinateTransform</a>( layer-&gt;<a class="code" href="classQgsMapLayer.html#cad1e3a9c10019c9d460021ac0150f37" title="Returns layer&amp;#39;s spatial reference system.">crs</a>(), <a class="code" href="classQgsPalLabeling.html#5a8eb0bc085fc6ccadf2db7676cd94d6">mMapRenderer</a>-&gt;<a class="code" href="classQgsMapRenderer.html#a3854eab85b3b29ef655a839e87529a1" title="returns CRS of destination coordinate reference system">destinationCrs</a>() );
<a name="l00772"></a>00772   <span class="keywordflow">else</span>
<a name="l00773"></a>00773     s-&gt;<a class="code" href="structQgsDiagramLayerSettings.html#7f6a355d9bb7fe19e3a3e4f13b258146">ct</a> = NULL;
<a name="l00774"></a>00774   s-&gt;<a class="code" href="structQgsDiagramLayerSettings.html#03b7228d044c30df81df819fd8153c74">xform</a> = <a class="code" href="classQgsPalLabeling.html#5a8eb0bc085fc6ccadf2db7676cd94d6">mMapRenderer</a>-&gt;<a class="code" href="classQgsMapRenderer.html#66fddb8674563b409dd594e09770fd00">coordinateTransform</a>();
<a name="l00775"></a>00775   <a class="code" href="classQgsPalLabeling.html#8ee614901f550642aef22069d0fc974a">mActiveDiagramLayers</a>.insert( layer, *s );
<a name="l00776"></a>00776   <span class="keywordflow">return</span> 1;
<a name="l00777"></a>00777 }
<a name="l00778"></a>00778 
<a name="l00779"></a><a class="code" href="classQgsPalLabeling.html#b24656707fb67c6045b3152cc21e4316">00779</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLabeling.html#b24656707fb67c6045b3152cc21e4316" title="hook called when drawing for every feature in a layer">QgsPalLabeling::registerFeature</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* <a class="code" href="classQgsPalLabeling.html#6133396353332633645806ec87792242">layer</a>, <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a...">QgsFeature</a>&amp; f, <span class="keyword">const</span> <a class="code" href="classQgsRenderContext.html" title="Contains information about the context of a rendering operation.">QgsRenderContext</a>&amp; context )
<a name="l00780"></a>00780 {
<a name="l00781"></a>00781   <a class="code" href="classQgsPalLayerSettings.html">QgsPalLayerSettings</a>&amp; lyr = <a class="code" href="classQgsPalLabeling.html#a1ed04621a8c1dc1056eca5da0ae341e">mActiveLayers</a>[layer];
<a name="l00782"></a>00782   lyr.<a class="code" href="classQgsPalLayerSettings.html#c926f9172dd4620ab5a984f9cb96d19d">registerFeature</a>( f, context );
<a name="l00783"></a>00783 }
<a name="l00784"></a>00784 
<a name="l00785"></a><a class="code" href="classQgsPalLabeling.html#ffd5f747b8d119528f1d91c487a30ac3">00785</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLabeling.html#ffd5f747b8d119528f1d91c487a30ac3" title="called for every diagram feature">QgsPalLabeling::registerDiagramFeature</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* <a class="code" href="classQgsPalLabeling.html#6133396353332633645806ec87792242">layer</a>, <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a...">QgsFeature</a>&amp; feat, <span class="keyword">const</span> <a class="code" href="classQgsRenderContext.html" title="Contains information about the context of a rendering operation.">QgsRenderContext</a>&amp; context )
<a name="l00786"></a>00786 {
<a name="l00787"></a>00787   <span class="comment">//get diagram layer settings, diagram renderer</span>
<a name="l00788"></a>00788   QHash&lt;QgsVectorLayer*, QgsDiagramLayerSettings&gt;::iterator layerIt = <a class="code" href="classQgsPalLabeling.html#8ee614901f550642aef22069d0fc974a">mActiveDiagramLayers</a>.find( layer );
<a name="l00789"></a>00789   <span class="keywordflow">if</span> ( layerIt == <a class="code" href="classQgsPalLabeling.html#8ee614901f550642aef22069d0fc974a">mActiveDiagramLayers</a>.constEnd() )
<a name="l00790"></a>00790   {
<a name="l00791"></a>00791     <span class="keywordflow">return</span>;
<a name="l00792"></a>00792   }
<a name="l00793"></a>00793 
<a name="l00794"></a>00794   <span class="comment">//convert geom to geos</span>
<a name="l00795"></a>00795   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* geom = feat.<a class="code" href="classQgsFeature.html#b0a934a1b173ce5ad8d13363c20ef3c8" title="Get the geometry object associated with this feature.">geometry</a>();
<a name="l00796"></a>00796 
<a name="l00797"></a>00797   <span class="keywordflow">if</span> ( layerIt.value().ct &amp;&amp; !<a class="code" href="classQgsPalLabeling.html#52433fc13fe0100c8e98d358d3d39605" title="called to find out whether the layer is used for labeling">willUseLayer</a>( layer ) ) <span class="comment">// reproject the geometry if feature not already transformed for labeling</span>
<a name="l00798"></a>00798   {
<a name="l00799"></a>00799     geom-&gt;<a class="code" href="classQgsGeometry.html#46fd84e518cae4368aadeeac89574dfa" title="Transform this geometry as described by CoordinateTranasform ct.">transform</a>( *( layerIt.value().ct ) );
<a name="l00800"></a>00800   }
<a name="l00801"></a>00801 
<a name="l00802"></a>00802   GEOSGeometry* geos_geom = geom-&gt;<a class="code" href="classQgsGeometry.html#ca7621fa485ec9c0cf5803968e8cb659" title="Returns a geos geomtry.">asGeos</a>();
<a name="l00803"></a>00803   <span class="keywordflow">if</span> ( geos_geom == 0 )
<a name="l00804"></a>00804   {
<a name="l00805"></a>00805     <span class="keywordflow">return</span>; <span class="comment">// invalid geometry</span>
<a name="l00806"></a>00806   }
<a name="l00807"></a>00807 
<a name="l00808"></a>00808   <span class="comment">//create PALGeometry with diagram = true</span>
<a name="l00809"></a>00809   <a class="code" href="classQgsPalGeometry.html">QgsPalGeometry</a>* lbl = <span class="keyword">new</span> <a class="code" href="classQgsPalGeometry.html">QgsPalGeometry</a>( feat.<a class="code" href="classQgsFeature.html#d4ae834f0941bf2578fe8a019f192668" title="Get the feature id for this feature.">id</a>(), <span class="stringliteral">""</span>, GEOSGeom_clone( geos_geom ) );
<a name="l00810"></a>00810   lbl-&gt;<a class="code" href="classQgsPalGeometry.html#7487bb832af5515a9c5f3e5cf0201b16">setIsDiagram</a>( <span class="keyword">true</span> );
<a name="l00811"></a>00811 
<a name="l00812"></a>00812   <span class="comment">// record the created geometry - it will be deleted at the end.</span>
<a name="l00813"></a>00813   layerIt.value().geometries.append( lbl );
<a name="l00814"></a>00814 
<a name="l00815"></a>00815   <span class="keywordtype">double</span> diagramWidth = 0;
<a name="l00816"></a>00816   <span class="keywordtype">double</span> diagramHeight = 0;
<a name="l00817"></a>00817   <a class="code" href="classQgsDiagramRendererV2.html" title="Returns diagram settings for a feature.">QgsDiagramRendererV2</a>* dr = layerIt.value().renderer;
<a name="l00818"></a>00818   <span class="keywordflow">if</span> ( dr )
<a name="l00819"></a>00819   {
<a name="l00820"></a>00820     QSizeF diagSize = dr-&gt;<a class="code" href="classQgsDiagramRendererV2.html#6ddd94b9dfe3cd2f0190279cd81f2b28" title="Returns size of the diagram for feature f in map units.">sizeMapUnits</a>( feat.<a class="code" href="classQgsFeature.html#d80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>(), context );
<a name="l00821"></a>00821     <span class="keywordflow">if</span> ( diagSize.isValid() )
<a name="l00822"></a>00822     {
<a name="l00823"></a>00823       diagramWidth = diagSize.width();
<a name="l00824"></a>00824       diagramHeight = diagSize.height();
<a name="l00825"></a>00825     }
<a name="l00826"></a>00826 
<a name="l00827"></a>00827     <span class="comment">//append the diagram attributes to lbl</span>
<a name="l00828"></a>00828     QList&lt;int&gt; diagramAttrib = dr-&gt;<a class="code" href="classQgsDiagramRendererV2.html#0c2ca6c82e9bf419cc5942a0d77fc4a6" title="Returns attribute indices needed for diagram rendering.">diagramAttributes</a>();
<a name="l00829"></a>00829     QList&lt;int&gt;::const_iterator diagAttIt = diagramAttrib.constBegin();
<a name="l00830"></a>00830     <span class="keywordflow">for</span> ( ; diagAttIt != diagramAttrib.constEnd(); ++diagAttIt )
<a name="l00831"></a>00831     {
<a name="l00832"></a>00832       lbl-&gt;<a class="code" href="classQgsPalGeometry.html#b6fa8d14fa796b2e728dde3894156f62">addDiagramAttribute</a>( *diagAttIt, feat.<a class="code" href="classQgsFeature.html#d80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>()[*diagAttIt] );
<a name="l00833"></a>00833     }
<a name="l00834"></a>00834   }
<a name="l00835"></a>00835 
<a name="l00836"></a>00836   <span class="comment">// register feature to the layer</span>
<a name="l00837"></a>00837   <span class="keywordtype">int</span> ddColX = layerIt.value().xPosColumn;
<a name="l00838"></a>00838   <span class="keywordtype">int</span> ddColY = layerIt.value().yPosColumn;
<a name="l00839"></a>00839   <span class="keywordtype">double</span> ddPosX = 0.0;
<a name="l00840"></a>00840   <span class="keywordtype">double</span> ddPosY = 0.0;
<a name="l00841"></a>00841   <span class="keywordtype">bool</span> ddPos = ( ddColX &gt;= 0 &amp;&amp; ddColY &gt;= 0 );
<a name="l00842"></a>00842   <span class="keywordflow">if</span> ( ddPos )
<a name="l00843"></a>00843   {
<a name="l00844"></a>00844     <span class="keywordtype">bool</span> posXOk, posYOk;
<a name="l00845"></a>00845     <span class="comment">//data defined diagram position is always centered</span>
<a name="l00846"></a>00846     ddPosX = feat.<a class="code" href="classQgsFeature.html#d80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>()[ddColX].toDouble( &amp;posXOk ) - diagramWidth / 2.0;
<a name="l00847"></a>00847     ddPosY = feat.<a class="code" href="classQgsFeature.html#d80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>()[ddColY].toDouble( &amp;posYOk ) - diagramHeight / 2.0;
<a name="l00848"></a>00848     <span class="keywordflow">if</span> ( !posXOk || !posYOk )
<a name="l00849"></a>00849     {
<a name="l00850"></a>00850       ddPos = <span class="keyword">false</span>;
<a name="l00851"></a>00851     }
<a name="l00852"></a>00852     <span class="keywordflow">else</span>
<a name="l00853"></a>00853     {
<a name="l00854"></a>00854       <span class="keyword">const</span> <a class="code" href="classQgsCoordinateTransform.html" title="Class for doing transforms between two map coordinate systems.">QgsCoordinateTransform</a>* ct = layerIt.value().ct;
<a name="l00855"></a>00855       <span class="keywordflow">if</span> ( ct )
<a name="l00856"></a>00856       {
<a name="l00857"></a>00857         <span class="keywordtype">double</span> z = 0;
<a name="l00858"></a>00858         ct-&gt;<a class="code" href="classQgsCoordinateTransform.html#6b3601d4afae2e004e4bec38339d4102">transformInPlace</a>( ddPosX, ddPosY, z );
<a name="l00859"></a>00859       }
<a name="l00860"></a>00860     }
<a name="l00861"></a>00861   }
<a name="l00862"></a>00862 
<a name="l00863"></a>00863   <span class="keywordflow">try</span>
<a name="l00864"></a>00864   {
<a name="l00865"></a>00865     <span class="keywordflow">if</span> ( !layerIt.value().palLayer-&gt;registerFeature( lbl-&gt;<a class="code" href="classQgsPalGeometry.html#a051906c05c755d1fdc070174eb4dc73">strId</a>(), lbl, diagramWidth, diagramHeight, <span class="stringliteral">""</span>, ddPosX, ddPosY, ddPos ) )
<a name="l00866"></a>00866     {
<a name="l00867"></a>00867       <span class="keywordflow">return</span>;
<a name="l00868"></a>00868     }
<a name="l00869"></a>00869   }
<a name="l00870"></a>00870   <span class="keywordflow">catch</span> ( std::exception* e )
<a name="l00871"></a>00871   {
<a name="l00872"></a>00872     <a class="code" href="qgslogger_8h.html#b273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">"Ignoring feature %1 due PAL exception: "</span> ).arg( feat.<a class="code" href="classQgsFeature.html#d4ae834f0941bf2578fe8a019f192668" title="Get the feature id for this feature.">id</a>() ) + QString::fromLatin1( e-&gt;what() ) );
<a name="l00873"></a>00873     <span class="keywordflow">return</span>;
<a name="l00874"></a>00874   }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876   pal::Feature* palFeat = layerIt.value().palLayer-&gt;getFeature( lbl-&gt;<a class="code" href="classQgsPalGeometry.html#a051906c05c755d1fdc070174eb4dc73">strId</a>() );
<a name="l00877"></a>00877   <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> ptZero = layerIt.value().xform-&gt;toMapCoordinates( 0, 0 );
<a name="l00878"></a>00878   <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> ptOne = layerIt.value().xform-&gt;toMapCoordinates( 1, 0 );
<a name="l00879"></a>00879   palFeat-&gt;setDistLabel( qAbs( ptOne.<a class="code" href="classQgsPoint.html#14cf4897a06313074760383398ee95d5">x</a>() - ptZero.<a class="code" href="classQgsPoint.html#14cf4897a06313074760383398ee95d5">x</a>() ) * layerIt.value().dist );
<a name="l00880"></a>00880 }
<a name="l00881"></a>00881 
<a name="l00882"></a>00882 
<a name="l00883"></a><a class="code" href="classQgsPalLabeling.html#bd1a7ab00ddcba367224b0afba2fd705">00883</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLabeling.html#bd1a7ab00ddcba367224b0afba2fd705" title="called when we&amp;#39;re going to start with rendering">QgsPalLabeling::init</a>( <a class="code" href="classQgsMapRenderer.html" title="A non GUI class for rendering a map layer set onto a QPainter.">QgsMapRenderer</a>* mr )
<a name="l00884"></a>00884 {
<a name="l00885"></a>00885   <a class="code" href="classQgsPalLabeling.html#5a8eb0bc085fc6ccadf2db7676cd94d6">mMapRenderer</a> = mr;
<a name="l00886"></a>00886 
<a name="l00887"></a>00887   <span class="comment">// delete if exists already</span>
<a name="l00888"></a>00888   <span class="keywordflow">if</span> ( <a class="code" href="classQgsPalLabeling.html#14bcfdc116292ba73a6f67abc635ef2c">mPal</a> )
<a name="l00889"></a>00889     <span class="keyword">delete</span> <a class="code" href="classQgsPalLabeling.html#14bcfdc116292ba73a6f67abc635ef2c">mPal</a>;
<a name="l00890"></a>00890 
<a name="l00891"></a>00891   <a class="code" href="classQgsPalLabeling.html#14bcfdc116292ba73a6f67abc635ef2c">mPal</a> = <span class="keyword">new</span> Pal;
<a name="l00892"></a>00892 
<a name="l00893"></a>00893   SearchMethod s;
<a name="l00894"></a>00894   <span class="keywordflow">switch</span> ( <a class="code" href="classQgsPalLabeling.html#b26053e4fced553b3d08f0ebd2582e3c">mSearch</a> )
<a name="l00895"></a>00895   {
<a name="l00896"></a>00896     <span class="keywordflow">default</span>:
<a name="l00897"></a>00897     <span class="keywordflow">case</span> <a class="code" href="classQgsPalLabeling.html#9c65d87be36faf21e0aef681f8bf59f015c214ec63e5a7b6a06ebb26bf5124b5">Chain</a>: s = CHAIN; <span class="keywordflow">break</span>;
<a name="l00898"></a>00898     <span class="keywordflow">case</span> <a class="code" href="classQgsPalLabeling.html#9c65d87be36faf21e0aef681f8bf59f0f9385caeeb1563c1383d4604a96813e3">Popmusic_Tabu</a>: s = POPMUSIC_TABU; <span class="keywordflow">break</span>;
<a name="l00899"></a>00899     <span class="keywordflow">case</span> <a class="code" href="classQgsPalLabeling.html#9c65d87be36faf21e0aef681f8bf59f063203d39e7ebd79a8f0d1be80c321553">Popmusic_Chain</a>: s = POPMUSIC_CHAIN; <span class="keywordflow">break</span>;
<a name="l00900"></a>00900     <span class="keywordflow">case</span> <a class="code" href="classQgsPalLabeling.html#9c65d87be36faf21e0aef681f8bf59f06094fcea0f4abd5b36ab18640a9e0824">Popmusic_Tabu_Chain</a>: s = POPMUSIC_TABU_CHAIN; <span class="keywordflow">break</span>;
<a name="l00901"></a>00901     <span class="keywordflow">case</span> <a class="code" href="classQgsPalLabeling.html#9c65d87be36faf21e0aef681f8bf59f00c5ff0aeaad746569283cfca6a34f477">Falp</a>: s = FALP; <span class="keywordflow">break</span>;
<a name="l00902"></a>00902   }
<a name="l00903"></a>00903   <a class="code" href="classQgsPalLabeling.html#14bcfdc116292ba73a6f67abc635ef2c">mPal</a>-&gt;setSearch( s );
<a name="l00904"></a>00904 
<a name="l00905"></a>00905   <span class="comment">// set number of candidates generated per feature</span>
<a name="l00906"></a>00906   <a class="code" href="classQgsPalLabeling.html#14bcfdc116292ba73a6f67abc635ef2c">mPal</a>-&gt;setPointP( <a class="code" href="classQgsPalLabeling.html#f2bc6088527baa7f003a2f819232916e">mCandPoint</a> );
<a name="l00907"></a>00907   <a class="code" href="classQgsPalLabeling.html#14bcfdc116292ba73a6f67abc635ef2c">mPal</a>-&gt;setLineP( <a class="code" href="classQgsPalLabeling.html#26f75105583ca23d283306535f6d9282">mCandLine</a> );
<a name="l00908"></a>00908   <a class="code" href="classQgsPalLabeling.html#14bcfdc116292ba73a6f67abc635ef2c">mPal</a>-&gt;setPolyP( <a class="code" href="classQgsPalLabeling.html#81e516776581bf7d7bb4d7bda1d70d0c">mCandPolygon</a> );
<a name="l00909"></a>00909 
<a name="l00910"></a>00910   <a class="code" href="classQgsPalLabeling.html#a1ed04621a8c1dc1056eca5da0ae341e">mActiveLayers</a>.clear();
<a name="l00911"></a>00911   <a class="code" href="classQgsPalLabeling.html#8ee614901f550642aef22069d0fc974a">mActiveDiagramLayers</a>.clear();
<a name="l00912"></a>00912 }
<a name="l00913"></a>00913 
<a name="l00914"></a><a class="code" href="classQgsPalLabeling.html#dafa62f4819e957d876754eb6ccc36be">00914</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLabeling.html#dafa62f4819e957d876754eb6ccc36be" title="called when we&amp;#39;re done with rendering">QgsPalLabeling::exit</a>()
<a name="l00915"></a>00915 {
<a name="l00916"></a>00916   <span class="keyword">delete</span> <a class="code" href="classQgsPalLabeling.html#14bcfdc116292ba73a6f67abc635ef2c">mPal</a>;
<a name="l00917"></a>00917   <a class="code" href="classQgsPalLabeling.html#14bcfdc116292ba73a6f67abc635ef2c">mPal</a> = NULL;
<a name="l00918"></a>00918   <a class="code" href="classQgsPalLabeling.html#5a8eb0bc085fc6ccadf2db7676cd94d6">mMapRenderer</a> = NULL;
<a name="l00919"></a>00919 }
<a name="l00920"></a>00920 
<a name="l00921"></a><a class="code" href="classQgsPalLabeling.html#6133396353332633645806ec87792242">00921</a> <a class="code" href="classQgsPalLayerSettings.html">QgsPalLayerSettings</a>&amp; <a class="code" href="classQgsPalLabeling.html#6133396353332633645806ec87792242">QgsPalLabeling::layer</a>( <span class="keyword">const</span> QString&amp; layerName )
<a name="l00922"></a>00922 {
<a name="l00923"></a>00923   QHash&lt;QgsVectorLayer*, QgsPalLayerSettings&gt;::iterator lit;
<a name="l00924"></a>00924   <span class="keywordflow">for</span> ( lit = <a class="code" href="classQgsPalLabeling.html#a1ed04621a8c1dc1056eca5da0ae341e">mActiveLayers</a>.begin(); lit != <a class="code" href="classQgsPalLabeling.html#a1ed04621a8c1dc1056eca5da0ae341e">mActiveLayers</a>.end(); ++lit )
<a name="l00925"></a>00925   {
<a name="l00926"></a>00926     <span class="keywordflow">if</span> ( lit.key() &amp;&amp; lit.key()-&gt;id() == layerName )
<a name="l00927"></a>00927     {
<a name="l00928"></a>00928       <span class="keywordflow">return</span> lit.value();
<a name="l00929"></a>00929     }
<a name="l00930"></a>00930   }
<a name="l00931"></a>00931   <span class="keywordflow">return</span> <a class="code" href="classQgsPalLabeling.html#a5954f7cdd58f16ef9bf3c73b6dbe5dd">mInvalidLayerSettings</a>;
<a name="l00932"></a>00932 }
<a name="l00933"></a>00933 
<a name="l00934"></a>00934 
<a name="l00935"></a><a class="code" href="classQgsPalLabeling.html#1b9f070d3be57db0c3a05b817af005c2">00935</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLabeling.html#1b9f070d3be57db0c3a05b817af005c2" title="called when the map is drawn and labels should be placed">QgsPalLabeling::drawLabeling</a>( <a class="code" href="classQgsRenderContext.html" title="Contains information about the context of a rendering operation.">QgsRenderContext</a>&amp; context )
<a name="l00936"></a>00936 {
<a name="l00937"></a>00937   Q_ASSERT( <a class="code" href="classQgsPalLabeling.html#5a8eb0bc085fc6ccadf2db7676cd94d6">mMapRenderer</a> != NULL );
<a name="l00938"></a>00938   QPainter* painter = context.<a class="code" href="classQgsRenderContext.html#3acf9ad3fc76e62c90db63bf13d7e0fb">painter</a>();
<a name="l00939"></a>00939   <a class="code" href="classQgsRectangle.html" title="A rectangle specified with double values.">QgsRectangle</a> extent = context.<a class="code" href="classQgsRenderContext.html#81f4ab07ab3420768f897386562a188a">extent</a>();
<a name="l00940"></a>00940 
<a name="l00941"></a>00941   <span class="keywordflow">if</span> ( <a class="code" href="classQgsPalLabeling.html#231decfc7ce4bce893f276d593ddab8c">mLabelSearchTree</a> )
<a name="l00942"></a>00942   {
<a name="l00943"></a>00943     <a class="code" href="classQgsPalLabeling.html#231decfc7ce4bce893f276d593ddab8c">mLabelSearchTree</a>-&gt;<a class="code" href="classQgsLabelSearchTree.html#2a828a0541c47858ada94a78f4944fc6" title="Removes and deletes all the entries.">clear</a>();
<a name="l00944"></a>00944   }
<a name="l00945"></a>00945 
<a name="l00946"></a>00946   QTime t;
<a name="l00947"></a>00947   t.start();
<a name="l00948"></a>00948 
<a name="l00949"></a>00949   <span class="comment">// do the labeling itself</span>
<a name="l00950"></a>00950   <span class="keywordtype">double</span> scale = <a class="code" href="classQgsPalLabeling.html#5a8eb0bc085fc6ccadf2db7676cd94d6">mMapRenderer</a>-&gt;<a class="code" href="classQgsMapRenderer.html#db0ff3685b4d079c5adeda8ef740bb1c">scale</a>(); <span class="comment">// scale denominator</span>
<a name="l00951"></a>00951   <a class="code" href="classQgsRectangle.html" title="A rectangle specified with double values.">QgsRectangle</a> r = extent;
<a name="l00952"></a>00952   <span class="keywordtype">double</span> bbox[] = { r.<a class="code" href="classQgsRectangle.html#949306e7574f826db80100bb3c6bcc18" title="Get the x minimum value (left side of rectangle).">xMinimum</a>(), r.<a class="code" href="classQgsRectangle.html#17947f3ca491bae3e0735a9696a74ceb" title="Get the y minimum value (bottom side of rectangle).">yMinimum</a>(), r.<a class="code" href="classQgsRectangle.html#3b3f45a9cd3ebe90c837d8401086af62" title="Get the x maximum value (right side of rectangle).">xMaximum</a>(), r.<a class="code" href="classQgsRectangle.html#962bf53c2732457edbe26e378719bf2b" title="Get the y maximum value (top side of rectangle).">yMaximum</a>() };
<a name="l00953"></a>00953 
<a name="l00954"></a>00954   std::list&lt;LabelPosition*&gt;* labels;
<a name="l00955"></a>00955   pal::Problem* problem;
<a name="l00956"></a>00956   <span class="keywordflow">try</span>
<a name="l00957"></a>00957   {
<a name="l00958"></a>00958     problem = <a class="code" href="classQgsPalLabeling.html#14bcfdc116292ba73a6f67abc635ef2c">mPal</a>-&gt;extractProblem( scale, bbox );
<a name="l00959"></a>00959   }
<a name="l00960"></a>00960   <span class="keywordflow">catch</span> ( std::exception&amp; e )
<a name="l00961"></a>00961   {
<a name="l00962"></a>00962     <a class="code" href="qgslogger_8h.html#b273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">"PAL EXCEPTION :-( "</span> + QString::fromLatin1( e.what() ) );
<a name="l00963"></a>00963     <span class="comment">//mActiveLayers.clear(); // clean up</span>
<a name="l00964"></a>00964     <span class="keywordflow">return</span>;
<a name="l00965"></a>00965   }
<a name="l00966"></a>00966 
<a name="l00967"></a>00967   <span class="keyword">const</span> <a class="code" href="classQgsMapToPixel.html" title="Perform transforms between map coordinates and device coordinates.">QgsMapToPixel</a>* xform = <a class="code" href="classQgsPalLabeling.html#5a8eb0bc085fc6ccadf2db7676cd94d6">mMapRenderer</a>-&gt;<a class="code" href="classQgsMapRenderer.html#66fddb8674563b409dd594e09770fd00">coordinateTransform</a>();
<a name="l00968"></a>00968 
<a name="l00969"></a>00969   <span class="comment">// draw rectangles with all candidates</span>
<a name="l00970"></a>00970   <span class="comment">// this is done before actual solution of the problem</span>
<a name="l00971"></a>00971   <span class="comment">// before number of candidates gets reduced</span>
<a name="l00972"></a>00972   <a class="code" href="classQgsPalLabeling.html#fd36dd981c68ed714d233a2500386a7c">mCandidates</a>.clear();
<a name="l00973"></a>00973   <span class="keywordflow">if</span> ( <a class="code" href="classQgsPalLabeling.html#d0490f7f918cd015b27697628c69aecc">mShowingCandidates</a> &amp;&amp; problem )
<a name="l00974"></a>00974   {
<a name="l00975"></a>00975     painter-&gt;setPen( QColor( 0, 0, 0, 64 ) );
<a name="l00976"></a>00976     painter-&gt;setBrush( Qt::NoBrush );
<a name="l00977"></a>00977     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; problem-&gt;getNumFeatures(); i++ )
<a name="l00978"></a>00978     {
<a name="l00979"></a>00979       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = 0; j &lt; problem-&gt;getFeatureCandidateCount( i ); j++ )
<a name="l00980"></a>00980       {
<a name="l00981"></a>00981         pal::LabelPosition* lp = problem-&gt;getFeatureCandidate( i, j );
<a name="l00982"></a>00982 
<a name="l00983"></a>00983         <a class="code" href="classQgsPalLabeling.html#1484cbfda6084fb0dcd87da9c7b5d26d">drawLabelCandidateRect</a>( lp, painter, xform );
<a name="l00984"></a>00984       }
<a name="l00985"></a>00985     }
<a name="l00986"></a>00986   }
<a name="l00987"></a>00987 
<a name="l00988"></a>00988   <span class="comment">// find the solution</span>
<a name="l00989"></a>00989   labels = <a class="code" href="classQgsPalLabeling.html#14bcfdc116292ba73a6f67abc635ef2c">mPal</a>-&gt;solveProblem( problem, <a class="code" href="classQgsPalLabeling.html#046ccd8f0f06d72c121269db9e035845">mShowingAllLabels</a> );
<a name="l00990"></a>00990 
<a name="l00991"></a>00991   <a class="code" href="qgslogger_8h.html#b273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">"LABELING work:  %1 ms ... labels# %2"</span> ).arg( t.elapsed() ).arg( labels-&gt;size() ) );
<a name="l00992"></a>00992   t.restart();
<a name="l00993"></a>00993 
<a name="l00994"></a>00994   painter-&gt;setRenderHint( QPainter::Antialiasing );
<a name="l00995"></a>00995 
<a name="l00996"></a>00996   <span class="comment">// draw the labels</span>
<a name="l00997"></a>00997   std::list&lt;LabelPosition*&gt;::iterator it = labels-&gt;begin();
<a name="l00998"></a>00998   <span class="keywordflow">for</span> ( ; it != labels-&gt;end(); ++it )
<a name="l00999"></a>00999   {
<a name="l01000"></a>01000     <a class="code" href="classQgsPalGeometry.html">QgsPalGeometry</a>* palGeometry = <span class="keyword">dynamic_cast&lt;</span> <a class="code" href="classQgsPalGeometry.html">QgsPalGeometry</a>* <span class="keyword">&gt;</span>(( *it )-&gt;getFeaturePart()-&gt;getUserGeometry() );
<a name="l01001"></a>01001     <span class="keywordflow">if</span> ( !palGeometry )
<a name="l01002"></a>01002     {
<a name="l01003"></a>01003       <span class="keywordflow">continue</span>;
<a name="l01004"></a>01004     }
<a name="l01005"></a>01005 
<a name="l01006"></a>01006     <span class="comment">//layer names</span>
<a name="l01007"></a>01007     QString layerNameUtf8 = QString::fromUtf8(( *it )-&gt;getLayerName() );
<a name="l01008"></a>01008     <span class="keywordflow">if</span> ( palGeometry-&gt;<a class="code" href="classQgsPalGeometry.html#fcd2849e424d1d12c011ef1e039a2422">isDiagram</a>() )
<a name="l01009"></a>01009     {
<a name="l01010"></a>01010       <span class="comment">//render diagram</span>
<a name="l01011"></a>01011       QHash&lt;QgsVectorLayer*, QgsDiagramLayerSettings&gt;::iterator dit = <a class="code" href="classQgsPalLabeling.html#8ee614901f550642aef22069d0fc974a">mActiveDiagramLayers</a>.begin();
<a name="l01012"></a>01012       <span class="keywordflow">for</span> ( dit = <a class="code" href="classQgsPalLabeling.html#8ee614901f550642aef22069d0fc974a">mActiveDiagramLayers</a>.begin(); dit != <a class="code" href="classQgsPalLabeling.html#8ee614901f550642aef22069d0fc974a">mActiveDiagramLayers</a>.end(); ++dit )
<a name="l01013"></a>01013       {
<a name="l01014"></a>01014         <span class="keywordflow">if</span> ( dit.key() &amp;&amp; dit.key()-&gt;id().append( <span class="stringliteral">"d"</span> ) == layerNameUtf8 )
<a name="l01015"></a>01015         {
<a name="l01016"></a>01016           <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> outPt = xform-&gt;<a class="code" href="classQgsMapToPixel.html#21f6d21d66bd292dcd68be179509c126">transform</a>(( *it )-&gt;getX(), ( *it )-&gt;getY() );
<a name="l01017"></a>01017           dit.value().renderer-&gt;renderDiagram( palGeometry-&gt;<a class="code" href="classQgsPalGeometry.html#257a751915ddc4f9e4bc174b1144602d">diagramAttributes</a>(), context, QPointF( outPt.<a class="code" href="classQgsPoint.html#14cf4897a06313074760383398ee95d5">x</a>(), outPt.<a class="code" href="classQgsPoint.html#07bd042b697bab243f4be31358d943ad">y</a>() ) );
<a name="l01018"></a>01018         }
<a name="l01019"></a>01019       }
<a name="l01020"></a>01020 
<a name="l01021"></a>01021       <span class="comment">//insert into label search tree to manipulate position interactively</span>
<a name="l01022"></a>01022       <span class="keywordflow">if</span> ( <a class="code" href="classQgsPalLabeling.html#231decfc7ce4bce893f276d593ddab8c">mLabelSearchTree</a> )
<a name="l01023"></a>01023       {
<a name="l01024"></a>01024         <span class="comment">//for diagrams, remove the additional 'd' at the end of the layer id</span>
<a name="l01025"></a>01025         QString layerId = layerNameUtf8;
<a name="l01026"></a>01026         layerId.chop( 1 );
<a name="l01027"></a>01027         <a class="code" href="classQgsPalLabeling.html#231decfc7ce4bce893f276d593ddab8c">mLabelSearchTree</a>-&gt;<a class="code" href="classQgsLabelSearchTree.html#724b0aaf76a12efa2556f9575d01fd7e" title="Inserts label position.">insertLabel</a>( *it,  QString( palGeometry-&gt;<a class="code" href="classQgsPalGeometry.html#a051906c05c755d1fdc070174eb4dc73">strId</a>() ).toInt(), layerId, true );
<a name="l01028"></a>01028       }
<a name="l01029"></a>01029       <span class="keywordflow">continue</span>;
<a name="l01030"></a>01030     }
<a name="l01031"></a>01031 
<a name="l01032"></a>01032     <span class="keyword">const</span> <a class="code" href="classQgsPalLayerSettings.html">QgsPalLayerSettings</a>&amp; lyr = <a class="code" href="classQgsPalLabeling.html#6133396353332633645806ec87792242">layer</a>( layerNameUtf8 );
<a name="l01033"></a>01033     QFont fontForLabel = lyr.<a class="code" href="classQgsPalLayerSettings.html#97f79c0709ac891e7b1157ced7156bab">textFont</a>;
<a name="l01034"></a>01034     QColor fontColor = lyr.<a class="code" href="classQgsPalLayerSettings.html#cbe45b8cb06f3d0b8f51c18919a744ba">textColor</a>;
<a name="l01035"></a>01035     <span class="keywordtype">double</span> bufferSize = lyr.<a class="code" href="classQgsPalLayerSettings.html#fbf1adda85087c82e05ba14547774e37">bufferSize</a>;
<a name="l01036"></a>01036     QColor bufferColor = lyr.<a class="code" href="classQgsPalLayerSettings.html#0aa38422710279da59e44539b064cbed">bufferColor</a>;
<a name="l01037"></a>01037 
<a name="l01038"></a>01038     <span class="comment">//apply data defined settings for the label</span>
<a name="l01039"></a>01039     <span class="comment">//font size</span>
<a name="l01040"></a>01040     QVariant dataDefinedSize = palGeometry-&gt;<a class="code" href="classQgsPalGeometry.html#d829eb35c07c88ae71d394d8c44e151f">dataDefinedValues</a>().value( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea7f337404d9060060478e5205de3e84ec">QgsPalLayerSettings::Size</a> );
<a name="l01041"></a>01041     <span class="keywordflow">if</span> ( dataDefinedSize.isValid() )
<a name="l01042"></a>01042     {
<a name="l01043"></a>01043       fontForLabel.setPixelSize( lyr.<a class="code" href="classQgsPalLayerSettings.html#46f2828a8fa0762d880fd864fc26deea" title="Calculates pixel size (considering output size should be in pixel or map units, scale...">sizeToPixel</a>( dataDefinedSize.toDouble(), context ) );
<a name="l01044"></a>01044     }
<a name="l01045"></a>01045     <span class="comment">//font color</span>
<a name="l01046"></a>01046     QVariant dataDefinedColor = palGeometry-&gt;<a class="code" href="classQgsPalGeometry.html#d829eb35c07c88ae71d394d8c44e151f">dataDefinedValues</a>().value( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3ceab0a05d2726384f314a72bf46cdf900f8">QgsPalLayerSettings::Color</a> );
<a name="l01047"></a>01047     <span class="keywordflow">if</span> ( dataDefinedColor.isValid() )
<a name="l01048"></a>01048     {
<a name="l01049"></a>01049       fontColor.setNamedColor( dataDefinedColor.toString() );
<a name="l01050"></a>01050       <span class="keywordflow">if</span> ( !fontColor.isValid() )
<a name="l01051"></a>01051       {
<a name="l01052"></a>01052         fontColor = lyr.<a class="code" href="classQgsPalLayerSettings.html#cbe45b8cb06f3d0b8f51c18919a744ba">textColor</a>;
<a name="l01053"></a>01053       }
<a name="l01054"></a>01054     }
<a name="l01055"></a>01055     <span class="comment">//font bold</span>
<a name="l01056"></a>01056     QVariant dataDefinedBold = palGeometry-&gt;<a class="code" href="classQgsPalGeometry.html#d829eb35c07c88ae71d394d8c44e151f">dataDefinedValues</a>().value( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea35ab7b17a948c256ba6ca6089e0a5415">QgsPalLayerSettings::Bold</a> );
<a name="l01057"></a>01057     <span class="keywordflow">if</span> ( dataDefinedBold.isValid() )
<a name="l01058"></a>01058     {
<a name="l01059"></a>01059       fontForLabel.setBold(( <span class="keywordtype">bool</span> )dataDefinedBold.toInt() );
<a name="l01060"></a>01060     }
<a name="l01061"></a>01061     <span class="comment">//font italic</span>
<a name="l01062"></a>01062     QVariant dataDefinedItalic = palGeometry-&gt;<a class="code" href="classQgsPalGeometry.html#d829eb35c07c88ae71d394d8c44e151f">dataDefinedValues</a>().value( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea8ed7b53c4acd14091160feb3954da0a3">QgsPalLayerSettings::Italic</a> );
<a name="l01063"></a>01063     <span class="keywordflow">if</span> ( dataDefinedItalic.isValid() )
<a name="l01064"></a>01064     {
<a name="l01065"></a>01065       fontForLabel.setItalic(( <span class="keywordtype">bool</span> ) dataDefinedItalic.toInt() );
<a name="l01066"></a>01066     }
<a name="l01067"></a>01067     <span class="comment">//font underline</span>
<a name="l01068"></a>01068     QVariant dataDefinedUnderline = palGeometry-&gt;<a class="code" href="classQgsPalGeometry.html#d829eb35c07c88ae71d394d8c44e151f">dataDefinedValues</a>().value( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea2aa75696a4bd40eea9dcb40cfaf44837">QgsPalLayerSettings::Underline</a> );
<a name="l01069"></a>01069     <span class="keywordflow">if</span> ( dataDefinedUnderline.isValid() )
<a name="l01070"></a>01070     {
<a name="l01071"></a>01071       fontForLabel.setUnderline(( <span class="keywordtype">bool</span> ) dataDefinedUnderline.toInt() );
<a name="l01072"></a>01072     }
<a name="l01073"></a>01073     <span class="comment">//font strikeout</span>
<a name="l01074"></a>01074     QVariant dataDefinedStrikeout = palGeometry-&gt;<a class="code" href="classQgsPalGeometry.html#d829eb35c07c88ae71d394d8c44e151f">dataDefinedValues</a>().value( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea225ff1b41357a4b1e48a897b122ddd45">QgsPalLayerSettings::Strikeout</a> );
<a name="l01075"></a>01075     <span class="keywordflow">if</span> ( dataDefinedStrikeout.isValid() )
<a name="l01076"></a>01076     {
<a name="l01077"></a>01077       fontForLabel.setStrikeOut(( <span class="keywordtype">bool</span> ) dataDefinedStrikeout.toInt() );
<a name="l01078"></a>01078     }
<a name="l01079"></a>01079     <span class="comment">//font family</span>
<a name="l01080"></a>01080     QVariant dataDefinedFontFamily = palGeometry-&gt;<a class="code" href="classQgsPalGeometry.html#d829eb35c07c88ae71d394d8c44e151f">dataDefinedValues</a>().value( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3ceae4a378482d89e27d52b7078a25cd2b8a">QgsPalLayerSettings::Family</a> );
<a name="l01081"></a>01081     <span class="keywordflow">if</span> ( dataDefinedFontFamily.isValid() )
<a name="l01082"></a>01082     {
<a name="l01083"></a>01083       fontForLabel.setFamily( dataDefinedFontFamily.toString() );
<a name="l01084"></a>01084     }
<a name="l01085"></a>01085     <span class="comment">//buffer size</span>
<a name="l01086"></a>01086     QVariant dataDefinedBufferSize = palGeometry-&gt;<a class="code" href="classQgsPalGeometry.html#d829eb35c07c88ae71d394d8c44e151f">dataDefinedValues</a>().value( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea46b800f2f7f82bfe1cc28ddcd25b972e">QgsPalLayerSettings::BufferSize</a> );
<a name="l01087"></a>01087     <span class="keywordflow">if</span> ( dataDefinedBufferSize.isValid() )
<a name="l01088"></a>01088     {
<a name="l01089"></a>01089       bufferSize = dataDefinedBufferSize.toDouble();
<a name="l01090"></a>01090     }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092     <span class="comment">//buffer color</span>
<a name="l01093"></a>01093     QVariant dataDefinedBufferColor = palGeometry-&gt;<a class="code" href="classQgsPalGeometry.html#d829eb35c07c88ae71d394d8c44e151f">dataDefinedValues</a>().value( <a class="code" href="classQgsPalLayerSettings.html#a4a68d8eea503219523ce0c7f0ba3cea17b8f0a3d267cfd3d448032c13167c7f">QgsPalLayerSettings::BufferColor</a> );
<a name="l01094"></a>01094     <span class="keywordflow">if</span> ( dataDefinedBufferColor.isValid() )
<a name="l01095"></a>01095     {
<a name="l01096"></a>01096       bufferColor.setNamedColor( dataDefinedBufferColor.toString() );
<a name="l01097"></a>01097       <span class="keywordflow">if</span> ( !bufferColor.isValid() )
<a name="l01098"></a>01098       {
<a name="l01099"></a>01099         bufferColor = lyr.<a class="code" href="classQgsPalLayerSettings.html#0aa38422710279da59e44539b064cbed">bufferColor</a>;
<a name="l01100"></a>01100       }
<a name="l01101"></a>01101     }
<a name="l01102"></a>01102 
<a name="l01103"></a>01103     <span class="keywordflow">if</span> ( lyr.<a class="code" href="classQgsPalLayerSettings.html#fbf1adda85087c82e05ba14547774e37">bufferSize</a> != 0 )
<a name="l01104"></a>01104       <a class="code" href="classQgsPalLabeling.html#089fac9dc35e9b87a640fd6976aa7a36" title="drawLabel">drawLabel</a>( *it, painter, fontForLabel, fontColor, xform, bufferSize, bufferColor, <span class="keyword">true</span> );
<a name="l01105"></a>01105 
<a name="l01106"></a>01106     <a class="code" href="classQgsPalLabeling.html#089fac9dc35e9b87a640fd6976aa7a36" title="drawLabel">drawLabel</a>( *it, painter, fontForLabel, fontColor, xform );
<a name="l01107"></a>01107 
<a name="l01108"></a>01108     <span class="keywordflow">if</span> ( <a class="code" href="classQgsPalLabeling.html#231decfc7ce4bce893f276d593ddab8c">mLabelSearchTree</a> )
<a name="l01109"></a>01109     {
<a name="l01110"></a>01110       <a class="code" href="classQgsPalLabeling.html#231decfc7ce4bce893f276d593ddab8c">mLabelSearchTree</a>-&gt;<a class="code" href="classQgsLabelSearchTree.html#724b0aaf76a12efa2556f9575d01fd7e" title="Inserts label position.">insertLabel</a>( *it,  QString( palGeometry-&gt;<a class="code" href="classQgsPalGeometry.html#a051906c05c755d1fdc070174eb4dc73">strId</a>() ).toInt(), ( *it )-&gt;getLayerName() );
<a name="l01111"></a>01111     }
<a name="l01112"></a>01112   }
<a name="l01113"></a>01113 
<a name="l01114"></a>01114   <a class="code" href="qgslogger_8h.html#b273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">"LABELING draw:  %1 ms"</span> ).arg( t.elapsed() ) );
<a name="l01115"></a>01115 
<a name="l01116"></a>01116   <span class="keyword">delete</span> problem;
<a name="l01117"></a>01117   <span class="keyword">delete</span> labels;
<a name="l01118"></a>01118 
<a name="l01119"></a>01119   <span class="comment">// delete all allocated geometries for features</span>
<a name="l01120"></a>01120   QHash&lt;QgsVectorLayer*, QgsPalLayerSettings&gt;::iterator lit;
<a name="l01121"></a>01121   <span class="keywordflow">for</span> ( lit = <a class="code" href="classQgsPalLabeling.html#a1ed04621a8c1dc1056eca5da0ae341e">mActiveLayers</a>.begin(); lit != <a class="code" href="classQgsPalLabeling.html#a1ed04621a8c1dc1056eca5da0ae341e">mActiveLayers</a>.end(); ++lit )
<a name="l01122"></a>01122   {
<a name="l01123"></a>01123     <a class="code" href="classQgsPalLayerSettings.html">QgsPalLayerSettings</a>&amp; lyr = lit.value();
<a name="l01124"></a>01124     <span class="keywordflow">for</span> ( QList&lt;QgsPalGeometry*&gt;::iterator git = lyr.<a class="code" href="classQgsPalLayerSettings.html#2cacdf8357f4cce05062ac73506f16ea">geometries</a>.begin(); git != lyr.<a class="code" href="classQgsPalLayerSettings.html#2cacdf8357f4cce05062ac73506f16ea">geometries</a>.end(); ++git )
<a name="l01125"></a>01125       <span class="keyword">delete</span> *git;
<a name="l01126"></a>01126     lyr.<a class="code" href="classQgsPalLayerSettings.html#2cacdf8357f4cce05062ac73506f16ea">geometries</a>.clear();
<a name="l01127"></a>01127   }
<a name="l01128"></a>01128 
<a name="l01129"></a>01129   <span class="comment">//delete all allocated geometries for diagrams</span>
<a name="l01130"></a>01130   QHash&lt;QgsVectorLayer*, QgsDiagramLayerSettings&gt;::iterator dIt = <a class="code" href="classQgsPalLabeling.html#8ee614901f550642aef22069d0fc974a">mActiveDiagramLayers</a>.begin();
<a name="l01131"></a>01131   <span class="keywordflow">for</span> ( ; dIt != <a class="code" href="classQgsPalLabeling.html#8ee614901f550642aef22069d0fc974a">mActiveDiagramLayers</a>.end(); ++dIt )
<a name="l01132"></a>01132   {
<a name="l01133"></a>01133     <a class="code" href="structQgsDiagramLayerSettings.html">QgsDiagramLayerSettings</a>&amp; dls = dIt.value();
<a name="l01134"></a>01134     <span class="keywordflow">for</span> ( QList&lt;QgsPalGeometry*&gt;::iterator git = dls.<a class="code" href="structQgsDiagramLayerSettings.html#c033a211b77dec28fa8c5089423840a7">geometries</a>.begin(); git != dls.<a class="code" href="structQgsDiagramLayerSettings.html#c033a211b77dec28fa8c5089423840a7">geometries</a>.end(); ++git )
<a name="l01135"></a>01135     {
<a name="l01136"></a>01136       <span class="keyword">delete</span> *git;
<a name="l01137"></a>01137     }
<a name="l01138"></a>01138     dls.<a class="code" href="structQgsDiagramLayerSettings.html#c033a211b77dec28fa8c5089423840a7">geometries</a>.clear();
<a name="l01139"></a>01139   }
<a name="l01140"></a>01140 }
<a name="l01141"></a>01141 
<a name="l01142"></a><a class="code" href="classQgsPalLabeling.html#8670e0765294d2ea1e73092389d8911f">01142</a> QList&lt;QgsLabelPosition&gt; <a class="code" href="classQgsPalLabeling.html#8670e0765294d2ea1e73092389d8911f" title="return infos about labels at a given (map) position">QgsPalLabeling::labelsAtPosition</a>( <span class="keyword">const</span> <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a>&amp; p )
<a name="l01143"></a>01143 {
<a name="l01144"></a>01144   QList&lt;QgsLabelPosition&gt; positions;
<a name="l01145"></a>01145 
<a name="l01146"></a>01146   QList&lt;QgsLabelPosition*&gt; positionPointers;
<a name="l01147"></a>01147   <span class="keywordflow">if</span> ( <a class="code" href="classQgsPalLabeling.html#231decfc7ce4bce893f276d593ddab8c">mLabelSearchTree</a> )
<a name="l01148"></a>01148   {
<a name="l01149"></a>01149     <a class="code" href="classQgsPalLabeling.html#231decfc7ce4bce893f276d593ddab8c">mLabelSearchTree</a>-&gt;<a class="code" href="classQgsLabelSearchTree.html#895a01021537200f0071ec1d735e9710" title="Returns label position(s) at a given point.">label</a>( p, positionPointers );
<a name="l01150"></a>01150     QList&lt;QgsLabelPosition*&gt;::const_iterator pointerIt = positionPointers.constBegin();
<a name="l01151"></a>01151     <span class="keywordflow">for</span> ( ; pointerIt != positionPointers.constEnd(); ++pointerIt )
<a name="l01152"></a>01152     {
<a name="l01153"></a>01153       positions.push_back( <a class="code" href="structQgsLabelPosition.html">QgsLabelPosition</a>( **pointerIt ) );
<a name="l01154"></a>01154     }
<a name="l01155"></a>01155   }
<a name="l01156"></a>01156 
<a name="l01157"></a>01157   <span class="keywordflow">return</span> positions;
<a name="l01158"></a>01158 }
<a name="l01159"></a>01159 
<a name="l01160"></a><a class="code" href="classQgsPalLabeling.html#bc8188ed1921763c0e7a11deb7a9eed4">01160</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLabeling.html#bc8188ed1921763c0e7a11deb7a9eed4">QgsPalLabeling::numCandidatePositions</a>( <span class="keywordtype">int</span>&amp; candPoint, <span class="keywordtype">int</span>&amp; candLine, <span class="keywordtype">int</span>&amp; candPolygon )
<a name="l01161"></a>01161 {
<a name="l01162"></a>01162   candPoint = <a class="code" href="classQgsPalLabeling.html#f2bc6088527baa7f003a2f819232916e">mCandPoint</a>;
<a name="l01163"></a>01163   candLine = <a class="code" href="classQgsPalLabeling.html#26f75105583ca23d283306535f6d9282">mCandLine</a>;
<a name="l01164"></a>01164   candPolygon = <a class="code" href="classQgsPalLabeling.html#81e516776581bf7d7bb4d7bda1d70d0c">mCandPolygon</a>;
<a name="l01165"></a>01165 }
<a name="l01166"></a>01166 
<a name="l01167"></a><a class="code" href="classQgsPalLabeling.html#8e68b75581d43c27c2af4b297738ae78">01167</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLabeling.html#8e68b75581d43c27c2af4b297738ae78">QgsPalLabeling::setNumCandidatePositions</a>( <span class="keywordtype">int</span> candPoint, <span class="keywordtype">int</span> candLine, <span class="keywordtype">int</span> candPolygon )
<a name="l01168"></a>01168 {
<a name="l01169"></a>01169   <a class="code" href="classQgsPalLabeling.html#f2bc6088527baa7f003a2f819232916e">mCandPoint</a> = candPoint;
<a name="l01170"></a>01170   <a class="code" href="classQgsPalLabeling.html#26f75105583ca23d283306535f6d9282">mCandLine</a> = candLine;
<a name="l01171"></a>01171   <a class="code" href="classQgsPalLabeling.html#81e516776581bf7d7bb4d7bda1d70d0c">mCandPolygon</a> = candPolygon;
<a name="l01172"></a>01172 }
<a name="l01173"></a>01173 
<a name="l01174"></a><a class="code" href="classQgsPalLabeling.html#3c97f127c6f800e907e3872703850a6f">01174</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLabeling.html#3c97f127c6f800e907e3872703850a6f">QgsPalLabeling::setSearchMethod</a>( <a class="code" href="classQgsPalLabeling.html#9c65d87be36faf21e0aef681f8bf59f0">QgsPalLabeling::Search</a> s )
<a name="l01175"></a>01175 {
<a name="l01176"></a>01176   <a class="code" href="classQgsPalLabeling.html#b26053e4fced553b3d08f0ebd2582e3c">mSearch</a> = s;
<a name="l01177"></a>01177 }
<a name="l01178"></a>01178 
<a name="l01179"></a><a class="code" href="classQgsPalLabeling.html#845052f4d8845d6416deb9989355a173">01179</a> <a class="code" href="classQgsPalLabeling.html#9c65d87be36faf21e0aef681f8bf59f0">QgsPalLabeling::Search</a> <a class="code" href="classQgsPalLabeling.html#845052f4d8845d6416deb9989355a173">QgsPalLabeling::searchMethod</a>()<span class="keyword"> const</span>
<a name="l01180"></a>01180 <span class="keyword"></span>{
<a name="l01181"></a>01181   <span class="keywordflow">return</span> <a class="code" href="classQgsPalLabeling.html#b26053e4fced553b3d08f0ebd2582e3c">mSearch</a>;
<a name="l01182"></a>01182 }
<a name="l01183"></a>01183 
<a name="l01184"></a><a class="code" href="classQgsPalLabeling.html#1484cbfda6084fb0dcd87da9c7b5d26d">01184</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLabeling.html#1484cbfda6084fb0dcd87da9c7b5d26d">QgsPalLabeling::drawLabelCandidateRect</a>( pal::LabelPosition* lp, QPainter* painter, <span class="keyword">const</span> <a class="code" href="classQgsMapToPixel.html" title="Perform transforms between map coordinates and device coordinates.">QgsMapToPixel</a>* xform )
<a name="l01185"></a>01185 {
<a name="l01186"></a>01186   <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> outPt = xform-&gt;<a class="code" href="classQgsMapToPixel.html#21f6d21d66bd292dcd68be179509c126">transform</a>( lp-&gt;getX(), lp-&gt;getY() );
<a name="l01187"></a>01187   <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> outPt2 = xform-&gt;<a class="code" href="classQgsMapToPixel.html#21f6d21d66bd292dcd68be179509c126">transform</a>( lp-&gt;getX() + lp-&gt;getWidth(), lp-&gt;getY() + lp-&gt;getHeight() );
<a name="l01188"></a>01188 
<a name="l01189"></a>01189   painter-&gt;save();
<a name="l01190"></a>01190   painter-&gt;translate( QPointF( outPt.<a class="code" href="classQgsPoint.html#14cf4897a06313074760383398ee95d5">x</a>(), outPt.<a class="code" href="classQgsPoint.html#07bd042b697bab243f4be31358d943ad">y</a>() ) );
<a name="l01191"></a>01191   painter-&gt;rotate( -lp-&gt;getAlpha() * 180 / <a class="code" href="qgsdistancearea_8cpp.html#e71449b1cc6e6250b91f539153a7a0d3">M_PI</a> );
<a name="l01192"></a>01192   QRectF rect( 0, 0, outPt2.<a class="code" href="classQgsPoint.html#14cf4897a06313074760383398ee95d5">x</a>() - outPt.<a class="code" href="classQgsPoint.html#14cf4897a06313074760383398ee95d5">x</a>(), outPt2.<a class="code" href="classQgsPoint.html#07bd042b697bab243f4be31358d943ad">y</a>() - outPt.<a class="code" href="classQgsPoint.html#07bd042b697bab243f4be31358d943ad">y</a>() );
<a name="l01193"></a>01193   painter-&gt;drawRect( rect );
<a name="l01194"></a>01194   painter-&gt;restore();
<a name="l01195"></a>01195 
<a name="l01196"></a>01196   <span class="comment">// save the rect</span>
<a name="l01197"></a>01197   rect.moveTo( outPt.<a class="code" href="classQgsPoint.html#14cf4897a06313074760383398ee95d5">x</a>(), outPt.<a class="code" href="classQgsPoint.html#07bd042b697bab243f4be31358d943ad">y</a>() );
<a name="l01198"></a>01198   <a class="code" href="classQgsPalLabeling.html#fd36dd981c68ed714d233a2500386a7c">mCandidates</a>.append( <a class="code" href="classQgsLabelCandidate.html">QgsLabelCandidate</a>( rect, lp-&gt;getCost() * 1000 ) );
<a name="l01199"></a>01199 
<a name="l01200"></a>01200   <span class="comment">// show all parts of the multipart label</span>
<a name="l01201"></a>01201   <span class="keywordflow">if</span> ( lp-&gt;getNextPart() )
<a name="l01202"></a>01202     <a class="code" href="classQgsPalLabeling.html#1484cbfda6084fb0dcd87da9c7b5d26d">drawLabelCandidateRect</a>( lp-&gt;getNextPart(), painter, xform );
<a name="l01203"></a>01203 }
<a name="l01204"></a>01204 
<a name="l01205"></a><a class="code" href="classQgsPalLabeling.html#089fac9dc35e9b87a640fd6976aa7a36">01205</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLabeling.html#089fac9dc35e9b87a640fd6976aa7a36" title="drawLabel">QgsPalLabeling::drawLabel</a>( pal::LabelPosition* label, QPainter* painter, <span class="keyword">const</span> QFont&amp; f, <span class="keyword">const</span> QColor&amp; c, <span class="keyword">const</span> <a class="code" href="classQgsMapToPixel.html" title="Perform transforms between map coordinates and device coordinates.">QgsMapToPixel</a>* xform, <span class="keywordtype">double</span> bufferSize,
<a name="l01206"></a>01206                                 <span class="keyword">const</span> QColor&amp; bufferColor, <span class="keywordtype">bool</span> drawBuffer )
<a name="l01207"></a>01207 {
<a name="l01208"></a>01208   <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> outPt = xform-&gt;<a class="code" href="classQgsMapToPixel.html#21f6d21d66bd292dcd68be179509c126">transform</a>( label-&gt;getX(), label-&gt;getY() );
<a name="l01209"></a>01209 
<a name="l01210"></a>01210   <span class="comment">// TODO: optimize access :)</span>
<a name="l01211"></a>01211   <span class="keyword">const</span> <a class="code" href="classQgsPalLayerSettings.html">QgsPalLayerSettings</a>&amp; lyr = <a class="code" href="classQgsPalLabeling.html#6133396353332633645806ec87792242">layer</a>( QString::fromUtf8( label-&gt;getLayerName() ) );
<a name="l01212"></a>01212 
<a name="l01213"></a>01213   QString text = (( <a class="code" href="classQgsPalGeometry.html">QgsPalGeometry</a>* )label-&gt;getFeaturePart()-&gt;getUserGeometry() )-&gt;text();
<a name="l01214"></a>01214   QString txt = ( label-&gt;getPartId() == -1 ? text : QString( text[label-&gt;getPartId()] ) );
<a name="l01215"></a>01215 
<a name="l01216"></a>01216   <span class="comment">//add the direction symbol if needed</span>
<a name="l01217"></a>01217   <span class="keywordflow">if</span> ( !txt.isEmpty() &amp;&amp; lyr.<a class="code" href="classQgsPalLayerSettings.html#de0e96125f5d912953b168a736d2e09b">placement</a> == <a class="code" href="classQgsPalLayerSettings.html#5d449d8e9cb89e5d453c6e33fe1c66cc4f3d6d88545bf3e32ed488e4a082f471">QgsPalLayerSettings::Line</a> &amp;&amp;
<a name="l01218"></a>01218        lyr.<a class="code" href="classQgsPalLayerSettings.html#499be91338f5ee41c56f4a88e7247450">addDirectionSymbol</a> &amp;&amp; !lyr.<a class="code" href="classQgsPalLayerSettings.html#477a4aa6642a5e47c6f3c3332b1ef6e5">multiLineLabels</a> )
<a name="l01219"></a>01219   {
<a name="l01220"></a>01220     <span class="keywordflow">if</span> ( label-&gt;getReversed() )
<a name="l01221"></a>01221     {
<a name="l01222"></a>01222       txt.prepend( <span class="stringliteral">"&lt;"</span> );
<a name="l01223"></a>01223     }
<a name="l01224"></a>01224     <span class="keywordflow">else</span>
<a name="l01225"></a>01225     {
<a name="l01226"></a>01226       txt.append( <span class="stringliteral">"&gt;"</span> );
<a name="l01227"></a>01227     }
<a name="l01228"></a>01228   }
<a name="l01229"></a>01229 
<a name="l01230"></a>01230   <span class="comment">//QgsDebugMsg( "drawLabel " + QString::number( drawBuffer ) + " " + txt );</span>
<a name="l01231"></a>01231 
<a name="l01232"></a>01232   QStringList multiLineList;
<a name="l01233"></a>01233   <span class="keywordflow">if</span> ( lyr.<a class="code" href="classQgsPalLayerSettings.html#477a4aa6642a5e47c6f3c3332b1ef6e5">multiLineLabels</a> )
<a name="l01234"></a>01234   {
<a name="l01235"></a>01235     multiLineList = txt.split( <span class="stringliteral">"\n"</span> );
<a name="l01236"></a>01236   }
<a name="l01237"></a>01237   <span class="keywordflow">else</span>
<a name="l01238"></a>01238   {
<a name="l01239"></a>01239     multiLineList &lt;&lt; txt;
<a name="l01240"></a>01240   }
<a name="l01241"></a>01241 
<a name="l01242"></a>01242   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; multiLineList.size(); ++i )
<a name="l01243"></a>01243   {
<a name="l01244"></a>01244     painter-&gt;save();
<a name="l01245"></a>01245     painter-&gt;translate( QPointF( outPt.<a class="code" href="classQgsPoint.html#14cf4897a06313074760383398ee95d5">x</a>(), outPt.<a class="code" href="classQgsPoint.html#07bd042b697bab243f4be31358d943ad">y</a>() ) );
<a name="l01246"></a>01246     painter-&gt;rotate( -label-&gt;getAlpha() * 180 / <a class="code" href="qgsdistancearea_8cpp.html#e71449b1cc6e6250b91f539153a7a0d3">M_PI</a> );
<a name="l01247"></a>01247 
<a name="l01248"></a>01248     <span class="comment">// scale down painter: the font size has been multiplied by raster scale factor</span>
<a name="l01249"></a>01249     <span class="comment">// to workaround a Qt font scaling bug with small font sizes</span>
<a name="l01250"></a>01250     painter-&gt;scale( 1.0 / lyr.<a class="code" href="classQgsPalLayerSettings.html#31d35efbd75cb3c342b98300cc1693cf">rasterCompressFactor</a>, 1.0 / lyr.<a class="code" href="classQgsPalLayerSettings.html#31d35efbd75cb3c342b98300cc1693cf">rasterCompressFactor</a> );
<a name="l01251"></a>01251 
<a name="l01252"></a>01252     <span class="keywordtype">double</span> yMultiLineOffset = ( multiLineList.size() - 1 - i ) * lyr.<a class="code" href="classQgsPalLayerSettings.html#085fcc0331f3f3ca085826a55f41f463">fontMetrics</a>-&gt;height();
<a name="l01253"></a>01253     painter-&gt;translate( QPointF( 0, - lyr.<a class="code" href="classQgsPalLayerSettings.html#085fcc0331f3f3ca085826a55f41f463">fontMetrics</a>-&gt;descent() - yMultiLineOffset ) );
<a name="l01254"></a>01254 
<a name="l01255"></a>01255     <span class="keywordflow">if</span> ( drawBuffer )
<a name="l01256"></a>01256     {
<a name="l01257"></a>01257       <span class="comment">// we're drawing buffer</span>
<a name="l01258"></a>01258       <a class="code" href="classQgsPalLabeling.html#75cda3b31e078dc004e84796cf7427f2">drawLabelBuffer</a>( painter, multiLineList.at( i ), f, bufferSize * lyr.<a class="code" href="classQgsPalLayerSettings.html#451e4e4bb95a04422ec5b3f583113297">vectorScaleFactor</a> * lyr.<a class="code" href="classQgsPalLayerSettings.html#31d35efbd75cb3c342b98300cc1693cf">rasterCompressFactor</a> , bufferColor );
<a name="l01259"></a>01259     }
<a name="l01260"></a>01260     <span class="keywordflow">else</span>
<a name="l01261"></a>01261     {
<a name="l01262"></a>01262       <span class="comment">// we're drawing real label</span>
<a name="l01263"></a>01263       QPainterPath path;
<a name="l01264"></a>01264       path.addText( 0, 0, f, multiLineList.at( i ) );
<a name="l01265"></a>01265       painter-&gt;setPen( Qt::NoPen );
<a name="l01266"></a>01266       painter-&gt;setBrush( c );
<a name="l01267"></a>01267       painter-&gt;drawPath( path );
<a name="l01268"></a>01268     }
<a name="l01269"></a>01269     painter-&gt;restore();
<a name="l01270"></a>01270 
<a name="l01271"></a>01271     <span class="keywordflow">if</span> ( label-&gt;getNextPart() )
<a name="l01272"></a>01272       <a class="code" href="classQgsPalLabeling.html#089fac9dc35e9b87a640fd6976aa7a36" title="drawLabel">drawLabel</a>( label-&gt;getNextPart(), painter, f, c, xform, bufferSize, bufferColor, drawBuffer );
<a name="l01273"></a>01273   }
<a name="l01274"></a>01274 }
<a name="l01275"></a>01275 
<a name="l01276"></a>01276 
<a name="l01277"></a><a class="code" href="classQgsPalLabeling.html#75cda3b31e078dc004e84796cf7427f2">01277</a> <span class="keywordtype">void</span> <a class="code" href="classQgsPalLabeling.html#75cda3b31e078dc004e84796cf7427f2">QgsPalLabeling::drawLabelBuffer</a>( QPainter* p, QString text, <span class="keyword">const</span> QFont&amp; font, <span class="keywordtype">double</span> size, QColor color )
<a name="l01278"></a>01278 {
<a name="l01279"></a>01279   QPainterPath path;
<a name="l01280"></a>01280   path.addText( 0, 0, font, text );
<a name="l01281"></a>01281   QPen pen( color );
<a name="l01282"></a>01282   pen.setWidthF( size );
<a name="l01283"></a>01283   p-&gt;setPen( pen );
<a name="l01284"></a>01284   p-&gt;setBrush( color );
<a name="l01285"></a>01285   p-&gt;drawPath( path );
<a name="l01286"></a>01286 }
<a name="l01287"></a>01287 
<a name="l01288"></a><a class="code" href="classQgsPalLabeling.html#7e1656a2380853ad6bf07aeabacbd737">01288</a> <a class="code" href="classQgsLabelingEngineInterface.html" title="Labeling engine interface.">QgsLabelingEngineInterface</a>* <a class="code" href="classQgsPalLabeling.html#7e1656a2380853ad6bf07aeabacbd737" title="called when passing engine among map renderers">QgsPalLabeling::clone</a>()
<a name="l01289"></a>01289 {
<a name="l01290"></a>01290   <a class="code" href="classQgsPalLabeling.html">QgsPalLabeling</a>* lbl = <span class="keyword">new</span> <a class="code" href="classQgsPalLabeling.html#add90f8184fad8efb262f44b42dffdbc">QgsPalLabeling</a>();
<a name="l01291"></a>01291   lbl-&gt;<a class="code" href="classQgsPalLabeling.html#046ccd8f0f06d72c121269db9e035845">mShowingAllLabels</a> = <a class="code" href="classQgsPalLabeling.html#046ccd8f0f06d72c121269db9e035845">mShowingAllLabels</a>;
<a name="l01292"></a>01292   lbl-&gt;<a class="code" href="classQgsPalLabeling.html#d0490f7f918cd015b27697628c69aecc">mShowingCandidates</a> = <a class="code" href="classQgsPalLabeling.html#d0490f7f918cd015b27697628c69aecc">mShowingCandidates</a>;
<a name="l01293"></a>01293   <span class="keywordflow">return</span> lbl;
<a name="l01294"></a>01294 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Sat Feb 4 19:08:32 2012 for Quantum GIS API Documentation by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
