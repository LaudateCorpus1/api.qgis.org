<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Quantum GIS API Documentation: src/core/qgscoordinatereferencesystem.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Quantum GIS API Documentation
   &#160;<span id="projectnumber">1.7.4</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">src/core/qgscoordinatereferencesystem.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="qgscoordinatereferencesystem_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/***************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">                          qgscoordinatereferencesystem.cpp</span>
<a name="l00003"></a>00003 <span class="comment"></span>
<a name="l00004"></a>00004 <span class="comment">                             -------------------</span>
<a name="l00005"></a>00005 <span class="comment">    begin                : 2007</span>
<a name="l00006"></a>00006 <span class="comment">    copyright            : (C) 2007 by Gary E. Sherman</span>
<a name="l00007"></a>00007 <span class="comment">    email                : sherman@mrcc.com</span>
<a name="l00008"></a>00008 <span class="comment">***************************************************************************/</span>
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="comment">/***************************************************************************</span>
<a name="l00011"></a>00011 <span class="comment"> *                                                                         *</span>
<a name="l00012"></a>00012 <span class="comment"> *   This program is free software; you can redistribute it and/or modify  *</span>
<a name="l00013"></a>00013 <span class="comment"> *   it under the terms of the GNU General Public License as published by  *</span>
<a name="l00014"></a>00014 <span class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</span>
<a name="l00015"></a>00015 <span class="comment"> *   (at your option) any later version.                                   *</span>
<a name="l00016"></a>00016 <span class="comment"> *                                                                         *</span>
<a name="l00017"></a>00017 <span class="comment"> ***************************************************************************/</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="qgscoordinatereferencesystem_8h.html">qgscoordinatereferencesystem.h</a>&quot;</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;cmath&gt;</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;QDir&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;QDomNode&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;QDomElement&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;QFileInfo&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;QRegExp&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;QTextStream&gt;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="qgsapplication_8h.html">qgsapplication.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="qgslogger_8h.html">qgslogger.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="qgsmessageoutput_8h.html">qgsmessageoutput.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="qgis_8h.html">qgis.h</a>&quot;</span> <span class="comment">//const vals declared here</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;sqlite3.h&gt;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="comment">//gdal and ogr includes (needed for == operator)</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;ogr_srs_api.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;cpl_error.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;cpl_conv.h&gt;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <a class="code" href="qgscoordinatereferencesystem_8h.html#ad0aecc3490d74e11de09480b91ea1f84">CUSTOM_CRS_VALIDATION</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a00027ee17ae6306f819322fe8ee6dc8d">QgsCoordinateReferenceSystem::mCustomSrsValidation</a> = NULL;
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="comment">//--------------------------</span>
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a51fef08cdc3353f9c6d5073981cefdc9">00045</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a51fef08cdc3353f9c6d5073981cefdc9" title="Default constructor.">QgsCoordinateReferenceSystem::QgsCoordinateReferenceSystem</a>()
<a name="l00046"></a>00046     : mMapUnits( <a class="code" href="classQGis.html" title="The QGis class provides global constants for use throughout the application.">QGis</a>::UnknownUnit )
<a name="l00047"></a>00047     , mIsValidFlag( 0 )
<a name="l00048"></a>00048     , mValidationHint( <span class="stringliteral">&quot;&quot;</span> )
<a name="l00049"></a>00049 {
<a name="l00050"></a>00050   <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> = OSRNewSpatialReference( NULL );
<a name="l00051"></a>00051 }
<a name="l00052"></a>00052 
<a name="l00053"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a89e5f9aa6b0522a2250ee7f7f0ce1048">00053</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a51fef08cdc3353f9c6d5073981cefdc9" title="Default constructor.">QgsCoordinateReferenceSystem::QgsCoordinateReferenceSystem</a>( QString theDefinition )
<a name="l00054"></a>00054     : mMapUnits( <a class="code" href="classQGis.html" title="The QGis class provides global constants for use throughout the application.">QGis</a>::UnknownUnit )
<a name="l00055"></a>00055     , mIsValidFlag( 0 )
<a name="l00056"></a>00056     , mValidationHint( <span class="stringliteral">&quot;&quot;</span> )
<a name="l00057"></a>00057 {
<a name="l00058"></a>00058   <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> = OSRNewSpatialReference( NULL );
<a name="l00059"></a>00059   <a class="code" href="classQgsCoordinateReferenceSystem.html#a8f0ea02f25d97b26f276e5773b2f1819">createFromString</a>( theDefinition );
<a name="l00060"></a>00060 }
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ab9678cc60493eb0a0df77151866a368c">00063</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a51fef08cdc3353f9c6d5073981cefdc9" title="Default constructor.">QgsCoordinateReferenceSystem::QgsCoordinateReferenceSystem</a>( <span class="keyword">const</span> <span class="keywordtype">long</span> theId, <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cf">CrsType</a> theType )
<a name="l00064"></a>00064     : mMapUnits( <a class="code" href="classQGis.html" title="The QGis class provides global constants for use throughout the application.">QGis</a>::UnknownUnit )
<a name="l00065"></a>00065     , mIsValidFlag( 0 )
<a name="l00066"></a>00066     , mValidationHint( <span class="stringliteral">&quot;&quot;</span> )
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068   <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> = OSRNewSpatialReference( NULL );
<a name="l00069"></a>00069   <a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9fd9c20f2b6c8e7cbd1114205d0ec5">createFromId</a>( theId, theType );
<a name="l00070"></a>00070 }
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a11b56d68ff28a4c7505e097336de7a4c">00072</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a11b56d68ff28a4c7505e097336de7a4c">QgsCoordinateReferenceSystem::~QgsCoordinateReferenceSystem</a>()
<a name="l00073"></a>00073 {
<a name="l00074"></a>00074   OSRDestroySpatialReference( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> );
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00077"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9fd9c20f2b6c8e7cbd1114205d0ec5">00077</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9fd9c20f2b6c8e7cbd1114205d0ec5">QgsCoordinateReferenceSystem::createFromId</a>( <span class="keyword">const</span> <span class="keywordtype">long</span> theId, <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cf">CrsType</a> theType )
<a name="l00078"></a>00078 {
<a name="l00079"></a>00079   <span class="keywordtype">bool</span> result = <span class="keyword">false</span>;
<a name="l00080"></a>00080   <span class="keywordflow">switch</span> ( theType )
<a name="l00081"></a>00081   {
<a name="l00082"></a>00082     <span class="keywordflow">case</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cfabc92b4ee3c6be188b5dfe000ddac415e">InternalCrsId</a>:
<a name="l00083"></a>00083       result = <a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">createFromSrsId</a>( theId );
<a name="l00084"></a>00084       <span class="keywordflow">break</span>;
<a name="l00085"></a>00085     <span class="keywordflow">case</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cfae88ca07f39092200cb8f0ac4328551a5">PostgisCrsId</a>:
<a name="l00086"></a>00086       result = <a class="code" href="classQgsCoordinateReferenceSystem.html#a5ae9f76a2a75b52ed9d4d710dcbbe129">createFromSrid</a>( theId );
<a name="l00087"></a>00087       <span class="keywordflow">break</span>;
<a name="l00088"></a>00088     <span class="keywordflow">case</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cfaa999f03c89ccddb4fb57570089de576b">EpsgCrsId</a>:
<a name="l00089"></a>00089       result = <a class="code" href="classQgsCoordinateReferenceSystem.html#a5789a11684af1415ffc74d7ce9ab91f0" title="Set up this CRS from the given OGC CRS.">createFromOgcWmsCrs</a>( QString( <span class="stringliteral">&quot;EPSG:%1&quot;</span> ).arg( theId ) );
<a name="l00090"></a>00090       <span class="keywordflow">break</span>;
<a name="l00091"></a>00091     <span class="keywordflow">default</span>:
<a name="l00092"></a>00092       <span class="comment">//THIS IS BAD...THIS PART OF CODE SHOULD NEVER BE REACHED...</span>
<a name="l00093"></a>00093       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Unexpected case reached!&quot;</span> );
<a name="l00094"></a>00094   };
<a name="l00095"></a>00095   <span class="keywordflow">return</span> result;
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a8f0ea02f25d97b26f276e5773b2f1819">00098</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a8f0ea02f25d97b26f276e5773b2f1819">QgsCoordinateReferenceSystem::createFromString</a>( <span class="keyword">const</span> QString theDefinition )
<a name="l00099"></a>00099 {
<a name="l00100"></a>00100   <span class="keywordtype">bool</span> result = <span class="keyword">false</span>;
<a name="l00101"></a>00101   QRegExp reCrsId( <span class="stringliteral">&quot;^(epsg|postgis|internal)\\:(\\d+)$&quot;</span>, Qt::CaseInsensitive );
<a name="l00102"></a>00102   <span class="keywordflow">if</span> ( reCrsId.indexIn( theDefinition ) == 0 )
<a name="l00103"></a>00103   {
<a name="l00104"></a>00104     QString authName = reCrsId.cap( 1 ).toLower();
<a name="l00105"></a>00105     <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cf">CrsType</a> type = <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cfabc92b4ee3c6be188b5dfe000ddac415e">InternalCrsId</a>;
<a name="l00106"></a>00106     <span class="keywordflow">if</span> ( authName == <span class="stringliteral">&quot;epsg&quot;</span> ) type = <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cfaa999f03c89ccddb4fb57570089de576b">EpsgCrsId</a>;
<a name="l00107"></a>00107     <span class="keywordflow">if</span> ( authName == <span class="stringliteral">&quot;postgis&quot;</span> ) type = <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cfae88ca07f39092200cb8f0ac4328551a5">PostgisCrsId</a>;
<a name="l00108"></a>00108     <span class="keywordtype">long</span> <span class="keywordtype">id</span> = reCrsId.cap( 2 ).toLong();
<a name="l00109"></a>00109     result = <a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9fd9c20f2b6c8e7cbd1114205d0ec5">createFromId</a>( <span class="keywordtype">id</span>, type );
<a name="l00110"></a>00110   }
<a name="l00111"></a>00111   <span class="keywordflow">else</span>
<a name="l00112"></a>00112   {
<a name="l00113"></a>00113     QRegExp reCrsStr( <span class="stringliteral">&quot;^(?:(wkt|proj4)\\:)?(.+)$&quot;</span>, Qt::CaseInsensitive );
<a name="l00114"></a>00114     <span class="keywordflow">if</span> ( reCrsStr.indexIn( theDefinition ) == 0 )
<a name="l00115"></a>00115     {
<a name="l00116"></a>00116       <span class="keywordflow">if</span> ( reCrsStr.cap( 1 ).toLower() == <span class="stringliteral">&quot;proj4&quot;</span> )
<a name="l00117"></a>00117       {
<a name="l00118"></a>00118         result = <a class="code" href="classQgsCoordinateReferenceSystem.html#acf5ccd2750d310c725937a82a700ecdb">createFromProj4</a>( reCrsStr.cap( 2 ) );
<a name="l00119"></a>00119       }
<a name="l00120"></a>00120       <span class="keywordflow">else</span>
<a name="l00121"></a>00121       {
<a name="l00122"></a>00122         result = <a class="code" href="classQgsCoordinateReferenceSystem.html#a273fd2081c378af3a6be0f9804fbce4a">createFromWkt</a>( reCrsStr.cap( 2 ) );
<a name="l00123"></a>00123       }
<a name="l00124"></a>00124     }
<a name="l00125"></a>00125   }
<a name="l00126"></a>00126   <span class="keywordflow">return</span> result;
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 
<a name="l00129"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a5789a11684af1415ffc74d7ce9ab91f0">00129</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a5789a11684af1415ffc74d7ce9ab91f0" title="Set up this CRS from the given OGC CRS.">QgsCoordinateReferenceSystem::createFromOgcWmsCrs</a>( QString theCrs )
<a name="l00130"></a>00130 {
<a name="l00131"></a>00131   QRegExp re( <span class="stringliteral">&quot;(user|custom|qgis):(\\d+)&quot;</span>, Qt::CaseInsensitive );
<a name="l00132"></a>00132   <span class="keywordflow">if</span> ( re.exactMatch( theCrs ) &amp;&amp; <a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">createFromSrsId</a>( re.cap( 2 ).toInt() ) )
<a name="l00133"></a>00133   {
<a name="l00134"></a>00134     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00135"></a>00135   }
<a name="l00136"></a>00136 
<a name="l00137"></a>00137   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a5d4649c20dd94d28dddd32b56f2bfff3">loadFromDb</a>( <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>(), <span class="stringliteral">&quot;lower(auth_name||&#39;:&#39;||auth_id)&quot;</span>, theCrs.toLower() ) )
<a name="l00138"></a>00138     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00139"></a>00139 
<a name="l00140"></a>00140   <span class="keywordflow">if</span> ( theCrs.compare( <span class="stringliteral">&quot;CRS:84&quot;</span>, Qt::CaseInsensitive ) == 0 )
<a name="l00141"></a>00141   {
<a name="l00142"></a>00142     <a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">createFromSrsId</a>( <a class="code" href="qgis_8h.html#af5cd54d47652544adf35af98511e41f4" title="Magic number for a geographic coord sys in QGIS srs.db tbl_srs.srs_id.">GEOCRS_ID</a> );
<a name="l00143"></a>00143     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00144"></a>00144   }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ace0cb3e77a0bbd8080c68b60c8bafc1e">00149</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a51fef08cdc3353f9c6d5073981cefdc9" title="Default constructor.">QgsCoordinateReferenceSystem::QgsCoordinateReferenceSystem</a>( <span class="keyword">const</span> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> &amp;srs )
<a name="l00150"></a>00150 {
<a name="l00151"></a>00151   <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> = OSRNewSpatialReference( NULL );
<a name="l00152"></a>00152   *<span class="keyword">this</span> = srs;
<a name="l00153"></a>00153 }
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 <span class="comment">// Assignment operator</span>
<a name="l00156"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a82e312eac028563b73c045c61bbac266">00156</a> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a>&amp; <a class="code" href="classQgsCoordinateReferenceSystem.html#a82e312eac028563b73c045c61bbac266" title="Assignment operator.">QgsCoordinateReferenceSystem::operator=</a>( <span class="keyword">const</span> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> &amp; srs )
<a name="l00157"></a>00157 {
<a name="l00158"></a>00158   <span class="keywordflow">if</span> ( &amp;srs != <span class="keyword">this</span> )
<a name="l00159"></a>00159   {
<a name="l00160"></a>00160     <a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a>;
<a name="l00161"></a>00161     <a class="code" href="classQgsCoordinateReferenceSystem.html#a587603e45b3e111d38c377b4bf90d052" title="A textual description of the srs.">mDescription</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a587603e45b3e111d38c377b4bf90d052" title="A textual description of the srs.">mDescription</a>;
<a name="l00162"></a>00162     <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a>;
<a name="l00163"></a>00163     <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a>;
<a name="l00164"></a>00164     <a class="code" href="classQgsCoordinateReferenceSystem.html#a6f9be65a137f9ea477f7190de74c8f66" title="Whether this is a geographic or projected coordinate system.">mGeoFlag</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a6f9be65a137f9ea477f7190de74c8f66" title="Whether this is a geographic or projected coordinate system.">mGeoFlag</a>;
<a name="l00165"></a>00165     <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a>;
<a name="l00166"></a>00166     <a class="code" href="classQgsCoordinateReferenceSystem.html#aadc5601daf830461d22dbe57f8978b14" title="If available, the Postgis spatial_ref_sys identifier for this srs (defaults to 0)">mSRID</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#aadc5601daf830461d22dbe57f8978b14" title="If available, the Postgis spatial_ref_sys identifier for this srs (defaults to 0)">mSRID</a>;
<a name="l00167"></a>00167     <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a>;
<a name="l00168"></a>00168     <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00169"></a>00169     <a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9ace892db2001726ea782c7c7993d8">mValidationHint</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9ace892db2001726ea782c7c7993d8">mValidationHint</a>;
<a name="l00170"></a>00170     <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00171"></a>00171     {
<a name="l00172"></a>00172       OSRDestroySpatialReference( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> );
<a name="l00173"></a>00173       <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> = OSRClone( srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> );
<a name="l00174"></a>00174     }
<a name="l00175"></a>00175   }
<a name="l00176"></a>00176   <span class="keywordflow">return</span> *<span class="keyword">this</span>;
<a name="l00177"></a>00177 }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179 <span class="comment">// Misc helper functions -----------------------</span>
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 
<a name="l00182"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a116bcaa537aea15ad7a137ec85d3e1fb">00182</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a116bcaa537aea15ad7a137ec85d3e1fb">QgsCoordinateReferenceSystem::validate</a>()
<a name="l00183"></a>00183 {
<a name="l00184"></a>00184   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00185"></a>00185     <span class="keywordflow">return</span>;
<a name="l00186"></a>00186 
<a name="l00187"></a>00187   <span class="comment">// try to validate using custom validation routines</span>
<a name="l00188"></a>00188   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a00027ee17ae6306f819322fe8ee6dc8d">mCustomSrsValidation</a> )
<a name="l00189"></a>00189     <a class="code" href="classQgsCoordinateReferenceSystem.html#a00027ee17ae6306f819322fe8ee6dc8d">mCustomSrsValidation</a>( <span class="keyword">this</span> );
<a name="l00190"></a>00190 
<a name="l00191"></a>00191   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00192"></a>00192     <span class="comment">// set the default</span>
<a name="l00193"></a>00193     <a class="code" href="classQgsCoordinateReferenceSystem.html#a5789a11684af1415ffc74d7ce9ab91f0" title="Set up this CRS from the given OGC CRS.">createFromOgcWmsCrs</a>( <a class="code" href="qgis_8h.html#afe921ae99906e4b03ed85cb77eae47ae" title="Geographic coord sys from EPSG authority.">GEO_EPSG_CRS_AUTHID</a> );
<a name="l00194"></a>00194 }
<a name="l00195"></a>00195 
<a name="l00196"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a5ae9f76a2a75b52ed9d4d710dcbbe129">00196</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a5ae9f76a2a75b52ed9d4d710dcbbe129">QgsCoordinateReferenceSystem::createFromSrid</a>( <span class="keywordtype">long</span> <span class="keywordtype">id</span> )
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a5d4649c20dd94d28dddd32b56f2bfff3">loadFromDb</a>( <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>(), <span class="stringliteral">&quot;srid&quot;</span>, QString::number( <span class="keywordtype">id</span> ) );
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00201"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ae0f28405e62ebb1cc7df0e1bbcd51670">00201</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ae0f28405e62ebb1cc7df0e1bbcd51670">QgsCoordinateReferenceSystem::createFromEpsg</a>( <span class="keywordtype">long</span> <span class="keywordtype">id</span> )
<a name="l00202"></a>00202 {
<a name="l00203"></a>00203   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a5789a11684af1415ffc74d7ce9ab91f0" title="Set up this CRS from the given OGC CRS.">createFromOgcWmsCrs</a>( QString( <span class="stringliteral">&quot;EPSG:%1&quot;</span> ).arg( <span class="keywordtype">id</span> ) );
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 
<a name="l00206"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">00206</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">QgsCoordinateReferenceSystem::createFromSrsId</a>( <span class="keywordtype">long</span> <span class="keywordtype">id</span> )
<a name="l00207"></a>00207 {
<a name="l00208"></a>00208   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a5d4649c20dd94d28dddd32b56f2bfff3">loadFromDb</a>( <span class="keywordtype">id</span> &lt; <a class="code" href="qgis_8h.html#ad8794344628fad7031cceb6b8ab2b8ec" title="Magick number that determines whether a projection crsid is a system (srs.db) or user (~/...">USER_CRS_START_ID</a> ? <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>() : <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>(),
<a name="l00209"></a>00209                      <span class="stringliteral">&quot;srs_id&quot;</span>, QString::number( <span class="keywordtype">id</span> ) );
<a name="l00210"></a>00210 }
<a name="l00211"></a>00211 
<a name="l00212"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a5d4649c20dd94d28dddd32b56f2bfff3">00212</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a5d4649c20dd94d28dddd32b56f2bfff3">QgsCoordinateReferenceSystem::loadFromDb</a>( QString db, QString expression, QString value )
<a name="l00213"></a>00213 {
<a name="l00214"></a>00214   <a class="code" href="qgslogger_8h.html#a795a1fcfb1c61b988bbd999396411d13">QgsDebugMsgLevel</a>( <span class="stringliteral">&quot;load CRS from &quot;</span> + db + <span class="stringliteral">&quot; where &quot;</span> + expression + <span class="stringliteral">&quot; is &quot;</span> + value, 3 );
<a name="l00215"></a>00215   <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <span class="keyword">false</span>;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217   QFileInfo myInfo( db );
<a name="l00218"></a>00218   <span class="keywordflow">if</span> ( !myInfo.exists() )
<a name="l00219"></a>00219   {
<a name="l00220"></a>00220     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;failed : &quot;</span> + db + <span class="stringliteral">&quot; does not exist!&quot;</span> );
<a name="l00221"></a>00221     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00222"></a>00222   }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a>      *myDatabase;
<a name="l00225"></a>00225   <span class="keyword">const</span> <span class="keywordtype">char</span>   *myTail;
<a name="l00226"></a>00226   sqlite3_stmt *myPreparedStatement;
<a name="l00227"></a>00227   <span class="keywordtype">int</span>           myResult;
<a name="l00228"></a>00228   <span class="comment">//check the db is available</span>
<a name="l00229"></a>00229   myResult = <a class="code" href="classQgsCoordinateReferenceSystem.html#ae487d953822068a45b9c8d2ef60a6d07">openDb</a>( db, &amp;myDatabase );
<a name="l00230"></a>00230   <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l00231"></a>00231   {
<a name="l00232"></a>00232     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;failed : &quot;</span> + db + <span class="stringliteral">&quot; could not be opened!&quot;</span> );
<a name="l00233"></a>00233     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00234"></a>00234   }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236   <span class="comment">/*</span>
<a name="l00237"></a>00237 <span class="comment">    srs_id INTEGER PRIMARY KEY,</span>
<a name="l00238"></a>00238 <span class="comment">    description text NOT NULL,</span>
<a name="l00239"></a>00239 <span class="comment">    projection_acronym text NOT NULL,</span>
<a name="l00240"></a>00240 <span class="comment">    ellipsoid_acronym NOT NULL,</span>
<a name="l00241"></a>00241 <span class="comment">    parameters text NOT NULL,</span>
<a name="l00242"></a>00242 <span class="comment">    srid integer NOT NULL,</span>
<a name="l00243"></a>00243 <span class="comment">    auth_name varchar NOT NULL,</span>
<a name="l00244"></a>00244 <span class="comment">    auth_id integer NOT NULL,</span>
<a name="l00245"></a>00245 <span class="comment">    is_geo integer NOT NULL);</span>
<a name="l00246"></a>00246 <span class="comment">  */</span>
<a name="l00247"></a>00247 
<a name="l00248"></a>00248   QString mySql = <span class="stringliteral">&quot;select srs_id,description,projection_acronym,ellipsoid_acronym,parameters,srid,auth_name||&#39;:&#39;||auth_id,is_geo from tbl_srs where &quot;</span> + expression + <span class="stringliteral">&quot;=&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( value );
<a name="l00249"></a>00249   myResult = sqlite3_prepare( myDatabase, mySql.toUtf8(), mySql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l00250"></a>00250   <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l00251"></a>00251   <span class="keywordflow">if</span> ( myResult == SQLITE_OK &amp;&amp; sqlite3_step( myPreparedStatement ) == SQLITE_ROW )
<a name="l00252"></a>00252   {
<a name="l00253"></a>00253     <a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 0 ) ).toLong();
<a name="l00254"></a>00254     <a class="code" href="classQgsCoordinateReferenceSystem.html#a587603e45b3e111d38c377b4bf90d052" title="A textual description of the srs.">mDescription</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 1 ) );
<a name="l00255"></a>00255     <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 2 ) );
<a name="l00256"></a>00256     <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 3 ) );
<a name="l00257"></a>00257     QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 4 ) );
<a name="l00258"></a>00258     <a class="code" href="classQgsCoordinateReferenceSystem.html#aadc5601daf830461d22dbe57f8978b14" title="If available, the Postgis spatial_ref_sys identifier for this srs (defaults to 0)">mSRID</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 5 ) ).toLong();
<a name="l00259"></a>00259     <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 6 ) );
<a name="l00260"></a>00260     <a class="code" href="classQgsCoordinateReferenceSystem.html#a6f9be65a137f9ea477f7190de74c8f66" title="Whether this is a geographic or projected coordinate system.">mGeoFlag</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 7 ) ).toInt() != 0;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262     <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a> &gt;= <a class="code" href="qgis_8h.html#ad8794344628fad7031cceb6b8ab2b8ec" title="Magick number that determines whether a projection crsid is a system (srs.db) or user (~/...">USER_CRS_START_ID</a> &amp;&amp; <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a>.isEmpty() )
<a name="l00263"></a>00263     {
<a name="l00264"></a>00264       <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a> = QString( <span class="stringliteral">&quot;USER:%1&quot;</span> ).arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a> );
<a name="l00265"></a>00265     }
<a name="l00266"></a>00266     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a>.startsWith( <span class="stringliteral">&quot;EPSG:&quot;</span>, Qt::CaseInsensitive ) )
<a name="l00267"></a>00267     {
<a name="l00268"></a>00268       OSRDestroySpatialReference( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> );
<a name="l00269"></a>00269       <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> = OSRNewSpatialReference( NULL );
<a name="l00270"></a>00270       <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = OSRSetFromUserInput( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a>.toLower().toAscii() ) == OGRERR_NONE;
<a name="l00271"></a>00271       <a class="code" href="classQgsCoordinateReferenceSystem.html#ac552bc85c6d409b529b6889bfd2456ac" title="Work out the projection units and set the appropriate local variable.">setMapUnits</a>();
<a name="l00272"></a>00272     }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="keywordflow">if</span> ( !<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00275"></a>00275     {
<a name="l00276"></a>00276       <a class="code" href="classQgsCoordinateReferenceSystem.html#ae0cd0008b170f81f0721fb475780e9ab">setProj4String</a>( toProj4 );
<a name="l00277"></a>00277     }
<a name="l00278"></a>00278   }
<a name="l00279"></a>00279   <span class="keywordflow">else</span>
<a name="l00280"></a>00280   {
<a name="l00281"></a>00281     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;failed : &quot;</span> + mySql );
<a name="l00282"></a>00282   }
<a name="l00283"></a>00283   sqlite3_finalize( myPreparedStatement );
<a name="l00284"></a>00284   sqlite3_close( myDatabase );
<a name="l00285"></a>00285   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00286"></a>00286 }
<a name="l00287"></a>00287 
<a name="l00288"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a273fd2081c378af3a6be0f9804fbce4a">00288</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a273fd2081c378af3a6be0f9804fbce4a">QgsCoordinateReferenceSystem::createFromWkt</a>( QString theWkt )
<a name="l00289"></a>00289 {
<a name="l00290"></a>00290   <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <span class="keyword">false</span>;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292   <span class="keywordflow">if</span> ( theWkt.isEmpty() )
<a name="l00293"></a>00293   {
<a name="l00294"></a>00294     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;theWkt is uninitialised, operation failed&quot;</span> );
<a name="l00295"></a>00295     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00296"></a>00296   }
<a name="l00297"></a>00297   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;wkt: &quot;</span> + theWkt );
<a name="l00298"></a>00298   QByteArray ba = theWkt.toLatin1();
<a name="l00299"></a>00299   <span class="keyword">const</span> <span class="keywordtype">char</span> *pWkt = ba.data();
<a name="l00300"></a>00300 
<a name="l00301"></a>00301   OGRErr myInputResult = OSRImportFromWkt( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, ( <span class="keywordtype">char</span> ** ) &amp; pWkt );
<a name="l00302"></a>00302 
<a name="l00303"></a>00303   <span class="keywordflow">if</span> ( myInputResult != OGRERR_NONE )
<a name="l00304"></a>00304   {
<a name="l00305"></a>00305     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;\n---------------------------------------------------------------&quot;</span> );
<a name="l00306"></a>00306     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;This CRS could *** NOT *** be set from the supplied Wkt &quot;</span> );
<a name="l00307"></a>00307     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;INPUT: &quot;</span> + theWkt );
<a name="l00308"></a>00308     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;UNUSED WKT: %1&quot;</span> ).arg( pWkt ) );
<a name="l00309"></a>00309     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;---------------------------------------------------------------\n&quot;</span> );
<a name="l00310"></a>00310     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00311"></a>00311   }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313   <span class="keywordflow">if</span> ( OSRAutoIdentifyEPSG( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> ) == OGRERR_NONE )
<a name="l00314"></a>00314   {
<a name="l00315"></a>00315     QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a4382981b1233c7f0ca1c7ce7bdb670d3">authid</a> = QString( <span class="stringliteral">&quot;%1:%2&quot;</span> )
<a name="l00316"></a>00316                      .arg( OSRGetAuthorityName( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, NULL ) )
<a name="l00317"></a>00317                      .arg( OSRGetAuthorityCode( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, NULL ) );
<a name="l00318"></a>00318     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;authid recognized as &quot;</span> + authid );
<a name="l00319"></a>00319     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a5789a11684af1415ffc74d7ce9ab91f0" title="Set up this CRS from the given OGC CRS.">createFromOgcWmsCrs</a>( authid );
<a name="l00320"></a>00320   }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322   <span class="comment">// always morph from esri as it doesn&#39;t hurt anything</span>
<a name="l00323"></a>00323   <span class="comment">// FW: Hey, that&#39;s not right!  It can screw stuff up! Disable</span>
<a name="l00324"></a>00324   <span class="comment">//myOgrSpatialRef.morphFromESRI();</span>
<a name="l00325"></a>00325 
<a name="l00326"></a>00326   <span class="comment">// create the proj4 structs needed for transforming</span>
<a name="l00327"></a>00327   <span class="keywordtype">char</span> *proj4src = NULL;
<a name="l00328"></a>00328   OSRExportToProj4( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, &amp;proj4src );
<a name="l00329"></a>00329 
<a name="l00330"></a>00330   <span class="comment">//now that we have the proj4string, delegate to createFromProj4 so</span>
<a name="l00331"></a>00331   <span class="comment">// that we can try to fill in the remaining class members...</span>
<a name="l00332"></a>00332   <span class="comment">//create from Proj will set the isValidFlag</span>
<a name="l00333"></a>00333   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsCoordinateReferenceSystem.html#acf5ccd2750d310c725937a82a700ecdb">createFromProj4</a>( proj4src ) )
<a name="l00334"></a>00334   {
<a name="l00335"></a>00335     CPLFree( proj4src );
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <span class="comment">// try fixed up version</span>
<a name="l00338"></a>00338     OSRFixup( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> );
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     OSRExportToProj4( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, &amp;proj4src );
<a name="l00341"></a>00341 
<a name="l00342"></a>00342     <a class="code" href="classQgsCoordinateReferenceSystem.html#acf5ccd2750d310c725937a82a700ecdb">createFromProj4</a>( proj4src );
<a name="l00343"></a>00343   }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345   CPLFree( proj4src );
<a name="l00346"></a>00346 
<a name="l00347"></a>00347   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00348"></a>00348   <span class="comment">//setMapunits will be called by createfromproj above</span>
<a name="l00349"></a>00349 }
<a name="l00350"></a>00350 
<a name="l00351"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#aa88613351434eeefdbdfbbd77ff33025">00351</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#aa88613351434eeefdbdfbbd77ff33025">QgsCoordinateReferenceSystem::isValid</a>()<span class="keyword"> const</span>
<a name="l00352"></a>00352 <span class="keyword"></span>{
<a name="l00353"></a>00353   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00354"></a>00354 }
<a name="l00355"></a>00355 
<a name="l00356"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#acf5ccd2750d310c725937a82a700ecdb">00356</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#acf5ccd2750d310c725937a82a700ecdb">QgsCoordinateReferenceSystem::createFromProj4</a>( <span class="keyword">const</span> QString theProj4String )
<a name="l00357"></a>00357 {
<a name="l00358"></a>00358   <span class="comment">//</span>
<a name="l00359"></a>00359   <span class="comment">// Examples:</span>
<a name="l00360"></a>00360   <span class="comment">// +proj=tmerc +lat_0=0 +lon_0=-62 +k=0.999500 +x_0=400000 +y_0=0</span>
<a name="l00361"></a>00361   <span class="comment">// +ellps=clrk80 +towgs84=-255,-15,71,0,0,0,0 +units=m +no_defs</span>
<a name="l00362"></a>00362   <span class="comment">//</span>
<a name="l00363"></a>00363   <span class="comment">// +proj=lcc +lat_1=46.8 +lat_0=46.8 +lon_0=2.337229166666664 +k_0=0.99987742</span>
<a name="l00364"></a>00364   <span class="comment">// +x_0=600000 +y_0=2200000 +a=6378249.2 +b=6356515.000000472 +units=m +no_defs</span>
<a name="l00365"></a>00365   <span class="comment">//</span>
<a name="l00366"></a>00366   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;proj4: &quot;</span> + theProj4String );
<a name="l00367"></a>00367   <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <span class="keyword">false</span>;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369   QRegExp myProjRegExp( <span class="stringliteral">&quot;\\+proj=(\\S+)&quot;</span> );
<a name="l00370"></a>00370   <span class="keywordtype">int</span> myStart = myProjRegExp.indexIn( theProj4String );
<a name="l00371"></a>00371   <span class="keywordflow">if</span> ( myStart == -1 )
<a name="l00372"></a>00372   {
<a name="l00373"></a>00373     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;proj string supplied has no +proj argument&quot;</span> );
<a name="l00374"></a>00374     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00375"></a>00375   }
<a name="l00376"></a>00376 
<a name="l00377"></a>00377   <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a> = myProjRegExp.cap( 1 );
<a name="l00378"></a>00378 
<a name="l00379"></a>00379   QRegExp myEllipseRegExp( <span class="stringliteral">&quot;\\+ellps=(\\S+)&quot;</span> );
<a name="l00380"></a>00380   myStart = myEllipseRegExp.indexIn( theProj4String );
<a name="l00381"></a>00381   <span class="keywordflow">if</span> ( myStart == -1 )
<a name="l00382"></a>00382   {
<a name="l00383"></a>00383     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;proj string supplied has no +ellps argument&quot;</span> );
<a name="l00384"></a>00384     <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a> = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00385"></a>00385   }
<a name="l00386"></a>00386   <span class="keywordflow">else</span>
<a name="l00387"></a>00387   {
<a name="l00388"></a>00388     <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a> = myEllipseRegExp.cap( 1 );
<a name="l00389"></a>00389   }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391   QRegExp myAxisRegExp( <span class="stringliteral">&quot;\\+a=(\\S+)&quot;</span> );
<a name="l00392"></a>00392   myStart = myAxisRegExp.indexIn( theProj4String );
<a name="l00393"></a>00393   <span class="keywordflow">if</span> ( myStart == -1 )
<a name="l00394"></a>00394   {
<a name="l00395"></a>00395     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;proj string supplied has no +a argument&quot;</span> );
<a name="l00396"></a>00396   }
<a name="l00397"></a>00397 
<a name="l00398"></a>00398   <span class="comment">/*</span>
<a name="l00399"></a>00399 <span class="comment">   * We try to match the proj string to and srsid using the following logic:</span>
<a name="l00400"></a>00400 <span class="comment">   *</span>
<a name="l00401"></a>00401 <span class="comment">   * - perform a whole text search on srs name (if not null). The srs name will</span>
<a name="l00402"></a>00402 <span class="comment">   *   have been set if this method has been delegated to from createFromWkt.</span>
<a name="l00403"></a>00403 <span class="comment">   * Normally we wouldnt expect this to work, but its worth trying first</span>
<a name="l00404"></a>00404 <span class="comment">   * as its quicker than methods below..</span>
<a name="l00405"></a>00405 <span class="comment">   */</span>
<a name="l00406"></a>00406   <span class="keywordtype">long</span> mySrsId = 0;
<a name="l00407"></a>00407   <a class="code" href="classQgsCoordinateReferenceSystem.html#a238dfb729c699d5e3f6d37f7527991b0">QgsCoordinateReferenceSystem::RecordMap</a> myRecord;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409   <span class="comment">/*</span>
<a name="l00410"></a>00410 <span class="comment">   * - if the above does not match perform a whole text search on proj4 string (if not null)</span>
<a name="l00411"></a>00411 <span class="comment">   */</span>
<a name="l00412"></a>00412   <span class="comment">// QgsDebugMsg( &quot;wholetext match on name failed, trying proj4string match&quot; );</span>
<a name="l00413"></a>00413   myRecord = <a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">getRecord</a>( <span class="stringliteral">&quot;select * from tbl_srs where parameters=&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( theProj4String.trimmed() ) );
<a name="l00414"></a>00414   <span class="keywordflow">if</span> ( myRecord.empty() )
<a name="l00415"></a>00415   {
<a name="l00416"></a>00416     <span class="comment">// Ticket #722 - aaronr</span>
<a name="l00417"></a>00417     <span class="comment">// Check if we can swap the lat_1 and lat_2 params (if they exist) to see if we match...</span>
<a name="l00418"></a>00418     <span class="comment">// First we check for lat_1 and lat_2</span>
<a name="l00419"></a>00419     QRegExp myLat1RegExp( <span class="stringliteral">&quot;\\+lat_1=\\S+&quot;</span> );
<a name="l00420"></a>00420     QRegExp myLat2RegExp( <span class="stringliteral">&quot;\\+lat_2=\\S+&quot;</span> );
<a name="l00421"></a>00421     <span class="keywordtype">int</span> myStart1 = 0;
<a name="l00422"></a>00422     <span class="keywordtype">int</span> myLength1 = 0;
<a name="l00423"></a>00423     <span class="keywordtype">int</span> myStart2 = 0;
<a name="l00424"></a>00424     <span class="keywordtype">int</span> myLength2 = 0;
<a name="l00425"></a>00425     QString lat1Str = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00426"></a>00426     QString lat2Str = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00427"></a>00427     myStart1 = myLat1RegExp.indexIn( theProj4String, myStart1 );
<a name="l00428"></a>00428     myStart2 = myLat2RegExp.indexIn( theProj4String, myStart2 );
<a name="l00429"></a>00429     <span class="keywordflow">if</span> ( myStart1 != -1 &amp;&amp; myStart2 != -1 )
<a name="l00430"></a>00430     {
<a name="l00431"></a>00431       myLength1 = myLat1RegExp.matchedLength();
<a name="l00432"></a>00432       myLength2 = myLat2RegExp.matchedLength();
<a name="l00433"></a>00433       lat1Str = theProj4String.mid( myStart1 + <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a>, myLength1 - <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a> );
<a name="l00434"></a>00434       lat2Str = theProj4String.mid( myStart2 + <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a>, myLength2 - <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a> );
<a name="l00435"></a>00435     }
<a name="l00436"></a>00436     <span class="comment">// If we found the lat_1 and lat_2 we need to swap and check to see if we can find it...</span>
<a name="l00437"></a>00437     <span class="keywordflow">if</span> ( lat1Str != <span class="stringliteral">&quot;&quot;</span> &amp;&amp; lat2Str != <span class="stringliteral">&quot;&quot;</span> )
<a name="l00438"></a>00438     {
<a name="l00439"></a>00439       <span class="comment">// Make our new string to check...</span>
<a name="l00440"></a>00440       QString theProj4StringModified = theProj4String;
<a name="l00441"></a>00441       <span class="comment">// First just swap in the lat_2 value for lat_1 value</span>
<a name="l00442"></a>00442       theProj4StringModified.replace( myStart1 + <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a>, myLength1 - <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a>, lat2Str );
<a name="l00443"></a>00443       <span class="comment">// Now we have to find the lat_2 location again since it has potentially moved...</span>
<a name="l00444"></a>00444       myStart2 = 0;
<a name="l00445"></a>00445       myStart2 = myLat2RegExp.indexIn( theProj4String, myStart2 );
<a name="l00446"></a>00446       theProj4StringModified.replace( myStart2 + <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a>, myLength2 - <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a>, lat1Str );
<a name="l00447"></a>00447       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;trying proj4string match with swapped lat_1,lat_2&quot;</span> );
<a name="l00448"></a>00448       myRecord = <a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">getRecord</a>( <span class="stringliteral">&quot;select * from tbl_srs where parameters=&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( theProj4StringModified.trimmed() ) );
<a name="l00449"></a>00449     }
<a name="l00450"></a>00450   }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452   <span class="keywordflow">if</span> ( myRecord.empty() )
<a name="l00453"></a>00453   {
<a name="l00454"></a>00454     <span class="comment">// match all arameters individually:</span>
<a name="l00455"></a>00455     <span class="comment">// - order of parameters doesn&#39;t matter</span>
<a name="l00456"></a>00456     <span class="comment">// - found definition may have more parameters (like +towgs84 in GDAL)</span>
<a name="l00457"></a>00457     <span class="comment">// - retry without datum, if no match is found (looks like +datum&lt;&gt;WGS84 was dropped in GDAL)</span>
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     QString sql = <span class="stringliteral">&quot;SELECT * FROM tbl_srs WHERE &quot;</span>;
<a name="l00460"></a>00460     QString delim = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00461"></a>00461     QString datum;
<a name="l00462"></a>00462     <span class="keywordflow">foreach</span>( QString param, theProj4String.split( <span class="stringliteral">&quot; &quot;</span>, QString::SkipEmptyParts ) )
<a name="l00463"></a>00463     {
<a name="l00464"></a>00464       QString arg = QString( <span class="stringliteral">&quot;&#39; &#39;||parameters||&#39; &#39; LIKE %1&quot;</span> ).arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( QString( <span class="stringliteral">&quot;% %1 %&quot;</span> ).arg( param ) ) );
<a name="l00465"></a>00465       <span class="keywordflow">if</span> ( param.startsWith( <span class="stringliteral">&quot;+datum=&quot;</span> ) )
<a name="l00466"></a>00466       {
<a name="l00467"></a>00467         datum = arg;
<a name="l00468"></a>00468       }
<a name="l00469"></a>00469       <span class="keywordflow">else</span>
<a name="l00470"></a>00470       {
<a name="l00471"></a>00471         sql += delim + arg;
<a name="l00472"></a>00472         delim = <span class="stringliteral">&quot; AND &quot;</span>;
<a name="l00473"></a>00473       }
<a name="l00474"></a>00474     }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476     <span class="keywordflow">if</span> ( !datum.isEmpty() )
<a name="l00477"></a>00477     {
<a name="l00478"></a>00478       myRecord = <a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">getRecord</a>( sql + delim + datum );
<a name="l00479"></a>00479     }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     <span class="keywordflow">if</span> ( myRecord.empty() )
<a name="l00482"></a>00482     {
<a name="l00483"></a>00483       <span class="comment">// datum might have disappeared in definition - retry without it</span>
<a name="l00484"></a>00484       myRecord = <a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">getRecord</a>( sql );
<a name="l00485"></a>00485     }
<a name="l00486"></a>00486   }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488   <span class="keywordflow">if</span> ( !myRecord.empty() )
<a name="l00489"></a>00489   {
<a name="l00490"></a>00490     mySrsId = myRecord[<span class="stringliteral">&quot;srs_id&quot;</span>].toLong();
<a name="l00491"></a>00491     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;proj4string param match search for srsid returned srsid: &quot;</span> + QString::number( mySrsId ) );
<a name="l00492"></a>00492     <span class="keywordflow">if</span> ( mySrsId &gt; 0 )
<a name="l00493"></a>00493     {
<a name="l00494"></a>00494       <a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">createFromSrsId</a>( mySrsId );
<a name="l00495"></a>00495     }
<a name="l00496"></a>00496   }
<a name="l00497"></a>00497   <span class="keywordflow">else</span>
<a name="l00498"></a>00498   {
<a name="l00499"></a>00499     <span class="comment">// Last ditch attempt to piece together what we know of the projection to find a match...</span>
<a name="l00500"></a>00500     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;globbing search for srsid from this proj string&quot;</span> );
<a name="l00501"></a>00501     <a class="code" href="classQgsCoordinateReferenceSystem.html#ae0cd0008b170f81f0721fb475780e9ab">setProj4String</a>( theProj4String );
<a name="l00502"></a>00502     mySrsId = <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcef003135c7bf9de91c79e6d9a54bb">findMatchingProj</a>();
<a name="l00503"></a>00503     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;globbing search for srsid returned srsid: &quot;</span> + QString::number( mySrsId ) );
<a name="l00504"></a>00504     <span class="keywordflow">if</span> ( mySrsId &gt; 0 )
<a name="l00505"></a>00505     {
<a name="l00506"></a>00506       <a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">createFromSrsId</a>( mySrsId );
<a name="l00507"></a>00507     }
<a name="l00508"></a>00508     <span class="keywordflow">else</span>
<a name="l00509"></a>00509     {
<a name="l00510"></a>00510       <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <span class="keyword">false</span>;
<a name="l00511"></a>00511     }
<a name="l00512"></a>00512   }
<a name="l00513"></a>00513 
<a name="l00514"></a>00514   <span class="comment">// if we failed to look up the projection in database, don&#39;t worry. we can still use it :)</span>
<a name="l00515"></a>00515   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00516"></a>00516   {
<a name="l00517"></a>00517     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Projection is not found in databases.&quot;</span> );
<a name="l00518"></a>00518     <a class="code" href="classQgsCoordinateReferenceSystem.html#ae0cd0008b170f81f0721fb475780e9ab">setProj4String</a>( theProj4String );
<a name="l00519"></a>00519 
<a name="l00520"></a>00520     <span class="comment">// Is the SRS is valid now, we know it&#39;s a decent +proj string that can be entered into the srs.db</span>
<a name="l00521"></a>00521     <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00522"></a>00522     {
<a name="l00523"></a>00523       <span class="comment">// but the proj.4 parsed string might already be in our database</span>
<a name="l00524"></a>00524       myRecord = <a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">getRecord</a>( <span class="stringliteral">&quot;select * from tbl_srs where parameters=&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() ) );
<a name="l00525"></a>00525       <span class="keywordflow">if</span> ( myRecord.empty() )
<a name="l00526"></a>00526       {
<a name="l00527"></a>00527         <span class="comment">// It&#39;s not, so try to add it</span>
<a name="l00528"></a>00528         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Projection appears to be valid. Save to database!&quot;</span> );
<a name="l00529"></a>00529         <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <a class="code" href="classQgsCoordinateReferenceSystem.html#a0a6af4d5bea2381495b2d4849056c3e4" title="Save the proj4-string as a custom CRS.">saveAsUserCRS</a>();
<a name="l00530"></a>00530 
<a name="l00531"></a>00531         <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00532"></a>00532         {
<a name="l00533"></a>00533           <span class="comment">// but validate that it&#39;s there afterwards</span>
<a name="l00534"></a>00534           myRecord = <a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">getRecord</a>( <span class="stringliteral">&quot;select * from tbl_srs where parameters=&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() ) );
<a name="l00535"></a>00535         }
<a name="l00536"></a>00536       }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538       <span class="keywordflow">if</span> ( !myRecord.empty() )
<a name="l00539"></a>00539       {
<a name="l00540"></a>00540         <span class="comment">// take the srid from the record</span>
<a name="l00541"></a>00541         mySrsId = myRecord[<span class="stringliteral">&quot;srs_id&quot;</span>].toLong();
<a name="l00542"></a>00542         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;proj4string match search for srsid returned srsid: &quot;</span> + QString::number( mySrsId ) );
<a name="l00543"></a>00543         <span class="keywordflow">if</span> ( mySrsId &gt; 0 )
<a name="l00544"></a>00544         {
<a name="l00545"></a>00545           <a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">createFromSrsId</a>( mySrsId );
<a name="l00546"></a>00546         }
<a name="l00547"></a>00547         <span class="keywordflow">else</span>
<a name="l00548"></a>00548         {
<a name="l00549"></a>00549           <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;invalid srid %1 found&quot;</span> ).arg( mySrsId ) );
<a name="l00550"></a>00550           <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <span class="keyword">false</span>;
<a name="l00551"></a>00551         }
<a name="l00552"></a>00552       }
<a name="l00553"></a>00553       <span class="keywordflow">else</span>
<a name="l00554"></a>00554       {
<a name="l00555"></a>00555         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Couldn&#39;t find newly added proj string?&quot;</span> );
<a name="l00556"></a>00556         <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <span class="keyword">false</span>;
<a name="l00557"></a>00557       }
<a name="l00558"></a>00558     }
<a name="l00559"></a>00559   }
<a name="l00560"></a>00560 
<a name="l00561"></a>00561 
<a name="l00562"></a>00562   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00563"></a>00563 }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565 <span class="comment">//private method meant for internal use by this class only</span>
<a name="l00566"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">00566</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a238dfb729c699d5e3f6d37f7527991b0">QgsCoordinateReferenceSystem::RecordMap</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">QgsCoordinateReferenceSystem::getRecord</a>( QString theSql )
<a name="l00567"></a>00567 {
<a name="l00568"></a>00568   QString myDatabaseFileName;
<a name="l00569"></a>00569   <a class="code" href="classQgsCoordinateReferenceSystem.html#a238dfb729c699d5e3f6d37f7527991b0">QgsCoordinateReferenceSystem::RecordMap</a> myMap;
<a name="l00570"></a>00570   QString myFieldName;
<a name="l00571"></a>00571   QString myFieldValue;
<a name="l00572"></a>00572   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a>      *myDatabase;
<a name="l00573"></a>00573   <span class="keyword">const</span> <span class="keywordtype">char</span>   *myTail;
<a name="l00574"></a>00574   sqlite3_stmt *myPreparedStatement;
<a name="l00575"></a>00575   <span class="keywordtype">int</span>           myResult;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;running query: &quot;</span> + theSql );
<a name="l00578"></a>00578   <span class="comment">// Get the full path name to the sqlite3 spatial reference database.</span>
<a name="l00579"></a>00579   myDatabaseFileName = <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>();
<a name="l00580"></a>00580   QFileInfo myInfo( myDatabaseFileName );
<a name="l00581"></a>00581   <span class="keywordflow">if</span> ( !myInfo.exists() )
<a name="l00582"></a>00582   {
<a name="l00583"></a>00583     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;failed : &quot;</span> + myDatabaseFileName +
<a name="l00584"></a>00584                  <span class="stringliteral">&quot; does not exist!&quot;</span> );
<a name="l00585"></a>00585     <span class="keywordflow">return</span> myMap;
<a name="l00586"></a>00586   }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588   <span class="comment">//check the db is available</span>
<a name="l00589"></a>00589   myResult = <a class="code" href="classQgsCoordinateReferenceSystem.html#ae487d953822068a45b9c8d2ef60a6d07">openDb</a>( myDatabaseFileName, &amp;myDatabase );
<a name="l00590"></a>00590   <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l00591"></a>00591   {
<a name="l00592"></a>00592     <span class="keywordflow">return</span> myMap;
<a name="l00593"></a>00593   }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595   myResult = sqlite3_prepare( myDatabase, theSql.toUtf8(), theSql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l00596"></a>00596   <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l00597"></a>00597   <span class="keywordflow">if</span> ( myResult == SQLITE_OK &amp;&amp; sqlite3_step( myPreparedStatement ) == SQLITE_ROW )
<a name="l00598"></a>00598   {
<a name="l00599"></a>00599     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;trying system srs.db&quot;</span> );
<a name="l00600"></a>00600     <span class="keywordtype">int</span> myColumnCount = sqlite3_column_count( myPreparedStatement );
<a name="l00601"></a>00601     <span class="comment">//loop through each column in the record adding its expression name and value to the map</span>
<a name="l00602"></a>00602     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> myColNo = 0; myColNo &lt; myColumnCount; myColNo++ )
<a name="l00603"></a>00603     {
<a name="l00604"></a>00604       myFieldName = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_name( myPreparedStatement, myColNo ) );
<a name="l00605"></a>00605       myFieldValue = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, myColNo ) );
<a name="l00606"></a>00606       myMap[myFieldName] = myFieldValue;
<a name="l00607"></a>00607     }
<a name="l00608"></a>00608   }
<a name="l00609"></a>00609   <span class="keywordflow">else</span>
<a name="l00610"></a>00610   {
<a name="l00611"></a>00611     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;trying user qgis.db&quot;</span> );
<a name="l00612"></a>00612     sqlite3_finalize( myPreparedStatement );
<a name="l00613"></a>00613     sqlite3_close( myDatabase );
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     myDatabaseFileName = <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>();
<a name="l00616"></a>00616     QFileInfo myFileInfo;
<a name="l00617"></a>00617     myFileInfo.setFile( myDatabaseFileName );
<a name="l00618"></a>00618     <span class="keywordflow">if</span> ( !myFileInfo.exists( ) )
<a name="l00619"></a>00619     {
<a name="l00620"></a>00620       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;user qgis.db not found&quot;</span> );
<a name="l00621"></a>00621       <span class="keywordflow">return</span> myMap;
<a name="l00622"></a>00622     }
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <span class="comment">//check the db is available</span>
<a name="l00625"></a>00625     myResult = <a class="code" href="classQgsCoordinateReferenceSystem.html#ae487d953822068a45b9c8d2ef60a6d07">openDb</a>( myDatabaseFileName, &amp;myDatabase );
<a name="l00626"></a>00626     <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l00627"></a>00627     {
<a name="l00628"></a>00628       <span class="keywordflow">return</span> myMap;
<a name="l00629"></a>00629     }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631     myResult = sqlite3_prepare( myDatabase, theSql.toUtf8(), theSql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l00632"></a>00632     <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l00633"></a>00633     <span class="keywordflow">if</span> ( myResult == SQLITE_OK &amp;&amp; sqlite3_step( myPreparedStatement ) == SQLITE_ROW )
<a name="l00634"></a>00634     {
<a name="l00635"></a>00635       <span class="keywordtype">int</span> myColumnCount = sqlite3_column_count( myPreparedStatement );
<a name="l00636"></a>00636       <span class="comment">//loop through each column in the record adding its field name and value to the map</span>
<a name="l00637"></a>00637       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> myColNo = 0; myColNo &lt; myColumnCount; myColNo++ )
<a name="l00638"></a>00638       {
<a name="l00639"></a>00639         myFieldName = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_name( myPreparedStatement, myColNo ) );
<a name="l00640"></a>00640         myFieldValue = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, myColNo ) );
<a name="l00641"></a>00641         myMap[myFieldName] = myFieldValue;
<a name="l00642"></a>00642       }
<a name="l00643"></a>00643     }
<a name="l00644"></a>00644     <span class="keywordflow">else</span>
<a name="l00645"></a>00645     {
<a name="l00646"></a>00646       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;failed :  &quot;</span> + theSql );
<a name="l00647"></a>00647 
<a name="l00648"></a>00648     }
<a name="l00649"></a>00649   }
<a name="l00650"></a>00650   sqlite3_finalize( myPreparedStatement );
<a name="l00651"></a>00651   sqlite3_close( myDatabase );
<a name="l00652"></a>00652 
<a name="l00653"></a>00653 <span class="preprocessor">#ifdef QGISDEBUG</span>
<a name="l00654"></a>00654 <span class="preprocessor"></span>  <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;retrieved:  &quot;</span> + theSql );
<a name="l00655"></a>00655   RecordMap::Iterator it;
<a name="l00656"></a>00656   <span class="keywordflow">for</span> ( it = myMap.begin(); it != myMap.end(); ++it )
<a name="l00657"></a>00657   {
<a name="l00658"></a>00658     <a class="code" href="qgslogger_8h.html#a795a1fcfb1c61b988bbd999396411d13">QgsDebugMsgLevel</a>( it.key() + <span class="stringliteral">&quot; =&gt; &quot;</span> + it.value(), 2 );
<a name="l00659"></a>00659   }
<a name="l00660"></a>00660 <span class="preprocessor">#endif</span>
<a name="l00661"></a>00661 <span class="preprocessor"></span>
<a name="l00662"></a>00662   <span class="keywordflow">return</span> myMap;
<a name="l00663"></a>00663 }
<a name="l00664"></a>00664 
<a name="l00665"></a>00665 <span class="comment">// Accessors -----------------------------------</span>
<a name="l00666"></a>00666 
<a name="l00667"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#add285911972f1facfe30388ab0eba01a">00667</a> <span class="keywordtype">long</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#add285911972f1facfe30388ab0eba01a">QgsCoordinateReferenceSystem::srsid</a>()<span class="keyword"> const</span>
<a name="l00668"></a>00668 <span class="keyword"></span>{
<a name="l00669"></a>00669   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a>;
<a name="l00670"></a>00670 }
<a name="l00671"></a>00671 
<a name="l00672"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a3cb64f24049d50fbacffd1eece5125ee">00672</a> <span class="keywordtype">long</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a3cb64f24049d50fbacffd1eece5125ee">QgsCoordinateReferenceSystem::postgisSrid</a>()<span class="keyword"> const</span>
<a name="l00673"></a>00673 <span class="keyword"></span>{
<a name="l00674"></a>00674 
<a name="l00675"></a>00675   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#aadc5601daf830461d22dbe57f8978b14" title="If available, the Postgis spatial_ref_sys identifier for this srs (defaults to 0)">mSRID</a>;
<a name="l00676"></a>00676 
<a name="l00677"></a>00677 }
<a name="l00678"></a>00678 
<a name="l00679"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#afae7fd3ededbb445ebf67678b6bf7d0c">00679</a> <span class="keywordtype">long</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#afae7fd3ededbb445ebf67678b6bf7d0c">QgsCoordinateReferenceSystem::epsg</a>()<span class="keyword"> const</span>
<a name="l00680"></a>00680 <span class="keyword"></span>{
<a name="l00681"></a>00681   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a>.startsWith( <span class="stringliteral">&quot;EPSG:&quot;</span>, Qt::CaseInsensitive ) )
<a name="l00682"></a>00682     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a>.mid( 5 ).toLong();
<a name="l00683"></a>00683   <span class="keywordflow">else</span>
<a name="l00684"></a>00684     <span class="keywordflow">return</span> 0;
<a name="l00685"></a>00685 }
<a name="l00686"></a>00686 
<a name="l00687"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a4382981b1233c7f0ca1c7ce7bdb670d3">00687</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a4382981b1233c7f0ca1c7ce7bdb670d3">QgsCoordinateReferenceSystem::authid</a>()<span class="keyword"> const</span>
<a name="l00688"></a>00688 <span class="keyword"></span>{
<a name="l00689"></a>00689   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a>;
<a name="l00690"></a>00690 }
<a name="l00691"></a>00691 
<a name="l00692"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#afbb64ee54a05d2f414cd6bc91850d768">00692</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#afbb64ee54a05d2f414cd6bc91850d768">QgsCoordinateReferenceSystem::description</a>()<span class="keyword"> const</span>
<a name="l00693"></a>00693 <span class="keyword"></span>{
<a name="l00694"></a>00694   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a587603e45b3e111d38c377b4bf90d052" title="A textual description of the srs.">mDescription</a>.isNull() )
<a name="l00695"></a>00695   {
<a name="l00696"></a>00696     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00697"></a>00697   }
<a name="l00698"></a>00698   <span class="keywordflow">else</span>
<a name="l00699"></a>00699   {
<a name="l00700"></a>00700     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a587603e45b3e111d38c377b4bf90d052" title="A textual description of the srs.">mDescription</a>;
<a name="l00701"></a>00701   }
<a name="l00702"></a>00702 }
<a name="l00703"></a>00703 
<a name="l00704"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a5856631fdebbfe839fa0955d5c36630a">00704</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a5856631fdebbfe839fa0955d5c36630a">QgsCoordinateReferenceSystem::projectionAcronym</a>()<span class="keyword"> const</span>
<a name="l00705"></a>00705 <span class="keyword"></span>{
<a name="l00706"></a>00706   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a>.isNull() )
<a name="l00707"></a>00707   {
<a name="l00708"></a>00708     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00709"></a>00709   }
<a name="l00710"></a>00710   <span class="keywordflow">else</span>
<a name="l00711"></a>00711   {
<a name="l00712"></a>00712     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a>;
<a name="l00713"></a>00713   }
<a name="l00714"></a>00714 }
<a name="l00715"></a>00715 
<a name="l00716"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a23f9df6ec7aa26eff0f3e535d0a82470">00716</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a23f9df6ec7aa26eff0f3e535d0a82470">QgsCoordinateReferenceSystem::ellipsoidAcronym</a>()<span class="keyword"> const</span>
<a name="l00717"></a>00717 <span class="keyword"></span>{
<a name="l00718"></a>00718   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a>.isNull() )
<a name="l00719"></a>00719   {
<a name="l00720"></a>00720     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00721"></a>00721   }
<a name="l00722"></a>00722   <span class="keywordflow">else</span>
<a name="l00723"></a>00723   {
<a name="l00724"></a>00724     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a>;
<a name="l00725"></a>00725   }
<a name="l00726"></a>00726 }
<a name="l00727"></a>00727 
<a name="l00728"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f">00728</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">QgsCoordinateReferenceSystem::toProj4</a>()<span class="keyword"> const</span>
<a name="l00729"></a>00729 <span class="keyword"></span>{
<a name="l00730"></a>00730   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00731"></a>00731     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00732"></a>00732 
<a name="l00733"></a>00733   QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>;
<a name="l00734"></a>00734   <span class="keywordtype">char</span> *proj4src = NULL;
<a name="l00735"></a>00735   OSRExportToProj4( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, &amp;proj4src );
<a name="l00736"></a>00736   toProj4 = proj4src;
<a name="l00737"></a>00737   CPLFree( proj4src );
<a name="l00738"></a>00738 
<a name="l00739"></a>00739   <span class="comment">// Stray spaces at the end?</span>
<a name="l00740"></a>00740   <span class="keywordflow">return</span> toProj4.trimmed();
<a name="l00741"></a>00741 }
<a name="l00742"></a>00742 
<a name="l00743"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a06cbad30d422173714895af571928cb2">00743</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a06cbad30d422173714895af571928cb2">QgsCoordinateReferenceSystem::geographicFlag</a>()<span class="keyword"> const</span>
<a name="l00744"></a>00744 <span class="keyword"></span>{
<a name="l00745"></a>00745   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a6f9be65a137f9ea477f7190de74c8f66" title="Whether this is a geographic or projected coordinate system.">mGeoFlag</a>;
<a name="l00746"></a>00746 }
<a name="l00747"></a>00747 
<a name="l00748"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a8dd2d190edae32d6e6ca63cfd8154154">00748</a> <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379c" title="Map units that qgis supports.">QGis::UnitType</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a8dd2d190edae32d6e6ca63cfd8154154">QgsCoordinateReferenceSystem::mapUnits</a>()<span class="keyword"> const</span>
<a name="l00749"></a>00749 <span class="keyword"></span>{
<a name="l00750"></a>00750   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a>;
<a name="l00751"></a>00751 }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753 
<a name="l00754"></a>00754 <span class="comment">// Mutators -----------------------------------</span>
<a name="l00755"></a>00755 
<a name="l00756"></a>00756 
<a name="l00757"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a53fc815b9a4f09b68678c1e6565eb1c0">00757</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a53fc815b9a4f09b68678c1e6565eb1c0">QgsCoordinateReferenceSystem::setInternalId</a>( <span class="keywordtype">long</span> theSrsId )
<a name="l00758"></a>00758 {
<a name="l00759"></a>00759   <a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a> = theSrsId;
<a name="l00760"></a>00760 }
<a name="l00761"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ab88807a76674cd7890c167396cf69fa1">00761</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ab88807a76674cd7890c167396cf69fa1">QgsCoordinateReferenceSystem::setAuthId</a>( QString authId )
<a name="l00762"></a>00762 {
<a name="l00763"></a>00763   <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a> = authId;
<a name="l00764"></a>00764 }
<a name="l00765"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a48720d509f6f87ee5d20fe63fa8546ef">00765</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a48720d509f6f87ee5d20fe63fa8546ef">QgsCoordinateReferenceSystem::setSrid</a>( <span class="keywordtype">long</span> theSrid )
<a name="l00766"></a>00766 {
<a name="l00767"></a>00767   <a class="code" href="classQgsCoordinateReferenceSystem.html#aadc5601daf830461d22dbe57f8978b14" title="If available, the Postgis spatial_ref_sys identifier for this srs (defaults to 0)">mSRID</a> = theSrid;
<a name="l00768"></a>00768 }
<a name="l00769"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#adc75c14d21fea1e2e912be121816719c">00769</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#adc75c14d21fea1e2e912be121816719c">QgsCoordinateReferenceSystem::setDescription</a>( QString theDescription )
<a name="l00770"></a>00770 {
<a name="l00771"></a>00771   <a class="code" href="classQgsCoordinateReferenceSystem.html#a587603e45b3e111d38c377b4bf90d052" title="A textual description of the srs.">mDescription</a> = theDescription;
<a name="l00772"></a>00772 }
<a name="l00773"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ae0cd0008b170f81f0721fb475780e9ab">00773</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ae0cd0008b170f81f0721fb475780e9ab">QgsCoordinateReferenceSystem::setProj4String</a>( QString theProj4String )
<a name="l00774"></a>00774 {
<a name="l00775"></a>00775   <span class="keyword">const</span> <span class="keywordtype">char</span> *oldlocale = setlocale( LC_NUMERIC, NULL );
<a name="l00776"></a>00776 
<a name="l00777"></a>00777   setlocale( LC_NUMERIC, <span class="stringliteral">&quot;C&quot;</span> );
<a name="l00778"></a>00778   OSRDestroySpatialReference( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> );
<a name="l00779"></a>00779   <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> = OSRNewSpatialReference( NULL );
<a name="l00780"></a>00780   <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = OSRImportFromProj4( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, theProj4String.toLatin1().constData() ) == OGRERR_NONE;
<a name="l00781"></a>00781   <a class="code" href="classQgsCoordinateReferenceSystem.html#ac552bc85c6d409b529b6889bfd2456ac" title="Work out the projection units and set the appropriate local variable.">setMapUnits</a>();
<a name="l00782"></a>00782 
<a name="l00783"></a>00783 <span class="preprocessor">#if defined(QGISDEBUG) &amp;&amp; QGISDEBUG&gt;=3</span>
<a name="l00784"></a>00784 <span class="preprocessor"></span>  <a class="code" href="classQgsCoordinateReferenceSystem.html#a43352910866a504c28c15be3bc73310f">debugPrint</a>();
<a name="l00785"></a>00785 <span class="preprocessor">#endif</span>
<a name="l00786"></a>00786 <span class="preprocessor"></span>
<a name="l00787"></a>00787   setlocale( LC_NUMERIC, oldlocale );
<a name="l00788"></a>00788 }
<a name="l00789"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a0164e462112889c561930102d28f4a61">00789</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a0164e462112889c561930102d28f4a61">QgsCoordinateReferenceSystem::setGeographicFlag</a>( <span class="keywordtype">bool</span> theGeoFlag )
<a name="l00790"></a>00790 {
<a name="l00791"></a>00791   <a class="code" href="classQgsCoordinateReferenceSystem.html#a6f9be65a137f9ea477f7190de74c8f66" title="Whether this is a geographic or projected coordinate system.">mGeoFlag</a> = theGeoFlag;
<a name="l00792"></a>00792 }
<a name="l00793"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a95dd68e576966d65c21614ed4f8a4906">00793</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a95dd68e576966d65c21614ed4f8a4906">QgsCoordinateReferenceSystem::setEpsg</a>( <span class="keywordtype">long</span> theEpsg )
<a name="l00794"></a>00794 {
<a name="l00795"></a>00795   <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a> = QString( <span class="stringliteral">&quot;EPSG:%1&quot;</span> ).arg( theEpsg );
<a name="l00796"></a>00796 }
<a name="l00797"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a915bde3df8c1c293b2e8fb093a38c5fb">00797</a> <span class="keywordtype">void</span>  <a class="code" href="classQgsCoordinateReferenceSystem.html#a915bde3df8c1c293b2e8fb093a38c5fb">QgsCoordinateReferenceSystem::setProjectionAcronym</a>( QString theProjectionAcronym )
<a name="l00798"></a>00798 {
<a name="l00799"></a>00799   <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a> = theProjectionAcronym;
<a name="l00800"></a>00800 }
<a name="l00801"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a730dc46ee45abe759ba0e8c5ed5bb998">00801</a> <span class="keywordtype">void</span>  <a class="code" href="classQgsCoordinateReferenceSystem.html#a730dc46ee45abe759ba0e8c5ed5bb998">QgsCoordinateReferenceSystem::setEllipsoidAcronym</a>( QString theEllipsoidAcronym )
<a name="l00802"></a>00802 {
<a name="l00803"></a>00803   <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a> = theEllipsoidAcronym;
<a name="l00804"></a>00804 }
<a name="l00805"></a>00805 
<a name="l00806"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ac552bc85c6d409b529b6889bfd2456ac">00806</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ac552bc85c6d409b529b6889bfd2456ac" title="Work out the projection units and set the appropriate local variable.">QgsCoordinateReferenceSystem::setMapUnits</a>()
<a name="l00807"></a>00807 {
<a name="l00808"></a>00808   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00809"></a>00809   {
<a name="l00810"></a>00810     <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a> = <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca0790d6f2b2c0747502235775b6b556ee">QGis::UnknownUnit</a>;
<a name="l00811"></a>00811     <span class="keywordflow">return</span>;
<a name="l00812"></a>00812   }
<a name="l00813"></a>00813 
<a name="l00814"></a>00814   <span class="keywordtype">char</span> *unitName;
<a name="l00815"></a>00815 
<a name="l00816"></a>00816   <span class="comment">// Of interest to us is that this call adds in a unit parameter if</span>
<a name="l00817"></a>00817   <span class="comment">// one doesn&#39;t already exist.</span>
<a name="l00818"></a>00818   OSRFixup( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> );
<a name="l00819"></a>00819 
<a name="l00820"></a>00820   <span class="keywordflow">if</span> ( OSRIsProjected( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> ) )
<a name="l00821"></a>00821   {
<a name="l00822"></a>00822     <span class="keywordtype">double</span> toMeter = OSRGetLinearUnits( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, &amp;unitName );
<a name="l00823"></a>00823     QString unit( unitName );
<a name="l00824"></a>00824 
<a name="l00825"></a>00825     <span class="comment">// If the units parameter was created during the Fixup() call</span>
<a name="l00826"></a>00826     <span class="comment">// above, the name of the units is likely to be &#39;unknown&#39;. Try to</span>
<a name="l00827"></a>00827     <span class="comment">// do better than that ... (but perhaps ogr should be enhanced to</span>
<a name="l00828"></a>00828     <span class="comment">// do this instead?).</span>
<a name="l00829"></a>00829 
<a name="l00830"></a>00830     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> feetToMeter = 0.3048;
<a name="l00831"></a>00831     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> smallNum = 1e-3;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833     <span class="keywordflow">if</span> ( qAbs( toMeter - feetToMeter ) &lt; smallNum )
<a name="l00834"></a>00834       unit = <span class="stringliteral">&quot;Foot&quot;</span>;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Projection has linear units of &quot;</span> + unit );
<a name="l00837"></a>00837 
<a name="l00838"></a>00838     <span class="keywordflow">if</span> ( <a class="code" href="qgis_8h.html#a14039c8aa54bda84192e28ecb298ed20">doubleNear</a>( toMeter, 1.0 ) ) <span class="comment">//Unit name for meters would be &quot;metre&quot;</span>
<a name="l00839"></a>00839       <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a> = <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca5132b3d9c171301d76d7a14d8b3a86dc">QGis::Meters</a>;
<a name="l00840"></a>00840     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( unit == <span class="stringliteral">&quot;Foot&quot;</span> )
<a name="l00841"></a>00841       <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a> = <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca0b4a519c1888a3f2beb8c1d23a4b2393">QGis::Feet</a>;
<a name="l00842"></a>00842     <span class="keywordflow">else</span>
<a name="l00843"></a>00843     {
<a name="l00844"></a>00844       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Unsupported map units of &quot;</span> + unit );
<a name="l00845"></a>00845       <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a> = <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca0790d6f2b2c0747502235775b6b556ee">QGis::UnknownUnit</a>;
<a name="l00846"></a>00846     }
<a name="l00847"></a>00847   }
<a name="l00848"></a>00848   <span class="keywordflow">else</span>
<a name="l00849"></a>00849   {
<a name="l00850"></a>00850     OSRGetAngularUnits( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, &amp;unitName );
<a name="l00851"></a>00851     QString unit( unitName );
<a name="l00852"></a>00852     <span class="keywordflow">if</span> ( unit == <span class="stringliteral">&quot;degree&quot;</span> )
<a name="l00853"></a>00853       <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a> = <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca94852e9654597b263f080312bc76c110">QGis::Degrees</a>;
<a name="l00854"></a>00854     <span class="keywordflow">else</span>
<a name="l00855"></a>00855     {
<a name="l00856"></a>00856       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Unsupported map units of &quot;</span> + unit );
<a name="l00857"></a>00857       <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a> = <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca0790d6f2b2c0747502235775b6b556ee">QGis::UnknownUnit</a>;
<a name="l00858"></a>00858     }
<a name="l00859"></a>00859     <a class="code" href="qgslogger_8h.html#a795a1fcfb1c61b988bbd999396411d13">QgsDebugMsgLevel</a>( <span class="stringliteral">&quot;Projection has angular units of &quot;</span> + unit, 3 );
<a name="l00860"></a>00860   }
<a name="l00861"></a>00861 }
<a name="l00862"></a>00862 
<a name="l00863"></a>00863 <span class="comment">/*</span>
<a name="l00864"></a>00864 <span class="comment">*    check if srs is a geocs or a proj cs (using ogr isGeographic)</span>
<a name="l00865"></a>00865 <span class="comment">*   then sequentially walk through the database (first users qgis.db srs tbl then</span>
<a name="l00866"></a>00866 <span class="comment">*   system srs.db tbl), converting each entry into an ogr srs and using isSame</span>
<a name="l00867"></a>00867 <span class="comment">*   or isSameGeocs (essentially calling the == overloaded operator). We&#39;ll try to</span>
<a name="l00868"></a>00868 <span class="comment">*   be smart about this and first parse out the proj and ellpse strings and only</span>
<a name="l00869"></a>00869 <span class="comment">*   check for a match in entities that have the same ellps and proj entries so</span>
<a name="l00870"></a>00870 <span class="comment">*   that it doesnt munch yer cpu so much.</span>
<a name="l00871"></a>00871 <span class="comment">*/</span>
<a name="l00872"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcef003135c7bf9de91c79e6d9a54bb">00872</a> <span class="keywordtype">long</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcef003135c7bf9de91c79e6d9a54bb">QgsCoordinateReferenceSystem::findMatchingProj</a>()
<a name="l00873"></a>00873 {
<a name="l00874"></a>00874   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;entered.&quot;</span> );
<a name="l00875"></a>00875   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a>.isNull() ||  <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a>.isNull() || !<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00876"></a>00876   {
<a name="l00877"></a>00877     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;QgsCoordinateReferenceSystem::findMatchingProj will only work if prj acr ellipsoid acr and proj4string are set&quot;</span>
<a name="l00878"></a>00878                  <span class="stringliteral">&quot; and the current projection is valid!&quot;</span> );
<a name="l00879"></a>00879     <span class="keywordflow">return</span> 0;
<a name="l00880"></a>00880   }
<a name="l00881"></a>00881 
<a name="l00882"></a>00882   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a>      *myDatabase;
<a name="l00883"></a>00883   <span class="keyword">const</span> <span class="keywordtype">char</span>   *myTail;
<a name="l00884"></a>00884   sqlite3_stmt *myPreparedStatement;
<a name="l00885"></a>00885   <span class="keywordtype">int</span>           myResult;
<a name="l00886"></a>00886 
<a name="l00887"></a>00887   <span class="comment">// Set up the query to retrieve the projection information needed to populate the list</span>
<a name="l00888"></a>00888   QString mySql = QString( <span class="stringliteral">&quot;select srs_id,parameters from tbl_srs where projection_acronym=%1 and ellipsoid_acronym=%2&quot;</span> )
<a name="l00889"></a>00889                   .arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a> ) )
<a name="l00890"></a>00890                   .arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a> ) );
<a name="l00891"></a>00891   <span class="comment">// Get the full path name to the sqlite3 spatial reference database.</span>
<a name="l00892"></a>00892   QString myDatabaseFileName = <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>();
<a name="l00893"></a>00893 
<a name="l00894"></a>00894   <span class="comment">//check the db is available</span>
<a name="l00895"></a>00895   myResult = <a class="code" href="classQgsCoordinateReferenceSystem.html#ae487d953822068a45b9c8d2ef60a6d07">openDb</a>( myDatabaseFileName, &amp;myDatabase );
<a name="l00896"></a>00896   <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l00897"></a>00897   {
<a name="l00898"></a>00898     <span class="keywordflow">return</span> 0;
<a name="l00899"></a>00899   }
<a name="l00900"></a>00900 
<a name="l00901"></a>00901   myResult = sqlite3_prepare( myDatabase, mySql.toUtf8(), mySql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l00902"></a>00902 <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l00903"></a>00903   <span class="keywordflow">if</span> ( myResult == SQLITE_OK )
<a name="l00904"></a>00904   {
<a name="l00905"></a>00905 
<a name="l00906"></a>00906     <span class="keywordflow">while</span> ( sqlite3_step( myPreparedStatement ) == SQLITE_ROW )
<a name="l00907"></a>00907     {
<a name="l00908"></a>00908       QString mySrsId = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 0 ) );
<a name="l00909"></a>00909       QString myProj4String = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 1 ) );
<a name="l00910"></a>00910       <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#ad9fbea571e861f319fbf961cece39995">equals</a>( myProj4String ) )
<a name="l00911"></a>00911       {
<a name="l00912"></a>00912         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;-------&gt; MATCH FOUND in srs.db srsid: &quot;</span> + mySrsId );
<a name="l00913"></a>00913         <span class="comment">// close the sqlite3 statement</span>
<a name="l00914"></a>00914         sqlite3_finalize( myPreparedStatement );
<a name="l00915"></a>00915         sqlite3_close( myDatabase );
<a name="l00916"></a>00916         <span class="keywordflow">return</span> mySrsId.toLong();
<a name="l00917"></a>00917       }
<a name="l00918"></a>00918       <span class="keywordflow">else</span>
<a name="l00919"></a>00919       {
<a name="l00920"></a>00920 <span class="comment">// QgsDebugMsg(QString(&quot; Not matched : %1&quot;).arg(myProj4String));</span>
<a name="l00921"></a>00921       }
<a name="l00922"></a>00922     }
<a name="l00923"></a>00923   }
<a name="l00924"></a>00924   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;no match found in srs.db, trying user db now!&quot;</span> );
<a name="l00925"></a>00925   <span class="comment">// close the sqlite3 statement</span>
<a name="l00926"></a>00926   sqlite3_finalize( myPreparedStatement );
<a name="l00927"></a>00927   sqlite3_close( myDatabase );
<a name="l00928"></a>00928   <span class="comment">//</span>
<a name="l00929"></a>00929   <span class="comment">// Try the users db now</span>
<a name="l00930"></a>00930   <span class="comment">//</span>
<a name="l00931"></a>00931 
<a name="l00932"></a>00932   myDatabaseFileName = <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>();
<a name="l00933"></a>00933   <span class="comment">//check the db is available</span>
<a name="l00934"></a>00934   myResult = <a class="code" href="classQgsCoordinateReferenceSystem.html#ae487d953822068a45b9c8d2ef60a6d07">openDb</a>( myDatabaseFileName, &amp;myDatabase );
<a name="l00935"></a>00935   <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l00936"></a>00936   {
<a name="l00937"></a>00937     <span class="keywordflow">return</span> 0;
<a name="l00938"></a>00938   }
<a name="l00939"></a>00939 
<a name="l00940"></a>00940   myResult = sqlite3_prepare( myDatabase, mySql.toUtf8(), mySql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l00941"></a>00941 <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l00942"></a>00942   <span class="keywordflow">if</span> ( myResult == SQLITE_OK )
<a name="l00943"></a>00943   {
<a name="l00944"></a>00944 
<a name="l00945"></a>00945     <span class="keywordflow">while</span> ( sqlite3_step( myPreparedStatement ) == SQLITE_ROW )
<a name="l00946"></a>00946     {
<a name="l00947"></a>00947       QString mySrsId = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 0 ) );
<a name="l00948"></a>00948       QString myProj4String = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 1 ) );
<a name="l00949"></a>00949       <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#ad9fbea571e861f319fbf961cece39995">equals</a>( myProj4String ) )
<a name="l00950"></a>00950       {
<a name="l00951"></a>00951         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;-------&gt; MATCH FOUND in user qgis.db srsid: &quot;</span> + mySrsId );
<a name="l00952"></a>00952         <span class="comment">// close the sqlite3 statement</span>
<a name="l00953"></a>00953         sqlite3_finalize( myPreparedStatement );
<a name="l00954"></a>00954         sqlite3_close( myDatabase );
<a name="l00955"></a>00955         <span class="keywordflow">return</span> mySrsId.toLong();
<a name="l00956"></a>00956       }
<a name="l00957"></a>00957       <span class="keywordflow">else</span>
<a name="l00958"></a>00958       {
<a name="l00959"></a>00959 <span class="comment">// QgsDebugMsg(QString(&quot; Not matched : %1&quot;).arg(myProj4String));</span>
<a name="l00960"></a>00960       }
<a name="l00961"></a>00961     }
<a name="l00962"></a>00962   }
<a name="l00963"></a>00963   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;no match found in user db&quot;</span> );
<a name="l00964"></a>00964 
<a name="l00965"></a>00965   <span class="comment">// close the sqlite3 statement</span>
<a name="l00966"></a>00966   sqlite3_finalize( myPreparedStatement );
<a name="l00967"></a>00967   sqlite3_close( myDatabase );
<a name="l00968"></a>00968   <span class="keywordflow">return</span> 0;
<a name="l00969"></a>00969 }
<a name="l00970"></a>00970 
<a name="l00971"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a06a9202bdd0a9361e11d3f94ff0eb1cb">00971</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a06a9202bdd0a9361e11d3f94ff0eb1cb">QgsCoordinateReferenceSystem::operator==</a>( <span class="keyword">const</span> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> &amp;theSrs )
<a name="l00972"></a>00972 {
<a name="l00973"></a>00973   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> || !theSrs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00974"></a>00974   {
<a name="l00975"></a>00975     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00976"></a>00976   }
<a name="l00977"></a>00977   <span class="keywordtype">char</span> *thisStr;
<a name="l00978"></a>00978   <span class="keywordtype">char</span> *otherStr;
<a name="l00979"></a>00979 
<a name="l00980"></a>00980   <span class="comment">// OSRIsSame is not relaibel when it comes to comparing +towgs84 parameters</span>
<a name="l00981"></a>00981   <span class="comment">// Use string compare on WKT instead.</span>
<a name="l00982"></a>00982   <span class="keywordflow">if</span> (( OSRExportToWkt( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, &amp;thisStr ) == OGRERR_NONE ) )
<a name="l00983"></a>00983   {
<a name="l00984"></a>00984     <span class="keywordflow">if</span> ( OSRExportToWkt( theSrs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, &amp;otherStr ) == OGRERR_NONE )
<a name="l00985"></a>00985     {
<a name="l00986"></a>00986       <a class="code" href="qgslogger_8h.html#a795a1fcfb1c61b988bbd999396411d13">QgsDebugMsgLevel</a>( QString( <span class="stringliteral">&quot;Comparing &quot;</span> ) + thisStr, 3 );
<a name="l00987"></a>00987       <a class="code" href="qgslogger_8h.html#a795a1fcfb1c61b988bbd999396411d13">QgsDebugMsgLevel</a>( QString( <span class="stringliteral">&quot;     with &quot;</span> ) + otherStr, 3 );
<a name="l00988"></a>00988       <span class="keywordflow">if</span> ( !strcmp( thisStr, otherStr ) )
<a name="l00989"></a>00989       {
<a name="l00990"></a>00990         <a class="code" href="qgslogger_8h.html#a795a1fcfb1c61b988bbd999396411d13">QgsDebugMsgLevel</a>( QString( <span class="stringliteral">&quot;MATCHED!&quot;</span> ) + otherStr, 3 );
<a name="l00991"></a>00991         CPLFree( thisStr );
<a name="l00992"></a>00992         CPLFree( otherStr );
<a name="l00993"></a>00993         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00994"></a>00994       }
<a name="l00995"></a>00995       CPLFree( otherStr );
<a name="l00996"></a>00996     }
<a name="l00997"></a>00997     CPLFree( thisStr );
<a name="l00998"></a>00998   }
<a name="l00999"></a>00999   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01000"></a>01000 }
<a name="l01001"></a>01001 
<a name="l01002"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a4c214e99c126ff8cfee02f2173821e31">01002</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a4c214e99c126ff8cfee02f2173821e31">QgsCoordinateReferenceSystem::operator!=</a>( <span class="keyword">const</span> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> &amp;theSrs )
<a name="l01003"></a>01003 {
<a name="l01004"></a>01004   <span class="keywordflow">return</span>  !( *<span class="keyword">this</span> == theSrs );
<a name="l01005"></a>01005 }
<a name="l01006"></a>01006 
<a name="l01007"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ad9fbea571e861f319fbf961cece39995">01007</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ad9fbea571e861f319fbf961cece39995">QgsCoordinateReferenceSystem::equals</a>( QString theProj4String )
<a name="l01008"></a>01008 {
<a name="l01009"></a>01009   <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> r;
<a name="l01010"></a>01010   r.<a class="code" href="classQgsCoordinateReferenceSystem.html#ae0cd0008b170f81f0721fb475780e9ab">setProj4String</a>( theProj4String );
<a name="l01011"></a>01011   <span class="keywordflow">return</span> *<span class="keyword">this</span> == r;
<a name="l01012"></a>01012 }
<a name="l01013"></a>01013 
<a name="l01014"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a55e62f3f587e9de20ed911d26d12f499">01014</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a55e62f3f587e9de20ed911d26d12f499">QgsCoordinateReferenceSystem::toWkt</a>()<span class="keyword"> const</span>
<a name="l01015"></a>01015 <span class="keyword"></span>{
<a name="l01016"></a>01016   QString myWkt;
<a name="l01017"></a>01017   <span class="keywordtype">char</span>* Wkt;
<a name="l01018"></a>01018   <span class="keywordflow">if</span> ( OSRExportToWkt( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, &amp;Wkt ) == OGRERR_NONE )
<a name="l01019"></a>01019   {
<a name="l01020"></a>01020     myWkt = Wkt;
<a name="l01021"></a>01021     OGRFree( Wkt );
<a name="l01022"></a>01022   }
<a name="l01023"></a>01023 
<a name="l01024"></a>01024   <span class="keywordflow">return</span> myWkt;
<a name="l01025"></a>01025 }
<a name="l01026"></a>01026 
<a name="l01027"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ae9be6624a006ec1a1d92abc8471c354b">01027</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ae9be6624a006ec1a1d92abc8471c354b">QgsCoordinateReferenceSystem::readXML</a>( QDomNode &amp; theNode )
<a name="l01028"></a>01028 {
<a name="l01029"></a>01029   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Reading Spatial Ref Sys from xml ------------------------!&quot;</span> );
<a name="l01030"></a>01030   QDomNode srsNode  = theNode.namedItem( <span class="stringliteral">&quot;spatialrefsys&quot;</span> );
<a name="l01031"></a>01031 
<a name="l01032"></a>01032   <span class="keywordflow">if</span> ( ! srsNode.isNull() )
<a name="l01033"></a>01033   {
<a name="l01034"></a>01034     <span class="keywordtype">bool</span> initialized = <span class="keyword">false</span>;
<a name="l01035"></a>01035 
<a name="l01036"></a>01036     QDomNode myNode = srsNode.namedItem( <span class="stringliteral">&quot;authid&quot;</span> );
<a name="l01037"></a>01037     <span class="keywordflow">if</span> ( !myNode.isNull() )
<a name="l01038"></a>01038     {
<a name="l01039"></a>01039       initialized = <a class="code" href="classQgsCoordinateReferenceSystem.html#a5789a11684af1415ffc74d7ce9ab91f0" title="Set up this CRS from the given OGC CRS.">createFromOgcWmsCrs</a>( myNode.toElement().text() );
<a name="l01040"></a>01040     }
<a name="l01041"></a>01041 
<a name="l01042"></a>01042     <span class="keywordflow">if</span> ( !initialized )
<a name="l01043"></a>01043     {
<a name="l01044"></a>01044       myNode = srsNode.namedItem( <span class="stringliteral">&quot;epsg&quot;</span> );
<a name="l01045"></a>01045       <span class="keywordflow">if</span> ( !myNode.isNull() )
<a name="l01046"></a>01046         initialized = <a class="code" href="classQgsCoordinateReferenceSystem.html#a5789a11684af1415ffc74d7ce9ab91f0" title="Set up this CRS from the given OGC CRS.">createFromOgcWmsCrs</a>( QString( <span class="stringliteral">&quot;EPSG:%1&quot;</span> ).arg( myNode.toElement().text().toLong() ) );
<a name="l01047"></a>01047     }
<a name="l01048"></a>01048 
<a name="l01049"></a>01049     <span class="keywordflow">if</span> ( initialized )
<a name="l01050"></a>01050     {
<a name="l01051"></a>01051       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Set from auth id&quot;</span> );
<a name="l01052"></a>01052     }
<a name="l01053"></a>01053     <span class="keywordflow">else</span>
<a name="l01054"></a>01054     {
<a name="l01055"></a>01055       myNode = srsNode.namedItem( <span class="stringliteral">&quot;proj4&quot;</span> );
<a name="l01056"></a>01056 
<a name="l01057"></a>01057       <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#acf5ccd2750d310c725937a82a700ecdb">createFromProj4</a>( myNode.toElement().text() ) )
<a name="l01058"></a>01058       {
<a name="l01059"></a>01059         <span class="comment">// createFromProj4() sets everything, including map units</span>
<a name="l01060"></a>01060         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Setting from proj4 string&quot;</span> );
<a name="l01061"></a>01061       }
<a name="l01062"></a>01062       <span class="keywordflow">else</span>
<a name="l01063"></a>01063       {
<a name="l01064"></a>01064         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Setting from elements one by one&quot;</span> );
<a name="l01065"></a>01065 
<a name="l01066"></a>01066         myNode = srsNode.namedItem( <span class="stringliteral">&quot;proj4&quot;</span> );
<a name="l01067"></a>01067         <a class="code" href="classQgsCoordinateReferenceSystem.html#ae0cd0008b170f81f0721fb475780e9ab">setProj4String</a>( myNode.toElement().text() );
<a name="l01068"></a>01068 
<a name="l01069"></a>01069         myNode = srsNode.namedItem( <span class="stringliteral">&quot;srsid&quot;</span> );
<a name="l01070"></a>01070         <a class="code" href="classQgsCoordinateReferenceSystem.html#a53fc815b9a4f09b68678c1e6565eb1c0">setInternalId</a>( myNode.toElement().text().toLong() );
<a name="l01071"></a>01071 
<a name="l01072"></a>01072         myNode = srsNode.namedItem( <span class="stringliteral">&quot;srid&quot;</span> );
<a name="l01073"></a>01073         <a class="code" href="classQgsCoordinateReferenceSystem.html#a48720d509f6f87ee5d20fe63fa8546ef">setSrid</a>( myNode.toElement().text().toLong() );
<a name="l01074"></a>01074 
<a name="l01075"></a>01075         myNode = srsNode.namedItem( <span class="stringliteral">&quot;authid&quot;</span> );
<a name="l01076"></a>01076         <a class="code" href="classQgsCoordinateReferenceSystem.html#ab88807a76674cd7890c167396cf69fa1">setAuthId</a>( myNode.toElement().text() );
<a name="l01077"></a>01077 
<a name="l01078"></a>01078         myNode = srsNode.namedItem( <span class="stringliteral">&quot;description&quot;</span> );
<a name="l01079"></a>01079         <a class="code" href="classQgsCoordinateReferenceSystem.html#adc75c14d21fea1e2e912be121816719c">setDescription</a>( myNode.toElement().text() );
<a name="l01080"></a>01080 
<a name="l01081"></a>01081         myNode = srsNode.namedItem( <span class="stringliteral">&quot;projectionacronym&quot;</span> );
<a name="l01082"></a>01082         <a class="code" href="classQgsCoordinateReferenceSystem.html#a915bde3df8c1c293b2e8fb093a38c5fb">setProjectionAcronym</a>( myNode.toElement().text() );
<a name="l01083"></a>01083 
<a name="l01084"></a>01084         myNode = srsNode.namedItem( <span class="stringliteral">&quot;ellipsoidacronym&quot;</span> );
<a name="l01085"></a>01085         <a class="code" href="classQgsCoordinateReferenceSystem.html#a730dc46ee45abe759ba0e8c5ed5bb998">setEllipsoidAcronym</a>( myNode.toElement().text() );
<a name="l01086"></a>01086 
<a name="l01087"></a>01087         myNode = srsNode.namedItem( <span class="stringliteral">&quot;geographicflag&quot;</span> );
<a name="l01088"></a>01088         <span class="keywordflow">if</span> ( myNode.toElement().text().compare( <span class="stringliteral">&quot;true&quot;</span> ) )
<a name="l01089"></a>01089         {
<a name="l01090"></a>01090           <a class="code" href="classQgsCoordinateReferenceSystem.html#a0164e462112889c561930102d28f4a61">setGeographicFlag</a>( <span class="keyword">true</span> );
<a name="l01091"></a>01091         }
<a name="l01092"></a>01092         <span class="keywordflow">else</span>
<a name="l01093"></a>01093         {
<a name="l01094"></a>01094           <a class="code" href="classQgsCoordinateReferenceSystem.html#a0164e462112889c561930102d28f4a61">setGeographicFlag</a>( <span class="keyword">false</span> );
<a name="l01095"></a>01095         }
<a name="l01096"></a>01096 
<a name="l01097"></a>01097         <span class="comment">//make sure the map units have been set</span>
<a name="l01098"></a>01098         <a class="code" href="classQgsCoordinateReferenceSystem.html#ac552bc85c6d409b529b6889bfd2456ac" title="Work out the projection units and set the appropriate local variable.">setMapUnits</a>();
<a name="l01099"></a>01099 
<a name="l01100"></a>01100         <span class="comment">//@TODO this srs needs to be validated!!!</span>
<a name="l01101"></a>01101         <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <span class="keyword">true</span>;<span class="comment">//shamelessly hard coded for now</span>
<a name="l01102"></a>01102       }
<a name="l01103"></a>01103     }
<a name="l01104"></a>01104   }
<a name="l01105"></a>01105   <span class="keywordflow">else</span>
<a name="l01106"></a>01106   {
<a name="l01107"></a>01107     <span class="comment">// Return default CRS if none was found in the XML.</span>
<a name="l01108"></a>01108     <a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9fd9c20f2b6c8e7cbd1114205d0ec5">createFromId</a>( <a class="code" href="qgis_8h.html#af5cd54d47652544adf35af98511e41f4" title="Magic number for a geographic coord sys in QGIS srs.db tbl_srs.srs_id.">GEOCRS_ID</a>, <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cfabc92b4ee3c6be188b5dfe000ddac415e">InternalCrsId</a> );
<a name="l01109"></a>01109   }
<a name="l01110"></a>01110   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01111"></a>01111 }
<a name="l01112"></a>01112 
<a name="l01113"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ad7fca10482d45467afb74b244af6b31c">01113</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ad7fca10482d45467afb74b244af6b31c">QgsCoordinateReferenceSystem::writeXML</a>( QDomNode &amp; theNode, QDomDocument &amp; theDoc )<span class="keyword"> const</span>
<a name="l01114"></a>01114 <span class="keyword"></span>{
<a name="l01115"></a>01115 
<a name="l01116"></a>01116   QDomElement myLayerNode = theNode.toElement();
<a name="l01117"></a>01117   QDomElement mySrsElement  = theDoc.createElement( <span class="stringliteral">&quot;spatialrefsys&quot;</span> );
<a name="l01118"></a>01118 
<a name="l01119"></a>01119   QDomElement myProj4Element  = theDoc.createElement( <span class="stringliteral">&quot;proj4&quot;</span> );
<a name="l01120"></a>01120   myProj4Element.appendChild( theDoc.createTextNode( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() ) );
<a name="l01121"></a>01121   mySrsElement.appendChild( myProj4Element );
<a name="l01122"></a>01122 
<a name="l01123"></a>01123   QDomElement mySrsIdElement  = theDoc.createElement( <span class="stringliteral">&quot;srsid&quot;</span> );
<a name="l01124"></a>01124   mySrsIdElement.appendChild( theDoc.createTextNode( QString::number( <a class="code" href="classQgsCoordinateReferenceSystem.html#add285911972f1facfe30388ab0eba01a">srsid</a>() ) ) );
<a name="l01125"></a>01125   mySrsElement.appendChild( mySrsIdElement );
<a name="l01126"></a>01126 
<a name="l01127"></a>01127   QDomElement mySridElement  = theDoc.createElement( <span class="stringliteral">&quot;srid&quot;</span> );
<a name="l01128"></a>01128   mySridElement.appendChild( theDoc.createTextNode( QString::number( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3cb64f24049d50fbacffd1eece5125ee">postgisSrid</a>() ) ) );
<a name="l01129"></a>01129   mySrsElement.appendChild( mySridElement );
<a name="l01130"></a>01130 
<a name="l01131"></a>01131   QDomElement myEpsgElement  = theDoc.createElement( <span class="stringliteral">&quot;authid&quot;</span> );
<a name="l01132"></a>01132   myEpsgElement.appendChild( theDoc.createTextNode( <a class="code" href="classQgsCoordinateReferenceSystem.html#a4382981b1233c7f0ca1c7ce7bdb670d3">authid</a>() ) );
<a name="l01133"></a>01133   mySrsElement.appendChild( myEpsgElement );
<a name="l01134"></a>01134 
<a name="l01135"></a>01135   QDomElement myDescriptionElement  = theDoc.createElement( <span class="stringliteral">&quot;description&quot;</span> );
<a name="l01136"></a>01136   myDescriptionElement.appendChild( theDoc.createTextNode( <a class="code" href="classQgsCoordinateReferenceSystem.html#afbb64ee54a05d2f414cd6bc91850d768">description</a>() ) );
<a name="l01137"></a>01137   mySrsElement.appendChild( myDescriptionElement );
<a name="l01138"></a>01138 
<a name="l01139"></a>01139   QDomElement myProjectionAcronymElement  = theDoc.createElement( <span class="stringliteral">&quot;projectionacronym&quot;</span> );
<a name="l01140"></a>01140   myProjectionAcronymElement.appendChild( theDoc.createTextNode( <a class="code" href="classQgsCoordinateReferenceSystem.html#a5856631fdebbfe839fa0955d5c36630a">projectionAcronym</a>() ) );
<a name="l01141"></a>01141   mySrsElement.appendChild( myProjectionAcronymElement );
<a name="l01142"></a>01142 
<a name="l01143"></a>01143   QDomElement myEllipsoidAcronymElement  = theDoc.createElement( <span class="stringliteral">&quot;ellipsoidacronym&quot;</span> );
<a name="l01144"></a>01144   myEllipsoidAcronymElement.appendChild( theDoc.createTextNode( <a class="code" href="classQgsCoordinateReferenceSystem.html#a23f9df6ec7aa26eff0f3e535d0a82470">ellipsoidAcronym</a>() ) );
<a name="l01145"></a>01145   mySrsElement.appendChild( myEllipsoidAcronymElement );
<a name="l01146"></a>01146 
<a name="l01147"></a>01147   QDomElement myGeographicFlagElement  = theDoc.createElement( <span class="stringliteral">&quot;geographicflag&quot;</span> );
<a name="l01148"></a>01148   QString myGeoFlagText = <span class="stringliteral">&quot;false&quot;</span>;
<a name="l01149"></a>01149   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a06cbad30d422173714895af571928cb2">geographicFlag</a>() )
<a name="l01150"></a>01150   {
<a name="l01151"></a>01151     myGeoFlagText = <span class="stringliteral">&quot;true&quot;</span>;
<a name="l01152"></a>01152   }
<a name="l01153"></a>01153 
<a name="l01154"></a>01154   myGeographicFlagElement.appendChild( theDoc.createTextNode( myGeoFlagText ) );
<a name="l01155"></a>01155   mySrsElement.appendChild( myGeographicFlagElement );
<a name="l01156"></a>01156 
<a name="l01157"></a>01157   myLayerNode.appendChild( mySrsElement );
<a name="l01158"></a>01158 
<a name="l01159"></a>01159   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01160"></a>01160 }
<a name="l01161"></a>01161 
<a name="l01162"></a>01162 
<a name="l01163"></a>01163 
<a name="l01164"></a>01164 <span class="comment">//</span>
<a name="l01165"></a>01165 <span class="comment">// Static helper methods below this point only please!</span>
<a name="l01166"></a>01166 <span class="comment">//</span>
<a name="l01167"></a>01167 
<a name="l01168"></a>01168 
<a name="l01169"></a>01169 <span class="comment">// Returns the whole proj4 string for the selected srsid</span>
<a name="l01170"></a>01170 <span class="comment">//this is a static method! NOTE I&#39;ve made it private for now to reduce API clutter TS</span>
<a name="l01171"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a4b9a3e12aa2a2a70f2500869d8ae1277">01171</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a4b9a3e12aa2a2a70f2500869d8ae1277" title="A static helper function to find out the proj4 string for a srsid.">QgsCoordinateReferenceSystem::proj4FromSrsId</a>( <span class="keyword">const</span> <span class="keywordtype">int</span> theSrsId )
<a name="l01172"></a>01172 {
<a name="l01173"></a>01173 
<a name="l01174"></a>01174   QString myDatabaseFileName;
<a name="l01175"></a>01175   QString myProjString;
<a name="l01176"></a>01176   QString mySql = <span class="stringliteral">&quot;select parameters from tbl_srs where srs_id = &quot;</span>;
<a name="l01177"></a>01177   mySql += QString::number( theSrsId );
<a name="l01178"></a>01178 
<a name="l01179"></a>01179   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;mySrsId = &quot;</span> + QString::number( theSrsId ) );
<a name="l01180"></a>01180   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;USER_CRS_START_ID = &quot;</span> + QString::number( <a class="code" href="qgis_8h.html#ad8794344628fad7031cceb6b8ab2b8ec" title="Magick number that determines whether a projection crsid is a system (srs.db) or user (~/...">USER_CRS_START_ID</a> ) );
<a name="l01181"></a>01181   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Selection sql : &quot;</span> + mySql );
<a name="l01182"></a>01182 
<a name="l01183"></a>01183   <span class="comment">//</span>
<a name="l01184"></a>01184   <span class="comment">// Determine if this is a user projection or a system on</span>
<a name="l01185"></a>01185   <span class="comment">// user projection defs all have srs_id &gt;= 100000</span>
<a name="l01186"></a>01186   <span class="comment">//</span>
<a name="l01187"></a>01187   <span class="keywordflow">if</span> ( theSrsId &gt;= <a class="code" href="qgis_8h.html#ad8794344628fad7031cceb6b8ab2b8ec" title="Magick number that determines whether a projection crsid is a system (srs.db) or user (~/...">USER_CRS_START_ID</a> )
<a name="l01188"></a>01188   {
<a name="l01189"></a>01189     myDatabaseFileName = <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>();
<a name="l01190"></a>01190     QFileInfo myFileInfo;
<a name="l01191"></a>01191     myFileInfo.setFile( myDatabaseFileName );
<a name="l01192"></a>01192     <span class="keywordflow">if</span> ( !myFileInfo.exists( ) ) <span class="comment">//its unlikely that this condition will ever be reached</span>
<a name="l01193"></a>01193     {
<a name="l01194"></a>01194       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;users qgis.db not found&quot;</span> );
<a name="l01195"></a>01195       <span class="keywordflow">return</span> NULL;
<a name="l01196"></a>01196     }
<a name="l01197"></a>01197   }
<a name="l01198"></a>01198   <span class="keywordflow">else</span> <span class="comment">//must be  a system projection then</span>
<a name="l01199"></a>01199   {
<a name="l01200"></a>01200     myDatabaseFileName = <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>();
<a name="l01201"></a>01201   }
<a name="l01202"></a>01202   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;db = &quot;</span> + myDatabaseFileName );
<a name="l01203"></a>01203 
<a name="l01204"></a>01204   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a> *db;
<a name="l01205"></a>01205   <span class="keywordtype">int</span> rc;
<a name="l01206"></a>01206   rc = <a class="code" href="classQgsCoordinateReferenceSystem.html#ae487d953822068a45b9c8d2ef60a6d07">openDb</a>( myDatabaseFileName, &amp;db );
<a name="l01207"></a>01207   <span class="keywordflow">if</span> ( rc )
<a name="l01208"></a>01208   {
<a name="l01209"></a>01209     <span class="keywordflow">return</span> QString();
<a name="l01210"></a>01210   }
<a name="l01211"></a>01211   <span class="comment">// prepare the sql statement</span>
<a name="l01212"></a>01212   <span class="keyword">const</span> <span class="keywordtype">char</span> *pzTail;
<a name="l01213"></a>01213   sqlite3_stmt *ppStmt;
<a name="l01214"></a>01214 
<a name="l01215"></a>01215   rc = sqlite3_prepare( db, mySql.toUtf8(), mySql.toUtf8().length(), &amp;ppStmt, &amp;pzTail );
<a name="l01216"></a>01216   <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l01217"></a>01217 
<a name="l01218"></a>01218   <span class="keywordflow">if</span> ( rc == SQLITE_OK )
<a name="l01219"></a>01219   {
<a name="l01220"></a>01220     <span class="keywordflow">if</span> ( sqlite3_step( ppStmt ) == SQLITE_ROW )
<a name="l01221"></a>01221     {
<a name="l01222"></a>01222       myProjString = QString::fromUtf8(( <span class="keywordtype">char</span>* )sqlite3_column_text( ppStmt, 0 ) );
<a name="l01223"></a>01223     }
<a name="l01224"></a>01224   }
<a name="l01225"></a>01225   <span class="comment">// close the statement</span>
<a name="l01226"></a>01226   sqlite3_finalize( ppStmt );
<a name="l01227"></a>01227   <span class="comment">// close the database</span>
<a name="l01228"></a>01228   sqlite3_close( db );
<a name="l01229"></a>01229 
<a name="l01230"></a>01230   <span class="comment">//Q_ASSERT(myProjString.length() &gt; 0);</span>
<a name="l01231"></a>01231   <span class="keywordflow">return</span> myProjString;
<a name="l01232"></a>01232 }
<a name="l01233"></a>01233 
<a name="l01234"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ae487d953822068a45b9c8d2ef60a6d07">01234</a> <span class="keywordtype">int</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ae487d953822068a45b9c8d2ef60a6d07">QgsCoordinateReferenceSystem::openDb</a>( QString path, <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a> **db )
<a name="l01235"></a>01235 {
<a name="l01236"></a>01236   <a class="code" href="qgslogger_8h.html#a795a1fcfb1c61b988bbd999396411d13">QgsDebugMsgLevel</a>( <span class="stringliteral">&quot;path = &quot;</span> + path, 3 );
<a name="l01237"></a>01237   <span class="keywordtype">int</span> myResult = sqlite3_open( path.toUtf8().data(), db );
<a name="l01238"></a>01238 
<a name="l01239"></a>01239   <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l01240"></a>01240   {
<a name="l01241"></a>01241     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Can&#39;t open database: &quot;</span> + QString( sqlite3_errmsg( *db ) ) );
<a name="l01242"></a>01242     <span class="comment">// XXX This will likely never happen since on open, sqlite creates the</span>
<a name="l01243"></a>01243     <span class="comment">//     database if it does not exist.</span>
<a name="l01244"></a>01244     <span class="comment">// ... unfortunately it happens on Windows</span>
<a name="l01245"></a>01245     <a class="code" href="classQgsMessageOutput.html" title="Interface for showing messages from QGIS in GUI independent way.">QgsMessageOutput</a>* output = <a class="code" href="classQgsMessageOutput.html#a6e18091209c31122fb8ee922283e0428" title="function that returns new class derived from QgsMessageOutput (don&#39;t forget to delete it then)...">QgsMessageOutput::createMessageOutput</a>();
<a name="l01246"></a>01246     output-&gt;<a class="code" href="classQgsMessageOutput.html#af20b317ab2b697922b945f27357b0a5a" title="set title for the messages">setTitle</a>( <span class="stringliteral">&quot;Error&quot;</span> );
<a name="l01247"></a>01247     output-&gt;<a class="code" href="classQgsMessageOutput.html#acdb304394aea31a627c0aba8293d006d" title="set message, it won&#39;t be displayed until">setMessage</a>( QObject::tr( <span class="stringliteral">&quot;Could not open CRS database %1&lt;br&gt;Error(%2): %3&quot;</span> )
<a name="l01248"></a>01248                         .arg( path )
<a name="l01249"></a>01249                         .arg( myResult )
<a name="l01250"></a>01250                         .arg( sqlite3_errmsg( *db ) ), <a class="code" href="classQgsMessageOutput.html#a0fe1e7a56276a9f51005d8410db8b379ae79d4be2ba626ffe4d59666809cf64e0">QgsMessageOutput::MessageText</a> );
<a name="l01251"></a>01251     output-&gt;<a class="code" href="classQgsMessageOutput.html#a63c446f410e98c65797516fc2377dc1d" title="display the message to the user">showMessage</a>();
<a name="l01252"></a>01252   }
<a name="l01253"></a>01253   <span class="keywordflow">return</span> myResult;
<a name="l01254"></a>01254 }
<a name="l01255"></a>01255 
<a name="l01256"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ab5914bec604ade25240d94e02d9774f1">01256</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ab5914bec604ade25240d94e02d9774f1" title="Sets custom function to force valid CRS QGIS uses implementation in QgisGui::customSrsValidation.">QgsCoordinateReferenceSystem::setCustomSrsValidation</a>( <a class="code" href="qgscoordinatereferencesystem_8h.html#ad0aecc3490d74e11de09480b91ea1f84">CUSTOM_CRS_VALIDATION</a> f )
<a name="l01257"></a>01257 {
<a name="l01258"></a>01258   <a class="code" href="classQgsCoordinateReferenceSystem.html#a00027ee17ae6306f819322fe8ee6dc8d">mCustomSrsValidation</a> = f;
<a name="l01259"></a>01259 }
<a name="l01260"></a>01260 
<a name="l01261"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a1a69206bc92217ad1b18879cc9f8cf2d">01261</a> <a class="code" href="qgscoordinatereferencesystem_8h.html#ad0aecc3490d74e11de09480b91ea1f84">CUSTOM_CRS_VALIDATION</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a1a69206bc92217ad1b18879cc9f8cf2d" title="Gets custom function.">QgsCoordinateReferenceSystem::customSrsValidation</a>()
<a name="l01262"></a>01262 {
<a name="l01263"></a>01263   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a00027ee17ae6306f819322fe8ee6dc8d">mCustomSrsValidation</a>;
<a name="l01264"></a>01264 }
<a name="l01265"></a>01265 
<a name="l01266"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a43352910866a504c28c15be3bc73310f">01266</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a43352910866a504c28c15be3bc73310f">QgsCoordinateReferenceSystem::debugPrint</a>()
<a name="l01267"></a>01267 {
<a name="l01268"></a>01268   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;***SpatialRefSystem***&quot;</span> );
<a name="l01269"></a>01269   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* Valid : &quot;</span> + ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> ? QString( <span class="stringliteral">&quot;true&quot;</span> ) : QString( <span class="stringliteral">&quot;false&quot;</span> ) ) );
<a name="l01270"></a>01270   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* SrsId : &quot;</span> + QString::number( <a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a> ) );
<a name="l01271"></a>01271   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* Proj4 : &quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() );
<a name="l01272"></a>01272   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* WKT   : &quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a55e62f3f587e9de20ed911d26d12f499">toWkt</a>() );
<a name="l01273"></a>01273   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* Desc. : &quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a587603e45b3e111d38c377b4bf90d052" title="A textual description of the srs.">mDescription</a> );
<a name="l01274"></a>01274   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a8dd2d190edae32d6e6ca63cfd8154154">mapUnits</a>() == <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca5132b3d9c171301d76d7a14d8b3a86dc">QGis::Meters</a> )
<a name="l01275"></a>01275   {
<a name="l01276"></a>01276     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* Units : meters&quot;</span> );
<a name="l01277"></a>01277   }
<a name="l01278"></a>01278   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a8dd2d190edae32d6e6ca63cfd8154154">mapUnits</a>() == <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca0b4a519c1888a3f2beb8c1d23a4b2393">QGis::Feet</a> )
<a name="l01279"></a>01279   {
<a name="l01280"></a>01280     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* Units : feet&quot;</span> );
<a name="l01281"></a>01281   }
<a name="l01282"></a>01282   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a8dd2d190edae32d6e6ca63cfd8154154">mapUnits</a>() == <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca94852e9654597b263f080312bc76c110">QGis::Degrees</a> )
<a name="l01283"></a>01283   {
<a name="l01284"></a>01284     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* Units : degrees&quot;</span> );
<a name="l01285"></a>01285   }
<a name="l01286"></a>01286 }
<a name="l01287"></a>01287 
<a name="l01288"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a7b9a6131fbfa797bdc85f1096a290cb0">01288</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a7b9a6131fbfa797bdc85f1096a290cb0">QgsCoordinateReferenceSystem::setValidationHint</a>( QString html )
<a name="l01289"></a>01289 {
<a name="l01290"></a>01290   <a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9ace892db2001726ea782c7c7993d8">mValidationHint</a> = html;
<a name="l01291"></a>01291 }
<a name="l01292"></a>01292 
<a name="l01293"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a797b2bfe6a0f95ba0f75abacba5eca0c">01293</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a797b2bfe6a0f95ba0f75abacba5eca0c">QgsCoordinateReferenceSystem::validationHint</a>()
<a name="l01294"></a>01294 {
<a name="l01295"></a>01295   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9ace892db2001726ea782c7c7993d8">mValidationHint</a>;
<a name="l01296"></a>01296 }
<a name="l01297"></a>01297 
<a name="l01300"></a>01300 
<a name="l01301"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a0a6af4d5bea2381495b2d4849056c3e4">01301</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a0a6af4d5bea2381495b2d4849056c3e4" title="Save the proj4-string as a custom CRS.">QgsCoordinateReferenceSystem::saveAsUserCRS</a>()
<a name="l01302"></a>01302 {
<a name="l01303"></a>01303   <span class="keywordflow">if</span> ( ! <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l01304"></a>01304   {
<a name="l01305"></a>01305     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Can&#39;t save an invalid CRS!&quot;</span> );
<a name="l01306"></a>01306     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01307"></a>01307   }
<a name="l01308"></a>01308 
<a name="l01309"></a>01309   QString mySql;
<a name="l01310"></a>01310   QString myName = QString( <span class="stringliteral">&quot; * %1 (%2)&quot;</span> )
<a name="l01311"></a>01311                    .arg( QObject::tr( <span class="stringliteral">&quot;Generated CRS&quot;</span>, <span class="stringliteral">&quot;A CRS automatically generated from layer info get this prefix for description&quot;</span> ) )
<a name="l01312"></a>01312                    .arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() );
<a name="l01313"></a>01313 
<a name="l01314"></a>01314   <span class="comment">//if this is the first record we need to ensure that its srs_id is 10000. For</span>
<a name="l01315"></a>01315   <span class="comment">//any rec after that sqlite3 will take care of the autonumering</span>
<a name="l01316"></a>01316   <span class="comment">//this was done to support sqlite 3.0 as it does not yet support</span>
<a name="l01317"></a>01317   <span class="comment">//the autoinc related system tables.</span>
<a name="l01318"></a>01318   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#abe5c19bd120267c722fd354efe997bea" title="Helper for getting number of user CRS already in db.">getRecordCount</a>() == 0 )
<a name="l01319"></a>01319   {
<a name="l01320"></a>01320     mySql = <span class="stringliteral">&quot;insert into tbl_srs (srs_id,description,projection_acronym,ellipsoid_acronym,parameters,is_geo) values (&quot;</span>
<a name="l01321"></a>01321             + QString::number( <a class="code" href="qgis_8h.html#ad8794344628fad7031cceb6b8ab2b8ec" title="Magick number that determines whether a projection crsid is a system (srs.db) or user (~/...">USER_CRS_START_ID</a> )
<a name="l01322"></a>01322             + <span class="stringliteral">&quot;,&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( myName )
<a name="l01323"></a>01323             + <span class="stringliteral">&quot;,&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a5856631fdebbfe839fa0955d5c36630a">projectionAcronym</a>() )
<a name="l01324"></a>01324             + <span class="stringliteral">&quot;,&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a23f9df6ec7aa26eff0f3e535d0a82470">ellipsoidAcronym</a>() )
<a name="l01325"></a>01325             + <span class="stringliteral">&quot;,&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() )
<a name="l01326"></a>01326             + <span class="stringliteral">&quot;,0)&quot;</span>; <span class="comment">// &lt;-- is_geo shamelessly hard coded for now</span>
<a name="l01327"></a>01327   }
<a name="l01328"></a>01328   <span class="keywordflow">else</span>
<a name="l01329"></a>01329   {
<a name="l01330"></a>01330     mySql = <span class="stringliteral">&quot;insert into tbl_srs (description,projection_acronym,ellipsoid_acronym,parameters,is_geo) values (&quot;</span>
<a name="l01331"></a>01331             + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( myName )
<a name="l01332"></a>01332             + <span class="stringliteral">&quot;,&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a5856631fdebbfe839fa0955d5c36630a">projectionAcronym</a>() )
<a name="l01333"></a>01333             + <span class="stringliteral">&quot;,&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a23f9df6ec7aa26eff0f3e535d0a82470">ellipsoidAcronym</a>() )
<a name="l01334"></a>01334             + <span class="stringliteral">&quot;,&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() )
<a name="l01335"></a>01335             + <span class="stringliteral">&quot;,0)&quot;</span>; <span class="comment">// &lt;-- is_geo shamelessly hard coded for now</span>
<a name="l01336"></a>01336   }
<a name="l01337"></a>01337   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a>      *myDatabase;
<a name="l01338"></a>01338   <span class="keyword">const</span> <span class="keywordtype">char</span>   *myTail;
<a name="l01339"></a>01339   sqlite3_stmt *myPreparedStatement;
<a name="l01340"></a>01340   <span class="keywordtype">int</span>           myResult;
<a name="l01341"></a>01341   <span class="comment">//check the db is available</span>
<a name="l01342"></a>01342   myResult = sqlite3_open( <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>().toUtf8().data(), &amp;myDatabase );
<a name="l01343"></a>01343   <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l01344"></a>01344   {
<a name="l01345"></a>01345     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;Can&#39;t open or create database %1: %2&quot;</span> )
<a name="l01346"></a>01346                  .arg( <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>() )
<a name="l01347"></a>01347                  .arg( sqlite3_errmsg( myDatabase ) ) );
<a name="l01348"></a>01348     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01349"></a>01349   }
<a name="l01350"></a>01350   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;Update or insert sql \n%1&quot;</span> ).arg( mySql ) );
<a name="l01351"></a>01351   myResult = sqlite3_prepare( myDatabase, mySql.toUtf8(), mySql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l01352"></a>01352   sqlite3_step( myPreparedStatement );
<a name="l01353"></a>01353   <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l01354"></a>01354   <span class="keywordflow">return</span> myResult == SQLITE_OK;
<a name="l01355"></a>01355 }
<a name="l01356"></a>01356 
<a name="l01357"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#abe5c19bd120267c722fd354efe997bea">01357</a> <span class="keywordtype">long</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#abe5c19bd120267c722fd354efe997bea" title="Helper for getting number of user CRS already in db.">QgsCoordinateReferenceSystem::getRecordCount</a>()
<a name="l01358"></a>01358 {
<a name="l01359"></a>01359   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a>      *myDatabase;
<a name="l01360"></a>01360   <span class="keyword">const</span> <span class="keywordtype">char</span>   *myTail;
<a name="l01361"></a>01361   sqlite3_stmt *myPreparedStatement;
<a name="l01362"></a>01362   <span class="keywordtype">int</span>           myResult;
<a name="l01363"></a>01363   <span class="keywordtype">long</span>          myRecordCount = 0;
<a name="l01364"></a>01364   <span class="comment">//check the db is available</span>
<a name="l01365"></a>01365   myResult = sqlite3_open( <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>().toUtf8().data(), &amp;myDatabase );
<a name="l01366"></a>01366   <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l01367"></a>01367   {
<a name="l01368"></a>01368     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;Can&#39;t open database: %1&quot;</span> ).arg( sqlite3_errmsg( myDatabase ) ) );
<a name="l01369"></a>01369     <span class="keywordflow">return</span> 0;
<a name="l01370"></a>01370   }
<a name="l01371"></a>01371   <span class="comment">// Set up the query to retrieve the projection information needed to populate the ELLIPSOID list</span>
<a name="l01372"></a>01372   QString mySql = <span class="stringliteral">&quot;select count(*) from tbl_srs&quot;</span>;
<a name="l01373"></a>01373   myResult = sqlite3_prepare( myDatabase, mySql.toUtf8(), mySql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l01374"></a>01374   <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l01375"></a>01375   <span class="keywordflow">if</span> ( myResult == SQLITE_OK )
<a name="l01376"></a>01376   {
<a name="l01377"></a>01377     <span class="keywordflow">if</span> ( sqlite3_step( myPreparedStatement ) == SQLITE_ROW )
<a name="l01378"></a>01378     {
<a name="l01379"></a>01379       QString myRecordCountString = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 0 ) );
<a name="l01380"></a>01380       myRecordCount = myRecordCountString.toLong();
<a name="l01381"></a>01381     }
<a name="l01382"></a>01382   }
<a name="l01383"></a>01383   <span class="comment">// close the sqlite3 statement</span>
<a name="l01384"></a>01384   sqlite3_finalize( myPreparedStatement );
<a name="l01385"></a>01385   sqlite3_close( myDatabase );
<a name="l01386"></a>01386   <span class="keywordflow">return</span> myRecordCount;
<a name="l01387"></a>01387 }
<a name="l01388"></a>01388 
<a name="l01389"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784">01389</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">QgsCoordinateReferenceSystem::quotedValue</a>( QString value )
<a name="l01390"></a>01390 {
<a name="l01391"></a>01391   value.replace( <span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;&#39;&#39;&quot;</span> );
<a name="l01392"></a>01392   <span class="keywordflow">return</span> value.prepend( <span class="stringliteral">&quot;&#39;&quot;</span> ).append( <span class="stringliteral">&quot;&#39;&quot;</span> );
<a name="l01393"></a>01393 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Tue Jun 19 2012 23:25:37 for Quantum GIS API Documentation by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
