<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Quantum GIS API Documentation: src/core/qgscoordinatereferencesystem.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Quantum GIS API Documentation
   &#160;<span id="projectnumber">1.8</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">src/core/qgscoordinatereferencesystem.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="qgscoordinatereferencesystem_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/***************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">                          qgscoordinatereferencesystem.cpp</span>
<a name="l00003"></a>00003 <span class="comment"></span>
<a name="l00004"></a>00004 <span class="comment">                             -------------------</span>
<a name="l00005"></a>00005 <span class="comment">    begin                : 2007</span>
<a name="l00006"></a>00006 <span class="comment">    copyright            : (C) 2007 by Gary E. Sherman</span>
<a name="l00007"></a>00007 <span class="comment">    email                : sherman@mrcc.com</span>
<a name="l00008"></a>00008 <span class="comment">***************************************************************************/</span>
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="comment">/***************************************************************************</span>
<a name="l00011"></a>00011 <span class="comment"> *                                                                         *</span>
<a name="l00012"></a>00012 <span class="comment"> *   This program is free software; you can redistribute it and/or modify  *</span>
<a name="l00013"></a>00013 <span class="comment"> *   it under the terms of the GNU General Public License as published by  *</span>
<a name="l00014"></a>00014 <span class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</span>
<a name="l00015"></a>00015 <span class="comment"> *   (at your option) any later version.                                   *</span>
<a name="l00016"></a>00016 <span class="comment"> *                                                                         *</span>
<a name="l00017"></a>00017 <span class="comment"> ***************************************************************************/</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="qgscoordinatereferencesystem_8h.html">qgscoordinatereferencesystem.h</a>&quot;</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;cmath&gt;</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;QDir&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;QTemporaryFile&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;QDomNode&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;QDomElement&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;QFileInfo&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;QRegExp&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;QTextStream&gt;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="qgsapplication_8h.html">qgsapplication.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="qgscrscache_8h.html">qgscrscache.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="qgslogger_8h.html">qgslogger.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="qgsmessagelog_8h.html">qgsmessagelog.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="qgis_8h.html">qgis.h</a>&quot;</span> <span class="comment">//const vals declared here</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;sqlite3.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;proj_api.h&gt;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="comment">//gdal and ogr includes (needed for == operator)</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;ogr_srs_api.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;cpl_error.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;cpl_conv.h&gt;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <a class="code" href="qgscoordinatereferencesystem_8h.html#ad0aecc3490d74e11de09480b91ea1f84">CUSTOM_CRS_VALIDATION</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a00027ee17ae6306f819322fe8ee6dc8d">QgsCoordinateReferenceSystem::mCustomSrsValidation</a> = NULL;
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">//--------------------------</span>
<a name="l00047"></a>00047 
<a name="l00048"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a51fef08cdc3353f9c6d5073981cefdc9">00048</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a51fef08cdc3353f9c6d5073981cefdc9" title="Default constructor.">QgsCoordinateReferenceSystem::QgsCoordinateReferenceSystem</a>()
<a name="l00049"></a>00049     : mMapUnits( <a class="code" href="classQGis.html" title="The QGis class provides global constants for use throughout the application.">QGis</a>::UnknownUnit )
<a name="l00050"></a>00050     , mIsValidFlag( 0 )
<a name="l00051"></a>00051     , mValidationHint( <span class="stringliteral">&quot;&quot;</span> )
<a name="l00052"></a>00052 {
<a name="l00053"></a>00053   <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> = OSRNewSpatialReference( NULL );
<a name="l00054"></a>00054 }
<a name="l00055"></a>00055 
<a name="l00056"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a89e5f9aa6b0522a2250ee7f7f0ce1048">00056</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a51fef08cdc3353f9c6d5073981cefdc9" title="Default constructor.">QgsCoordinateReferenceSystem::QgsCoordinateReferenceSystem</a>( QString theDefinition )
<a name="l00057"></a>00057     : mMapUnits( <a class="code" href="classQGis.html" title="The QGis class provides global constants for use throughout the application.">QGis</a>::UnknownUnit )
<a name="l00058"></a>00058     , mIsValidFlag( 0 )
<a name="l00059"></a>00059     , mValidationHint( <span class="stringliteral">&quot;&quot;</span> )
<a name="l00060"></a>00060 {
<a name="l00061"></a>00061   <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> = OSRNewSpatialReference( NULL );
<a name="l00062"></a>00062   <a class="code" href="classQgsCoordinateReferenceSystem.html#a8f0ea02f25d97b26f276e5773b2f1819">createFromString</a>( theDefinition );
<a name="l00063"></a>00063 }
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 
<a name="l00066"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ab9678cc60493eb0a0df77151866a368c">00066</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a51fef08cdc3353f9c6d5073981cefdc9" title="Default constructor.">QgsCoordinateReferenceSystem::QgsCoordinateReferenceSystem</a>( <span class="keyword">const</span> <span class="keywordtype">long</span> theId, <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cf">CrsType</a> theType )
<a name="l00067"></a>00067     : mMapUnits( <a class="code" href="classQGis.html" title="The QGis class provides global constants for use throughout the application.">QGis</a>::UnknownUnit )
<a name="l00068"></a>00068     , mIsValidFlag( 0 )
<a name="l00069"></a>00069     , mValidationHint( <span class="stringliteral">&quot;&quot;</span> )
<a name="l00070"></a>00070 {
<a name="l00071"></a>00071   <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> = OSRNewSpatialReference( NULL );
<a name="l00072"></a>00072   <a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9fd9c20f2b6c8e7cbd1114205d0ec5">createFromId</a>( theId, theType );
<a name="l00073"></a>00073 }
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a11b56d68ff28a4c7505e097336de7a4c">00075</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a11b56d68ff28a4c7505e097336de7a4c">QgsCoordinateReferenceSystem::~QgsCoordinateReferenceSystem</a>()
<a name="l00076"></a>00076 {
<a name="l00077"></a>00077   OSRDestroySpatialReference( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> );
<a name="l00078"></a>00078 }
<a name="l00079"></a>00079 
<a name="l00080"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9fd9c20f2b6c8e7cbd1114205d0ec5">00080</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9fd9c20f2b6c8e7cbd1114205d0ec5">QgsCoordinateReferenceSystem::createFromId</a>( <span class="keyword">const</span> <span class="keywordtype">long</span> theId, <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cf">CrsType</a> theType )
<a name="l00081"></a>00081 {
<a name="l00082"></a>00082   <span class="keywordtype">bool</span> result = <span class="keyword">false</span>;
<a name="l00083"></a>00083   <span class="keywordflow">switch</span> ( theType )
<a name="l00084"></a>00084   {
<a name="l00085"></a>00085     <span class="keywordflow">case</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cfabc92b4ee3c6be188b5dfe000ddac415e">InternalCrsId</a>:
<a name="l00086"></a>00086       result = <a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">createFromSrsId</a>( theId );
<a name="l00087"></a>00087       <span class="keywordflow">break</span>;
<a name="l00088"></a>00088     <span class="keywordflow">case</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cfae88ca07f39092200cb8f0ac4328551a5">PostgisCrsId</a>:
<a name="l00089"></a>00089       result = <a class="code" href="classQgsCoordinateReferenceSystem.html#a5ae9f76a2a75b52ed9d4d710dcbbe129">createFromSrid</a>( theId );
<a name="l00090"></a>00090       <span class="keywordflow">break</span>;
<a name="l00091"></a>00091     <span class="keywordflow">case</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cfaa999f03c89ccddb4fb57570089de576b">EpsgCrsId</a>:
<a name="l00092"></a>00092       result = <a class="code" href="classQgsCoordinateReferenceSystem.html#a5789a11684af1415ffc74d7ce9ab91f0" title="Set up this CRS from the given OGC CRS.">createFromOgcWmsCrs</a>( QString( <span class="stringliteral">&quot;EPSG:%1&quot;</span> ).arg( theId ) );
<a name="l00093"></a>00093       <span class="keywordflow">break</span>;
<a name="l00094"></a>00094     <span class="keywordflow">default</span>:
<a name="l00095"></a>00095       <span class="comment">//THIS IS BAD...THIS PART OF CODE SHOULD NEVER BE REACHED...</span>
<a name="l00096"></a>00096       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Unexpected case reached!&quot;</span> );
<a name="l00097"></a>00097   };
<a name="l00098"></a>00098   <span class="keywordflow">return</span> result;
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 
<a name="l00101"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a8f0ea02f25d97b26f276e5773b2f1819">00101</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a8f0ea02f25d97b26f276e5773b2f1819">QgsCoordinateReferenceSystem::createFromString</a>( <span class="keyword">const</span> QString theDefinition )
<a name="l00102"></a>00102 {
<a name="l00103"></a>00103   <span class="keywordtype">bool</span> result = <span class="keyword">false</span>;
<a name="l00104"></a>00104   QRegExp reCrsId( <span class="stringliteral">&quot;^(epsg|postgis|internal)\\:(\\d+)$&quot;</span>, Qt::CaseInsensitive );
<a name="l00105"></a>00105   <span class="keywordflow">if</span> ( reCrsId.indexIn( theDefinition ) == 0 )
<a name="l00106"></a>00106   {
<a name="l00107"></a>00107     QString authName = reCrsId.cap( 1 ).toLower();
<a name="l00108"></a>00108     <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cf">CrsType</a> type = <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cfabc92b4ee3c6be188b5dfe000ddac415e">InternalCrsId</a>;
<a name="l00109"></a>00109     <span class="keywordflow">if</span> ( authName == <span class="stringliteral">&quot;epsg&quot;</span> )
<a name="l00110"></a>00110       type = <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cfaa999f03c89ccddb4fb57570089de576b">EpsgCrsId</a>;
<a name="l00111"></a>00111     <span class="keywordflow">if</span> ( authName == <span class="stringliteral">&quot;postgis&quot;</span> )
<a name="l00112"></a>00112       type = <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cfae88ca07f39092200cb8f0ac4328551a5">PostgisCrsId</a>;
<a name="l00113"></a>00113     <span class="keywordtype">long</span> <span class="keywordtype">id</span> = reCrsId.cap( 2 ).toLong();
<a name="l00114"></a>00114     result = <a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9fd9c20f2b6c8e7cbd1114205d0ec5">createFromId</a>( <span class="keywordtype">id</span>, type );
<a name="l00115"></a>00115   }
<a name="l00116"></a>00116   <span class="keywordflow">else</span>
<a name="l00117"></a>00117   {
<a name="l00118"></a>00118     QRegExp reCrsStr( <span class="stringliteral">&quot;^(?:(wkt|proj4)\\:)?(.+)$&quot;</span>, Qt::CaseInsensitive );
<a name="l00119"></a>00119     <span class="keywordflow">if</span> ( reCrsStr.indexIn( theDefinition ) == 0 )
<a name="l00120"></a>00120     {
<a name="l00121"></a>00121       <span class="keywordflow">if</span> ( reCrsStr.cap( 1 ).toLower() == <span class="stringliteral">&quot;proj4&quot;</span> )
<a name="l00122"></a>00122       {
<a name="l00123"></a>00123         result = <a class="code" href="classQgsCoordinateReferenceSystem.html#acf5ccd2750d310c725937a82a700ecdb">createFromProj4</a>( reCrsStr.cap( 2 ) );
<a name="l00124"></a>00124       }
<a name="l00125"></a>00125       <span class="keywordflow">else</span>
<a name="l00126"></a>00126       {
<a name="l00127"></a>00127         result = <a class="code" href="classQgsCoordinateReferenceSystem.html#a273fd2081c378af3a6be0f9804fbce4a">createFromWkt</a>( reCrsStr.cap( 2 ) );
<a name="l00128"></a>00128       }
<a name="l00129"></a>00129     }
<a name="l00130"></a>00130   }
<a name="l00131"></a>00131   <span class="keywordflow">return</span> result;
<a name="l00132"></a>00132 }
<a name="l00133"></a>00133 
<a name="l00134"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ac1fcbf32930a7c7a6d012633f4964e74">00134</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ac1fcbf32930a7c7a6d012633f4964e74">QgsCoordinateReferenceSystem::createFromUserInput</a>( <span class="keyword">const</span> QString theDefinition )
<a name="l00135"></a>00135 {
<a name="l00136"></a>00136   QString theWkt;
<a name="l00137"></a>00137   <span class="keywordtype">char</span> *wkt = NULL;
<a name="l00138"></a>00138   OGRSpatialReferenceH crs = OSRNewSpatialReference( NULL );
<a name="l00139"></a>00139 
<a name="l00140"></a>00140   <span class="comment">// make sure towgs84 parameter is loaded if using an ESRI definition and gdal &gt;= 1.9</span>
<a name="l00141"></a>00141 <span class="preprocessor">#if GDAL_VERSION_NUM &gt;= 1900</span>
<a name="l00142"></a>00142 <span class="preprocessor"></span>  <span class="keywordflow">if</span> ( theDefinition.startsWith( <span class="stringliteral">&quot;ESRI::&quot;</span> ) )
<a name="l00143"></a>00143   {
<a name="l00144"></a>00144     <a class="code" href="classQgsCoordinateReferenceSystem.html#a98d3c061553eb9a87bdb71824e493ca6">setupESRIWktFix</a>();
<a name="l00145"></a>00145   }
<a name="l00146"></a>00146 <span class="preprocessor">#endif</span>
<a name="l00147"></a>00147 <span class="preprocessor"></span>
<a name="l00148"></a>00148   <span class="keywordflow">if</span> ( OSRSetFromUserInput( crs, theDefinition.toLocal8Bit().constData() ) == OGRERR_NONE )
<a name="l00149"></a>00149   {
<a name="l00150"></a>00150     <span class="keywordflow">if</span> ( OSRExportToWkt( crs, &amp;wkt ) == OGRERR_NONE )
<a name="l00151"></a>00151     {
<a name="l00152"></a>00152       theWkt = wkt;
<a name="l00153"></a>00153       OGRFree( wkt );
<a name="l00154"></a>00154     }
<a name="l00155"></a>00155     OSRDestroySpatialReference( crs );
<a name="l00156"></a>00156   }
<a name="l00157"></a>00157   <span class="comment">//QgsDebugMsg( &quot;theDefinition: &quot; + theDefinition + &quot; theWkt = &quot; + theWkt );</span>
<a name="l00158"></a>00158   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a273fd2081c378af3a6be0f9804fbce4a">createFromWkt</a>( theWkt );
<a name="l00159"></a>00159 }
<a name="l00160"></a>00160 
<a name="l00161"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a98d3c061553eb9a87bdb71824e493ca6">00161</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a98d3c061553eb9a87bdb71824e493ca6">QgsCoordinateReferenceSystem::setupESRIWktFix</a>( )
<a name="l00162"></a>00162 {
<a name="l00163"></a>00163   <span class="comment">// make sure towgs84 parameter is loaded if gdal &gt;= 1.9</span>
<a name="l00164"></a>00164   <span class="comment">// this requires setting GDAL_FIX_ESRI_WKT=GEOGCS (see qgis bug #5598 and gdal bug #4673)</span>
<a name="l00165"></a>00165 <span class="preprocessor">#if GDAL_VERSION_NUM &gt;= 1900</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span>  <span class="keyword">const</span> <span class="keywordtype">char</span>* configOld = CPLGetConfigOption( <span class="stringliteral">&quot;GDAL_FIX_ESRI_WKT&quot;</span>, <span class="stringliteral">&quot;&quot;</span> );
<a name="l00167"></a>00167   <span class="keyword">const</span> <span class="keywordtype">char</span>* configNew = <span class="stringliteral">&quot;GEOGCS&quot;</span>;
<a name="l00168"></a>00168   <span class="comment">// only set if it was not set, to let user change the value if needed</span>
<a name="l00169"></a>00169   <span class="keywordflow">if</span> ( strcmp( configOld, <span class="stringliteral">&quot;&quot;</span> ) == 0 )
<a name="l00170"></a>00170   {
<a name="l00171"></a>00171     CPLSetConfigOption( <span class="stringliteral">&quot;GDAL_FIX_ESRI_WKT&quot;</span>, configNew );
<a name="l00172"></a>00172     <span class="keywordflow">if</span> ( strcmp( configNew, CPLGetConfigOption( <span class="stringliteral">&quot;GDAL_FIX_ESRI_WKT&quot;</span>, <span class="stringliteral">&quot;&quot;</span> ) ) != 0 )
<a name="l00173"></a>00173       <a class="code" href="classQgsLogger.html#afaff131a055cc342651e83d322b09d9a" title="Goes to qWarning.">QgsLogger::warning</a>( QString( <span class="stringliteral">&quot;GDAL_FIX_ESRI_WKT could not be set to %1 : %2&quot;</span>
<a name="l00174"></a>00174                                  ).arg( configNew ).arg( CPLGetConfigOption( <span class="stringliteral">&quot;GDAL_FIX_ESRI_WKT&quot;</span>, <span class="stringliteral">&quot;&quot;</span> ) ) ) ;
<a name="l00175"></a>00175     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;set GDAL_FIX_ESRI_WKT : %1&quot;</span> ).arg( configNew ) );
<a name="l00176"></a>00176   }
<a name="l00177"></a>00177   <span class="keywordflow">else</span>
<a name="l00178"></a>00178     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;GDAL_FIX_ESRI_WKT was already set : %1&quot;</span> ).arg( configNew ) );
<a name="l00179"></a>00179 <span class="preprocessor">#endif</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span>}
<a name="l00181"></a>00181 
<a name="l00182"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a5789a11684af1415ffc74d7ce9ab91f0">00182</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a5789a11684af1415ffc74d7ce9ab91f0" title="Set up this CRS from the given OGC CRS.">QgsCoordinateReferenceSystem::createFromOgcWmsCrs</a>( QString theCrs )
<a name="l00183"></a>00183 {
<a name="l00184"></a>00184   QRegExp re( <span class="stringliteral">&quot;(user|custom|qgis):(\\d+)&quot;</span>, Qt::CaseInsensitive );
<a name="l00185"></a>00185   <span class="keywordflow">if</span> ( re.exactMatch( theCrs ) &amp;&amp; <a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">createFromSrsId</a>( re.cap( 2 ).toInt() ) )
<a name="l00186"></a>00186   {
<a name="l00187"></a>00187     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00188"></a>00188   }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a5d4649c20dd94d28dddd32b56f2bfff3">loadFromDb</a>( <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>(), <span class="stringliteral">&quot;lower(auth_name||&#39;:&#39;||auth_id)&quot;</span>, theCrs.toLower() ) )
<a name="l00191"></a>00191     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193   <span class="keywordflow">if</span> ( theCrs.compare( <span class="stringliteral">&quot;CRS:84&quot;</span>, Qt::CaseInsensitive ) == 0 )
<a name="l00194"></a>00194   {
<a name="l00195"></a>00195     <a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">createFromSrsId</a>( <a class="code" href="qgis_8h.html#af5cd54d47652544adf35af98511e41f4" title="Magic number for a geographic coord sys in QGIS srs.db tbl_srs.srs_id.">GEOCRS_ID</a> );
<a name="l00196"></a>00196     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00197"></a>00197   }
<a name="l00198"></a>00198 
<a name="l00199"></a>00199   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 
<a name="l00202"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ace0cb3e77a0bbd8080c68b60c8bafc1e">00202</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a51fef08cdc3353f9c6d5073981cefdc9" title="Default constructor.">QgsCoordinateReferenceSystem::QgsCoordinateReferenceSystem</a>( <span class="keyword">const</span> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> &amp;srs )
<a name="l00203"></a>00203 {
<a name="l00204"></a>00204   <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> = OSRNewSpatialReference( NULL );
<a name="l00205"></a>00205   *<span class="keyword">this</span> = srs;
<a name="l00206"></a>00206 }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 <span class="comment">// Assignment operator</span>
<a name="l00209"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a82e312eac028563b73c045c61bbac266">00209</a> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a>&amp; <a class="code" href="classQgsCoordinateReferenceSystem.html#a82e312eac028563b73c045c61bbac266" title="Assignment operator.">QgsCoordinateReferenceSystem::operator=</a>( <span class="keyword">const</span> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> &amp; srs )
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211   <span class="keywordflow">if</span> ( &amp;srs != <span class="keyword">this</span> )
<a name="l00212"></a>00212   {
<a name="l00213"></a>00213     <a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a>;
<a name="l00214"></a>00214     <a class="code" href="classQgsCoordinateReferenceSystem.html#a587603e45b3e111d38c377b4bf90d052" title="A textual description of the srs.">mDescription</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a587603e45b3e111d38c377b4bf90d052" title="A textual description of the srs.">mDescription</a>;
<a name="l00215"></a>00215     <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a>;
<a name="l00216"></a>00216     <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a>;
<a name="l00217"></a>00217     <a class="code" href="classQgsCoordinateReferenceSystem.html#a6f9be65a137f9ea477f7190de74c8f66" title="Whether this is a geographic or projected coordinate system.">mGeoFlag</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a6f9be65a137f9ea477f7190de74c8f66" title="Whether this is a geographic or projected coordinate system.">mGeoFlag</a>;
<a name="l00218"></a>00218     <a class="code" href="classQgsCoordinateReferenceSystem.html#a56f83b7210c0ee13633cb0672320a68e" title="Whether this is a coordinate system has inverted axis.">mAxisInverted</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a56f83b7210c0ee13633cb0672320a68e" title="Whether this is a coordinate system has inverted axis.">mAxisInverted</a>;
<a name="l00219"></a>00219     <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a>;
<a name="l00220"></a>00220     <a class="code" href="classQgsCoordinateReferenceSystem.html#aadc5601daf830461d22dbe57f8978b14" title="If available, the Postgis spatial_ref_sys identifier for this srs (defaults to 0)">mSRID</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#aadc5601daf830461d22dbe57f8978b14" title="If available, the Postgis spatial_ref_sys identifier for this srs (defaults to 0)">mSRID</a>;
<a name="l00221"></a>00221     <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a>;
<a name="l00222"></a>00222     <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00223"></a>00223     <a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9ace892db2001726ea782c7c7993d8">mValidationHint</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9ace892db2001726ea782c7c7993d8">mValidationHint</a>;
<a name="l00224"></a>00224     <a class="code" href="classQgsCoordinateReferenceSystem.html#a8ee0ef723cb6af96bcf2ead7f72d6277">mWkt</a> = srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a8ee0ef723cb6af96bcf2ead7f72d6277">mWkt</a>;
<a name="l00225"></a>00225     <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00226"></a>00226     {
<a name="l00227"></a>00227       OSRDestroySpatialReference( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> );
<a name="l00228"></a>00228       <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> = OSRClone( srs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> );
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230   }
<a name="l00231"></a>00231   <span class="keywordflow">return</span> *<span class="keyword">this</span>;
<a name="l00232"></a>00232 }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234 <span class="comment">// Misc helper functions -----------------------</span>
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a116bcaa537aea15ad7a137ec85d3e1fb">00237</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a116bcaa537aea15ad7a137ec85d3e1fb">QgsCoordinateReferenceSystem::validate</a>()
<a name="l00238"></a>00238 {
<a name="l00239"></a>00239   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00240"></a>00240     <span class="keywordflow">return</span>;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242   <span class="comment">// try to validate using custom validation routines</span>
<a name="l00243"></a>00243   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a00027ee17ae6306f819322fe8ee6dc8d">mCustomSrsValidation</a> )
<a name="l00244"></a>00244     <a class="code" href="classQgsCoordinateReferenceSystem.html#a00027ee17ae6306f819322fe8ee6dc8d">mCustomSrsValidation</a>( <span class="keyword">this</span> );
<a name="l00245"></a>00245 
<a name="l00246"></a>00246   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00247"></a>00247     <span class="comment">// set the default</span>
<a name="l00248"></a>00248     <a class="code" href="classQgsCoordinateReferenceSystem.html#a5789a11684af1415ffc74d7ce9ab91f0" title="Set up this CRS from the given OGC CRS.">createFromOgcWmsCrs</a>( <a class="code" href="qgis_8h.html#afe921ae99906e4b03ed85cb77eae47ae" title="Geographic coord sys from EPSG authority.">GEO_EPSG_CRS_AUTHID</a> );
<a name="l00249"></a>00249 }
<a name="l00250"></a>00250 
<a name="l00251"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a5ae9f76a2a75b52ed9d4d710dcbbe129">00251</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a5ae9f76a2a75b52ed9d4d710dcbbe129">QgsCoordinateReferenceSystem::createFromSrid</a>( <span class="keywordtype">long</span> <span class="keywordtype">id</span> )
<a name="l00252"></a>00252 {
<a name="l00253"></a>00253   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a5d4649c20dd94d28dddd32b56f2bfff3">loadFromDb</a>( <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>(), <span class="stringliteral">&quot;srid&quot;</span>, QString::number( <span class="keywordtype">id</span> ) );
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00256"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ae0f28405e62ebb1cc7df0e1bbcd51670">00256</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ae0f28405e62ebb1cc7df0e1bbcd51670">QgsCoordinateReferenceSystem::createFromEpsg</a>( <span class="keywordtype">long</span> <span class="keywordtype">id</span> )
<a name="l00257"></a>00257 {
<a name="l00258"></a>00258   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a5789a11684af1415ffc74d7ce9ab91f0" title="Set up this CRS from the given OGC CRS.">createFromOgcWmsCrs</a>( QString( <span class="stringliteral">&quot;EPSG:%1&quot;</span> ).arg( <span class="keywordtype">id</span> ) );
<a name="l00259"></a>00259 }
<a name="l00260"></a>00260 
<a name="l00261"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">00261</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">QgsCoordinateReferenceSystem::createFromSrsId</a>( <span class="keywordtype">long</span> <span class="keywordtype">id</span> )
<a name="l00262"></a>00262 {
<a name="l00263"></a>00263   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a5d4649c20dd94d28dddd32b56f2bfff3">loadFromDb</a>( <span class="keywordtype">id</span> &lt; <a class="code" href="qgis_8h.html#ad8794344628fad7031cceb6b8ab2b8ec" title="Magick number that determines whether a projection crsid is a system (srs.db) or user (~/...">USER_CRS_START_ID</a> ? <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>() :
<a name="l00264"></a>00264                      <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>(),
<a name="l00265"></a>00265                      <span class="stringliteral">&quot;srs_id&quot;</span>, QString::number( <span class="keywordtype">id</span> ) );
<a name="l00266"></a>00266 }
<a name="l00267"></a>00267 
<a name="l00268"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a5d4649c20dd94d28dddd32b56f2bfff3">00268</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a5d4649c20dd94d28dddd32b56f2bfff3">QgsCoordinateReferenceSystem::loadFromDb</a>( QString db, QString expression, QString value )
<a name="l00269"></a>00269 {
<a name="l00270"></a>00270   <a class="code" href="qgslogger_8h.html#a795a1fcfb1c61b988bbd999396411d13">QgsDebugMsgLevel</a>( <span class="stringliteral">&quot;load CRS from &quot;</span> + db + <span class="stringliteral">&quot; where &quot;</span> + expression + <span class="stringliteral">&quot; is &quot;</span> + value, 3 );
<a name="l00271"></a>00271   <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <span class="keyword">false</span>;
<a name="l00272"></a>00272   <a class="code" href="classQgsCoordinateReferenceSystem.html#a8ee0ef723cb6af96bcf2ead7f72d6277">mWkt</a>.clear();
<a name="l00273"></a>00273 
<a name="l00274"></a>00274   QFileInfo myInfo( db );
<a name="l00275"></a>00275   <span class="keywordflow">if</span> ( !myInfo.exists() )
<a name="l00276"></a>00276   {
<a name="l00277"></a>00277     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;failed : &quot;</span> + db + <span class="stringliteral">&quot; does not exist!&quot;</span> );
<a name="l00278"></a>00278     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00279"></a>00279   }
<a name="l00280"></a>00280 
<a name="l00281"></a>00281   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a>      *myDatabase;
<a name="l00282"></a>00282   <span class="keyword">const</span> <span class="keywordtype">char</span>   *myTail;
<a name="l00283"></a>00283   sqlite3_stmt *myPreparedStatement;
<a name="l00284"></a>00284   <span class="keywordtype">int</span>           myResult;
<a name="l00285"></a>00285   <span class="comment">//check the db is available</span>
<a name="l00286"></a>00286   myResult = <a class="code" href="classQgsCoordinateReferenceSystem.html#aed9df708f2dbbd8609e6717fbd8ab8bd">openDb</a>( db, &amp;myDatabase );
<a name="l00287"></a>00287   <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l00288"></a>00288   {
<a name="l00289"></a>00289     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;failed : &quot;</span> + db + <span class="stringliteral">&quot; could not be opened!&quot;</span> );
<a name="l00290"></a>00290     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00291"></a>00291   }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293   <span class="comment">/*</span>
<a name="l00294"></a>00294 <span class="comment">    srs_id INTEGER PRIMARY KEY,</span>
<a name="l00295"></a>00295 <span class="comment">    description text NOT NULL,</span>
<a name="l00296"></a>00296 <span class="comment">    projection_acronym text NOT NULL,</span>
<a name="l00297"></a>00297 <span class="comment">    ellipsoid_acronym NOT NULL,</span>
<a name="l00298"></a>00298 <span class="comment">    parameters text NOT NULL,</span>
<a name="l00299"></a>00299 <span class="comment">    srid integer NOT NULL,</span>
<a name="l00300"></a>00300 <span class="comment">    auth_name varchar NOT NULL,</span>
<a name="l00301"></a>00301 <span class="comment">    auth_id integer NOT NULL,</span>
<a name="l00302"></a>00302 <span class="comment">    is_geo integer NOT NULL);</span>
<a name="l00303"></a>00303 <span class="comment">  */</span>
<a name="l00304"></a>00304 
<a name="l00305"></a>00305   QString mySql = <span class="stringliteral">&quot;select srs_id,description,projection_acronym,&quot;</span>
<a name="l00306"></a>00306                   <span class="stringliteral">&quot;ellipsoid_acronym,parameters,srid,auth_name||&#39;:&#39;||auth_id,is_geo &quot;</span>
<a name="l00307"></a>00307                   <span class="stringliteral">&quot;from tbl_srs where &quot;</span> + expression + <span class="stringliteral">&quot;=&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( value ) + <span class="stringliteral">&quot; order by deprecated&quot;</span>;
<a name="l00308"></a>00308   myResult = sqlite3_prepare( myDatabase, mySql.toUtf8(),
<a name="l00309"></a>00309                               mySql.toUtf8().length(),
<a name="l00310"></a>00310                               &amp;myPreparedStatement, &amp;myTail );
<a name="l00311"></a>00311   <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l00312"></a>00312   <span class="keywordflow">if</span> ( myResult == SQLITE_OK &amp;&amp; sqlite3_step( myPreparedStatement ) == SQLITE_ROW )
<a name="l00313"></a>00313   {
<a name="l00314"></a>00314     <a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text(
<a name="l00315"></a>00315                                  myPreparedStatement, 0 ) ).toLong();
<a name="l00316"></a>00316     <a class="code" href="classQgsCoordinateReferenceSystem.html#a587603e45b3e111d38c377b4bf90d052" title="A textual description of the srs.">mDescription</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text(
<a name="l00317"></a>00317                                        myPreparedStatement, 1 ) );
<a name="l00318"></a>00318     <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 2 ) );
<a name="l00319"></a>00319     <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 3 ) );
<a name="l00320"></a>00320     QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 4 ) );
<a name="l00321"></a>00321     <a class="code" href="classQgsCoordinateReferenceSystem.html#aadc5601daf830461d22dbe57f8978b14" title="If available, the Postgis spatial_ref_sys identifier for this srs (defaults to 0)">mSRID</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 5 ) ).toLong();
<a name="l00322"></a>00322     <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 6 ) );
<a name="l00323"></a>00323     <a class="code" href="classQgsCoordinateReferenceSystem.html#a6f9be65a137f9ea477f7190de74c8f66" title="Whether this is a geographic or projected coordinate system.">mGeoFlag</a> = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 7 ) ).toInt() != 0;
<a name="l00324"></a>00324     <a class="code" href="classQgsCoordinateReferenceSystem.html#a56f83b7210c0ee13633cb0672320a68e" title="Whether this is a coordinate system has inverted axis.">mAxisInverted</a> = -1;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326     <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a> &gt;= <a class="code" href="qgis_8h.html#ad8794344628fad7031cceb6b8ab2b8ec" title="Magick number that determines whether a projection crsid is a system (srs.db) or user (~/...">USER_CRS_START_ID</a> &amp;&amp; <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a>.isEmpty() )
<a name="l00327"></a>00327     {
<a name="l00328"></a>00328       <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a> = QString( <span class="stringliteral">&quot;USER:%1&quot;</span> ).arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a> );
<a name="l00329"></a>00329     }
<a name="l00330"></a>00330     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a>.startsWith( <span class="stringliteral">&quot;EPSG:&quot;</span>, Qt::CaseInsensitive ) )
<a name="l00331"></a>00331     {
<a name="l00332"></a>00332       OSRDestroySpatialReference( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> );
<a name="l00333"></a>00333       <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> = OSRNewSpatialReference( NULL );
<a name="l00334"></a>00334       <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = OSRSetFromUserInput( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a>.toLower().toAscii() ) == OGRERR_NONE;
<a name="l00335"></a>00335       <a class="code" href="classQgsCoordinateReferenceSystem.html#ac552bc85c6d409b529b6889bfd2456ac" title="Work out the projection units and set the appropriate local variable.">setMapUnits</a>();
<a name="l00336"></a>00336     }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     <span class="keywordflow">if</span> ( !<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00339"></a>00339     {
<a name="l00340"></a>00340       <a class="code" href="classQgsCoordinateReferenceSystem.html#ae0cd0008b170f81f0721fb475780e9ab">setProj4String</a>( toProj4 );
<a name="l00341"></a>00341     }
<a name="l00342"></a>00342   }
<a name="l00343"></a>00343   <span class="keywordflow">else</span>
<a name="l00344"></a>00344   {
<a name="l00345"></a>00345     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;failed : &quot;</span> + mySql );
<a name="l00346"></a>00346   }
<a name="l00347"></a>00347   sqlite3_finalize( myPreparedStatement );
<a name="l00348"></a>00348   sqlite3_close( myDatabase );
<a name="l00349"></a>00349   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00350"></a>00350 }
<a name="l00351"></a>00351 
<a name="l00352"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a3480b9b620fe3b0370f0c3bca4596d99">00352</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a3480b9b620fe3b0370f0c3bca4596d99">QgsCoordinateReferenceSystem::axisInverted</a>()<span class="keyword"> const</span>
<a name="l00353"></a>00353 <span class="keyword"></span>{
<a name="l00354"></a>00354   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a56f83b7210c0ee13633cb0672320a68e" title="Whether this is a coordinate system has inverted axis.">mAxisInverted</a> == -1 )
<a name="l00355"></a>00355   {
<a name="l00356"></a>00356     OGRAxisOrientation orientation;
<a name="l00357"></a>00357     <span class="keyword">const</span> <span class="keywordtype">char</span> *axis0 = OSRGetAxis( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, <a class="code" href="classQgsCoordinateReferenceSystem.html#a6f9be65a137f9ea477f7190de74c8f66" title="Whether this is a geographic or projected coordinate system.">mGeoFlag</a> ? <span class="stringliteral">&quot;GEOGCS&quot;</span> : <span class="stringliteral">&quot;PROJCS&quot;</span>, 0, &amp;orientation );
<a name="l00358"></a>00358     <a class="code" href="classQgsCoordinateReferenceSystem.html#a56f83b7210c0ee13633cb0672320a68e" title="Whether this is a coordinate system has inverted axis.">mAxisInverted</a> = <a class="code" href="classQgsCoordinateReferenceSystem.html#a6f9be65a137f9ea477f7190de74c8f66" title="Whether this is a geographic or projected coordinate system.">mGeoFlag</a>
<a name="l00359"></a>00359                     ? ( orientation == OAO_East || orientation == OAO_West || orientation == OAO_Other )
<a name="l00360"></a>00360                     : ( orientation == OAO_North || orientation == OAO_South );
<a name="l00361"></a>00361     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;srid:%1 axis0:%2 orientation:%3 inverted:%4&quot;</span> ).arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#aadc5601daf830461d22dbe57f8978b14" title="If available, the Postgis spatial_ref_sys identifier for this srs (defaults to 0)">mSRID</a> ).arg( axis0 ).arg( OSRAxisEnumToName( orientation ) ).arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#a56f83b7210c0ee13633cb0672320a68e" title="Whether this is a coordinate system has inverted axis.">mAxisInverted</a> ) );
<a name="l00362"></a>00362     Q_UNUSED( axis0 );
<a name="l00363"></a>00363   }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a56f83b7210c0ee13633cb0672320a68e" title="Whether this is a coordinate system has inverted axis.">mAxisInverted</a> != 0;
<a name="l00366"></a>00366 }
<a name="l00367"></a>00367 
<a name="l00368"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a273fd2081c378af3a6be0f9804fbce4a">00368</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a273fd2081c378af3a6be0f9804fbce4a">QgsCoordinateReferenceSystem::createFromWkt</a>( QString theWkt )
<a name="l00369"></a>00369 {
<a name="l00370"></a>00370   <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <span class="keyword">false</span>;
<a name="l00371"></a>00371   <a class="code" href="classQgsCoordinateReferenceSystem.html#a8ee0ef723cb6af96bcf2ead7f72d6277">mWkt</a>.clear();
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   <span class="keywordflow">if</span> ( theWkt.isEmpty() )
<a name="l00374"></a>00374   {
<a name="l00375"></a>00375     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;theWkt is uninitialised, operation failed&quot;</span> );
<a name="l00376"></a>00376     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00377"></a>00377   }
<a name="l00378"></a>00378   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;wkt: &quot;</span> + theWkt );
<a name="l00379"></a>00379   QByteArray ba = theWkt.toLatin1();
<a name="l00380"></a>00380   <span class="keyword">const</span> <span class="keywordtype">char</span> *pWkt = ba.data();
<a name="l00381"></a>00381 
<a name="l00382"></a>00382   OGRErr myInputResult = OSRImportFromWkt( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, ( <span class="keywordtype">char</span> ** ) &amp; pWkt );
<a name="l00383"></a>00383 
<a name="l00384"></a>00384   <span class="keywordflow">if</span> ( myInputResult != OGRERR_NONE )
<a name="l00385"></a>00385   {
<a name="l00386"></a>00386     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;\n---------------------------------------------------------------&quot;</span> );
<a name="l00387"></a>00387     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;This CRS could *** NOT *** be set from the supplied Wkt &quot;</span> );
<a name="l00388"></a>00388     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;INPUT: &quot;</span> + theWkt );
<a name="l00389"></a>00389     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;UNUSED WKT: %1&quot;</span> ).arg( pWkt ) );
<a name="l00390"></a>00390     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;---------------------------------------------------------------\n&quot;</span> );
<a name="l00391"></a>00391     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00392"></a>00392   }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394   <span class="keywordflow">if</span> ( OSRAutoIdentifyEPSG( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> ) == OGRERR_NONE )
<a name="l00395"></a>00395   {
<a name="l00396"></a>00396     QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a4382981b1233c7f0ca1c7ce7bdb670d3">authid</a> = QString( <span class="stringliteral">&quot;%1:%2&quot;</span> )
<a name="l00397"></a>00397                      .arg( OSRGetAuthorityName( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, NULL ) )
<a name="l00398"></a>00398                      .arg( OSRGetAuthorityCode( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, NULL ) );
<a name="l00399"></a>00399     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;authid recognized as &quot;</span> + authid );
<a name="l00400"></a>00400     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a5789a11684af1415ffc74d7ce9ab91f0" title="Set up this CRS from the given OGC CRS.">createFromOgcWmsCrs</a>( authid );
<a name="l00401"></a>00401   }
<a name="l00402"></a>00402 
<a name="l00403"></a>00403   <span class="comment">// always morph from esri as it doesn&#39;t hurt anything</span>
<a name="l00404"></a>00404   <span class="comment">// FW: Hey, that&#39;s not right!  It can screw stuff up! Disable</span>
<a name="l00405"></a>00405   <span class="comment">//myOgrSpatialRef.morphFromESRI();</span>
<a name="l00406"></a>00406 
<a name="l00407"></a>00407   <span class="comment">// create the proj4 structs needed for transforming</span>
<a name="l00408"></a>00408   <span class="keywordtype">char</span> *proj4src = NULL;
<a name="l00409"></a>00409   OSRExportToProj4( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, &amp;proj4src );
<a name="l00410"></a>00410 
<a name="l00411"></a>00411   <span class="comment">//now that we have the proj4string, delegate to createFromProj4 so</span>
<a name="l00412"></a>00412   <span class="comment">// that we can try to fill in the remaining class members...</span>
<a name="l00413"></a>00413   <span class="comment">//create from Proj will set the isValidFlag</span>
<a name="l00414"></a>00414   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsCoordinateReferenceSystem.html#acf5ccd2750d310c725937a82a700ecdb">createFromProj4</a>( proj4src ) )
<a name="l00415"></a>00415   {
<a name="l00416"></a>00416     CPLFree( proj4src );
<a name="l00417"></a>00417 
<a name="l00418"></a>00418     <span class="comment">// try fixed up version</span>
<a name="l00419"></a>00419     OSRFixup( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> );
<a name="l00420"></a>00420 
<a name="l00421"></a>00421     OSRExportToProj4( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, &amp;proj4src );
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     <a class="code" href="classQgsCoordinateReferenceSystem.html#acf5ccd2750d310c725937a82a700ecdb">createFromProj4</a>( proj4src );
<a name="l00424"></a>00424   }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426   CPLFree( proj4src );
<a name="l00427"></a>00427 
<a name="l00428"></a>00428   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00429"></a>00429   <span class="comment">//setMapunits will be called by createfromproj above</span>
<a name="l00430"></a>00430 }
<a name="l00431"></a>00431 
<a name="l00432"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#aa88613351434eeefdbdfbbd77ff33025">00432</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#aa88613351434eeefdbdfbbd77ff33025">QgsCoordinateReferenceSystem::isValid</a>()<span class="keyword"> const</span>
<a name="l00433"></a>00433 <span class="keyword"></span>{
<a name="l00434"></a>00434   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00435"></a>00435 }
<a name="l00436"></a>00436 
<a name="l00437"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#acf5ccd2750d310c725937a82a700ecdb">00437</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#acf5ccd2750d310c725937a82a700ecdb">QgsCoordinateReferenceSystem::createFromProj4</a>( <span class="keyword">const</span> QString theProj4String )
<a name="l00438"></a>00438 {
<a name="l00439"></a>00439   <span class="comment">//</span>
<a name="l00440"></a>00440   <span class="comment">// Examples:</span>
<a name="l00441"></a>00441   <span class="comment">// +proj=tmerc +lat_0=0 +lon_0=-62 +k=0.999500 +x_0=400000 +y_0=0</span>
<a name="l00442"></a>00442   <span class="comment">// +ellps=clrk80 +towgs84=-255,-15,71,0,0,0,0 +units=m +no_defs</span>
<a name="l00443"></a>00443   <span class="comment">//</span>
<a name="l00444"></a>00444   <span class="comment">// +proj=lcc +lat_1=46.8 +lat_0=46.8 +lon_0=2.337229166666664 +k_0=0.99987742</span>
<a name="l00445"></a>00445   <span class="comment">// +x_0=600000 +y_0=2200000 +a=6378249.2 +b=6356515.000000472 +units=m +no_defs</span>
<a name="l00446"></a>00446   <span class="comment">//</span>
<a name="l00447"></a>00447   QString myProj4String = theProj4String.trimmed();
<a name="l00448"></a>00448   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;proj4: &quot;</span> + myProj4String );
<a name="l00449"></a>00449   <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <span class="keyword">false</span>;
<a name="l00450"></a>00450   <a class="code" href="classQgsCoordinateReferenceSystem.html#a8ee0ef723cb6af96bcf2ead7f72d6277">mWkt</a>.clear();
<a name="l00451"></a>00451 
<a name="l00452"></a>00452   QRegExp myProjRegExp( <span class="stringliteral">&quot;\\+proj=(\\S+)&quot;</span> );
<a name="l00453"></a>00453   <span class="keywordtype">int</span> myStart = myProjRegExp.indexIn( myProj4String );
<a name="l00454"></a>00454   <span class="keywordflow">if</span> ( myStart == -1 )
<a name="l00455"></a>00455   {
<a name="l00456"></a>00456     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;proj string supplied has no +proj argument&quot;</span> );
<a name="l00457"></a>00457     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00458"></a>00458   }
<a name="l00459"></a>00459 
<a name="l00460"></a>00460   <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a> = myProjRegExp.cap( 1 );
<a name="l00461"></a>00461 
<a name="l00462"></a>00462   QRegExp myEllipseRegExp( <span class="stringliteral">&quot;\\+ellps=(\\S+)&quot;</span> );
<a name="l00463"></a>00463   myStart = myEllipseRegExp.indexIn( myProj4String );
<a name="l00464"></a>00464   <span class="keywordflow">if</span> ( myStart == -1 )
<a name="l00465"></a>00465   {
<a name="l00466"></a>00466     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;proj string supplied has no +ellps argument&quot;</span> );
<a name="l00467"></a>00467     <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a> = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00468"></a>00468   }
<a name="l00469"></a>00469   <span class="keywordflow">else</span>
<a name="l00470"></a>00470   {
<a name="l00471"></a>00471     <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a> = myEllipseRegExp.cap( 1 );
<a name="l00472"></a>00472   }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474   QRegExp myAxisRegExp( <span class="stringliteral">&quot;\\+a=(\\S+)&quot;</span> );
<a name="l00475"></a>00475   myStart = myAxisRegExp.indexIn( myProj4String );
<a name="l00476"></a>00476   <span class="keywordflow">if</span> ( myStart == -1 )
<a name="l00477"></a>00477   {
<a name="l00478"></a>00478     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;proj string supplied has no +a argument&quot;</span> );
<a name="l00479"></a>00479   }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481   <span class="comment">/*</span>
<a name="l00482"></a>00482 <span class="comment">   * We try to match the proj string to and srsid using the following logic:</span>
<a name="l00483"></a>00483 <span class="comment">   *</span>
<a name="l00484"></a>00484 <span class="comment">   * - perform a whole text search on srs name (if not null). The srs name will</span>
<a name="l00485"></a>00485 <span class="comment">   *   have been set if this method has been delegated to from createFromWkt.</span>
<a name="l00486"></a>00486 <span class="comment">   * Normally we wouldnt expect this to work, but its worth trying first</span>
<a name="l00487"></a>00487 <span class="comment">   * as its quicker than methods below..</span>
<a name="l00488"></a>00488 <span class="comment">   */</span>
<a name="l00489"></a>00489   <span class="keywordtype">long</span> mySrsId = 0;
<a name="l00490"></a>00490   <a class="code" href="classQgsCoordinateReferenceSystem.html#a238dfb729c699d5e3f6d37f7527991b0">QgsCoordinateReferenceSystem::RecordMap</a> myRecord;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492   <span class="comment">/*</span>
<a name="l00493"></a>00493 <span class="comment">   * - if the above does not match perform a whole text search on proj4 string (if not null)</span>
<a name="l00494"></a>00494 <span class="comment">   */</span>
<a name="l00495"></a>00495   <span class="comment">// QgsDebugMsg( &quot;wholetext match on name failed, trying proj4string match&quot; );</span>
<a name="l00496"></a>00496   myRecord = <a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">getRecord</a>( <span class="stringliteral">&quot;select * from tbl_srs where parameters=&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( myProj4String ) + <span class="stringliteral">&quot; order by deprecated&quot;</span> );
<a name="l00497"></a>00497   <span class="keywordflow">if</span> ( myRecord.empty() )
<a name="l00498"></a>00498   {
<a name="l00499"></a>00499     <span class="comment">// Ticket #722 - aaronr</span>
<a name="l00500"></a>00500     <span class="comment">// Check if we can swap the lat_1 and lat_2 params (if they exist) to see if we match...</span>
<a name="l00501"></a>00501     <span class="comment">// First we check for lat_1 and lat_2</span>
<a name="l00502"></a>00502     QRegExp myLat1RegExp( <span class="stringliteral">&quot;\\+lat_1=\\S+&quot;</span> );
<a name="l00503"></a>00503     QRegExp myLat2RegExp( <span class="stringliteral">&quot;\\+lat_2=\\S+&quot;</span> );
<a name="l00504"></a>00504     <span class="keywordtype">int</span> myStart1 = 0;
<a name="l00505"></a>00505     <span class="keywordtype">int</span> myLength1 = 0;
<a name="l00506"></a>00506     <span class="keywordtype">int</span> myStart2 = 0;
<a name="l00507"></a>00507     <span class="keywordtype">int</span> myLength2 = 0;
<a name="l00508"></a>00508     QString lat1Str = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00509"></a>00509     QString lat2Str = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00510"></a>00510     myStart1 = myLat1RegExp.indexIn( myProj4String, myStart1 );
<a name="l00511"></a>00511     myStart2 = myLat2RegExp.indexIn( myProj4String, myStart2 );
<a name="l00512"></a>00512     <span class="keywordflow">if</span> ( myStart1 != -1 &amp;&amp; myStart2 != -1 )
<a name="l00513"></a>00513     {
<a name="l00514"></a>00514       myLength1 = myLat1RegExp.matchedLength();
<a name="l00515"></a>00515       myLength2 = myLat2RegExp.matchedLength();
<a name="l00516"></a>00516       lat1Str = myProj4String.mid( myStart1 + <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a>, myLength1 - <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a> );
<a name="l00517"></a>00517       lat2Str = myProj4String.mid( myStart2 + <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a>, myLength2 - <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a> );
<a name="l00518"></a>00518     }
<a name="l00519"></a>00519     <span class="comment">// If we found the lat_1 and lat_2 we need to swap and check to see if we can find it...</span>
<a name="l00520"></a>00520     <span class="keywordflow">if</span> ( lat1Str != <span class="stringliteral">&quot;&quot;</span> &amp;&amp; lat2Str != <span class="stringliteral">&quot;&quot;</span> )
<a name="l00521"></a>00521     {
<a name="l00522"></a>00522       <span class="comment">// Make our new string to check...</span>
<a name="l00523"></a>00523       QString theProj4StringModified = myProj4String;
<a name="l00524"></a>00524       <span class="comment">// First just swap in the lat_2 value for lat_1 value</span>
<a name="l00525"></a>00525       theProj4StringModified.replace( myStart1 + <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a>, myLength1 - <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a>, lat2Str );
<a name="l00526"></a>00526       <span class="comment">// Now we have to find the lat_2 location again since it has potentially moved...</span>
<a name="l00527"></a>00527       myStart2 = 0;
<a name="l00528"></a>00528       myStart2 = myLat2RegExp.indexIn( theProj4String, myStart2 );
<a name="l00529"></a>00529       theProj4StringModified.replace( myStart2 + <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a>, myLength2 - <a class="code" href="qgis_8h.html#ad366afa11bc36df66e469ace50bee53b" title="The length of the string &quot;+lat_1=&quot;.">LAT_PREFIX_LEN</a>, lat1Str );
<a name="l00530"></a>00530       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;trying proj4string match with swapped lat_1,lat_2&quot;</span> );
<a name="l00531"></a>00531       myRecord = <a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">getRecord</a>( <span class="stringliteral">&quot;select * from tbl_srs where parameters=&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( theProj4StringModified.trimmed() ) + <span class="stringliteral">&quot; order by deprecated&quot;</span> );
<a name="l00532"></a>00532     }
<a name="l00533"></a>00533   }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535   <span class="keywordflow">if</span> ( myRecord.empty() )
<a name="l00536"></a>00536   {
<a name="l00537"></a>00537     <span class="comment">// match all parameters individually:</span>
<a name="l00538"></a>00538     <span class="comment">// - order of parameters doesn&#39;t matter</span>
<a name="l00539"></a>00539     <span class="comment">// - found definition may have more parameters (like +towgs84 in GDAL)</span>
<a name="l00540"></a>00540     <span class="comment">// - retry without datum, if no match is found (looks like +datum&lt;&gt;WGS84 was dropped in GDAL)</span>
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     QString sql = <span class="stringliteral">&quot;SELECT * FROM tbl_srs WHERE &quot;</span>;
<a name="l00543"></a>00543     QString delim = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00544"></a>00544     QString datum;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546     <span class="comment">// split on spaces followed by a plus sign (+) to deal</span>
<a name="l00547"></a>00547     <span class="comment">// also with parameters containing spaces (e.g. +nadgrids)</span>
<a name="l00548"></a>00548     <span class="comment">// make sure result is trimmed (#5598)</span>
<a name="l00549"></a>00549     <span class="keywordflow">foreach</span>( QString param, myProj4String.split( QRegExp( <span class="stringliteral">&quot;\\s+(?=\\+)&quot;</span> ), QString::SkipEmptyParts ) )
<a name="l00550"></a>00550     {
<a name="l00551"></a>00551       QString arg = QString( <span class="stringliteral">&quot;&#39; &#39;||parameters||&#39; &#39; LIKE %1&quot;</span> ).arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( QString( <span class="stringliteral">&quot;% %1 %&quot;</span> ).arg( param.trimmed() ) ) );
<a name="l00552"></a>00552       <span class="keywordflow">if</span> ( param.startsWith( <span class="stringliteral">&quot;+datum=&quot;</span> ) )
<a name="l00553"></a>00553       {
<a name="l00554"></a>00554         datum = arg;
<a name="l00555"></a>00555       }
<a name="l00556"></a>00556       <span class="keywordflow">else</span>
<a name="l00557"></a>00557       {
<a name="l00558"></a>00558         sql += delim + arg;
<a name="l00559"></a>00559         delim = <span class="stringliteral">&quot; AND &quot;</span>;
<a name="l00560"></a>00560       }
<a name="l00561"></a>00561     }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563     <span class="keywordflow">if</span> ( !datum.isEmpty() )
<a name="l00564"></a>00564     {
<a name="l00565"></a>00565       myRecord = <a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">getRecord</a>( sql + delim + datum + <span class="stringliteral">&quot; order by deprecated&quot;</span> );
<a name="l00566"></a>00566     }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     <span class="keywordflow">if</span> ( myRecord.empty() )
<a name="l00569"></a>00569     {
<a name="l00570"></a>00570       <span class="comment">// datum might have disappeared in definition - retry without it</span>
<a name="l00571"></a>00571       myRecord = <a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">getRecord</a>( sql + <span class="stringliteral">&quot; order by deprecated&quot;</span> );
<a name="l00572"></a>00572     }
<a name="l00573"></a>00573   }
<a name="l00574"></a>00574 
<a name="l00575"></a>00575   <span class="keywordflow">if</span> ( !myRecord.empty() )
<a name="l00576"></a>00576   {
<a name="l00577"></a>00577     mySrsId = myRecord[<span class="stringliteral">&quot;srs_id&quot;</span>].toLong();
<a name="l00578"></a>00578     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;proj4string param match search for srsid returned srsid: &quot;</span> + QString::number( mySrsId ) );
<a name="l00579"></a>00579     <span class="keywordflow">if</span> ( mySrsId &gt; 0 )
<a name="l00580"></a>00580     {
<a name="l00581"></a>00581       <a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">createFromSrsId</a>( mySrsId );
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583   }
<a name="l00584"></a>00584   <span class="keywordflow">else</span>
<a name="l00585"></a>00585   {
<a name="l00586"></a>00586     <span class="comment">// Last ditch attempt to piece together what we know of the projection to find a match...</span>
<a name="l00587"></a>00587     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;globbing search for srsid from this proj string&quot;</span> );
<a name="l00588"></a>00588     <a class="code" href="classQgsCoordinateReferenceSystem.html#ae0cd0008b170f81f0721fb475780e9ab">setProj4String</a>( myProj4String );
<a name="l00589"></a>00589     mySrsId = <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcef003135c7bf9de91c79e6d9a54bb">findMatchingProj</a>();
<a name="l00590"></a>00590     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;globbing search for srsid returned srsid: &quot;</span> + QString::number( mySrsId ) );
<a name="l00591"></a>00591     <span class="keywordflow">if</span> ( mySrsId &gt; 0 )
<a name="l00592"></a>00592     {
<a name="l00593"></a>00593       <a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">createFromSrsId</a>( mySrsId );
<a name="l00594"></a>00594     }
<a name="l00595"></a>00595     <span class="keywordflow">else</span>
<a name="l00596"></a>00596     {
<a name="l00597"></a>00597       <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <span class="keyword">false</span>;
<a name="l00598"></a>00598     }
<a name="l00599"></a>00599   }
<a name="l00600"></a>00600 
<a name="l00601"></a>00601   <span class="comment">// if we failed to look up the projection in database, don&#39;t worry. we can still use it :)</span>
<a name="l00602"></a>00602   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00603"></a>00603   {
<a name="l00604"></a>00604     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Projection is not found in databases.&quot;</span> );
<a name="l00605"></a>00605     <a class="code" href="classQgsCoordinateReferenceSystem.html#ae0cd0008b170f81f0721fb475780e9ab">setProj4String</a>( myProj4String );
<a name="l00606"></a>00606 
<a name="l00607"></a>00607     <span class="comment">// Is the SRS is valid now, we know it&#39;s a decent +proj string that can be entered into the srs.db</span>
<a name="l00608"></a>00608     <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00609"></a>00609     {
<a name="l00610"></a>00610       <span class="comment">// but the proj.4 parsed string might already be in our database</span>
<a name="l00611"></a>00611       myRecord = <a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">getRecord</a>( <span class="stringliteral">&quot;select * from tbl_srs where parameters=&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() ) + <span class="stringliteral">&quot; order by deprecated&quot;</span> );
<a name="l00612"></a>00612       <span class="keywordflow">if</span> ( myRecord.empty() )
<a name="l00613"></a>00613       {
<a name="l00614"></a>00614         <span class="comment">// It&#39;s not, so try to add it</span>
<a name="l00615"></a>00615         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Projection appears to be valid. Save to database!&quot;</span> );
<a name="l00616"></a>00616         <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <a class="code" href="classQgsCoordinateReferenceSystem.html#a0a6af4d5bea2381495b2d4849056c3e4" title="Save the proj4-string as a custom CRS.">saveAsUserCRS</a>();
<a name="l00617"></a>00617 
<a name="l00618"></a>00618         <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00619"></a>00619         {
<a name="l00620"></a>00620           <span class="comment">// but validate that it&#39;s there afterwards</span>
<a name="l00621"></a>00621           myRecord = <a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">getRecord</a>( <span class="stringliteral">&quot;select * from tbl_srs where parameters=&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() ) + <span class="stringliteral">&quot; order by deprecated&quot;</span> );
<a name="l00622"></a>00622         }
<a name="l00623"></a>00623       }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625       <span class="keywordflow">if</span> ( !myRecord.empty() )
<a name="l00626"></a>00626       {
<a name="l00627"></a>00627         <span class="comment">// take the srid from the record</span>
<a name="l00628"></a>00628         mySrsId = myRecord[<span class="stringliteral">&quot;srs_id&quot;</span>].toLong();
<a name="l00629"></a>00629         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;proj4string match search for srsid returned srsid: &quot;</span> + QString::number( mySrsId ) );
<a name="l00630"></a>00630         <span class="keywordflow">if</span> ( mySrsId &gt; 0 )
<a name="l00631"></a>00631         {
<a name="l00632"></a>00632           <a class="code" href="classQgsCoordinateReferenceSystem.html#abe875cd97646dddca629e539ecb38cb8">createFromSrsId</a>( mySrsId );
<a name="l00633"></a>00633         }
<a name="l00634"></a>00634         <span class="keywordflow">else</span>
<a name="l00635"></a>00635         {
<a name="l00636"></a>00636           <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;invalid srid %1 found&quot;</span> ).arg( mySrsId ) );
<a name="l00637"></a>00637           <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <span class="keyword">false</span>;
<a name="l00638"></a>00638         }
<a name="l00639"></a>00639       }
<a name="l00640"></a>00640       <span class="keywordflow">else</span>
<a name="l00641"></a>00641       {
<a name="l00642"></a>00642         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Couldn&#39;t find newly added proj string?&quot;</span> );
<a name="l00643"></a>00643         <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <span class="keyword">false</span>;
<a name="l00644"></a>00644       }
<a name="l00645"></a>00645     }
<a name="l00646"></a>00646   }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a>;
<a name="l00649"></a>00649 }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 <span class="comment">//private method meant for internal use by this class only</span>
<a name="l00652"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">00652</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a238dfb729c699d5e3f6d37f7527991b0">QgsCoordinateReferenceSystem::RecordMap</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a406240fc2c4a790e86f71058f2bf0237">QgsCoordinateReferenceSystem::getRecord</a>( QString theSql )
<a name="l00653"></a>00653 {
<a name="l00654"></a>00654   QString myDatabaseFileName;
<a name="l00655"></a>00655   <a class="code" href="classQgsCoordinateReferenceSystem.html#a238dfb729c699d5e3f6d37f7527991b0">QgsCoordinateReferenceSystem::RecordMap</a> myMap;
<a name="l00656"></a>00656   QString myFieldName;
<a name="l00657"></a>00657   QString myFieldValue;
<a name="l00658"></a>00658   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a>      *myDatabase;
<a name="l00659"></a>00659   <span class="keyword">const</span> <span class="keywordtype">char</span>   *myTail;
<a name="l00660"></a>00660   sqlite3_stmt *myPreparedStatement;
<a name="l00661"></a>00661   <span class="keywordtype">int</span>           myResult;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;running query: &quot;</span> + theSql );
<a name="l00664"></a>00664   <span class="comment">// Get the full path name to the sqlite3 spatial reference database.</span>
<a name="l00665"></a>00665   myDatabaseFileName = <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>();
<a name="l00666"></a>00666   QFileInfo myInfo( myDatabaseFileName );
<a name="l00667"></a>00667   <span class="keywordflow">if</span> ( !myInfo.exists() )
<a name="l00668"></a>00668   {
<a name="l00669"></a>00669     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;failed : &quot;</span> + myDatabaseFileName +
<a name="l00670"></a>00670                  <span class="stringliteral">&quot; does not exist!&quot;</span> );
<a name="l00671"></a>00671     <span class="keywordflow">return</span> myMap;
<a name="l00672"></a>00672   }
<a name="l00673"></a>00673 
<a name="l00674"></a>00674   <span class="comment">//check the db is available</span>
<a name="l00675"></a>00675   myResult = <a class="code" href="classQgsCoordinateReferenceSystem.html#aed9df708f2dbbd8609e6717fbd8ab8bd">openDb</a>( myDatabaseFileName, &amp;myDatabase );
<a name="l00676"></a>00676   <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l00677"></a>00677   {
<a name="l00678"></a>00678     <span class="keywordflow">return</span> myMap;
<a name="l00679"></a>00679   }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681   myResult = sqlite3_prepare( myDatabase, theSql.toUtf8(), theSql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l00682"></a>00682   <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l00683"></a>00683   <span class="keywordflow">if</span> ( myResult == SQLITE_OK &amp;&amp; sqlite3_step( myPreparedStatement ) == SQLITE_ROW )
<a name="l00684"></a>00684   {
<a name="l00685"></a>00685     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;trying system srs.db&quot;</span> );
<a name="l00686"></a>00686     <span class="keywordtype">int</span> myColumnCount = sqlite3_column_count( myPreparedStatement );
<a name="l00687"></a>00687     <span class="comment">//loop through each column in the record adding its expression name and value to the map</span>
<a name="l00688"></a>00688     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> myColNo = 0; myColNo &lt; myColumnCount; myColNo++ )
<a name="l00689"></a>00689     {
<a name="l00690"></a>00690       myFieldName = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_name( myPreparedStatement, myColNo ) );
<a name="l00691"></a>00691       myFieldValue = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, myColNo ) );
<a name="l00692"></a>00692       myMap[myFieldName] = myFieldValue;
<a name="l00693"></a>00693     }
<a name="l00694"></a>00694   }
<a name="l00695"></a>00695   <span class="keywordflow">else</span>
<a name="l00696"></a>00696   {
<a name="l00697"></a>00697     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;trying user qgis.db&quot;</span> );
<a name="l00698"></a>00698     sqlite3_finalize( myPreparedStatement );
<a name="l00699"></a>00699     sqlite3_close( myDatabase );
<a name="l00700"></a>00700 
<a name="l00701"></a>00701     myDatabaseFileName = <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>();
<a name="l00702"></a>00702     QFileInfo myFileInfo;
<a name="l00703"></a>00703     myFileInfo.setFile( myDatabaseFileName );
<a name="l00704"></a>00704     <span class="keywordflow">if</span> ( !myFileInfo.exists( ) )
<a name="l00705"></a>00705     {
<a name="l00706"></a>00706       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;user qgis.db not found&quot;</span> );
<a name="l00707"></a>00707       <span class="keywordflow">return</span> myMap;
<a name="l00708"></a>00708     }
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <span class="comment">//check the db is available</span>
<a name="l00711"></a>00711     myResult = <a class="code" href="classQgsCoordinateReferenceSystem.html#aed9df708f2dbbd8609e6717fbd8ab8bd">openDb</a>( myDatabaseFileName, &amp;myDatabase );
<a name="l00712"></a>00712     <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l00713"></a>00713     {
<a name="l00714"></a>00714       <span class="keywordflow">return</span> myMap;
<a name="l00715"></a>00715     }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     myResult = sqlite3_prepare( myDatabase, theSql.toUtf8(), theSql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l00718"></a>00718     <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l00719"></a>00719     <span class="keywordflow">if</span> ( myResult == SQLITE_OK &amp;&amp; sqlite3_step( myPreparedStatement ) == SQLITE_ROW )
<a name="l00720"></a>00720     {
<a name="l00721"></a>00721       <span class="keywordtype">int</span> myColumnCount = sqlite3_column_count( myPreparedStatement );
<a name="l00722"></a>00722       <span class="comment">//loop through each column in the record adding its field name and value to the map</span>
<a name="l00723"></a>00723       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> myColNo = 0; myColNo &lt; myColumnCount; myColNo++ )
<a name="l00724"></a>00724       {
<a name="l00725"></a>00725         myFieldName = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_name( myPreparedStatement, myColNo ) );
<a name="l00726"></a>00726         myFieldValue = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, myColNo ) );
<a name="l00727"></a>00727         myMap[myFieldName] = myFieldValue;
<a name="l00728"></a>00728       }
<a name="l00729"></a>00729     }
<a name="l00730"></a>00730     <span class="keywordflow">else</span>
<a name="l00731"></a>00731     {
<a name="l00732"></a>00732       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;failed :  &quot;</span> + theSql );
<a name="l00733"></a>00733 
<a name="l00734"></a>00734     }
<a name="l00735"></a>00735   }
<a name="l00736"></a>00736   sqlite3_finalize( myPreparedStatement );
<a name="l00737"></a>00737   sqlite3_close( myDatabase );
<a name="l00738"></a>00738 
<a name="l00739"></a>00739 <span class="preprocessor">#ifdef QGISDEBUG</span>
<a name="l00740"></a>00740 <span class="preprocessor"></span>  <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;retrieved:  &quot;</span> + theSql );
<a name="l00741"></a>00741   RecordMap::Iterator it;
<a name="l00742"></a>00742   <span class="keywordflow">for</span> ( it = myMap.begin(); it != myMap.end(); ++it )
<a name="l00743"></a>00743   {
<a name="l00744"></a>00744     <a class="code" href="qgslogger_8h.html#a795a1fcfb1c61b988bbd999396411d13">QgsDebugMsgLevel</a>( it.key() + <span class="stringliteral">&quot; =&gt; &quot;</span> + it.value(), 2 );
<a name="l00745"></a>00745   }
<a name="l00746"></a>00746 <span class="preprocessor">#endif</span>
<a name="l00747"></a>00747 <span class="preprocessor"></span>
<a name="l00748"></a>00748   <span class="keywordflow">return</span> myMap;
<a name="l00749"></a>00749 }
<a name="l00750"></a>00750 
<a name="l00751"></a>00751 <span class="comment">// Accessors -----------------------------------</span>
<a name="l00752"></a>00752 
<a name="l00753"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#add285911972f1facfe30388ab0eba01a">00753</a> <span class="keywordtype">long</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#add285911972f1facfe30388ab0eba01a">QgsCoordinateReferenceSystem::srsid</a>()<span class="keyword"> const</span>
<a name="l00754"></a>00754 <span class="keyword"></span>{
<a name="l00755"></a>00755   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a>;
<a name="l00756"></a>00756 }
<a name="l00757"></a>00757 
<a name="l00758"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a3cb64f24049d50fbacffd1eece5125ee">00758</a> <span class="keywordtype">long</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a3cb64f24049d50fbacffd1eece5125ee">QgsCoordinateReferenceSystem::postgisSrid</a>()<span class="keyword"> const</span>
<a name="l00759"></a>00759 <span class="keyword"></span>{
<a name="l00760"></a>00760 
<a name="l00761"></a>00761   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#aadc5601daf830461d22dbe57f8978b14" title="If available, the Postgis spatial_ref_sys identifier for this srs (defaults to 0)">mSRID</a>;
<a name="l00762"></a>00762 
<a name="l00763"></a>00763 }
<a name="l00764"></a>00764 
<a name="l00765"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#afae7fd3ededbb445ebf67678b6bf7d0c">00765</a> <span class="keywordtype">long</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#afae7fd3ededbb445ebf67678b6bf7d0c">QgsCoordinateReferenceSystem::epsg</a>()<span class="keyword"> const</span>
<a name="l00766"></a>00766 <span class="keyword"></span>{
<a name="l00767"></a>00767   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a>.startsWith( <span class="stringliteral">&quot;EPSG:&quot;</span>, Qt::CaseInsensitive ) )
<a name="l00768"></a>00768     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a>.mid( 5 ).toLong();
<a name="l00769"></a>00769   <span class="keywordflow">else</span>
<a name="l00770"></a>00770     <span class="keywordflow">return</span> 0;
<a name="l00771"></a>00771 }
<a name="l00772"></a>00772 
<a name="l00773"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a4382981b1233c7f0ca1c7ce7bdb670d3">00773</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a4382981b1233c7f0ca1c7ce7bdb670d3">QgsCoordinateReferenceSystem::authid</a>()<span class="keyword"> const</span>
<a name="l00774"></a>00774 <span class="keyword"></span>{
<a name="l00775"></a>00775   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a>;
<a name="l00776"></a>00776 }
<a name="l00777"></a>00777 
<a name="l00778"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#afbb64ee54a05d2f414cd6bc91850d768">00778</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#afbb64ee54a05d2f414cd6bc91850d768">QgsCoordinateReferenceSystem::description</a>()<span class="keyword"> const</span>
<a name="l00779"></a>00779 <span class="keyword"></span>{
<a name="l00780"></a>00780   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a587603e45b3e111d38c377b4bf90d052" title="A textual description of the srs.">mDescription</a>.isNull() )
<a name="l00781"></a>00781   {
<a name="l00782"></a>00782     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00783"></a>00783   }
<a name="l00784"></a>00784   <span class="keywordflow">else</span>
<a name="l00785"></a>00785   {
<a name="l00786"></a>00786     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a587603e45b3e111d38c377b4bf90d052" title="A textual description of the srs.">mDescription</a>;
<a name="l00787"></a>00787   }
<a name="l00788"></a>00788 }
<a name="l00789"></a>00789 
<a name="l00790"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a5856631fdebbfe839fa0955d5c36630a">00790</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a5856631fdebbfe839fa0955d5c36630a">QgsCoordinateReferenceSystem::projectionAcronym</a>()<span class="keyword"> const</span>
<a name="l00791"></a>00791 <span class="keyword"></span>{
<a name="l00792"></a>00792   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a>.isNull() )
<a name="l00793"></a>00793   {
<a name="l00794"></a>00794     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00795"></a>00795   }
<a name="l00796"></a>00796   <span class="keywordflow">else</span>
<a name="l00797"></a>00797   {
<a name="l00798"></a>00798     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a>;
<a name="l00799"></a>00799   }
<a name="l00800"></a>00800 }
<a name="l00801"></a>00801 
<a name="l00802"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a23f9df6ec7aa26eff0f3e535d0a82470">00802</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a23f9df6ec7aa26eff0f3e535d0a82470">QgsCoordinateReferenceSystem::ellipsoidAcronym</a>()<span class="keyword"> const</span>
<a name="l00803"></a>00803 <span class="keyword"></span>{
<a name="l00804"></a>00804   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a>.isNull() )
<a name="l00805"></a>00805   {
<a name="l00806"></a>00806     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00807"></a>00807   }
<a name="l00808"></a>00808   <span class="keywordflow">else</span>
<a name="l00809"></a>00809   {
<a name="l00810"></a>00810     <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a>;
<a name="l00811"></a>00811   }
<a name="l00812"></a>00812 }
<a name="l00813"></a>00813 
<a name="l00814"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f">00814</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">QgsCoordinateReferenceSystem::toProj4</a>()<span class="keyword"> const</span>
<a name="l00815"></a>00815 <span class="keyword"></span>{
<a name="l00816"></a>00816   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00817"></a>00817     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00818"></a>00818 
<a name="l00819"></a>00819   QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>;
<a name="l00820"></a>00820   <span class="keywordtype">char</span> *proj4src = NULL;
<a name="l00821"></a>00821   OSRExportToProj4( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, &amp;proj4src );
<a name="l00822"></a>00822   toProj4 = proj4src;
<a name="l00823"></a>00823   CPLFree( proj4src );
<a name="l00824"></a>00824 
<a name="l00825"></a>00825   <span class="comment">// Stray spaces at the end?</span>
<a name="l00826"></a>00826   <span class="keywordflow">return</span> toProj4.trimmed();
<a name="l00827"></a>00827 }
<a name="l00828"></a>00828 
<a name="l00829"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a06cbad30d422173714895af571928cb2">00829</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a06cbad30d422173714895af571928cb2">QgsCoordinateReferenceSystem::geographicFlag</a>()<span class="keyword"> const</span>
<a name="l00830"></a>00830 <span class="keyword"></span>{
<a name="l00831"></a>00831   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a6f9be65a137f9ea477f7190de74c8f66" title="Whether this is a geographic or projected coordinate system.">mGeoFlag</a>;
<a name="l00832"></a>00832 }
<a name="l00833"></a>00833 
<a name="l00834"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a8dd2d190edae32d6e6ca63cfd8154154">00834</a> <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379c" title="Map units that qgis supports.">QGis::UnitType</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a8dd2d190edae32d6e6ca63cfd8154154">QgsCoordinateReferenceSystem::mapUnits</a>()<span class="keyword"> const</span>
<a name="l00835"></a>00835 <span class="keyword"></span>{
<a name="l00836"></a>00836   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a>;
<a name="l00837"></a>00837 }
<a name="l00838"></a>00838 
<a name="l00839"></a>00839 
<a name="l00840"></a>00840 <span class="comment">// Mutators -----------------------------------</span>
<a name="l00841"></a>00841 
<a name="l00842"></a>00842 
<a name="l00843"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a53fc815b9a4f09b68678c1e6565eb1c0">00843</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a53fc815b9a4f09b68678c1e6565eb1c0">QgsCoordinateReferenceSystem::setInternalId</a>( <span class="keywordtype">long</span> theSrsId )
<a name="l00844"></a>00844 {
<a name="l00845"></a>00845   <a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a> = theSrsId;
<a name="l00846"></a>00846 }
<a name="l00847"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ab88807a76674cd7890c167396cf69fa1">00847</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ab88807a76674cd7890c167396cf69fa1">QgsCoordinateReferenceSystem::setAuthId</a>( QString authId )
<a name="l00848"></a>00848 {
<a name="l00849"></a>00849   <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a> = authId;
<a name="l00850"></a>00850 }
<a name="l00851"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a48720d509f6f87ee5d20fe63fa8546ef">00851</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a48720d509f6f87ee5d20fe63fa8546ef">QgsCoordinateReferenceSystem::setSrid</a>( <span class="keywordtype">long</span> theSrid )
<a name="l00852"></a>00852 {
<a name="l00853"></a>00853   <a class="code" href="classQgsCoordinateReferenceSystem.html#aadc5601daf830461d22dbe57f8978b14" title="If available, the Postgis spatial_ref_sys identifier for this srs (defaults to 0)">mSRID</a> = theSrid;
<a name="l00854"></a>00854 }
<a name="l00855"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#adc75c14d21fea1e2e912be121816719c">00855</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#adc75c14d21fea1e2e912be121816719c">QgsCoordinateReferenceSystem::setDescription</a>( QString theDescription )
<a name="l00856"></a>00856 {
<a name="l00857"></a>00857   <a class="code" href="classQgsCoordinateReferenceSystem.html#a587603e45b3e111d38c377b4bf90d052" title="A textual description of the srs.">mDescription</a> = theDescription;
<a name="l00858"></a>00858 }
<a name="l00859"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ae0cd0008b170f81f0721fb475780e9ab">00859</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ae0cd0008b170f81f0721fb475780e9ab">QgsCoordinateReferenceSystem::setProj4String</a>( QString theProj4String )
<a name="l00860"></a>00860 {
<a name="l00861"></a>00861   <span class="keyword">const</span> <span class="keywordtype">char</span> *oldlocale = setlocale( LC_NUMERIC, NULL );
<a name="l00862"></a>00862 
<a name="l00863"></a>00863   setlocale( LC_NUMERIC, <span class="stringliteral">&quot;C&quot;</span> );
<a name="l00864"></a>00864   OSRDestroySpatialReference( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> );
<a name="l00865"></a>00865   <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> = OSRNewSpatialReference( NULL );
<a name="l00866"></a>00866   <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> =
<a name="l00867"></a>00867     OSRImportFromProj4( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, theProj4String.trimmed().toLatin1().constData() )
<a name="l00868"></a>00868     == OGRERR_NONE;
<a name="l00869"></a>00869   <a class="code" href="classQgsCoordinateReferenceSystem.html#a8ee0ef723cb6af96bcf2ead7f72d6277">mWkt</a>.clear();
<a name="l00870"></a>00870   <a class="code" href="classQgsCoordinateReferenceSystem.html#ac552bc85c6d409b529b6889bfd2456ac" title="Work out the projection units and set the appropriate local variable.">setMapUnits</a>();
<a name="l00871"></a>00871 
<a name="l00872"></a>00872 <span class="preprocessor">#if defined(QGISDEBUG) &amp;&amp; QGISDEBUG&gt;=3</span>
<a name="l00873"></a>00873 <span class="preprocessor"></span>  <a class="code" href="classQgsCoordinateReferenceSystem.html#a43352910866a504c28c15be3bc73310f">debugPrint</a>();
<a name="l00874"></a>00874 <span class="preprocessor">#endif</span>
<a name="l00875"></a>00875 <span class="preprocessor"></span>
<a name="l00876"></a>00876   setlocale( LC_NUMERIC, oldlocale );
<a name="l00877"></a>00877 }
<a name="l00878"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a0164e462112889c561930102d28f4a61">00878</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a0164e462112889c561930102d28f4a61">QgsCoordinateReferenceSystem::setGeographicFlag</a>( <span class="keywordtype">bool</span> theGeoFlag )
<a name="l00879"></a>00879 {
<a name="l00880"></a>00880   <a class="code" href="classQgsCoordinateReferenceSystem.html#a6f9be65a137f9ea477f7190de74c8f66" title="Whether this is a geographic or projected coordinate system.">mGeoFlag</a> = theGeoFlag;
<a name="l00881"></a>00881 }
<a name="l00882"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a95dd68e576966d65c21614ed4f8a4906">00882</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a95dd68e576966d65c21614ed4f8a4906">QgsCoordinateReferenceSystem::setEpsg</a>( <span class="keywordtype">long</span> theEpsg )
<a name="l00883"></a>00883 {
<a name="l00884"></a>00884   <a class="code" href="classQgsCoordinateReferenceSystem.html#ac0caf92436bc53103f84118f591402ab" title="If available the authority identifier for this srs.">mAuthId</a> = QString( <span class="stringliteral">&quot;EPSG:%1&quot;</span> ).arg( theEpsg );
<a name="l00885"></a>00885 }
<a name="l00886"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a915bde3df8c1c293b2e8fb093a38c5fb">00886</a> <span class="keywordtype">void</span>  <a class="code" href="classQgsCoordinateReferenceSystem.html#a915bde3df8c1c293b2e8fb093a38c5fb">QgsCoordinateReferenceSystem::setProjectionAcronym</a>( QString theProjectionAcronym )
<a name="l00887"></a>00887 {
<a name="l00888"></a>00888   <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a> = theProjectionAcronym;
<a name="l00889"></a>00889 }
<a name="l00890"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a730dc46ee45abe759ba0e8c5ed5bb998">00890</a> <span class="keywordtype">void</span>  <a class="code" href="classQgsCoordinateReferenceSystem.html#a730dc46ee45abe759ba0e8c5ed5bb998">QgsCoordinateReferenceSystem::setEllipsoidAcronym</a>( QString theEllipsoidAcronym )
<a name="l00891"></a>00891 {
<a name="l00892"></a>00892   <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a> = theEllipsoidAcronym;
<a name="l00893"></a>00893 }
<a name="l00894"></a>00894 
<a name="l00895"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ac552bc85c6d409b529b6889bfd2456ac">00895</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ac552bc85c6d409b529b6889bfd2456ac" title="Work out the projection units and set the appropriate local variable.">QgsCoordinateReferenceSystem::setMapUnits</a>()
<a name="l00896"></a>00896 {
<a name="l00897"></a>00897   <span class="keywordflow">if</span> ( !<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00898"></a>00898   {
<a name="l00899"></a>00899     <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a> = <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca0790d6f2b2c0747502235775b6b556ee">QGis::UnknownUnit</a>;
<a name="l00900"></a>00900     <span class="keywordflow">return</span>;
<a name="l00901"></a>00901   }
<a name="l00902"></a>00902 
<a name="l00903"></a>00903   <span class="keywordtype">char</span> *unitName;
<a name="l00904"></a>00904 
<a name="l00905"></a>00905   <span class="comment">// Of interest to us is that this call adds in a unit parameter if</span>
<a name="l00906"></a>00906   <span class="comment">// one doesn&#39;t already exist.</span>
<a name="l00907"></a>00907   OSRFixup( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> );
<a name="l00908"></a>00908 
<a name="l00909"></a>00909   <span class="keywordflow">if</span> ( OSRIsProjected( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a> ) )
<a name="l00910"></a>00910   {
<a name="l00911"></a>00911     <span class="keywordtype">double</span> toMeter = OSRGetLinearUnits( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, &amp;unitName );
<a name="l00912"></a>00912     QString unit( unitName );
<a name="l00913"></a>00913 
<a name="l00914"></a>00914     <span class="comment">// If the units parameter was created during the Fixup() call</span>
<a name="l00915"></a>00915     <span class="comment">// above, the name of the units is likely to be &#39;unknown&#39;. Try to</span>
<a name="l00916"></a>00916     <span class="comment">// do better than that ... (but perhaps ogr should be enhanced to</span>
<a name="l00917"></a>00917     <span class="comment">// do this instead?).</span>
<a name="l00918"></a>00918 
<a name="l00919"></a>00919     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> feetToMeter = 0.3048;
<a name="l00920"></a>00920     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> smallNum = 1e-3;
<a name="l00921"></a>00921 
<a name="l00922"></a>00922     <span class="keywordflow">if</span> ( qAbs( toMeter - feetToMeter ) &lt; smallNum )
<a name="l00923"></a>00923       unit = <span class="stringliteral">&quot;Foot&quot;</span>;
<a name="l00924"></a>00924 
<a name="l00925"></a>00925     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Projection has linear units of &quot;</span> + unit );
<a name="l00926"></a>00926 
<a name="l00927"></a>00927     <span class="keywordflow">if</span> ( <a class="code" href="qgis_8h.html#a14039c8aa54bda84192e28ecb298ed20">doubleNear</a>( toMeter, 1.0 ) ) <span class="comment">//Unit name for meters would be &quot;metre&quot;</span>
<a name="l00928"></a>00928       <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a> = <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca5132b3d9c171301d76d7a14d8b3a86dc">QGis::Meters</a>;
<a name="l00929"></a>00929     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( unit == <span class="stringliteral">&quot;Foot&quot;</span> )
<a name="l00930"></a>00930       <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a> = <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca0b4a519c1888a3f2beb8c1d23a4b2393">QGis::Feet</a>;
<a name="l00931"></a>00931     <span class="keywordflow">else</span>
<a name="l00932"></a>00932     {
<a name="l00933"></a>00933       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Unsupported map units of &quot;</span> + unit );
<a name="l00934"></a>00934       <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a> = <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca0790d6f2b2c0747502235775b6b556ee">QGis::UnknownUnit</a>;
<a name="l00935"></a>00935     }
<a name="l00936"></a>00936   }
<a name="l00937"></a>00937   <span class="keywordflow">else</span>
<a name="l00938"></a>00938   {
<a name="l00939"></a>00939     OSRGetAngularUnits( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, &amp;unitName );
<a name="l00940"></a>00940     QString unit( unitName );
<a name="l00941"></a>00941     <span class="keywordflow">if</span> ( unit == <span class="stringliteral">&quot;degree&quot;</span> )
<a name="l00942"></a>00942       <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a> = <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca94852e9654597b263f080312bc76c110">QGis::Degrees</a>;
<a name="l00943"></a>00943     <span class="keywordflow">else</span>
<a name="l00944"></a>00944     {
<a name="l00945"></a>00945       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Unsupported map units of &quot;</span> + unit );
<a name="l00946"></a>00946       <a class="code" href="classQgsCoordinateReferenceSystem.html#a0da6cf8b52593de402dcdb1133a5bfc2" title="The map units.">mMapUnits</a> = <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca0790d6f2b2c0747502235775b6b556ee">QGis::UnknownUnit</a>;
<a name="l00947"></a>00947     }
<a name="l00948"></a>00948     <a class="code" href="qgslogger_8h.html#a795a1fcfb1c61b988bbd999396411d13">QgsDebugMsgLevel</a>( <span class="stringliteral">&quot;Projection has angular units of &quot;</span> + unit, 3 );
<a name="l00949"></a>00949   }
<a name="l00950"></a>00950 }
<a name="l00951"></a>00951 
<a name="l00952"></a>00952 <span class="comment">/*</span>
<a name="l00953"></a>00953 <span class="comment">*    check if srs is a geocs or a proj cs (using ogr isGeographic)</span>
<a name="l00954"></a>00954 <span class="comment">*   then sequentially walk through the database (first users qgis.db srs tbl then</span>
<a name="l00955"></a>00955 <span class="comment">*   system srs.db tbl), converting each entry into an ogr srs and using isSame</span>
<a name="l00956"></a>00956 <span class="comment">*   or isSameGeocs (essentially calling the == overloaded operator). We&#39;ll try to</span>
<a name="l00957"></a>00957 <span class="comment">*   be smart about this and first parse out the proj and ellpse strings and only</span>
<a name="l00958"></a>00958 <span class="comment">*   check for a match in entities that have the same ellps and proj entries so</span>
<a name="l00959"></a>00959 <span class="comment">*   that it doesnt munch yer cpu so much.</span>
<a name="l00960"></a>00960 <span class="comment">*/</span>
<a name="l00961"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcef003135c7bf9de91c79e6d9a54bb">00961</a> <span class="keywordtype">long</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcef003135c7bf9de91c79e6d9a54bb">QgsCoordinateReferenceSystem::findMatchingProj</a>()
<a name="l00962"></a>00962 {
<a name="l00963"></a>00963   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;entered.&quot;</span> );
<a name="l00964"></a>00964   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a>.isNull() ||  <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a>.isNull()
<a name="l00965"></a>00965        || !<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l00966"></a>00966   {
<a name="l00967"></a>00967     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;QgsCoordinateReferenceSystem::findMatchingProj will only &quot;</span>
<a name="l00968"></a>00968                  <span class="stringliteral">&quot;work if prj acr ellipsoid acr and proj4string are set&quot;</span>
<a name="l00969"></a>00969                  <span class="stringliteral">&quot; and the current projection is valid!&quot;</span> );
<a name="l00970"></a>00970     <span class="keywordflow">return</span> 0;
<a name="l00971"></a>00971   }
<a name="l00972"></a>00972 
<a name="l00973"></a>00973   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a>      *myDatabase;
<a name="l00974"></a>00974   <span class="keyword">const</span> <span class="keywordtype">char</span>   *myTail;
<a name="l00975"></a>00975   sqlite3_stmt *myPreparedStatement;
<a name="l00976"></a>00976   <span class="keywordtype">int</span>           myResult;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978   <span class="comment">// Set up the query to retrieve the projection information</span>
<a name="l00979"></a>00979   <span class="comment">// needed to populate the list</span>
<a name="l00980"></a>00980   QString mySql = QString( <span class="stringliteral">&quot;select srs_id,parameters from tbl_srs where &quot;</span>
<a name="l00981"></a>00981                            <span class="stringliteral">&quot;projection_acronym=%1 and ellipsoid_acronym=%2 order by deprecated&quot;</span> )
<a name="l00982"></a>00982                   .arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a2a477741983c7c27c07eaa4fb8a1929c" title="The official proj4 acronym for the projection family.">mProjectionAcronym</a> ) )
<a name="l00983"></a>00983                   .arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a11c3be1f72cbb9e4a495cd375862b7d3" title="The official proj4 acronym for the ellipoid.">mEllipsoidAcronym</a> ) );
<a name="l00984"></a>00984   <span class="comment">// Get the full path name to the sqlite3 spatial reference database.</span>
<a name="l00985"></a>00985   QString myDatabaseFileName = <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>();
<a name="l00986"></a>00986 
<a name="l00987"></a>00987   <span class="comment">//check the db is available</span>
<a name="l00988"></a>00988   myResult = <a class="code" href="classQgsCoordinateReferenceSystem.html#aed9df708f2dbbd8609e6717fbd8ab8bd">openDb</a>( myDatabaseFileName, &amp;myDatabase );
<a name="l00989"></a>00989   <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l00990"></a>00990   {
<a name="l00991"></a>00991     <span class="keywordflow">return</span> 0;
<a name="l00992"></a>00992   }
<a name="l00993"></a>00993 
<a name="l00994"></a>00994   myResult = sqlite3_prepare( myDatabase, mySql.toUtf8(), mySql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l00995"></a>00995 <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l00996"></a>00996   <span class="keywordflow">if</span> ( myResult == SQLITE_OK )
<a name="l00997"></a>00997   {
<a name="l00998"></a>00998 
<a name="l00999"></a>00999     <span class="keywordflow">while</span> ( sqlite3_step( myPreparedStatement ) == SQLITE_ROW )
<a name="l01000"></a>01000     {
<a name="l01001"></a>01001       QString mySrsId = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 0 ) );
<a name="l01002"></a>01002       QString myProj4String = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 1 ) );
<a name="l01003"></a>01003       <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() == myProj4String.trimmed() )
<a name="l01004"></a>01004       {
<a name="l01005"></a>01005         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;-------&gt; MATCH FOUND in srs.db srsid: &quot;</span> + mySrsId );
<a name="l01006"></a>01006         <span class="comment">// close the sqlite3 statement</span>
<a name="l01007"></a>01007         sqlite3_finalize( myPreparedStatement );
<a name="l01008"></a>01008         sqlite3_close( myDatabase );
<a name="l01009"></a>01009         <span class="keywordflow">return</span> mySrsId.toLong();
<a name="l01010"></a>01010       }
<a name="l01011"></a>01011       <span class="keywordflow">else</span>
<a name="l01012"></a>01012       {
<a name="l01013"></a>01013 <span class="comment">// QgsDebugMsg(QString(&quot; Not matched : %1&quot;).arg(myProj4String));</span>
<a name="l01014"></a>01014       }
<a name="l01015"></a>01015     }
<a name="l01016"></a>01016   }
<a name="l01017"></a>01017   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;no match found in srs.db, trying user db now!&quot;</span> );
<a name="l01018"></a>01018   <span class="comment">// close the sqlite3 statement</span>
<a name="l01019"></a>01019   sqlite3_finalize( myPreparedStatement );
<a name="l01020"></a>01020   sqlite3_close( myDatabase );
<a name="l01021"></a>01021   <span class="comment">//</span>
<a name="l01022"></a>01022   <span class="comment">// Try the users db now</span>
<a name="l01023"></a>01023   <span class="comment">//</span>
<a name="l01024"></a>01024 
<a name="l01025"></a>01025   myDatabaseFileName = <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>();
<a name="l01026"></a>01026   <span class="comment">//check the db is available</span>
<a name="l01027"></a>01027   myResult = <a class="code" href="classQgsCoordinateReferenceSystem.html#aed9df708f2dbbd8609e6717fbd8ab8bd">openDb</a>( myDatabaseFileName, &amp;myDatabase );
<a name="l01028"></a>01028   <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l01029"></a>01029   {
<a name="l01030"></a>01030     <span class="keywordflow">return</span> 0;
<a name="l01031"></a>01031   }
<a name="l01032"></a>01032 
<a name="l01033"></a>01033   myResult = sqlite3_prepare( myDatabase, mySql.toUtf8(), mySql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l01034"></a>01034 <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l01035"></a>01035   <span class="keywordflow">if</span> ( myResult == SQLITE_OK )
<a name="l01036"></a>01036   {
<a name="l01037"></a>01037 
<a name="l01038"></a>01038     <span class="keywordflow">while</span> ( sqlite3_step( myPreparedStatement ) == SQLITE_ROW )
<a name="l01039"></a>01039     {
<a name="l01040"></a>01040       QString mySrsId = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 0 ) );
<a name="l01041"></a>01041       QString myProj4String = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 1 ) );
<a name="l01042"></a>01042       <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() == myProj4String.trimmed() )
<a name="l01043"></a>01043       {
<a name="l01044"></a>01044         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;-------&gt; MATCH FOUND in user qgis.db srsid: &quot;</span> + mySrsId );
<a name="l01045"></a>01045         <span class="comment">// close the sqlite3 statement</span>
<a name="l01046"></a>01046         sqlite3_finalize( myPreparedStatement );
<a name="l01047"></a>01047         sqlite3_close( myDatabase );
<a name="l01048"></a>01048         <span class="keywordflow">return</span> mySrsId.toLong();
<a name="l01049"></a>01049       }
<a name="l01050"></a>01050       <span class="keywordflow">else</span>
<a name="l01051"></a>01051       {
<a name="l01052"></a>01052 <span class="comment">// QgsDebugMsg(QString(&quot; Not matched : %1&quot;).arg(myProj4String));</span>
<a name="l01053"></a>01053       }
<a name="l01054"></a>01054     }
<a name="l01055"></a>01055   }
<a name="l01056"></a>01056   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;no match found in user db&quot;</span> );
<a name="l01057"></a>01057 
<a name="l01058"></a>01058   <span class="comment">// close the sqlite3 statement</span>
<a name="l01059"></a>01059   sqlite3_finalize( myPreparedStatement );
<a name="l01060"></a>01060   sqlite3_close( myDatabase );
<a name="l01061"></a>01061   <span class="keywordflow">return</span> 0;
<a name="l01062"></a>01062 }
<a name="l01063"></a>01063 
<a name="l01064"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a87f7203f2e51df57622ae4db250cb204">01064</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a87f7203f2e51df57622ae4db250cb204">QgsCoordinateReferenceSystem::operator==</a>( <span class="keyword">const</span> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> &amp;theSrs )<span class="keyword"> const</span>
<a name="l01065"></a>01065 <span class="keyword"></span>{
<a name="l01066"></a>01066   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> &amp;&amp; theSrs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> &amp;&amp; theSrs.<a class="code" href="classQgsCoordinateReferenceSystem.html#a4382981b1233c7f0ca1c7ce7bdb670d3">authid</a>() == <a class="code" href="classQgsCoordinateReferenceSystem.html#a4382981b1233c7f0ca1c7ce7bdb670d3">authid</a>();
<a name="l01067"></a>01067 }
<a name="l01068"></a>01068 
<a name="l01069"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#aa36af36ecbd4a3766512785e78312fb7">01069</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#aa36af36ecbd4a3766512785e78312fb7">QgsCoordinateReferenceSystem::operator!=</a>( <span class="keyword">const</span> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> &amp;theSrs )<span class="keyword"> const</span>
<a name="l01070"></a>01070 <span class="keyword"></span>{
<a name="l01071"></a>01071   <span class="keywordflow">return</span>  !( *<span class="keyword">this</span> == theSrs );
<a name="l01072"></a>01072 }
<a name="l01073"></a>01073 
<a name="l01074"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ad9fbea571e861f319fbf961cece39995">01074</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ad9fbea571e861f319fbf961cece39995">QgsCoordinateReferenceSystem::equals</a>( QString theProj4String )
<a name="l01075"></a>01075 {
<a name="l01076"></a>01076   <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> r;
<a name="l01077"></a>01077   r.<a class="code" href="classQgsCoordinateReferenceSystem.html#acf5ccd2750d310c725937a82a700ecdb">createFromProj4</a>( theProj4String );
<a name="l01078"></a>01078   <span class="keywordflow">return</span> *<span class="keyword">this</span> == r;
<a name="l01079"></a>01079 }
<a name="l01080"></a>01080 
<a name="l01081"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a55e62f3f587e9de20ed911d26d12f499">01081</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a55e62f3f587e9de20ed911d26d12f499">QgsCoordinateReferenceSystem::toWkt</a>()<span class="keyword"> const</span>
<a name="l01082"></a>01082 <span class="keyword"></span>{
<a name="l01083"></a>01083   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a8ee0ef723cb6af96bcf2ead7f72d6277">mWkt</a>.isEmpty() )
<a name="l01084"></a>01084   {
<a name="l01085"></a>01085     <span class="keywordtype">char</span> *wkt;
<a name="l01086"></a>01086     <span class="keywordflow">if</span> ( OSRExportToWkt( <a class="code" href="classQgsCoordinateReferenceSystem.html#a7818fd7f1bf6fc2479dc2a8e3966bb2b">mCRS</a>, &amp;wkt ) == OGRERR_NONE )
<a name="l01087"></a>01087     {
<a name="l01088"></a>01088       <a class="code" href="classQgsCoordinateReferenceSystem.html#a8ee0ef723cb6af96bcf2ead7f72d6277">mWkt</a> = wkt;
<a name="l01089"></a>01089       OGRFree( wkt );
<a name="l01090"></a>01090     }
<a name="l01091"></a>01091   }
<a name="l01092"></a>01092   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a8ee0ef723cb6af96bcf2ead7f72d6277">mWkt</a>;
<a name="l01093"></a>01093 }
<a name="l01094"></a>01094 
<a name="l01095"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ae9be6624a006ec1a1d92abc8471c354b">01095</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ae9be6624a006ec1a1d92abc8471c354b">QgsCoordinateReferenceSystem::readXML</a>( QDomNode &amp; theNode )
<a name="l01096"></a>01096 {
<a name="l01097"></a>01097   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Reading Spatial Ref Sys from xml ------------------------!&quot;</span> );
<a name="l01098"></a>01098   QDomNode srsNode  = theNode.namedItem( <span class="stringliteral">&quot;spatialrefsys&quot;</span> );
<a name="l01099"></a>01099 
<a name="l01100"></a>01100   <span class="keywordflow">if</span> ( ! srsNode.isNull() )
<a name="l01101"></a>01101   {
<a name="l01102"></a>01102     <span class="keywordtype">bool</span> initialized = <span class="keyword">false</span>;
<a name="l01103"></a>01103 
<a name="l01104"></a>01104     <span class="keywordtype">long</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#add285911972f1facfe30388ab0eba01a">srsid</a> = srsNode.namedItem( <span class="stringliteral">&quot;srsid&quot;</span> ).toElement().text().toLong();
<a name="l01105"></a>01105 
<a name="l01106"></a>01106     QDomNode myNode;
<a name="l01107"></a>01107 
<a name="l01108"></a>01108     <span class="keywordflow">if</span> ( srsid &lt; <a class="code" href="qgis_8h.html#ad8794344628fad7031cceb6b8ab2b8ec" title="Magick number that determines whether a projection crsid is a system (srs.db) or user (~/...">USER_CRS_START_ID</a> )
<a name="l01109"></a>01109     {
<a name="l01110"></a>01110       myNode = srsNode.namedItem( <span class="stringliteral">&quot;authid&quot;</span> );
<a name="l01111"></a>01111       <span class="keywordflow">if</span> ( !myNode.isNull() )
<a name="l01112"></a>01112       {
<a name="l01113"></a>01113         <a class="code" href="classQgsCoordinateReferenceSystem.html#a82e312eac028563b73c045c61bbac266" title="Assignment operator.">operator=</a>( <a class="code" href="classQgsCRSCache.html#a4e04f2ab4de841fb6147a573ba75b6d8">QgsCRSCache::instance</a>()-&gt;crsByAuthId( myNode.toElement().text() ) );
<a name="l01114"></a>01114         <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#aa88613351434eeefdbdfbbd77ff33025">isValid</a>() )
<a name="l01115"></a>01115         {
<a name="l01116"></a>01116           initialized = <span class="keyword">true</span>;
<a name="l01117"></a>01117         }
<a name="l01118"></a>01118       }
<a name="l01119"></a>01119 
<a name="l01120"></a>01120       <span class="keywordflow">if</span> ( !initialized )
<a name="l01121"></a>01121       {
<a name="l01122"></a>01122         myNode = srsNode.namedItem( <span class="stringliteral">&quot;epsg&quot;</span> );
<a name="l01123"></a>01123         <span class="keywordflow">if</span> ( !myNode.isNull() )
<a name="l01124"></a>01124         {
<a name="l01125"></a>01125           <a class="code" href="classQgsCoordinateReferenceSystem.html#a82e312eac028563b73c045c61bbac266" title="Assignment operator.">operator=</a>( <a class="code" href="classQgsCRSCache.html#a4e04f2ab4de841fb6147a573ba75b6d8">QgsCRSCache::instance</a>()-&gt;crsByEpsgId( myNode.toElement().text().toLong() ) );
<a name="l01126"></a>01126           <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#aa88613351434eeefdbdfbbd77ff33025">isValid</a>() )
<a name="l01127"></a>01127           {
<a name="l01128"></a>01128             initialized = <span class="keyword">true</span>;
<a name="l01129"></a>01129           }
<a name="l01130"></a>01130         }
<a name="l01131"></a>01131       }
<a name="l01132"></a>01132     }
<a name="l01133"></a>01133     <span class="keywordflow">else</span>
<a name="l01134"></a>01134     {
<a name="l01135"></a>01135       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Ignoring authid/epsg for user crs.&quot;</span> );
<a name="l01136"></a>01136     }
<a name="l01137"></a>01137 
<a name="l01138"></a>01138     <span class="keywordflow">if</span> ( initialized )
<a name="l01139"></a>01139     {
<a name="l01140"></a>01140       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Set from auth id&quot;</span> );
<a name="l01141"></a>01141     }
<a name="l01142"></a>01142     <span class="keywordflow">else</span>
<a name="l01143"></a>01143     {
<a name="l01144"></a>01144       myNode = srsNode.namedItem( <span class="stringliteral">&quot;proj4&quot;</span> );
<a name="l01145"></a>01145 
<a name="l01146"></a>01146       <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#acf5ccd2750d310c725937a82a700ecdb">createFromProj4</a>( myNode.toElement().text() ) )
<a name="l01147"></a>01147       {
<a name="l01148"></a>01148         <span class="comment">// createFromProj4() sets everything, including map units</span>
<a name="l01149"></a>01149         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Setting from proj4 string&quot;</span> );
<a name="l01150"></a>01150       }
<a name="l01151"></a>01151       <span class="keywordflow">else</span>
<a name="l01152"></a>01152       {
<a name="l01153"></a>01153         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Setting from elements one by one&quot;</span> );
<a name="l01154"></a>01154 
<a name="l01155"></a>01155         myNode = srsNode.namedItem( <span class="stringliteral">&quot;proj4&quot;</span> );
<a name="l01156"></a>01156         <a class="code" href="classQgsCoordinateReferenceSystem.html#ae0cd0008b170f81f0721fb475780e9ab">setProj4String</a>( myNode.toElement().text() );
<a name="l01157"></a>01157 
<a name="l01158"></a>01158         myNode = srsNode.namedItem( <span class="stringliteral">&quot;srsid&quot;</span> );
<a name="l01159"></a>01159         <a class="code" href="classQgsCoordinateReferenceSystem.html#a53fc815b9a4f09b68678c1e6565eb1c0">setInternalId</a>( myNode.toElement().text().toLong() );
<a name="l01160"></a>01160 
<a name="l01161"></a>01161         myNode = srsNode.namedItem( <span class="stringliteral">&quot;srid&quot;</span> );
<a name="l01162"></a>01162         <a class="code" href="classQgsCoordinateReferenceSystem.html#a48720d509f6f87ee5d20fe63fa8546ef">setSrid</a>( myNode.toElement().text().toLong() );
<a name="l01163"></a>01163 
<a name="l01164"></a>01164         myNode = srsNode.namedItem( <span class="stringliteral">&quot;authid&quot;</span> );
<a name="l01165"></a>01165         <a class="code" href="classQgsCoordinateReferenceSystem.html#ab88807a76674cd7890c167396cf69fa1">setAuthId</a>( myNode.toElement().text() );
<a name="l01166"></a>01166 
<a name="l01167"></a>01167         myNode = srsNode.namedItem( <span class="stringliteral">&quot;description&quot;</span> );
<a name="l01168"></a>01168         <a class="code" href="classQgsCoordinateReferenceSystem.html#adc75c14d21fea1e2e912be121816719c">setDescription</a>( myNode.toElement().text() );
<a name="l01169"></a>01169 
<a name="l01170"></a>01170         myNode = srsNode.namedItem( <span class="stringliteral">&quot;projectionacronym&quot;</span> );
<a name="l01171"></a>01171         <a class="code" href="classQgsCoordinateReferenceSystem.html#a915bde3df8c1c293b2e8fb093a38c5fb">setProjectionAcronym</a>( myNode.toElement().text() );
<a name="l01172"></a>01172 
<a name="l01173"></a>01173         myNode = srsNode.namedItem( <span class="stringliteral">&quot;ellipsoidacronym&quot;</span> );
<a name="l01174"></a>01174         <a class="code" href="classQgsCoordinateReferenceSystem.html#a730dc46ee45abe759ba0e8c5ed5bb998">setEllipsoidAcronym</a>( myNode.toElement().text() );
<a name="l01175"></a>01175 
<a name="l01176"></a>01176         myNode = srsNode.namedItem( <span class="stringliteral">&quot;geographicflag&quot;</span> );
<a name="l01177"></a>01177         <span class="keywordflow">if</span> ( myNode.toElement().text().compare( <span class="stringliteral">&quot;true&quot;</span> ) )
<a name="l01178"></a>01178         {
<a name="l01179"></a>01179           <a class="code" href="classQgsCoordinateReferenceSystem.html#a0164e462112889c561930102d28f4a61">setGeographicFlag</a>( <span class="keyword">true</span> );
<a name="l01180"></a>01180         }
<a name="l01181"></a>01181         <span class="keywordflow">else</span>
<a name="l01182"></a>01182         {
<a name="l01183"></a>01183           <a class="code" href="classQgsCoordinateReferenceSystem.html#a0164e462112889c561930102d28f4a61">setGeographicFlag</a>( <span class="keyword">false</span> );
<a name="l01184"></a>01184         }
<a name="l01185"></a>01185 
<a name="l01186"></a>01186         <span class="comment">//make sure the map units have been set</span>
<a name="l01187"></a>01187         <a class="code" href="classQgsCoordinateReferenceSystem.html#ac552bc85c6d409b529b6889bfd2456ac" title="Work out the projection units and set the appropriate local variable.">setMapUnits</a>();
<a name="l01188"></a>01188 
<a name="l01189"></a>01189         <span class="comment">//@TODO this srs needs to be validated!!!</span>
<a name="l01190"></a>01190         <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> = <span class="keyword">true</span>; <span class="comment">//shamelessly hard coded for now</span>
<a name="l01191"></a>01191       }
<a name="l01192"></a>01192     }
<a name="l01193"></a>01193   }
<a name="l01194"></a>01194   <span class="keywordflow">else</span>
<a name="l01195"></a>01195   {
<a name="l01196"></a>01196     <span class="comment">// Return default CRS if none was found in the XML.</span>
<a name="l01197"></a>01197     <a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9fd9c20f2b6c8e7cbd1114205d0ec5">createFromId</a>( <a class="code" href="qgis_8h.html#af5cd54d47652544adf35af98511e41f4" title="Magic number for a geographic coord sys in QGIS srs.db tbl_srs.srs_id.">GEOCRS_ID</a>, <a class="code" href="classQgsCoordinateReferenceSystem.html#a50be71ef85725c7a3959f780ac7c36cfabc92b4ee3c6be188b5dfe000ddac415e">InternalCrsId</a> );
<a name="l01198"></a>01198   }
<a name="l01199"></a>01199   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01200"></a>01200 }
<a name="l01201"></a>01201 
<a name="l01202"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ad7fca10482d45467afb74b244af6b31c">01202</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ad7fca10482d45467afb74b244af6b31c">QgsCoordinateReferenceSystem::writeXML</a>( QDomNode &amp; theNode, QDomDocument &amp; theDoc )<span class="keyword"> const</span>
<a name="l01203"></a>01203 <span class="keyword"></span>{
<a name="l01204"></a>01204 
<a name="l01205"></a>01205   QDomElement myLayerNode = theNode.toElement();
<a name="l01206"></a>01206   QDomElement mySrsElement  = theDoc.createElement( <span class="stringliteral">&quot;spatialrefsys&quot;</span> );
<a name="l01207"></a>01207 
<a name="l01208"></a>01208   QDomElement myProj4Element  = theDoc.createElement( <span class="stringliteral">&quot;proj4&quot;</span> );
<a name="l01209"></a>01209   myProj4Element.appendChild( theDoc.createTextNode( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() ) );
<a name="l01210"></a>01210   mySrsElement.appendChild( myProj4Element );
<a name="l01211"></a>01211 
<a name="l01212"></a>01212   QDomElement mySrsIdElement  = theDoc.createElement( <span class="stringliteral">&quot;srsid&quot;</span> );
<a name="l01213"></a>01213   mySrsIdElement.appendChild( theDoc.createTextNode( QString::number( <a class="code" href="classQgsCoordinateReferenceSystem.html#add285911972f1facfe30388ab0eba01a">srsid</a>() ) ) );
<a name="l01214"></a>01214   mySrsElement.appendChild( mySrsIdElement );
<a name="l01215"></a>01215 
<a name="l01216"></a>01216   QDomElement mySridElement  = theDoc.createElement( <span class="stringliteral">&quot;srid&quot;</span> );
<a name="l01217"></a>01217   mySridElement.appendChild( theDoc.createTextNode( QString::number( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3cb64f24049d50fbacffd1eece5125ee">postgisSrid</a>() ) ) );
<a name="l01218"></a>01218   mySrsElement.appendChild( mySridElement );
<a name="l01219"></a>01219 
<a name="l01220"></a>01220   QDomElement myEpsgElement  = theDoc.createElement( <span class="stringliteral">&quot;authid&quot;</span> );
<a name="l01221"></a>01221   myEpsgElement.appendChild( theDoc.createTextNode( <a class="code" href="classQgsCoordinateReferenceSystem.html#a4382981b1233c7f0ca1c7ce7bdb670d3">authid</a>() ) );
<a name="l01222"></a>01222   mySrsElement.appendChild( myEpsgElement );
<a name="l01223"></a>01223 
<a name="l01224"></a>01224   QDomElement myDescriptionElement  = theDoc.createElement( <span class="stringliteral">&quot;description&quot;</span> );
<a name="l01225"></a>01225   myDescriptionElement.appendChild( theDoc.createTextNode( <a class="code" href="classQgsCoordinateReferenceSystem.html#afbb64ee54a05d2f414cd6bc91850d768">description</a>() ) );
<a name="l01226"></a>01226   mySrsElement.appendChild( myDescriptionElement );
<a name="l01227"></a>01227 
<a name="l01228"></a>01228   QDomElement myProjectionAcronymElement  = theDoc.createElement( <span class="stringliteral">&quot;projectionacronym&quot;</span> );
<a name="l01229"></a>01229   myProjectionAcronymElement.appendChild( theDoc.createTextNode( <a class="code" href="classQgsCoordinateReferenceSystem.html#a5856631fdebbfe839fa0955d5c36630a">projectionAcronym</a>() ) );
<a name="l01230"></a>01230   mySrsElement.appendChild( myProjectionAcronymElement );
<a name="l01231"></a>01231 
<a name="l01232"></a>01232   QDomElement myEllipsoidAcronymElement  = theDoc.createElement( <span class="stringliteral">&quot;ellipsoidacronym&quot;</span> );
<a name="l01233"></a>01233   myEllipsoidAcronymElement.appendChild( theDoc.createTextNode( <a class="code" href="classQgsCoordinateReferenceSystem.html#a23f9df6ec7aa26eff0f3e535d0a82470">ellipsoidAcronym</a>() ) );
<a name="l01234"></a>01234   mySrsElement.appendChild( myEllipsoidAcronymElement );
<a name="l01235"></a>01235 
<a name="l01236"></a>01236   QDomElement myGeographicFlagElement  = theDoc.createElement( <span class="stringliteral">&quot;geographicflag&quot;</span> );
<a name="l01237"></a>01237   QString myGeoFlagText = <span class="stringliteral">&quot;false&quot;</span>;
<a name="l01238"></a>01238   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a06cbad30d422173714895af571928cb2">geographicFlag</a>() )
<a name="l01239"></a>01239   {
<a name="l01240"></a>01240     myGeoFlagText = <span class="stringliteral">&quot;true&quot;</span>;
<a name="l01241"></a>01241   }
<a name="l01242"></a>01242 
<a name="l01243"></a>01243   myGeographicFlagElement.appendChild( theDoc.createTextNode( myGeoFlagText ) );
<a name="l01244"></a>01244   mySrsElement.appendChild( myGeographicFlagElement );
<a name="l01245"></a>01245 
<a name="l01246"></a>01246   myLayerNode.appendChild( mySrsElement );
<a name="l01247"></a>01247 
<a name="l01248"></a>01248   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01249"></a>01249 }
<a name="l01250"></a>01250 
<a name="l01251"></a>01251 
<a name="l01252"></a>01252 
<a name="l01253"></a>01253 <span class="comment">//</span>
<a name="l01254"></a>01254 <span class="comment">// Static helper methods below this point only please!</span>
<a name="l01255"></a>01255 <span class="comment">//</span>
<a name="l01256"></a>01256 
<a name="l01257"></a>01257 
<a name="l01258"></a>01258 <span class="comment">// Returns the whole proj4 string for the selected srsid</span>
<a name="l01259"></a>01259 <span class="comment">//this is a static method! NOTE I&#39;ve made it private for now to reduce API clutter TS</span>
<a name="l01260"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a4b9a3e12aa2a2a70f2500869d8ae1277">01260</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a4b9a3e12aa2a2a70f2500869d8ae1277" title="A static helper function to find out the proj4 string for a srsid.">QgsCoordinateReferenceSystem::proj4FromSrsId</a>( <span class="keyword">const</span> <span class="keywordtype">int</span> theSrsId )
<a name="l01261"></a>01261 {
<a name="l01262"></a>01262 
<a name="l01263"></a>01263   QString myDatabaseFileName;
<a name="l01264"></a>01264   QString myProjString;
<a name="l01265"></a>01265   QString mySql = QString( <span class="stringliteral">&quot;select parameters from tbl_srs where srs_id = %1 order by deprecated&quot;</span> ).arg( theSrsId );
<a name="l01266"></a>01266 
<a name="l01267"></a>01267   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;mySrsId = &quot;</span> + QString::number( theSrsId ) );
<a name="l01268"></a>01268   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;USER_CRS_START_ID = &quot;</span> + QString::number( <a class="code" href="qgis_8h.html#ad8794344628fad7031cceb6b8ab2b8ec" title="Magick number that determines whether a projection crsid is a system (srs.db) or user (~/...">USER_CRS_START_ID</a> ) );
<a name="l01269"></a>01269   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Selection sql : &quot;</span> + mySql );
<a name="l01270"></a>01270 
<a name="l01271"></a>01271   <span class="comment">//</span>
<a name="l01272"></a>01272   <span class="comment">// Determine if this is a user projection or a system on</span>
<a name="l01273"></a>01273   <span class="comment">// user projection defs all have srs_id &gt;= 100000</span>
<a name="l01274"></a>01274   <span class="comment">//</span>
<a name="l01275"></a>01275   <span class="keywordflow">if</span> ( theSrsId &gt;= <a class="code" href="qgis_8h.html#ad8794344628fad7031cceb6b8ab2b8ec" title="Magick number that determines whether a projection crsid is a system (srs.db) or user (~/...">USER_CRS_START_ID</a> )
<a name="l01276"></a>01276   {
<a name="l01277"></a>01277     myDatabaseFileName = <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>();
<a name="l01278"></a>01278     QFileInfo myFileInfo;
<a name="l01279"></a>01279     myFileInfo.setFile( myDatabaseFileName );
<a name="l01280"></a>01280     <span class="keywordflow">if</span> ( !myFileInfo.exists( ) ) <span class="comment">//its unlikely that this condition will ever be reached</span>
<a name="l01281"></a>01281     {
<a name="l01282"></a>01282       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;users qgis.db not found&quot;</span> );
<a name="l01283"></a>01283       <span class="keywordflow">return</span> NULL;
<a name="l01284"></a>01284     }
<a name="l01285"></a>01285   }
<a name="l01286"></a>01286   <span class="keywordflow">else</span> <span class="comment">//must be  a system projection then</span>
<a name="l01287"></a>01287   {
<a name="l01288"></a>01288     myDatabaseFileName = <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>();
<a name="l01289"></a>01289   }
<a name="l01290"></a>01290   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;db = &quot;</span> + myDatabaseFileName );
<a name="l01291"></a>01291 
<a name="l01292"></a>01292   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a> *db;
<a name="l01293"></a>01293   <span class="keywordtype">int</span> rc;
<a name="l01294"></a>01294   rc = <a class="code" href="classQgsCoordinateReferenceSystem.html#aed9df708f2dbbd8609e6717fbd8ab8bd">openDb</a>( myDatabaseFileName, &amp;db );
<a name="l01295"></a>01295   <span class="keywordflow">if</span> ( rc )
<a name="l01296"></a>01296   {
<a name="l01297"></a>01297     <span class="keywordflow">return</span> QString();
<a name="l01298"></a>01298   }
<a name="l01299"></a>01299   <span class="comment">// prepare the sql statement</span>
<a name="l01300"></a>01300   <span class="keyword">const</span> <span class="keywordtype">char</span> *pzTail;
<a name="l01301"></a>01301   sqlite3_stmt *ppStmt;
<a name="l01302"></a>01302 
<a name="l01303"></a>01303   rc = sqlite3_prepare( db, mySql.toUtf8(), mySql.toUtf8().length(), &amp;ppStmt, &amp;pzTail );
<a name="l01304"></a>01304   <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l01305"></a>01305 
<a name="l01306"></a>01306   <span class="keywordflow">if</span> ( rc == SQLITE_OK )
<a name="l01307"></a>01307   {
<a name="l01308"></a>01308     <span class="keywordflow">if</span> ( sqlite3_step( ppStmt ) == SQLITE_ROW )
<a name="l01309"></a>01309     {
<a name="l01310"></a>01310       myProjString = QString::fromUtf8(( <span class="keywordtype">char</span>* )sqlite3_column_text( ppStmt, 0 ) );
<a name="l01311"></a>01311     }
<a name="l01312"></a>01312   }
<a name="l01313"></a>01313   <span class="comment">// close the statement</span>
<a name="l01314"></a>01314   sqlite3_finalize( ppStmt );
<a name="l01315"></a>01315   <span class="comment">// close the database</span>
<a name="l01316"></a>01316   sqlite3_close( db );
<a name="l01317"></a>01317 
<a name="l01318"></a>01318   <span class="comment">//Q_ASSERT(myProjString.length() &gt; 0);</span>
<a name="l01319"></a>01319   <span class="keywordflow">return</span> myProjString;
<a name="l01320"></a>01320 }
<a name="l01321"></a>01321 
<a name="l01322"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#aed9df708f2dbbd8609e6717fbd8ab8bd">01322</a> <span class="keywordtype">int</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#aed9df708f2dbbd8609e6717fbd8ab8bd">QgsCoordinateReferenceSystem::openDb</a>( QString path, <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a> **db, <span class="keywordtype">bool</span> readonly )
<a name="l01323"></a>01323 {
<a name="l01324"></a>01324   <a class="code" href="qgslogger_8h.html#a795a1fcfb1c61b988bbd999396411d13">QgsDebugMsgLevel</a>( <span class="stringliteral">&quot;path = &quot;</span> + path, 3 );
<a name="l01325"></a>01325   <span class="keywordtype">int</span> myResult = readonly
<a name="l01326"></a>01326                  ? sqlite3_open_v2( path.toUtf8().data(), db, SQLITE_OPEN_READONLY, NULL )
<a name="l01327"></a>01327                  : sqlite3_open( path.toUtf8().data(), db );
<a name="l01328"></a>01328 
<a name="l01329"></a>01329   <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l01330"></a>01330   {
<a name="l01331"></a>01331     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Can&#39;t open database: &quot;</span> + QString( sqlite3_errmsg( *db ) ) );
<a name="l01332"></a>01332     <span class="comment">// XXX This will likely never happen since on open, sqlite creates the</span>
<a name="l01333"></a>01333     <span class="comment">//     database if it does not exist.</span>
<a name="l01334"></a>01334     <span class="comment">// ... unfortunately it happens on Windows</span>
<a name="l01335"></a>01335     <a class="code" href="classQgsMessageLog.html#a916f70109098361865cbfa9d7a2374d3" title="add a message to the instance (and create it if necessary)">QgsMessageLog::logMessage</a>( QObject::tr( <span class="stringliteral">&quot;Could not open CRS database %1\nError(%2): %3&quot;</span> )
<a name="l01336"></a>01336                                .arg( path )
<a name="l01337"></a>01337                                .arg( myResult )
<a name="l01338"></a>01338                                .arg( sqlite3_errmsg( *db ) ), QObject::tr( <span class="stringliteral">&quot;CRS&quot;</span> ) );
<a name="l01339"></a>01339   }
<a name="l01340"></a>01340   <span class="keywordflow">return</span> myResult;
<a name="l01341"></a>01341 }
<a name="l01342"></a>01342 
<a name="l01343"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#ab5914bec604ade25240d94e02d9774f1">01343</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#ab5914bec604ade25240d94e02d9774f1" title="Sets custom function to force valid CRS QGIS uses implementation in QgisGui::customSrsValidation.">QgsCoordinateReferenceSystem::setCustomSrsValidation</a>( <a class="code" href="qgscoordinatereferencesystem_8h.html#ad0aecc3490d74e11de09480b91ea1f84">CUSTOM_CRS_VALIDATION</a> f )
<a name="l01344"></a>01344 {
<a name="l01345"></a>01345   <a class="code" href="classQgsCoordinateReferenceSystem.html#a00027ee17ae6306f819322fe8ee6dc8d">mCustomSrsValidation</a> = f;
<a name="l01346"></a>01346 }
<a name="l01347"></a>01347 
<a name="l01348"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a1a69206bc92217ad1b18879cc9f8cf2d">01348</a> <a class="code" href="qgscoordinatereferencesystem_8h.html#ad0aecc3490d74e11de09480b91ea1f84">CUSTOM_CRS_VALIDATION</a> <a class="code" href="classQgsCoordinateReferenceSystem.html#a1a69206bc92217ad1b18879cc9f8cf2d" title="Gets custom function.">QgsCoordinateReferenceSystem::customSrsValidation</a>()
<a name="l01349"></a>01349 {
<a name="l01350"></a>01350   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a00027ee17ae6306f819322fe8ee6dc8d">mCustomSrsValidation</a>;
<a name="l01351"></a>01351 }
<a name="l01352"></a>01352 
<a name="l01353"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a43352910866a504c28c15be3bc73310f">01353</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a43352910866a504c28c15be3bc73310f">QgsCoordinateReferenceSystem::debugPrint</a>()
<a name="l01354"></a>01354 {
<a name="l01355"></a>01355   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;***SpatialRefSystem***&quot;</span> );
<a name="l01356"></a>01356   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* Valid : &quot;</span> + ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> ? QString( <span class="stringliteral">&quot;true&quot;</span> ) : QString( <span class="stringliteral">&quot;false&quot;</span> ) ) );
<a name="l01357"></a>01357   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* SrsId : &quot;</span> + QString::number( <a class="code" href="classQgsCoordinateReferenceSystem.html#ac16e634d9b4e39f08dd72f22d9451e04" title="The internal sqlite3 srs.db primary key for this srs.">mSrsId</a> ) );
<a name="l01358"></a>01358   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* Proj4 : &quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() );
<a name="l01359"></a>01359   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* WKT   : &quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a55e62f3f587e9de20ed911d26d12f499">toWkt</a>() );
<a name="l01360"></a>01360   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* Desc. : &quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a587603e45b3e111d38c377b4bf90d052" title="A textual description of the srs.">mDescription</a> );
<a name="l01361"></a>01361   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a8dd2d190edae32d6e6ca63cfd8154154">mapUnits</a>() == <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca5132b3d9c171301d76d7a14d8b3a86dc">QGis::Meters</a> )
<a name="l01362"></a>01362   {
<a name="l01363"></a>01363     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* Units : meters&quot;</span> );
<a name="l01364"></a>01364   }
<a name="l01365"></a>01365   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a8dd2d190edae32d6e6ca63cfd8154154">mapUnits</a>() == <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca0b4a519c1888a3f2beb8c1d23a4b2393">QGis::Feet</a> )
<a name="l01366"></a>01366   {
<a name="l01367"></a>01367     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* Units : feet&quot;</span> );
<a name="l01368"></a>01368   }
<a name="l01369"></a>01369   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#a8dd2d190edae32d6e6ca63cfd8154154">mapUnits</a>() == <a class="code" href="classQGis.html#a47ff90a581c29ad1cee29c7d56cc379ca94852e9654597b263f080312bc76c110">QGis::Degrees</a> )
<a name="l01370"></a>01370   {
<a name="l01371"></a>01371     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;* Units : degrees&quot;</span> );
<a name="l01372"></a>01372   }
<a name="l01373"></a>01373 }
<a name="l01374"></a>01374 
<a name="l01375"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a7b9a6131fbfa797bdc85f1096a290cb0">01375</a> <span class="keywordtype">void</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a7b9a6131fbfa797bdc85f1096a290cb0">QgsCoordinateReferenceSystem::setValidationHint</a>( QString html )
<a name="l01376"></a>01376 {
<a name="l01377"></a>01377   <a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9ace892db2001726ea782c7c7993d8">mValidationHint</a> = html;
<a name="l01378"></a>01378 }
<a name="l01379"></a>01379 
<a name="l01380"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a797b2bfe6a0f95ba0f75abacba5eca0c">01380</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a797b2bfe6a0f95ba0f75abacba5eca0c">QgsCoordinateReferenceSystem::validationHint</a>()
<a name="l01381"></a>01381 {
<a name="l01382"></a>01382   <span class="keywordflow">return</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a8d9ace892db2001726ea782c7c7993d8">mValidationHint</a>;
<a name="l01383"></a>01383 }
<a name="l01384"></a>01384 
<a name="l01387"></a>01387 
<a name="l01388"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a0a6af4d5bea2381495b2d4849056c3e4">01388</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a0a6af4d5bea2381495b2d4849056c3e4" title="Save the proj4-string as a custom CRS.">QgsCoordinateReferenceSystem::saveAsUserCRS</a>()
<a name="l01389"></a>01389 {
<a name="l01390"></a>01390   <span class="keywordflow">if</span> ( ! <a class="code" href="classQgsCoordinateReferenceSystem.html#a993398ef106cddb10ffd386e3a5cd719" title="Wehter this srs is properly defined and valid.">mIsValidFlag</a> )
<a name="l01391"></a>01391   {
<a name="l01392"></a>01392     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;Can&#39;t save an invalid CRS!&quot;</span> );
<a name="l01393"></a>01393     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01394"></a>01394   }
<a name="l01395"></a>01395 
<a name="l01396"></a>01396   QString mySql;
<a name="l01397"></a>01397   QString myName = QString( <span class="stringliteral">&quot; * %1 (%2)&quot;</span> )
<a name="l01398"></a>01398                    .arg( QObject::tr( <span class="stringliteral">&quot;Generated CRS&quot;</span>, <span class="stringliteral">&quot;A CRS automatically generated from layer info get this prefix for description&quot;</span> ) )
<a name="l01399"></a>01399                    .arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() );
<a name="l01400"></a>01400 
<a name="l01401"></a>01401   <span class="comment">//if this is the first record we need to ensure that its srs_id is 10000. For</span>
<a name="l01402"></a>01402   <span class="comment">//any rec after that sqlite3 will take care of the autonumering</span>
<a name="l01403"></a>01403   <span class="comment">//this was done to support sqlite 3.0 as it does not yet support</span>
<a name="l01404"></a>01404   <span class="comment">//the autoinc related system tables.</span>
<a name="l01405"></a>01405   <span class="keywordflow">if</span> ( <a class="code" href="classQgsCoordinateReferenceSystem.html#abe5c19bd120267c722fd354efe997bea" title="Helper for getting number of user CRS already in db.">getRecordCount</a>() == 0 )
<a name="l01406"></a>01406   {
<a name="l01407"></a>01407     mySql = <span class="stringliteral">&quot;insert into tbl_srs (srs_id,description,projection_acronym,ellipsoid_acronym,parameters,is_geo) values (&quot;</span>
<a name="l01408"></a>01408             + QString::number( <a class="code" href="qgis_8h.html#ad8794344628fad7031cceb6b8ab2b8ec" title="Magick number that determines whether a projection crsid is a system (srs.db) or user (~/...">USER_CRS_START_ID</a> )
<a name="l01409"></a>01409             + <span class="stringliteral">&quot;,&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( myName )
<a name="l01410"></a>01410             + <span class="stringliteral">&quot;,&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a5856631fdebbfe839fa0955d5c36630a">projectionAcronym</a>() )
<a name="l01411"></a>01411             + <span class="stringliteral">&quot;,&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a23f9df6ec7aa26eff0f3e535d0a82470">ellipsoidAcronym</a>() )
<a name="l01412"></a>01412             + <span class="stringliteral">&quot;,&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() )
<a name="l01413"></a>01413             + <span class="stringliteral">&quot;,0)&quot;</span>; <span class="comment">// &lt;-- is_geo shamelessly hard coded for now</span>
<a name="l01414"></a>01414   }
<a name="l01415"></a>01415   <span class="keywordflow">else</span>
<a name="l01416"></a>01416   {
<a name="l01417"></a>01417     mySql = <span class="stringliteral">&quot;insert into tbl_srs (description,projection_acronym,ellipsoid_acronym,parameters,is_geo) values (&quot;</span>
<a name="l01418"></a>01418             + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( myName )
<a name="l01419"></a>01419             + <span class="stringliteral">&quot;,&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a5856631fdebbfe839fa0955d5c36630a">projectionAcronym</a>() )
<a name="l01420"></a>01420             + <span class="stringliteral">&quot;,&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a23f9df6ec7aa26eff0f3e535d0a82470">ellipsoidAcronym</a>() )
<a name="l01421"></a>01421             + <span class="stringliteral">&quot;,&quot;</span> + <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() )
<a name="l01422"></a>01422             + <span class="stringliteral">&quot;,0)&quot;</span>; <span class="comment">// &lt;-- is_geo shamelessly hard coded for now</span>
<a name="l01423"></a>01423   }
<a name="l01424"></a>01424   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a>      *myDatabase;
<a name="l01425"></a>01425   <span class="keyword">const</span> <span class="keywordtype">char</span>   *myTail;
<a name="l01426"></a>01426   sqlite3_stmt *myPreparedStatement;
<a name="l01427"></a>01427   <span class="keywordtype">int</span>           myResult;
<a name="l01428"></a>01428   <span class="comment">//check the db is available</span>
<a name="l01429"></a>01429   myResult = sqlite3_open( <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>().toUtf8().data(), &amp;myDatabase );
<a name="l01430"></a>01430   <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l01431"></a>01431   {
<a name="l01432"></a>01432     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;Can&#39;t open or create database %1: %2&quot;</span> )
<a name="l01433"></a>01433                  .arg( <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>() )
<a name="l01434"></a>01434                  .arg( sqlite3_errmsg( myDatabase ) ) );
<a name="l01435"></a>01435     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01436"></a>01436   }
<a name="l01437"></a>01437   <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;Update or insert sql \n%1&quot;</span> ).arg( mySql ) );
<a name="l01438"></a>01438   myResult = sqlite3_prepare( myDatabase, mySql.toUtf8(), mySql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l01439"></a>01439   sqlite3_step( myPreparedStatement );
<a name="l01440"></a>01440 
<a name="l01441"></a>01441   <a class="code" href="classQgsMessageLog.html#a916f70109098361865cbfa9d7a2374d3" title="add a message to the instance (and create it if necessary)">QgsMessageLog::logMessage</a>( QObject::tr( <span class="stringliteral">&quot;Saved user CRS [%1]&quot;</span> ).arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#a3dcb9691205369b26c3183857a0fe93f" title="Get the Proj Proj4 string representation of this srs.">toProj4</a>() ), QObject::tr( <span class="stringliteral">&quot;CRS&quot;</span> ) );
<a name="l01442"></a>01442 
<a name="l01443"></a>01443   <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l01444"></a>01444   <span class="keywordflow">return</span> myResult == SQLITE_OK;
<a name="l01445"></a>01445 }
<a name="l01446"></a>01446 
<a name="l01447"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#abe5c19bd120267c722fd354efe997bea">01447</a> <span class="keywordtype">long</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#abe5c19bd120267c722fd354efe997bea" title="Helper for getting number of user CRS already in db.">QgsCoordinateReferenceSystem::getRecordCount</a>()
<a name="l01448"></a>01448 {
<a name="l01449"></a>01449   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a>      *myDatabase;
<a name="l01450"></a>01450   <span class="keyword">const</span> <span class="keywordtype">char</span>   *myTail;
<a name="l01451"></a>01451   sqlite3_stmt *myPreparedStatement;
<a name="l01452"></a>01452   <span class="keywordtype">int</span>           myResult;
<a name="l01453"></a>01453   <span class="keywordtype">long</span>          myRecordCount = 0;
<a name="l01454"></a>01454   <span class="comment">//check the db is available</span>
<a name="l01455"></a>01455   myResult = sqlite3_open_v2( <a class="code" href="classQgsApplication.html#a326f95d3b446f8c3944ede386e920310" title="Returns the path to the user qgis.db file.">QgsApplication::qgisUserDbFilePath</a>().toUtf8().data(), &amp;myDatabase, SQLITE_OPEN_READONLY, NULL );
<a name="l01456"></a>01456   <span class="keywordflow">if</span> ( myResult != SQLITE_OK )
<a name="l01457"></a>01457   {
<a name="l01458"></a>01458     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;Can&#39;t open database: %1&quot;</span> ).arg( sqlite3_errmsg( myDatabase ) ) );
<a name="l01459"></a>01459     <span class="keywordflow">return</span> 0;
<a name="l01460"></a>01460   }
<a name="l01461"></a>01461   <span class="comment">// Set up the query to retrieve the projection information needed to populate the ELLIPSOID list</span>
<a name="l01462"></a>01462   QString mySql = <span class="stringliteral">&quot;select count(*) from tbl_srs&quot;</span>;
<a name="l01463"></a>01463   myResult = sqlite3_prepare( myDatabase, mySql.toUtf8(), mySql.toUtf8().length(), &amp;myPreparedStatement, &amp;myTail );
<a name="l01464"></a>01464   <span class="comment">// XXX Need to free memory from the error msg if one is set</span>
<a name="l01465"></a>01465   <span class="keywordflow">if</span> ( myResult == SQLITE_OK )
<a name="l01466"></a>01466   {
<a name="l01467"></a>01467     <span class="keywordflow">if</span> ( sqlite3_step( myPreparedStatement ) == SQLITE_ROW )
<a name="l01468"></a>01468     {
<a name="l01469"></a>01469       QString myRecordCountString = QString::fromUtf8(( <span class="keywordtype">char</span> * )sqlite3_column_text( myPreparedStatement, 0 ) );
<a name="l01470"></a>01470       myRecordCount = myRecordCountString.toLong();
<a name="l01471"></a>01471     }
<a name="l01472"></a>01472   }
<a name="l01473"></a>01473   <span class="comment">// close the sqlite3 statement</span>
<a name="l01474"></a>01474   sqlite3_finalize( myPreparedStatement );
<a name="l01475"></a>01475   sqlite3_close( myDatabase );
<a name="l01476"></a>01476   <span class="keywordflow">return</span> myRecordCount;
<a name="l01477"></a>01477 }
<a name="l01478"></a>01478 
<a name="l01479"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784">01479</a> QString <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">QgsCoordinateReferenceSystem::quotedValue</a>( QString value )
<a name="l01480"></a>01480 {
<a name="l01481"></a>01481   value.replace( <span class="stringliteral">&quot;&#39;&quot;</span>, <span class="stringliteral">&quot;&#39;&#39;&quot;</span> );
<a name="l01482"></a>01482   <span class="keywordflow">return</span> value.prepend( <span class="stringliteral">&quot;&#39;&quot;</span> ).append( <span class="stringliteral">&quot;&#39;&quot;</span> );
<a name="l01483"></a>01483 }
<a name="l01484"></a>01484 
<a name="l01485"></a><a class="code" href="classQgsCoordinateReferenceSystem.html#a32583a7ea5bbc184f9cfa86a6692ce51">01485</a> <span class="keywordtype">int</span> <a class="code" href="classQgsCoordinateReferenceSystem.html#a32583a7ea5bbc184f9cfa86a6692ce51">QgsCoordinateReferenceSystem::syncDb</a>()
<a name="l01486"></a>01486 {
<a name="l01487"></a>01487   <span class="keywordtype">int</span> updated = 0, errors = 0;
<a name="l01488"></a>01488 
<a name="l01489"></a>01489   <a class="code" href="qgscoordinatereferencesystem_8h.html#a0ef6f2646262c8a9b24368d8ac140f69">sqlite3</a> *database;
<a name="l01490"></a>01490   <span class="keywordflow">if</span> ( sqlite3_open( <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>().toUtf8().constData(), &amp;database ) != SQLITE_OK )
<a name="l01491"></a>01491   {
<a name="l01492"></a>01492     qCritical( <span class="stringliteral">&quot;Could not open database: %s [%s]\n&quot;</span>, <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>().toLocal8Bit().constData(), sqlite3_errmsg( database ) );
<a name="l01493"></a>01493     <span class="keywordflow">return</span> -1;
<a name="l01494"></a>01494   }
<a name="l01495"></a>01495 
<a name="l01496"></a>01496   <span class="keywordflow">if</span> ( sqlite3_exec( database, <span class="stringliteral">&quot;BEGIN TRANSACTION&quot;</span>, 0, 0, 0 ) != SQLITE_OK )
<a name="l01497"></a>01497   {
<a name="l01498"></a>01498     qCritical( <span class="stringliteral">&quot;Could not begin transaction: %s [%s]\n&quot;</span>, <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>().toLocal8Bit().constData(), sqlite3_errmsg( database ) );
<a name="l01499"></a>01499     <span class="keywordflow">return</span> -1;
<a name="l01500"></a>01500   }
<a name="l01501"></a>01501 
<a name="l01502"></a>01502   <span class="keyword">const</span> <span class="keywordtype">char</span> *tail;
<a name="l01503"></a>01503   sqlite3_stmt *select;
<a name="l01504"></a>01504   QString sql = <span class="stringliteral">&quot;select auth_name,auth_id,parameters from tbl_srs WHERE auth_name IS NOT NULL AND auth_id IS NOT NULL order by deprecated&quot;</span>;
<a name="l01505"></a>01505   <span class="keywordflow">if</span> ( sqlite3_prepare( database, sql.toAscii(), sql.size(), &amp;select, &amp;tail ) != SQLITE_OK )
<a name="l01506"></a>01506   {
<a name="l01507"></a>01507     qCritical( <span class="stringliteral">&quot;Could not prepare: %s [%s]\n&quot;</span>, sql.toAscii().constData(), sqlite3_errmsg( database ) );
<a name="l01508"></a>01508     sqlite3_close( database );
<a name="l01509"></a>01509     <span class="keywordflow">return</span> -1;
<a name="l01510"></a>01510   }
<a name="l01511"></a>01511 
<a name="l01512"></a>01512   OGRSpatialReferenceH crs = OSRNewSpatialReference( NULL );
<a name="l01513"></a>01513 
<a name="l01514"></a>01514   <span class="keywordflow">while</span> ( sqlite3_step( select ) == SQLITE_ROW )
<a name="l01515"></a>01515   {
<a name="l01516"></a>01516     <span class="keyword">const</span> <span class="keywordtype">char</span> *auth_name = ( <span class="keyword">const</span> <span class="keywordtype">char</span> * ) sqlite3_column_text( select, 0 );
<a name="l01517"></a>01517     <span class="keyword">const</span> <span class="keywordtype">char</span> *auth_id   = ( <span class="keyword">const</span> <span class="keywordtype">char</span> * ) sqlite3_column_text( select, 1 );
<a name="l01518"></a>01518     <span class="keyword">const</span> <span class="keywordtype">char</span> *params    = ( <span class="keyword">const</span> <span class="keywordtype">char</span> * ) sqlite3_column_text( select, 2 );
<a name="l01519"></a>01519 
<a name="l01520"></a>01520     QString proj4;
<a name="l01521"></a>01521 
<a name="l01522"></a>01522     <span class="keywordflow">if</span> ( QString( auth_name ).compare( <span class="stringliteral">&quot;epsg&quot;</span>, Qt::CaseInsensitive ) == 0 )
<a name="l01523"></a>01523     {
<a name="l01524"></a>01524       OGRErr ogrErr = OSRSetFromUserInput( crs, QString( <span class="stringliteral">&quot;epsg:%1&quot;</span> ).arg( auth_id ).toAscii() );
<a name="l01525"></a>01525 
<a name="l01526"></a>01526       <span class="keywordflow">if</span> ( ogrErr == OGRERR_NONE )
<a name="l01527"></a>01527       {
<a name="l01528"></a>01528         <span class="keywordtype">char</span> *output = 0;
<a name="l01529"></a>01529 
<a name="l01530"></a>01530         <span class="keywordflow">if</span> ( OSRExportToProj4( crs, &amp;output ) == OGRERR_NONE )
<a name="l01531"></a>01531         {
<a name="l01532"></a>01532           proj4 = output;
<a name="l01533"></a>01533           proj4 = proj4.trimmed();
<a name="l01534"></a>01534         }
<a name="l01535"></a>01535         <span class="keywordflow">else</span>
<a name="l01536"></a>01536         {
<a name="l01537"></a>01537           <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;could not retrieve proj.4 string for epsg:%1 from OGR&quot;</span> ).arg( auth_id ) );
<a name="l01538"></a>01538         }
<a name="l01539"></a>01539 
<a name="l01540"></a>01540         <span class="keywordflow">if</span> ( output )
<a name="l01541"></a>01541           CPLFree( output );
<a name="l01542"></a>01542       }
<a name="l01543"></a>01543     }
<a name="l01544"></a>01544 <span class="preprocessor">#if !defined(PJ_VERSION) || PJ_VERSION!=470</span>
<a name="l01545"></a>01545 <span class="preprocessor"></span>    <span class="comment">// 4.7.0 has a bug that crashes after 16 consecutive pj_init_plus with different strings</span>
<a name="l01546"></a>01546     <span class="keywordflow">else</span>
<a name="l01547"></a>01547     {
<a name="l01548"></a>01548       QString input = QString( <span class="stringliteral">&quot;+init=%1:%2&quot;</span> ).arg( QString( auth_name ).toLower() ).arg( auth_id );
<a name="l01549"></a>01549       <a class="code" href="qgscoordinatetransform_8h.html#aea4dd1c4fc6b1070245e4b919e290499">projPJ</a> pj = pj_init_plus( input.toAscii() );
<a name="l01550"></a>01550       <span class="keywordflow">if</span> ( !pj )
<a name="l01551"></a>01551       {
<a name="l01552"></a>01552         input = QString( <span class="stringliteral">&quot;+init=%1:%2&quot;</span> ).arg( QString( auth_name ).toUpper() ).arg( auth_id );
<a name="l01553"></a>01553         pj = pj_init_plus( input.toAscii() );
<a name="l01554"></a>01554       }
<a name="l01555"></a>01555 
<a name="l01556"></a>01556       <span class="keywordflow">if</span> ( pj )
<a name="l01557"></a>01557       {
<a name="l01558"></a>01558         <span class="keywordtype">char</span> *def = pj_get_def( pj, 0 );
<a name="l01559"></a>01559         <span class="keywordflow">if</span> ( def )
<a name="l01560"></a>01560         {
<a name="l01561"></a>01561           proj4 = def;
<a name="l01562"></a>01562           pj_dalloc( def );
<a name="l01563"></a>01563 
<a name="l01564"></a>01564           input.prepend( <span class="charliteral">&#39; &#39;</span> ).append( <span class="charliteral">&#39; &#39;</span> );
<a name="l01565"></a>01565           <span class="keywordflow">if</span> ( proj4.startsWith( input ) )
<a name="l01566"></a>01566           {
<a name="l01567"></a>01567             proj4 = proj4.mid( input.size() );
<a name="l01568"></a>01568             proj4 = proj4.trimmed();
<a name="l01569"></a>01569           }
<a name="l01570"></a>01570         }
<a name="l01571"></a>01571         <span class="keywordflow">else</span>
<a name="l01572"></a>01572         {
<a name="l01573"></a>01573           <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( QString( <span class="stringliteral">&quot;could not retrieve proj string for %1 from PROJ&quot;</span> ).arg( input ) );
<a name="l01574"></a>01574         }
<a name="l01575"></a>01575       }
<a name="l01576"></a>01576       <span class="keywordflow">else</span>
<a name="l01577"></a>01577       {
<a name="l01578"></a>01578         <a class="code" href="qgslogger_8h.html#a795a1fcfb1c61b988bbd999396411d13">QgsDebugMsgLevel</a>( QString( <span class="stringliteral">&quot;could not retrieve crs for %1 from PROJ&quot;</span> ).arg( input ), 3 );
<a name="l01579"></a>01579       }
<a name="l01580"></a>01580 
<a name="l01581"></a>01581       pj_free( pj );
<a name="l01582"></a>01582     }
<a name="l01583"></a>01583 <span class="preprocessor">#endif</span>
<a name="l01584"></a>01584 <span class="preprocessor"></span>
<a name="l01585"></a>01585     <span class="keywordflow">if</span> ( proj4.isEmpty() )
<a name="l01586"></a>01586     {
<a name="l01587"></a>01587       <span class="keywordflow">continue</span>;
<a name="l01588"></a>01588     }
<a name="l01589"></a>01589 
<a name="l01590"></a>01590     <span class="keywordflow">if</span> ( proj4 != params )
<a name="l01591"></a>01591     {
<a name="l01592"></a>01592       <span class="keywordtype">char</span> *errMsg = NULL;
<a name="l01593"></a>01593       sql = QString( <span class="stringliteral">&quot;UPDATE tbl_srs SET parameters=%1 WHERE auth_name=%2 AND auth_id=%3&quot;</span> )
<a name="l01594"></a>01594             .arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( proj4 ) )
<a name="l01595"></a>01595             .arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( auth_name ) )
<a name="l01596"></a>01596             .arg( <a class="code" href="classQgsCoordinateReferenceSystem.html#a661f618542b6b5cf1b00236eecd55784" title="Helper for sql-safe value quoting.">quotedValue</a>( auth_id ) );
<a name="l01597"></a>01597 
<a name="l01598"></a>01598       <span class="keywordflow">if</span> ( sqlite3_exec( database, sql.toUtf8(), 0, 0, &amp;errMsg ) != SQLITE_OK )
<a name="l01599"></a>01599       {
<a name="l01600"></a>01600         qCritical( <span class="stringliteral">&quot;Could not execute: %s [%s/%s]\n&quot;</span>,
<a name="l01601"></a>01601                    sql.toLocal8Bit().constData(),
<a name="l01602"></a>01602                    sqlite3_errmsg( database ),
<a name="l01603"></a>01603                    errMsg ? errMsg : <span class="stringliteral">&quot;(unknown error)&quot;</span> );
<a name="l01604"></a>01604         errors++;
<a name="l01605"></a>01605       }
<a name="l01606"></a>01606       <span class="keywordflow">else</span>
<a name="l01607"></a>01607       {
<a name="l01608"></a>01608         updated++;
<a name="l01609"></a>01609         <a class="code" href="qgslogger_8h.html#a795a1fcfb1c61b988bbd999396411d13">QgsDebugMsgLevel</a>( QString( <span class="stringliteral">&quot;SQL: %1\n OLD:%2\n NEW:%3&quot;</span> ).arg( sql ).arg( params ).arg( proj4 ), 3 );
<a name="l01610"></a>01610       }
<a name="l01611"></a>01611 
<a name="l01612"></a>01612       <span class="keywordflow">if</span> ( errMsg )
<a name="l01613"></a>01613         sqlite3_free( errMsg );
<a name="l01614"></a>01614     }
<a name="l01615"></a>01615   }
<a name="l01616"></a>01616 
<a name="l01617"></a>01617   OSRDestroySpatialReference( crs );
<a name="l01618"></a>01618 
<a name="l01619"></a>01619   sqlite3_finalize( select );
<a name="l01620"></a>01620 
<a name="l01621"></a>01621   <span class="keywordflow">if</span> ( sqlite3_exec( database, <span class="stringliteral">&quot;COMMIT&quot;</span>, 0, 0, 0 ) != SQLITE_OK )
<a name="l01622"></a>01622   {
<a name="l01623"></a>01623     qCritical( <span class="stringliteral">&quot;Could not commit transaction: %s [%s]\n&quot;</span>, <a class="code" href="classQgsApplication.html#ade49108acdad95ab09c8098a528659f8" title="Returns the path to the srs.db file.">QgsApplication::srsDbFilePath</a>().toLocal8Bit().constData(), sqlite3_errmsg( database ) );
<a name="l01624"></a>01624     <span class="keywordflow">return</span> -1;
<a name="l01625"></a>01625   }
<a name="l01626"></a>01626 
<a name="l01627"></a>01627   sqlite3_close( database );
<a name="l01628"></a>01628 
<a name="l01629"></a>01629   <span class="keywordflow">if</span> ( errors &gt; 0 )
<a name="l01630"></a>01630     <span class="keywordflow">return</span> -errors;
<a name="l01631"></a>01631   <span class="keywordflow">else</span>
<a name="l01632"></a>01632     <span class="keywordflow">return</span> updated;
<a name="l01633"></a>01633 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Tue Jun 19 2012 23:22:40 for Quantum GIS API Documentation by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
