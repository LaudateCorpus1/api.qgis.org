<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Quantum GIS API Documentation: src/analysis/raster/qgsrelief.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Quantum GIS API Documentation
   &#160;<span id="projectnumber">1.8</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">src/analysis/raster/qgsrelief.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="qgsrelief_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/***************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">                          qgsrelief.cpp  -  description</span>
<a name="l00003"></a>00003 <span class="comment">                          ---------------------------</span>
<a name="l00004"></a>00004 <span class="comment">    begin                : November 2011</span>
<a name="l00005"></a>00005 <span class="comment">    copyright            : (C) 2011 by Marco Hugentobler</span>
<a name="l00006"></a>00006 <span class="comment">    email                : marco dot hugentobler at sourcepole dot ch</span>
<a name="l00007"></a>00007 <span class="comment"> ***************************************************************************/</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="comment">/***************************************************************************</span>
<a name="l00010"></a>00010 <span class="comment"> *                                                                         *</span>
<a name="l00011"></a>00011 <span class="comment"> *   This program is free software; you can redistribute it and/or modify  *</span>
<a name="l00012"></a>00012 <span class="comment"> *   it under the terms of the GNU General Public License as published by  *</span>
<a name="l00013"></a>00013 <span class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</span>
<a name="l00014"></a>00014 <span class="comment"> *   (at your option) any later version.                                   *</span>
<a name="l00015"></a>00015 <span class="comment"> *                                                                         *</span>
<a name="l00016"></a>00016 <span class="comment"> ***************************************************************************/</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="qgsrelief_8h.html">qgsrelief.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="qgsaspectfilter_8h.html">qgsaspectfilter.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="qgshillshadefilter_8h.html">qgshillshadefilter.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="qgsslopefilter_8h.html">qgsslopefilter.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="qgis_8h.html">qgis.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;cpl_string.h&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;QProgressDialog&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;cfloat&gt;</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;QFile&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;QTextStream&gt;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#if defined(GDAL_VERSION_NUM) &amp;&amp; GDAL_VERSION_NUM &gt;= 1800</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span><span class="preprocessor">#define TO8(x) (x).toUtf8().constData()</span>
<a name="l00032"></a>00032 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00033"></a><a class="code" href="qgsrelief_8cpp.html#aa9757bc3fb1a21483651058539ebb565">00033</a> <span class="preprocessor"></span><span class="preprocessor">#define TO8(x) (x).toLocal8Bit().constData()</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span>
<a name="l00036"></a><a class="code" href="classQgsRelief.html#a74b09dc7875faa96cfbe4c194f438df1">00036</a> <a class="code" href="classQgsRelief.html#a74b09dc7875faa96cfbe4c194f438df1">QgsRelief::QgsRelief</a>( <span class="keyword">const</span> QString&amp; inputFile, <span class="keyword">const</span> QString&amp; outputFile, <span class="keyword">const</span> QString&amp; outputFormat ): \
<a name="l00037"></a>00037     mInputFile( inputFile ), mOutputFile( outputFile ), mOutputFormat( outputFormat ), mZFactor( 1.0 )
<a name="l00038"></a>00038 {
<a name="l00039"></a>00039   <a class="code" href="classQgsRelief.html#a156b7ca09a3a97f8d84c5a5191ce4d85">mSlopeFilter</a> = <span class="keyword">new</span> <a class="code" href="classQgsSlopeFilter.html" title="Calculates slope values in a window of 3x3 cells based on first order derivatives in x- and y- direct...">QgsSlopeFilter</a>( inputFile, outputFile, outputFormat );
<a name="l00040"></a>00040   <a class="code" href="classQgsRelief.html#a1bce792868290580eac294d1782f2545">mAspectFilter</a> = <span class="keyword">new</span> <a class="code" href="classQgsAspectFilter.html" title="Calculates aspect values in a window of 3x3 cells based on first order derivatives in x- and y- direc...">QgsAspectFilter</a>( inputFile, outputFile, outputFormat );
<a name="l00041"></a>00041   <a class="code" href="classQgsRelief.html#af581777eff9a3a26c0821b364095633a">mHillshadeFilter285</a> = <span class="keyword">new</span> <a class="code" href="classQgsHillshadeFilter.html">QgsHillshadeFilter</a>( inputFile, outputFile, outputFormat, 285, 30 );
<a name="l00042"></a>00042   <a class="code" href="classQgsRelief.html#abd3483736220957436d6aa7a87f4b815">mHillshadeFilter300</a> = <span class="keyword">new</span> <a class="code" href="classQgsHillshadeFilter.html">QgsHillshadeFilter</a>( inputFile, outputFile, outputFormat, 300, 30 );
<a name="l00043"></a>00043   <a class="code" href="classQgsRelief.html#ad53477260bfeb581aa00876d813b6d65">mHillshadeFilter315</a> = <span class="keyword">new</span> <a class="code" href="classQgsHillshadeFilter.html">QgsHillshadeFilter</a>( inputFile, outputFile, outputFormat, 315, 30 );
<a name="l00044"></a>00044 
<a name="l00045"></a>00045   <span class="comment">/*mReliefColors = calculateOptimizedReliefClasses();</span>
<a name="l00046"></a>00046 <span class="comment">    setDefaultReliefColors();*/</span>
<a name="l00047"></a>00047 }
<a name="l00048"></a>00048 
<a name="l00049"></a><a class="code" href="classQgsRelief.html#a96c5e15bc4285e6dbc331f83c18e276c">00049</a> <a class="code" href="classQgsRelief.html#a96c5e15bc4285e6dbc331f83c18e276c">QgsRelief::~QgsRelief</a>()
<a name="l00050"></a>00050 {
<a name="l00051"></a>00051   <span class="keyword">delete</span> <a class="code" href="classQgsRelief.html#a156b7ca09a3a97f8d84c5a5191ce4d85">mSlopeFilter</a>;
<a name="l00052"></a>00052   <span class="keyword">delete</span> <a class="code" href="classQgsRelief.html#a1bce792868290580eac294d1782f2545">mAspectFilter</a>;
<a name="l00053"></a>00053   <span class="keyword">delete</span> <a class="code" href="classQgsRelief.html#af581777eff9a3a26c0821b364095633a">mHillshadeFilter285</a>;
<a name="l00054"></a>00054   <span class="keyword">delete</span> <a class="code" href="classQgsRelief.html#abd3483736220957436d6aa7a87f4b815">mHillshadeFilter300</a>;
<a name="l00055"></a>00055   <span class="keyword">delete</span> <a class="code" href="classQgsRelief.html#ad53477260bfeb581aa00876d813b6d65">mHillshadeFilter315</a>;
<a name="l00056"></a>00056 }
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="classQgsRelief.html#a14ba6c1d79c34fa54f13e64dd7ee8745">00058</a> <span class="keywordtype">void</span> <a class="code" href="classQgsRelief.html#a14ba6c1d79c34fa54f13e64dd7ee8745">QgsRelief::clearReliefColors</a>()
<a name="l00059"></a>00059 {
<a name="l00060"></a>00060   <a class="code" href="classQgsRelief.html#ab3c622ef2066f1a93aa4d6f43950fca9">mReliefColors</a>.clear();
<a name="l00061"></a>00061 }
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="classQgsRelief.html#add981b50e5e44290b700aa80222cd7b8">00063</a> <span class="keywordtype">void</span> <a class="code" href="classQgsRelief.html#add981b50e5e44290b700aa80222cd7b8">QgsRelief::addReliefColorClass</a>( <span class="keyword">const</span> <a class="code" href="structQgsRelief_1_1ReliefColor.html">ReliefColor</a>&amp; color )
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065   <a class="code" href="classQgsRelief.html#ab3c622ef2066f1a93aa4d6f43950fca9">mReliefColors</a>.push_back( color );
<a name="l00066"></a>00066 }
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="classQgsRelief.html#a919cde8864c0f0d66b4d51cf14bedab2">00068</a> <span class="keywordtype">void</span> <a class="code" href="classQgsRelief.html#a919cde8864c0f0d66b4d51cf14bedab2" title="Sets relief colors.">QgsRelief::setDefaultReliefColors</a>()
<a name="l00069"></a>00069 {
<a name="l00070"></a>00070   <a class="code" href="classQgsRelief.html#a14ba6c1d79c34fa54f13e64dd7ee8745">clearReliefColors</a>();
<a name="l00071"></a>00071   <a class="code" href="classQgsRelief.html#add981b50e5e44290b700aa80222cd7b8">addReliefColorClass</a>( <a class="code" href="structQgsRelief_1_1ReliefColor.html">ReliefColor</a>( QColor( 9, 176, 76 ), 0, 200 ) );
<a name="l00072"></a>00072   <a class="code" href="classQgsRelief.html#add981b50e5e44290b700aa80222cd7b8">addReliefColorClass</a>( <a class="code" href="structQgsRelief_1_1ReliefColor.html">ReliefColor</a>( QColor( 20, 228, 128 ), 200, 500 ) );
<a name="l00073"></a>00073   <a class="code" href="classQgsRelief.html#add981b50e5e44290b700aa80222cd7b8">addReliefColorClass</a>( <a class="code" href="structQgsRelief_1_1ReliefColor.html">ReliefColor</a>( QColor( 167, 239, 153 ), 500, 1000 ) );
<a name="l00074"></a>00074   <a class="code" href="classQgsRelief.html#add981b50e5e44290b700aa80222cd7b8">addReliefColorClass</a>( <a class="code" href="structQgsRelief_1_1ReliefColor.html">ReliefColor</a>( QColor( 218, 188, 143 ), 1000, 2000 ) );
<a name="l00075"></a>00075   <a class="code" href="classQgsRelief.html#add981b50e5e44290b700aa80222cd7b8">addReliefColorClass</a>( <a class="code" href="structQgsRelief_1_1ReliefColor.html">ReliefColor</a>( QColor( 233, 158, 91 ), 2000, 4000 ) );
<a name="l00076"></a>00076   <a class="code" href="classQgsRelief.html#add981b50e5e44290b700aa80222cd7b8">addReliefColorClass</a>( <a class="code" href="structQgsRelief_1_1ReliefColor.html">ReliefColor</a>( QColor( 255, 255, 255 ), 4000, 9000 ) );
<a name="l00077"></a>00077 }
<a name="l00078"></a>00078 
<a name="l00079"></a><a class="code" href="classQgsRelief.html#abc4ebda9f7efdae0aa8b25635df0eb96">00079</a> <span class="keywordtype">int</span> <a class="code" href="classQgsRelief.html#abc4ebda9f7efdae0aa8b25635df0eb96" title="Starts the calculation, reads from mInputFile and stores the result in mOutputFile.">QgsRelief::processRaster</a>( QProgressDialog* p )
<a name="l00080"></a>00080 {
<a name="l00081"></a>00081   <span class="comment">//open input file</span>
<a name="l00082"></a>00082   <span class="keywordtype">int</span> xSize, ySize;
<a name="l00083"></a>00083   GDALDatasetH  inputDataset = <a class="code" href="classQgsRelief.html#a6b6805cc94d0f46d14b8851ee2b6996a" title="Opens the input file and returns the dataset handle and the number of pixels in x-/y- direction...">openInputFile</a>( xSize, ySize );
<a name="l00084"></a>00084   <span class="keywordflow">if</span> ( inputDataset == NULL )
<a name="l00085"></a>00085   {
<a name="l00086"></a>00086     <span class="keywordflow">return</span> 1; <span class="comment">//opening of input file failed</span>
<a name="l00087"></a>00087   }
<a name="l00088"></a>00088 
<a name="l00089"></a>00089   <span class="comment">//output driver</span>
<a name="l00090"></a>00090   GDALDriverH outputDriver = <a class="code" href="classQgsRelief.html#a2d1bb6040ac5ced072c98daf48332e96" title="Opens the output driver and tests if it supports the creation of a new dataset.">openOutputDriver</a>();
<a name="l00091"></a>00091   <span class="keywordflow">if</span> ( outputDriver == 0 )
<a name="l00092"></a>00092   {
<a name="l00093"></a>00093     <span class="keywordflow">return</span> 2;
<a name="l00094"></a>00094   }
<a name="l00095"></a>00095 
<a name="l00096"></a>00096   GDALDatasetH outputDataset = <a class="code" href="classQgsRelief.html#a911547a99fbd8f7cdf216cb9d1ff876c" title="Opens the output file and sets the same geotransform and CRS as the input data.">openOutputFile</a>( inputDataset, outputDriver );
<a name="l00097"></a>00097   <span class="keywordflow">if</span> ( outputDataset == NULL )
<a name="l00098"></a>00098   {
<a name="l00099"></a>00099     <span class="keywordflow">return</span> 3; <span class="comment">//create operation on output file failed</span>
<a name="l00100"></a>00100   }
<a name="l00101"></a>00101 
<a name="l00102"></a>00102   <span class="comment">//initialize dependency filters with cell sizes</span>
<a name="l00103"></a>00103   <a class="code" href="classQgsRelief.html#af581777eff9a3a26c0821b364095633a">mHillshadeFilter285</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a51d8e80594791062935d7f4fa2739707">setCellSizeX</a>( <a class="code" href="classQgsRelief.html#a8de7689744ce9ebeda3eec33b5f5770b">mCellSizeX</a> );
<a name="l00104"></a>00104   <a class="code" href="classQgsRelief.html#af581777eff9a3a26c0821b364095633a">mHillshadeFilter285</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#aa26965f48f1bd581810834c45a792530">setCellSizeY</a>( <a class="code" href="classQgsRelief.html#a45c276f9b6cc4bbe1167562751f78309">mCellSizeY</a> );
<a name="l00105"></a>00105   <a class="code" href="classQgsRelief.html#af581777eff9a3a26c0821b364095633a">mHillshadeFilter285</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a890a01a27494a6978596798ad01a0e9b">setZFactor</a>( <a class="code" href="classQgsRelief.html#a086a701d4f53848f97ee90c3427b93ed">mZFactor</a> );
<a name="l00106"></a>00106   <a class="code" href="classQgsRelief.html#abd3483736220957436d6aa7a87f4b815">mHillshadeFilter300</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a51d8e80594791062935d7f4fa2739707">setCellSizeX</a>( <a class="code" href="classQgsRelief.html#a8de7689744ce9ebeda3eec33b5f5770b">mCellSizeX</a> );
<a name="l00107"></a>00107   <a class="code" href="classQgsRelief.html#abd3483736220957436d6aa7a87f4b815">mHillshadeFilter300</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#aa26965f48f1bd581810834c45a792530">setCellSizeY</a>( <a class="code" href="classQgsRelief.html#a45c276f9b6cc4bbe1167562751f78309">mCellSizeY</a> );
<a name="l00108"></a>00108   <a class="code" href="classQgsRelief.html#abd3483736220957436d6aa7a87f4b815">mHillshadeFilter300</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a890a01a27494a6978596798ad01a0e9b">setZFactor</a>( <a class="code" href="classQgsRelief.html#a086a701d4f53848f97ee90c3427b93ed">mZFactor</a> );
<a name="l00109"></a>00109   <a class="code" href="classQgsRelief.html#ad53477260bfeb581aa00876d813b6d65">mHillshadeFilter315</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a51d8e80594791062935d7f4fa2739707">setCellSizeX</a>( <a class="code" href="classQgsRelief.html#a8de7689744ce9ebeda3eec33b5f5770b">mCellSizeX</a> );
<a name="l00110"></a>00110   <a class="code" href="classQgsRelief.html#ad53477260bfeb581aa00876d813b6d65">mHillshadeFilter315</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#aa26965f48f1bd581810834c45a792530">setCellSizeY</a>( <a class="code" href="classQgsRelief.html#a45c276f9b6cc4bbe1167562751f78309">mCellSizeY</a> );
<a name="l00111"></a>00111   <a class="code" href="classQgsRelief.html#ad53477260bfeb581aa00876d813b6d65">mHillshadeFilter315</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a890a01a27494a6978596798ad01a0e9b">setZFactor</a>( <a class="code" href="classQgsRelief.html#a086a701d4f53848f97ee90c3427b93ed">mZFactor</a> );
<a name="l00112"></a>00112   <a class="code" href="classQgsRelief.html#a156b7ca09a3a97f8d84c5a5191ce4d85">mSlopeFilter</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a51d8e80594791062935d7f4fa2739707">setCellSizeX</a>( <a class="code" href="classQgsRelief.html#a8de7689744ce9ebeda3eec33b5f5770b">mCellSizeX</a> );
<a name="l00113"></a>00113   <a class="code" href="classQgsRelief.html#a156b7ca09a3a97f8d84c5a5191ce4d85">mSlopeFilter</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#aa26965f48f1bd581810834c45a792530">setCellSizeY</a>( <a class="code" href="classQgsRelief.html#a45c276f9b6cc4bbe1167562751f78309">mCellSizeY</a> );
<a name="l00114"></a>00114   <a class="code" href="classQgsRelief.html#a156b7ca09a3a97f8d84c5a5191ce4d85">mSlopeFilter</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a890a01a27494a6978596798ad01a0e9b">setZFactor</a>( <a class="code" href="classQgsRelief.html#a086a701d4f53848f97ee90c3427b93ed">mZFactor</a> );
<a name="l00115"></a>00115   <a class="code" href="classQgsRelief.html#a1bce792868290580eac294d1782f2545">mAspectFilter</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a51d8e80594791062935d7f4fa2739707">setCellSizeX</a>( <a class="code" href="classQgsRelief.html#a8de7689744ce9ebeda3eec33b5f5770b">mCellSizeX</a> );
<a name="l00116"></a>00116   <a class="code" href="classQgsRelief.html#a1bce792868290580eac294d1782f2545">mAspectFilter</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#aa26965f48f1bd581810834c45a792530">setCellSizeY</a>( <a class="code" href="classQgsRelief.html#a45c276f9b6cc4bbe1167562751f78309">mCellSizeY</a> );
<a name="l00117"></a>00117   <a class="code" href="classQgsRelief.html#a1bce792868290580eac294d1782f2545">mAspectFilter</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a890a01a27494a6978596798ad01a0e9b">setZFactor</a>( <a class="code" href="classQgsRelief.html#a086a701d4f53848f97ee90c3427b93ed">mZFactor</a> );
<a name="l00118"></a>00118 
<a name="l00119"></a>00119   <span class="comment">//open first raster band for reading (operation is only for single band raster)</span>
<a name="l00120"></a>00120   GDALRasterBandH rasterBand = GDALGetRasterBand( inputDataset, 1 );
<a name="l00121"></a>00121   <span class="keywordflow">if</span> ( rasterBand == NULL )
<a name="l00122"></a>00122   {
<a name="l00123"></a>00123     GDALClose( inputDataset );
<a name="l00124"></a>00124     GDALClose( outputDataset );
<a name="l00125"></a>00125     <span class="keywordflow">return</span> 4;
<a name="l00126"></a>00126   }
<a name="l00127"></a>00127   <a class="code" href="classQgsRelief.html#a7115fee6013f126436e1c62621b1f0de" title="The nodata value of the input layer.">mInputNodataValue</a> = GDALGetRasterNoDataValue( rasterBand, NULL );
<a name="l00128"></a>00128   <a class="code" href="classQgsRelief.html#a156b7ca09a3a97f8d84c5a5191ce4d85">mSlopeFilter</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a846c9778f8913db710b7d1b79f96441e">setInputNodataValue</a>( <a class="code" href="classQgsRelief.html#a7115fee6013f126436e1c62621b1f0de" title="The nodata value of the input layer.">mInputNodataValue</a> );
<a name="l00129"></a>00129   <a class="code" href="classQgsRelief.html#a1bce792868290580eac294d1782f2545">mAspectFilter</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a846c9778f8913db710b7d1b79f96441e">setInputNodataValue</a>( <a class="code" href="classQgsRelief.html#a7115fee6013f126436e1c62621b1f0de" title="The nodata value of the input layer.">mInputNodataValue</a> );
<a name="l00130"></a>00130   <a class="code" href="classQgsRelief.html#af581777eff9a3a26c0821b364095633a">mHillshadeFilter285</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a846c9778f8913db710b7d1b79f96441e">setInputNodataValue</a>( <a class="code" href="classQgsRelief.html#a7115fee6013f126436e1c62621b1f0de" title="The nodata value of the input layer.">mInputNodataValue</a> );
<a name="l00131"></a>00131   <a class="code" href="classQgsRelief.html#abd3483736220957436d6aa7a87f4b815">mHillshadeFilter300</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a846c9778f8913db710b7d1b79f96441e">setInputNodataValue</a>( <a class="code" href="classQgsRelief.html#a7115fee6013f126436e1c62621b1f0de" title="The nodata value of the input layer.">mInputNodataValue</a> );
<a name="l00132"></a>00132   <a class="code" href="classQgsRelief.html#ad53477260bfeb581aa00876d813b6d65">mHillshadeFilter315</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a846c9778f8913db710b7d1b79f96441e">setInputNodataValue</a>( <a class="code" href="classQgsRelief.html#a7115fee6013f126436e1c62621b1f0de" title="The nodata value of the input layer.">mInputNodataValue</a> );
<a name="l00133"></a>00133 
<a name="l00134"></a>00134   GDALRasterBandH outputRedBand = GDALGetRasterBand( outputDataset, 1 );
<a name="l00135"></a>00135   GDALRasterBandH outputGreenBand = GDALGetRasterBand( outputDataset, 2 );
<a name="l00136"></a>00136   GDALRasterBandH outputBlueBand = GDALGetRasterBand( outputDataset, 3 );
<a name="l00137"></a>00137 
<a name="l00138"></a>00138   <span class="keywordflow">if</span> ( outputRedBand == NULL || outputGreenBand == NULL || outputBlueBand == NULL )
<a name="l00139"></a>00139   {
<a name="l00140"></a>00140     GDALClose( inputDataset );
<a name="l00141"></a>00141     GDALClose( outputDataset );
<a name="l00142"></a>00142     <span class="keywordflow">return</span> 5;
<a name="l00143"></a>00143   }
<a name="l00144"></a>00144   <span class="comment">//try to set -9999 as nodata value</span>
<a name="l00145"></a>00145   GDALSetRasterNoDataValue( outputRedBand, -9999 );
<a name="l00146"></a>00146   GDALSetRasterNoDataValue( outputGreenBand, -9999 );
<a name="l00147"></a>00147   GDALSetRasterNoDataValue( outputBlueBand, -9999 );
<a name="l00148"></a>00148   <a class="code" href="classQgsRelief.html#a735945a50bb9adfa4d550a9c3568bd1d" title="The nodata value of the output layer.">mOutputNodataValue</a> = GDALGetRasterNoDataValue( outputRedBand, NULL );
<a name="l00149"></a>00149   <a class="code" href="classQgsRelief.html#a156b7ca09a3a97f8d84c5a5191ce4d85">mSlopeFilter</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a6ab4e7b6ae02d6eb87d7c5f866282e90">setOutputNodataValue</a>( <a class="code" href="classQgsRelief.html#a735945a50bb9adfa4d550a9c3568bd1d" title="The nodata value of the output layer.">mOutputNodataValue</a> );
<a name="l00150"></a>00150   <a class="code" href="classQgsRelief.html#a1bce792868290580eac294d1782f2545">mAspectFilter</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a6ab4e7b6ae02d6eb87d7c5f866282e90">setOutputNodataValue</a>( <a class="code" href="classQgsRelief.html#a735945a50bb9adfa4d550a9c3568bd1d" title="The nodata value of the output layer.">mOutputNodataValue</a> );
<a name="l00151"></a>00151   <a class="code" href="classQgsRelief.html#af581777eff9a3a26c0821b364095633a">mHillshadeFilter285</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a6ab4e7b6ae02d6eb87d7c5f866282e90">setOutputNodataValue</a>( <a class="code" href="classQgsRelief.html#a735945a50bb9adfa4d550a9c3568bd1d" title="The nodata value of the output layer.">mOutputNodataValue</a> );
<a name="l00152"></a>00152   <a class="code" href="classQgsRelief.html#abd3483736220957436d6aa7a87f4b815">mHillshadeFilter300</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a6ab4e7b6ae02d6eb87d7c5f866282e90">setOutputNodataValue</a>( <a class="code" href="classQgsRelief.html#a735945a50bb9adfa4d550a9c3568bd1d" title="The nodata value of the output layer.">mOutputNodataValue</a> );
<a name="l00153"></a>00153   <a class="code" href="classQgsRelief.html#ad53477260bfeb581aa00876d813b6d65">mHillshadeFilter315</a>-&gt;<a class="code" href="classQgsNineCellFilter.html#a6ab4e7b6ae02d6eb87d7c5f866282e90">setOutputNodataValue</a>( <a class="code" href="classQgsRelief.html#a735945a50bb9adfa4d550a9c3568bd1d" title="The nodata value of the output layer.">mOutputNodataValue</a> );
<a name="l00154"></a>00154 
<a name="l00155"></a>00155   <span class="keywordflow">if</span> ( ySize &lt; 3 ) <span class="comment">//we require at least three rows (should be true for most datasets)</span>
<a name="l00156"></a>00156   {
<a name="l00157"></a>00157     GDALClose( inputDataset );
<a name="l00158"></a>00158     GDALClose( outputDataset );
<a name="l00159"></a>00159     <span class="keywordflow">return</span> 6;
<a name="l00160"></a>00160   }
<a name="l00161"></a>00161 
<a name="l00162"></a>00162   <span class="comment">//keep only three scanlines in memory at a time</span>
<a name="l00163"></a>00163   <span class="keywordtype">float</span>* scanLine1 = ( <span class="keywordtype">float</span> * ) CPLMalloc( <span class="keyword">sizeof</span>( <span class="keywordtype">float</span> ) * xSize );
<a name="l00164"></a>00164   <span class="keywordtype">float</span>* scanLine2 = ( <span class="keywordtype">float</span> * ) CPLMalloc( <span class="keyword">sizeof</span>( <span class="keywordtype">float</span> ) * xSize );
<a name="l00165"></a>00165   <span class="keywordtype">float</span>* scanLine3 = ( <span class="keywordtype">float</span> * ) CPLMalloc( <span class="keyword">sizeof</span>( <span class="keywordtype">float</span> ) * xSize );
<a name="l00166"></a>00166 
<a name="l00167"></a>00167   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* resultRedLine = ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * ) CPLMalloc( <span class="keyword">sizeof</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ) * xSize );
<a name="l00168"></a>00168   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* resultGreenLine = ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * ) CPLMalloc( <span class="keyword">sizeof</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ) * xSize );
<a name="l00169"></a>00169   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* resultBlueLine = ( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * ) CPLMalloc( <span class="keyword">sizeof</span>( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ) * xSize );
<a name="l00170"></a>00170 
<a name="l00171"></a>00171   <span class="keywordflow">if</span> ( p )
<a name="l00172"></a>00172   {
<a name="l00173"></a>00173     p-&gt;setMaximum( ySize );
<a name="l00174"></a>00174   }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176   <span class="keywordtype">bool</span> resultOk;
<a name="l00177"></a>00177 
<a name="l00178"></a>00178   <span class="comment">//values outside the layer extent (if the 3x3 window is on the border) are sent to the processing method as (input) nodata values</span>
<a name="l00179"></a>00179   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; ySize; ++i )
<a name="l00180"></a>00180   {
<a name="l00181"></a>00181     <span class="keywordflow">if</span> ( p )
<a name="l00182"></a>00182     {
<a name="l00183"></a>00183       p-&gt;setValue( i );
<a name="l00184"></a>00184     }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     <span class="keywordflow">if</span> ( p &amp;&amp; p-&gt;wasCanceled() )
<a name="l00187"></a>00187     {
<a name="l00188"></a>00188       <span class="keywordflow">break</span>;
<a name="l00189"></a>00189     }
<a name="l00190"></a>00190 
<a name="l00191"></a>00191     <span class="keywordflow">if</span> ( i == 0 )
<a name="l00192"></a>00192     {
<a name="l00193"></a>00193       <span class="comment">//fill scanline 1 with (input) nodata for the values above the first row and feed scanline2 with the first row</span>
<a name="l00194"></a>00194       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> a = 0; a &lt; xSize; ++a )
<a name="l00195"></a>00195       {
<a name="l00196"></a>00196         scanLine1[a] = <a class="code" href="classQgsRelief.html#a7115fee6013f126436e1c62621b1f0de" title="The nodata value of the input layer.">mInputNodataValue</a>;
<a name="l00197"></a>00197       }
<a name="l00198"></a>00198       GDALRasterIO( rasterBand, GF_Read, 0, 0, xSize, 1, scanLine2, xSize, 1, GDT_Float32, 0, 0 );
<a name="l00199"></a>00199     }
<a name="l00200"></a>00200     <span class="keywordflow">else</span>
<a name="l00201"></a>00201     {
<a name="l00202"></a>00202       <span class="comment">//normally fetch only scanLine3 and release scanline 1 if we move forward one row</span>
<a name="l00203"></a>00203       CPLFree( scanLine1 );
<a name="l00204"></a>00204       scanLine1 = scanLine2;
<a name="l00205"></a>00205       scanLine2 = scanLine3;
<a name="l00206"></a>00206       scanLine3 = ( <span class="keywordtype">float</span> * ) CPLMalloc( <span class="keyword">sizeof</span>( <span class="keywordtype">float</span> ) * xSize );
<a name="l00207"></a>00207     }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <span class="keywordflow">if</span> ( i == ySize - 1 ) <span class="comment">//fill the row below the bottom with nodata values</span>
<a name="l00210"></a>00210     {
<a name="l00211"></a>00211       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> a = 0; a &lt; xSize; ++a )
<a name="l00212"></a>00212       {
<a name="l00213"></a>00213         scanLine3[a] = <a class="code" href="classQgsRelief.html#a7115fee6013f126436e1c62621b1f0de" title="The nodata value of the input layer.">mInputNodataValue</a>;
<a name="l00214"></a>00214       }
<a name="l00215"></a>00215     }
<a name="l00216"></a>00216     <span class="keywordflow">else</span>
<a name="l00217"></a>00217     {
<a name="l00218"></a>00218       GDALRasterIO( rasterBand, GF_Read, 0, i + 1, xSize, 1, scanLine3, xSize, 1, GDT_Float32, 0, 0 );
<a name="l00219"></a>00219     }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = 0; j &lt; xSize; ++j )
<a name="l00222"></a>00222     {
<a name="l00223"></a>00223       <span class="keywordflow">if</span> ( j == 0 )
<a name="l00224"></a>00224       {
<a name="l00225"></a>00225         resultOk = <a class="code" href="classQgsRelief.html#a002784d273c6b388432132bcd55c40d3">processNineCellWindow</a>( &amp;<a class="code" href="classQgsRelief.html#a7115fee6013f126436e1c62621b1f0de" title="The nodata value of the input layer.">mInputNodataValue</a>, &amp;scanLine1[j], &amp;scanLine1[j+1], &amp;<a class="code" href="classQgsRelief.html#a7115fee6013f126436e1c62621b1f0de" title="The nodata value of the input layer.">mInputNodataValue</a>, &amp;scanLine2[j], \
<a name="l00226"></a>00226                                           &amp;scanLine2[j+1], &amp;<a class="code" href="classQgsRelief.html#a7115fee6013f126436e1c62621b1f0de" title="The nodata value of the input layer.">mInputNodataValue</a>, &amp;scanLine3[j], &amp;scanLine3[j+1], \
<a name="l00227"></a>00227                                           &amp;resultRedLine[j], &amp;resultGreenLine[j], &amp;resultBlueLine[j] );
<a name="l00228"></a>00228       }
<a name="l00229"></a>00229       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( j == xSize - 1 )
<a name="l00230"></a>00230       {
<a name="l00231"></a>00231         resultOk = <a class="code" href="classQgsRelief.html#a002784d273c6b388432132bcd55c40d3">processNineCellWindow</a>( &amp;scanLine1[j-1], &amp;scanLine1[j], &amp;<a class="code" href="classQgsRelief.html#a7115fee6013f126436e1c62621b1f0de" title="The nodata value of the input layer.">mInputNodataValue</a>, &amp;scanLine2[j-1], &amp;scanLine2[j], \
<a name="l00232"></a>00232                                           &amp;<a class="code" href="classQgsRelief.html#a7115fee6013f126436e1c62621b1f0de" title="The nodata value of the input layer.">mInputNodataValue</a>, &amp;scanLine3[j-1], &amp;scanLine3[j], &amp;<a class="code" href="classQgsRelief.html#a7115fee6013f126436e1c62621b1f0de" title="The nodata value of the input layer.">mInputNodataValue</a>, \
<a name="l00233"></a>00233                                           &amp;resultRedLine[j], &amp;resultGreenLine[j], &amp;resultBlueLine[j] );
<a name="l00234"></a>00234       }
<a name="l00235"></a>00235       <span class="keywordflow">else</span>
<a name="l00236"></a>00236       {
<a name="l00237"></a>00237         resultOk = <a class="code" href="classQgsRelief.html#a002784d273c6b388432132bcd55c40d3">processNineCellWindow</a>( &amp;scanLine1[j-1], &amp;scanLine1[j], &amp;scanLine1[j+1], &amp;scanLine2[j-1], &amp;scanLine2[j], \
<a name="l00238"></a>00238                                           &amp;scanLine2[j+1], &amp;scanLine3[j-1], &amp;scanLine3[j], &amp;scanLine3[j+1], \
<a name="l00239"></a>00239                                           &amp;resultRedLine[j], &amp;resultGreenLine[j], &amp;resultBlueLine[j] );
<a name="l00240"></a>00240       }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242       <span class="keywordflow">if</span> ( !resultOk )
<a name="l00243"></a>00243       {
<a name="l00244"></a>00244         resultRedLine[j] = <a class="code" href="classQgsRelief.html#a735945a50bb9adfa4d550a9c3568bd1d" title="The nodata value of the output layer.">mOutputNodataValue</a>;
<a name="l00245"></a>00245         resultGreenLine[j] = <a class="code" href="classQgsRelief.html#a735945a50bb9adfa4d550a9c3568bd1d" title="The nodata value of the output layer.">mOutputNodataValue</a>;
<a name="l00246"></a>00246         resultBlueLine[j] = <a class="code" href="classQgsRelief.html#a735945a50bb9adfa4d550a9c3568bd1d" title="The nodata value of the output layer.">mOutputNodataValue</a>;
<a name="l00247"></a>00247       }
<a name="l00248"></a>00248     }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     GDALRasterIO( outputRedBand, GF_Write, 0, i, xSize, 1, resultRedLine, xSize, 1, GDT_Byte, 0, 0 );
<a name="l00251"></a>00251     GDALRasterIO( outputGreenBand, GF_Write, 0, i, xSize, 1, resultGreenLine, xSize, 1, GDT_Byte, 0, 0 );
<a name="l00252"></a>00252     GDALRasterIO( outputBlueBand, GF_Write, 0, i, xSize, 1, resultBlueLine, xSize, 1, GDT_Byte, 0, 0 );
<a name="l00253"></a>00253   }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255   <span class="keywordflow">if</span> ( p )
<a name="l00256"></a>00256   {
<a name="l00257"></a>00257     p-&gt;setValue( ySize );
<a name="l00258"></a>00258   }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260   CPLFree( resultRedLine );
<a name="l00261"></a>00261   CPLFree( resultBlueLine );
<a name="l00262"></a>00262   CPLFree( resultGreenLine );
<a name="l00263"></a>00263   CPLFree( scanLine1 );
<a name="l00264"></a>00264   CPLFree( scanLine2 );
<a name="l00265"></a>00265   CPLFree( scanLine3 );
<a name="l00266"></a>00266 
<a name="l00267"></a>00267   GDALClose( inputDataset );
<a name="l00268"></a>00268 
<a name="l00269"></a>00269   <span class="keywordflow">if</span> ( p &amp;&amp; p-&gt;wasCanceled() )
<a name="l00270"></a>00270   {
<a name="l00271"></a>00271     <span class="comment">//delete the dataset without closing (because it is faster)</span>
<a name="l00272"></a>00272     GDALDeleteDataset( outputDriver, <a class="code" href="classQgsRelief.html#a461b166a1de3391ae6531c438662f344">mOutputFile</a>.toLocal8Bit().data() );
<a name="l00273"></a>00273     <span class="keywordflow">return</span> 7;
<a name="l00274"></a>00274   }
<a name="l00275"></a>00275   GDALClose( outputDataset );
<a name="l00276"></a>00276 
<a name="l00277"></a>00277   <span class="keywordflow">return</span> 0;
<a name="l00278"></a>00278 }
<a name="l00279"></a>00279 
<a name="l00280"></a><a class="code" href="classQgsRelief.html#a002784d273c6b388432132bcd55c40d3">00280</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsRelief.html#a002784d273c6b388432132bcd55c40d3">QgsRelief::processNineCellWindow</a>( <span class="keywordtype">float</span>* x1, <span class="keywordtype">float</span>* x2, <span class="keywordtype">float</span>* x3, <span class="keywordtype">float</span>* x4, <span class="keywordtype">float</span>* x5, <span class="keywordtype">float</span>* x6, <span class="keywordtype">float</span>* x7, <span class="keywordtype">float</span>* x8, <span class="keywordtype">float</span>* x9,
<a name="l00281"></a>00281                                        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* red, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* green, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* blue )
<a name="l00282"></a>00282 {
<a name="l00283"></a>00283   <span class="comment">//1. component: color and hillshade from 300 degrees</span>
<a name="l00284"></a>00284   <span class="keywordtype">int</span> r = 0;
<a name="l00285"></a>00285   <span class="keywordtype">int</span> g = 0;
<a name="l00286"></a>00286   <span class="keywordtype">int</span> b = 0;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288   <span class="keywordtype">float</span> hillShadeValue300 = <a class="code" href="classQgsRelief.html#abd3483736220957436d6aa7a87f4b815">mHillshadeFilter300</a>-&gt;<a class="code" href="classQgsHillshadeFilter.html#a192a4839ccad83c2283002d76b4e0363" title="Calculates output value from nine input values.">processNineCellWindow</a>( x1, x2, x3, x4, x5, x6, x7, x8, x9 );
<a name="l00289"></a>00289   <span class="keywordflow">if</span> ( hillShadeValue300 != <a class="code" href="classQgsRelief.html#a735945a50bb9adfa4d550a9c3568bd1d" title="The nodata value of the output layer.">mOutputNodataValue</a> )
<a name="l00290"></a>00290   {
<a name="l00291"></a>00291     <span class="keywordflow">if</span> ( !<a class="code" href="classQgsRelief.html#a10512b7df4f601a466743ca59a590b6b" title="Set elevation color.">setElevationColor</a>( *x5, &amp;r, &amp;g, &amp;b ) )
<a name="l00292"></a>00292     {
<a name="l00293"></a>00293       r = hillShadeValue300;
<a name="l00294"></a>00294       g = hillShadeValue300;
<a name="l00295"></a>00295       b = hillShadeValue300;
<a name="l00296"></a>00296     }
<a name="l00297"></a>00297     <span class="keywordflow">else</span>
<a name="l00298"></a>00298     {
<a name="l00299"></a>00299       r = r / 2.0 + hillShadeValue300 / 2.0;
<a name="l00300"></a>00300       g = g / 2.0 + hillShadeValue300 / 2.0;
<a name="l00301"></a>00301       b = b / 2.0 + hillShadeValue300 / 2.0;
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303   }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305   <span class="comment">//2. component: hillshade and slope</span>
<a name="l00306"></a>00306   <span class="keywordtype">float</span> hillShadeValue315 = <a class="code" href="classQgsRelief.html#ad53477260bfeb581aa00876d813b6d65">mHillshadeFilter315</a>-&gt;<a class="code" href="classQgsHillshadeFilter.html#a192a4839ccad83c2283002d76b4e0363" title="Calculates output value from nine input values.">processNineCellWindow</a>( x1, x2, x3, x4, x5, x6, x7, x8, x9 );
<a name="l00307"></a>00307   <span class="keywordtype">float</span> slope = <a class="code" href="classQgsRelief.html#a156b7ca09a3a97f8d84c5a5191ce4d85">mSlopeFilter</a>-&gt;<a class="code" href="classQgsSlopeFilter.html#a5359368410db0a89ae4fc925a3daa6ac" title="Calculates output value from nine input values.">processNineCellWindow</a>( x1, x2, x3, x4, x5, x6, x7, x8, x9 );
<a name="l00308"></a>00308   <span class="keywordflow">if</span> ( hillShadeValue315 != <a class="code" href="classQgsRelief.html#a735945a50bb9adfa4d550a9c3568bd1d" title="The nodata value of the output layer.">mOutputNodataValue</a> &amp;&amp; slope != <a class="code" href="classQgsRelief.html#a735945a50bb9adfa4d550a9c3568bd1d" title="The nodata value of the output layer.">mOutputNodataValue</a> )
<a name="l00309"></a>00309   {
<a name="l00310"></a>00310     <span class="keywordtype">int</span> r2, g2, b2;
<a name="l00311"></a>00311     <span class="keywordflow">if</span> ( slope &gt; 15 )
<a name="l00312"></a>00312     {
<a name="l00313"></a>00313       r2 = 0 / 2.0 + hillShadeValue315 / 2.0;
<a name="l00314"></a>00314       g2 = 0 / 2.0 + hillShadeValue315 / 2.0;
<a name="l00315"></a>00315       b2 = 0 / 2.0 + hillShadeValue315 / 2.0;
<a name="l00316"></a>00316     }
<a name="l00317"></a>00317     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( slope &gt;= 1 )
<a name="l00318"></a>00318     {
<a name="l00319"></a>00319       <span class="keywordtype">int</span> slopeValue = 255 - ( slope / 15.0 * 255.0 );
<a name="l00320"></a>00320       r2 = slopeValue / 2.0 + hillShadeValue315 / 2.0;
<a name="l00321"></a>00321       g2 = slopeValue / 2.0 + hillShadeValue315 / 2.0;
<a name="l00322"></a>00322       b2 = slopeValue / 2.0 + hillShadeValue315 / 2.0;
<a name="l00323"></a>00323     }
<a name="l00324"></a>00324     <span class="keywordflow">else</span>
<a name="l00325"></a>00325     {
<a name="l00326"></a>00326       r2 = hillShadeValue315; g2 = hillShadeValue315; b2 = hillShadeValue315;
<a name="l00327"></a>00327     }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329     <span class="comment">//combine with r,g,b with 70 percentage coverage</span>
<a name="l00330"></a>00330     r = r * 0.7 + r2 * 0.3;
<a name="l00331"></a>00331     g = g * 0.7 + g2 * 0.3;
<a name="l00332"></a>00332     b = b * 0.7 + b2 * 0.3;
<a name="l00333"></a>00333   }
<a name="l00334"></a>00334 
<a name="l00335"></a>00335   <span class="comment">//3. combine yellow aspect with 10% transparency, illumination from 285 degrees</span>
<a name="l00336"></a>00336   <span class="keywordtype">float</span> hillShadeValue285 = <a class="code" href="classQgsRelief.html#af581777eff9a3a26c0821b364095633a">mHillshadeFilter285</a>-&gt;<a class="code" href="classQgsHillshadeFilter.html#a192a4839ccad83c2283002d76b4e0363" title="Calculates output value from nine input values.">processNineCellWindow</a>( x1, x2, x3, x4, x5, x6, x7, x8, x9 );
<a name="l00337"></a>00337   <span class="keywordtype">float</span> aspect = <a class="code" href="classQgsRelief.html#a1bce792868290580eac294d1782f2545">mAspectFilter</a>-&gt;<a class="code" href="classQgsAspectFilter.html#a0c91a39f4a4ccf16be0aa117a8f6e048" title="Calculates output value from nine input values.">processNineCellWindow</a>( x1, x2, x3, x4, x5, x6, x7, x8, x9 );
<a name="l00338"></a>00338   <span class="keywordflow">if</span> ( hillShadeValue285 != <a class="code" href="classQgsRelief.html#a735945a50bb9adfa4d550a9c3568bd1d" title="The nodata value of the output layer.">mOutputNodataValue</a> &amp;&amp; aspect != <a class="code" href="classQgsRelief.html#a735945a50bb9adfa4d550a9c3568bd1d" title="The nodata value of the output layer.">mOutputNodataValue</a> )
<a name="l00339"></a>00339   {
<a name="l00340"></a>00340     <span class="keywordtype">double</span> angle_diff = qAbs( 285 - aspect );
<a name="l00341"></a>00341     <span class="keywordflow">if</span> ( angle_diff &gt; 180 )
<a name="l00342"></a>00342     {
<a name="l00343"></a>00343       angle_diff -= 180;
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346     <span class="keywordtype">int</span> r3, g3, b3;
<a name="l00347"></a>00347     <span class="keywordflow">if</span> ( angle_diff &lt; 90 )
<a name="l00348"></a>00348     {
<a name="l00349"></a>00349       <span class="keywordtype">int</span> aspectVal = ( 1 - cos( angle_diff * <a class="code" href="qgsdistancearea_8cpp.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a> / 180 ) ) * 255;
<a name="l00350"></a>00350       r3 = 0.5 * 255 + hillShadeValue315 * 0.5;
<a name="l00351"></a>00351       g3 = 0.5 * 255 + hillShadeValue315 * 0.5;
<a name="l00352"></a>00352       b3 = 0.5 * aspectVal + hillShadeValue315 * 0.5;
<a name="l00353"></a>00353     }
<a name="l00354"></a>00354     <span class="keywordflow">else</span> <span class="comment">//white</span>
<a name="l00355"></a>00355     {
<a name="l00356"></a>00356       r3 = 0.5 * 255 + hillShadeValue315 * 0.5;
<a name="l00357"></a>00357       g3 = 0.5 * 255 + hillShadeValue315 * 0.5;
<a name="l00358"></a>00358       b3 = 0.5 * 255 + hillShadeValue315 * 0.5;
<a name="l00359"></a>00359     }
<a name="l00360"></a>00360 
<a name="l00361"></a>00361     r = r3 * 0.1 + r * 0.9;
<a name="l00362"></a>00362     g = g3 * 0.1 + g * 0.9;
<a name="l00363"></a>00363     b = b3 * 0.1 + b * 0.9;
<a name="l00364"></a>00364   }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366   *red = ( <span class="keywordtype">unsigned</span> char )r;
<a name="l00367"></a>00367   *green = ( <span class="keywordtype">unsigned</span> char )g;
<a name="l00368"></a>00368   *blue = ( <span class="keywordtype">unsigned</span> char )b;
<a name="l00369"></a>00369   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00370"></a>00370 }
<a name="l00371"></a>00371 
<a name="l00372"></a><a class="code" href="classQgsRelief.html#a10512b7df4f601a466743ca59a590b6b">00372</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsRelief.html#a10512b7df4f601a466743ca59a590b6b" title="Set elevation color.">QgsRelief::setElevationColor</a>( <span class="keywordtype">double</span> elevation, <span class="keywordtype">int</span>* red, <span class="keywordtype">int</span>* green, <span class="keywordtype">int</span>* blue )
<a name="l00373"></a>00373 {
<a name="l00374"></a>00374   QList&lt; ReliefColor &gt;::const_iterator reliefColorIt =  <a class="code" href="classQgsRelief.html#ab3c622ef2066f1a93aa4d6f43950fca9">mReliefColors</a>.constBegin();
<a name="l00375"></a>00375   <span class="keywordflow">for</span> ( ; reliefColorIt != <a class="code" href="classQgsRelief.html#ab3c622ef2066f1a93aa4d6f43950fca9">mReliefColors</a>.constEnd(); ++reliefColorIt )
<a name="l00376"></a>00376   {
<a name="l00377"></a>00377     <span class="keywordflow">if</span> ( elevation &gt;= reliefColorIt-&gt;minElevation &amp;&amp; elevation &lt;= reliefColorIt-&gt;maxElevation )
<a name="l00378"></a>00378     {
<a name="l00379"></a>00379       <span class="keyword">const</span> QColor&amp; c = reliefColorIt-&gt;color;
<a name="l00380"></a>00380       *red = c.red();
<a name="l00381"></a>00381       *green = c.green();
<a name="l00382"></a>00382       *blue = c.blue();
<a name="l00383"></a>00383 
<a name="l00384"></a>00384       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00385"></a>00385     }
<a name="l00386"></a>00386   }
<a name="l00387"></a>00387   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00388"></a>00388 }
<a name="l00389"></a>00389 
<a name="l00390"></a>00390 <span class="comment">//duplicated from QgsNineCellFilter. Todo: make common base class</span>
<a name="l00391"></a><a class="code" href="classQgsRelief.html#a6b6805cc94d0f46d14b8851ee2b6996a">00391</a> GDALDatasetH <a class="code" href="classQgsRelief.html#a6b6805cc94d0f46d14b8851ee2b6996a" title="Opens the input file and returns the dataset handle and the number of pixels in x-/y- direction...">QgsRelief::openInputFile</a>( <span class="keywordtype">int</span>&amp; nCellsX, <span class="keywordtype">int</span>&amp; nCellsY )
<a name="l00392"></a>00392 {
<a name="l00393"></a>00393   GDALDatasetH inputDataset = GDALOpen( <a class="code" href="qgsrelief_8cpp.html#aa9757bc3fb1a21483651058539ebb565">TO8</a>( <a class="code" href="classQgsRelief.html#a0949f0c8c99e1c439f928ab8de9c2211">mInputFile</a> ), GA_ReadOnly );
<a name="l00394"></a>00394   <span class="keywordflow">if</span> ( inputDataset != NULL )
<a name="l00395"></a>00395   {
<a name="l00396"></a>00396     nCellsX = GDALGetRasterXSize( inputDataset );
<a name="l00397"></a>00397     nCellsY = GDALGetRasterYSize( inputDataset );
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     <span class="comment">//we need at least one band</span>
<a name="l00400"></a>00400     <span class="keywordflow">if</span> ( GDALGetRasterCount( inputDataset ) &lt; 1 )
<a name="l00401"></a>00401     {
<a name="l00402"></a>00402       GDALClose( inputDataset );
<a name="l00403"></a>00403       <span class="keywordflow">return</span> NULL;
<a name="l00404"></a>00404     }
<a name="l00405"></a>00405   }
<a name="l00406"></a>00406   <span class="keywordflow">return</span> inputDataset;
<a name="l00407"></a>00407 }
<a name="l00408"></a>00408 
<a name="l00409"></a><a class="code" href="classQgsRelief.html#a2d1bb6040ac5ced072c98daf48332e96">00409</a> GDALDriverH <a class="code" href="classQgsRelief.html#a2d1bb6040ac5ced072c98daf48332e96" title="Opens the output driver and tests if it supports the creation of a new dataset.">QgsRelief::openOutputDriver</a>()
<a name="l00410"></a>00410 {
<a name="l00411"></a>00411   <span class="keywordtype">char</span> **driverMetadata;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413   <span class="comment">//open driver</span>
<a name="l00414"></a>00414   GDALDriverH outputDriver = GDALGetDriverByName( <a class="code" href="classQgsRelief.html#a369f2c204e5ead377199f3e441df6e6b">mOutputFormat</a>.toLocal8Bit().data() );
<a name="l00415"></a>00415 
<a name="l00416"></a>00416   <span class="keywordflow">if</span> ( outputDriver == NULL )
<a name="l00417"></a>00417   {
<a name="l00418"></a>00418     <span class="keywordflow">return</span> outputDriver; <span class="comment">//return NULL, driver does not exist</span>
<a name="l00419"></a>00419   }
<a name="l00420"></a>00420 
<a name="l00421"></a>00421   driverMetadata = GDALGetMetadata( outputDriver, NULL );
<a name="l00422"></a>00422   <span class="keywordflow">if</span> ( !CSLFetchBoolean( driverMetadata, GDAL_DCAP_CREATE, <span class="keyword">false</span> ) )
<a name="l00423"></a>00423   {
<a name="l00424"></a>00424     <span class="keywordflow">return</span> NULL; <span class="comment">//driver exist, but it does not support the create operation</span>
<a name="l00425"></a>00425   }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427   <span class="keywordflow">return</span> outputDriver;
<a name="l00428"></a>00428 }
<a name="l00429"></a>00429 
<a name="l00430"></a><a class="code" href="classQgsRelief.html#a911547a99fbd8f7cdf216cb9d1ff876c">00430</a> GDALDatasetH <a class="code" href="classQgsRelief.html#a911547a99fbd8f7cdf216cb9d1ff876c" title="Opens the output file and sets the same geotransform and CRS as the input data.">QgsRelief::openOutputFile</a>( GDALDatasetH inputDataset, GDALDriverH outputDriver )
<a name="l00431"></a>00431 {
<a name="l00432"></a>00432   <span class="keywordflow">if</span> ( inputDataset == NULL )
<a name="l00433"></a>00433   {
<a name="l00434"></a>00434     <span class="keywordflow">return</span> NULL;
<a name="l00435"></a>00435   }
<a name="l00436"></a>00436 
<a name="l00437"></a>00437   <span class="keywordtype">int</span> xSize = GDALGetRasterXSize( inputDataset );
<a name="l00438"></a>00438   <span class="keywordtype">int</span> ySize = GDALGetRasterYSize( inputDataset );;
<a name="l00439"></a>00439 
<a name="l00440"></a>00440   <span class="comment">//open output file</span>
<a name="l00441"></a>00441   <span class="keywordtype">char</span> **papszOptions = NULL;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443   <span class="comment">//use PACKBITS compression for tiffs by default</span>
<a name="l00444"></a>00444   papszOptions = CSLSetNameValue( papszOptions, <span class="stringliteral">&quot;COMPRESS&quot;</span>, <span class="stringliteral">&quot;PACKBITS&quot;</span> );
<a name="l00445"></a>00445 
<a name="l00446"></a>00446   <span class="comment">//create three band raster (reg, green, blue)</span>
<a name="l00447"></a>00447   GDALDatasetH outputDataset = GDALCreate( outputDriver, <a class="code" href="classQgsRelief.html#a461b166a1de3391ae6531c438662f344">mOutputFile</a>.toLocal8Bit().data(), xSize, ySize, 3, GDT_Byte, papszOptions );
<a name="l00448"></a>00448   <span class="keywordflow">if</span> ( outputDataset == NULL )
<a name="l00449"></a>00449   {
<a name="l00450"></a>00450     <span class="keywordflow">return</span> outputDataset;
<a name="l00451"></a>00451   }
<a name="l00452"></a>00452 
<a name="l00453"></a>00453   <span class="comment">//get geotransform from inputDataset</span>
<a name="l00454"></a>00454   <span class="keywordtype">double</span> geotransform[6];
<a name="l00455"></a>00455   <span class="keywordflow">if</span> ( GDALGetGeoTransform( inputDataset, geotransform ) != CE_None )
<a name="l00456"></a>00456   {
<a name="l00457"></a>00457     GDALClose( outputDataset );
<a name="l00458"></a>00458     <span class="keywordflow">return</span> NULL;
<a name="l00459"></a>00459   }
<a name="l00460"></a>00460   GDALSetGeoTransform( outputDataset, geotransform );
<a name="l00461"></a>00461 
<a name="l00462"></a>00462   <span class="comment">//make sure mCellSizeX and mCellSizeY are always &gt; 0</span>
<a name="l00463"></a>00463   <a class="code" href="classQgsRelief.html#a8de7689744ce9ebeda3eec33b5f5770b">mCellSizeX</a> = geotransform[1];
<a name="l00464"></a>00464   <span class="keywordflow">if</span> ( <a class="code" href="classQgsRelief.html#a8de7689744ce9ebeda3eec33b5f5770b">mCellSizeX</a> &lt; 0 )
<a name="l00465"></a>00465   {
<a name="l00466"></a>00466     <a class="code" href="classQgsRelief.html#a8de7689744ce9ebeda3eec33b5f5770b">mCellSizeX</a> = -<a class="code" href="classQgsRelief.html#a8de7689744ce9ebeda3eec33b5f5770b">mCellSizeX</a>;
<a name="l00467"></a>00467   }
<a name="l00468"></a>00468   <a class="code" href="classQgsRelief.html#a45c276f9b6cc4bbe1167562751f78309">mCellSizeY</a> = geotransform[5];
<a name="l00469"></a>00469   <span class="keywordflow">if</span> ( <a class="code" href="classQgsRelief.html#a45c276f9b6cc4bbe1167562751f78309">mCellSizeY</a> &lt; 0 )
<a name="l00470"></a>00470   {
<a name="l00471"></a>00471     <a class="code" href="classQgsRelief.html#a45c276f9b6cc4bbe1167562751f78309">mCellSizeY</a> = -<a class="code" href="classQgsRelief.html#a45c276f9b6cc4bbe1167562751f78309">mCellSizeY</a>;
<a name="l00472"></a>00472   }
<a name="l00473"></a>00473 
<a name="l00474"></a>00474   <span class="keyword">const</span> <span class="keywordtype">char</span>* projection = GDALGetProjectionRef( inputDataset );
<a name="l00475"></a>00475   GDALSetProjection( outputDataset, projection );
<a name="l00476"></a>00476 
<a name="l00477"></a>00477   <span class="keywordflow">return</span> outputDataset;
<a name="l00478"></a>00478 }
<a name="l00479"></a>00479 
<a name="l00480"></a>00480 <span class="comment">//this function is mainly there for debugging</span>
<a name="l00481"></a><a class="code" href="classQgsRelief.html#a708e32ec211a7eee600c8ff7fa194b98">00481</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsRelief.html#a708e32ec211a7eee600c8ff7fa194b98" title="Write frequency of elevation values to file for manual inspection.">QgsRelief::exportFrequencyDistributionToCsv</a>( <span class="keyword">const</span> QString&amp; <a class="code" href="qgssvgcache_8cpp.html#a0e09ef09634c9ff8c49d989b80771a34">file</a> )
<a name="l00482"></a>00482 {
<a name="l00483"></a>00483   <span class="keywordtype">int</span> nCellsX, nCellsY;
<a name="l00484"></a>00484   GDALDatasetH inputDataset = <a class="code" href="classQgsRelief.html#a6b6805cc94d0f46d14b8851ee2b6996a" title="Opens the input file and returns the dataset handle and the number of pixels in x-/y- direction...">openInputFile</a>( nCellsX, nCellsY );
<a name="l00485"></a>00485   <span class="keywordflow">if</span> ( inputDataset == NULL )
<a name="l00486"></a>00486   {
<a name="l00487"></a>00487     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00488"></a>00488   }
<a name="l00489"></a>00489 
<a name="l00490"></a>00490   <span class="comment">//open first raster band for reading (elevation raster is always single band)</span>
<a name="l00491"></a>00491   GDALRasterBandH elevationBand = GDALGetRasterBand( inputDataset, 1 );
<a name="l00492"></a>00492   <span class="keywordflow">if</span> ( elevationBand == NULL )
<a name="l00493"></a>00493   {
<a name="l00494"></a>00494     GDALClose( inputDataset );
<a name="l00495"></a>00495     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00496"></a>00496   }
<a name="l00497"></a>00497 
<a name="l00498"></a>00498   <span class="comment">//1. get minimum and maximum of elevation raster -&gt; 252 elevation classes</span>
<a name="l00499"></a>00499   <span class="keywordtype">int</span> minOk, maxOk;
<a name="l00500"></a>00500   <span class="keywordtype">double</span> minMax[2];
<a name="l00501"></a>00501   minMax[0] = GDALGetRasterMinimum( elevationBand, &amp;minOk );
<a name="l00502"></a>00502   minMax[1] = GDALGetRasterMaximum( elevationBand, &amp;maxOk );
<a name="l00503"></a>00503 
<a name="l00504"></a>00504   <span class="keywordflow">if</span> ( !minOk || !maxOk )
<a name="l00505"></a>00505   {
<a name="l00506"></a>00506     GDALComputeRasterMinMax( elevationBand, TRUE, minMax );
<a name="l00507"></a>00507   }
<a name="l00508"></a>00508 
<a name="l00509"></a>00509   <span class="comment">//2. go through raster cells and get frequency of classes</span>
<a name="l00510"></a>00510 
<a name="l00511"></a>00511   <span class="comment">//store elevation frequency in 256 elevation classes</span>
<a name="l00512"></a>00512   <span class="keywordtype">double</span> frequency[252];
<a name="l00513"></a>00513   <span class="keywordtype">double</span> frequencyClassRange = ( minMax[1] - minMax[0] ) / 252.0;
<a name="l00514"></a>00514   <span class="comment">//initialize to zero</span>
<a name="l00515"></a>00515   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; 252; ++i )
<a name="l00516"></a>00516   {
<a name="l00517"></a>00517     frequency[i] = 0;
<a name="l00518"></a>00518   }
<a name="l00519"></a>00519 
<a name="l00520"></a>00520   <span class="keywordtype">float</span>* scanLine = ( <span class="keywordtype">float</span> * ) CPLMalloc( <span class="keyword">sizeof</span>( <span class="keywordtype">float</span> ) *  nCellsX );
<a name="l00521"></a>00521   <span class="keywordtype">int</span> elevationClass = -1;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; nCellsY; ++i )
<a name="l00524"></a>00524   {
<a name="l00525"></a>00525     GDALRasterIO( elevationBand, GF_Read, 0, i, nCellsX, 1,
<a name="l00526"></a>00526                   scanLine, nCellsX, 1, GDT_Float32,
<a name="l00527"></a>00527                   0, 0 );
<a name="l00528"></a>00528     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = 0; j &lt; nCellsX; ++j )
<a name="l00529"></a>00529     {
<a name="l00530"></a>00530       elevationClass = <a class="code" href="classQgsRelief.html#a2a0f73669804a3d4edfa3308352f8e7f" title="Returns class (0-255) for an elevation value.">frequencyClassForElevation</a>( scanLine[j], minMax[0], frequencyClassRange );
<a name="l00531"></a>00531       <span class="keywordflow">if</span> ( elevationClass &gt;= 0 )
<a name="l00532"></a>00532       {
<a name="l00533"></a>00533         frequency[elevationClass] += 1.0;
<a name="l00534"></a>00534       }
<a name="l00535"></a>00535     }
<a name="l00536"></a>00536   }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538   CPLFree( scanLine );
<a name="l00539"></a>00539 
<a name="l00540"></a>00540   <span class="comment">//log10 transformation for all frequency values</span>
<a name="l00541"></a>00541   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; 252; ++i )
<a name="l00542"></a>00542   {
<a name="l00543"></a>00543     frequency[i] = log10( frequency[i] );
<a name="l00544"></a>00544   }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546   <span class="comment">//write out frequency values to csv file for debugging</span>
<a name="l00547"></a>00547   QFile outFile( file );
<a name="l00548"></a>00548   <span class="keywordflow">if</span> ( !outFile.open( QIODevice::WriteOnly ) )
<a name="l00549"></a>00549   {
<a name="l00550"></a>00550     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00551"></a>00551   }
<a name="l00552"></a>00552 
<a name="l00553"></a>00553   QTextStream outstream( &amp;outFile );
<a name="l00554"></a>00554   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; 252; ++i )
<a name="l00555"></a>00555   {
<a name="l00556"></a>00556     outstream &lt;&lt; QString::number( i ) + <span class="stringliteral">&quot;,&quot;</span> + QString::number( frequency[i] ) &lt;&lt; endl;
<a name="l00557"></a>00557   }
<a name="l00558"></a>00558   outFile.close();
<a name="l00559"></a>00559   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00560"></a>00560 }
<a name="l00561"></a>00561 
<a name="l00562"></a><a class="code" href="classQgsRelief.html#abadf645f07b6d78970e1333a453ccdce">00562</a> QList&lt; QgsRelief::ReliefColor &gt; <a class="code" href="classQgsRelief.html#abadf645f07b6d78970e1333a453ccdce" title="Calculates class breaks according with the method of Buenzli (2011) using an iterative algorithm for ...">QgsRelief::calculateOptimizedReliefClasses</a>()
<a name="l00563"></a>00563 {
<a name="l00564"></a>00564   QList&lt; QgsRelief::ReliefColor &gt; resultList;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566   <span class="keywordtype">int</span> nCellsX, nCellsY;
<a name="l00567"></a>00567   GDALDatasetH inputDataset = <a class="code" href="classQgsRelief.html#a6b6805cc94d0f46d14b8851ee2b6996a" title="Opens the input file and returns the dataset handle and the number of pixels in x-/y- direction...">openInputFile</a>( nCellsX, nCellsY );
<a name="l00568"></a>00568   <span class="keywordflow">if</span> ( inputDataset == NULL )
<a name="l00569"></a>00569   {
<a name="l00570"></a>00570     <span class="keywordflow">return</span> resultList;
<a name="l00571"></a>00571   }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573   <span class="comment">//open first raster band for reading (elevation raster is always single band)</span>
<a name="l00574"></a>00574   GDALRasterBandH elevationBand = GDALGetRasterBand( inputDataset, 1 );
<a name="l00575"></a>00575   <span class="keywordflow">if</span> ( elevationBand == NULL )
<a name="l00576"></a>00576   {
<a name="l00577"></a>00577     GDALClose( inputDataset );
<a name="l00578"></a>00578     <span class="keywordflow">return</span> resultList;
<a name="l00579"></a>00579   }
<a name="l00580"></a>00580 
<a name="l00581"></a>00581   <span class="comment">//1. get minimum and maximum of elevation raster -&gt; 252 elevation classes</span>
<a name="l00582"></a>00582   <span class="keywordtype">int</span> minOk, maxOk;
<a name="l00583"></a>00583   <span class="keywordtype">double</span> minMax[2];
<a name="l00584"></a>00584   minMax[0] = GDALGetRasterMinimum( elevationBand, &amp;minOk );
<a name="l00585"></a>00585   minMax[1] = GDALGetRasterMaximum( elevationBand, &amp;maxOk );
<a name="l00586"></a>00586 
<a name="l00587"></a>00587   <span class="keywordflow">if</span> ( !minOk || !maxOk )
<a name="l00588"></a>00588   {
<a name="l00589"></a>00589     GDALComputeRasterMinMax( elevationBand, TRUE, minMax );
<a name="l00590"></a>00590   }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592   <span class="comment">//2. go through raster cells and get frequency of classes</span>
<a name="l00593"></a>00593 
<a name="l00594"></a>00594   <span class="comment">//store elevation frequency in 256 elevation classes</span>
<a name="l00595"></a>00595   <span class="keywordtype">double</span> frequency[252];
<a name="l00596"></a>00596   <span class="keywordtype">double</span> frequencyClassRange = ( minMax[1] - minMax[0] ) / 252.0;
<a name="l00597"></a>00597   <span class="comment">//initialize to zero</span>
<a name="l00598"></a>00598   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; 252; ++i )
<a name="l00599"></a>00599   {
<a name="l00600"></a>00600     frequency[i] = 0;
<a name="l00601"></a>00601   }
<a name="l00602"></a>00602 
<a name="l00603"></a>00603   <span class="keywordtype">float</span>* scanLine = ( <span class="keywordtype">float</span> * ) CPLMalloc( <span class="keyword">sizeof</span>( <span class="keywordtype">float</span> ) *  nCellsX );
<a name="l00604"></a>00604   <span class="keywordtype">int</span> elevationClass = -1;
<a name="l00605"></a>00605 
<a name="l00606"></a>00606   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; nCellsY; ++i )
<a name="l00607"></a>00607   {
<a name="l00608"></a>00608     GDALRasterIO( elevationBand, GF_Read, 0, i, nCellsX, 1,
<a name="l00609"></a>00609                   scanLine, nCellsX, 1, GDT_Float32,
<a name="l00610"></a>00610                   0, 0 );
<a name="l00611"></a>00611     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = 0; j &lt; nCellsX; ++j )
<a name="l00612"></a>00612     {
<a name="l00613"></a>00613       elevationClass = <a class="code" href="classQgsRelief.html#a2a0f73669804a3d4edfa3308352f8e7f" title="Returns class (0-255) for an elevation value.">frequencyClassForElevation</a>( scanLine[j], minMax[0], frequencyClassRange );
<a name="l00614"></a>00614       <span class="keywordflow">if</span> ( elevationClass &lt; 0 )
<a name="l00615"></a>00615       {
<a name="l00616"></a>00616         elevationClass = 0;
<a name="l00617"></a>00617       }
<a name="l00618"></a>00618       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( elevationClass &gt;= 252 )
<a name="l00619"></a>00619       {
<a name="l00620"></a>00620         elevationClass = 251;
<a name="l00621"></a>00621       }
<a name="l00622"></a>00622       frequency[elevationClass] += 1.0;
<a name="l00623"></a>00623     }
<a name="l00624"></a>00624   }
<a name="l00625"></a>00625 
<a name="l00626"></a>00626   CPLFree( scanLine );
<a name="l00627"></a>00627 
<a name="l00628"></a>00628   <span class="comment">//log10 transformation for all frequency values</span>
<a name="l00629"></a>00629   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; 252; ++i )
<a name="l00630"></a>00630   {
<a name="l00631"></a>00631     frequency[i] = log10( frequency[i] );
<a name="l00632"></a>00632   }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634   <span class="comment">//start with 9 uniformly distributed classes</span>
<a name="l00635"></a>00635   QList&lt;int&gt; classBreaks;
<a name="l00636"></a>00636   classBreaks.append( 0 );
<a name="l00637"></a>00637   classBreaks.append( 28 );
<a name="l00638"></a>00638   classBreaks.append( 56 );
<a name="l00639"></a>00639   classBreaks.append( 84 );
<a name="l00640"></a>00640   classBreaks.append( 112 );
<a name="l00641"></a>00641   classBreaks.append( 140 );
<a name="l00642"></a>00642   classBreaks.append( 168 );
<a name="l00643"></a>00643   classBreaks.append( 196 );
<a name="l00644"></a>00644   classBreaks.append( 224 );
<a name="l00645"></a>00645   classBreaks.append( 252 );
<a name="l00646"></a>00646 
<a name="l00647"></a>00647   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; 10; ++i )
<a name="l00648"></a>00648   {
<a name="l00649"></a>00649     <a class="code" href="classQgsRelief.html#a2dd60be041d1a5e500ed4de0b506beee" title="Do one iteration of class break optimisation (algorithm from Garcia and Rodriguez)">optimiseClassBreaks</a>( classBreaks, frequency );
<a name="l00650"></a>00650   }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652   <span class="comment">//debug, print out all the classbreaks</span>
<a name="l00653"></a>00653   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; classBreaks.size(); ++i )
<a name="l00654"></a>00654   {
<a name="l00655"></a>00655     qWarning( <span class="stringliteral">&quot;%d&quot;</span>, classBreaks[i] );
<a name="l00656"></a>00656   }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658   <span class="comment">//set colors according to optimised class breaks</span>
<a name="l00659"></a>00659   QList&lt;QColor&gt; colorList;
<a name="l00660"></a>00660   colorList.push_back( QColor( 7, 165, 144 ) );
<a name="l00661"></a>00661   colorList.push_back( QColor( 12, 221, 162 ) );
<a name="l00662"></a>00662   colorList.push_back( QColor( 33, 252, 183 ) );
<a name="l00663"></a>00663   colorList.push_back( QColor( 247, 252, 152 ) );
<a name="l00664"></a>00664   colorList.push_back( QColor( 252, 196, 8 ) );
<a name="l00665"></a>00665   colorList.push_back( QColor( 252, 166, 15 ) );
<a name="l00666"></a>00666   colorList.push_back( QColor( 175, 101, 15 ) );
<a name="l00667"></a>00667   colorList.push_back( QColor( 255, 133, 92 ) );
<a name="l00668"></a>00668   colorList.push_back( QColor( 204, 204, 204 ) );
<a name="l00669"></a>00669 
<a name="l00670"></a>00670   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 1; i &lt; classBreaks.size(); ++i )
<a name="l00671"></a>00671   {
<a name="l00672"></a>00672     <span class="keywordtype">double</span> minElevation = minMax[0] + classBreaks[i - 1] * frequencyClassRange;
<a name="l00673"></a>00673     <span class="keywordtype">double</span> maxElevation = minMax[0] + classBreaks[i] * frequencyClassRange;
<a name="l00674"></a>00674     resultList.push_back( <a class="code" href="structQgsRelief_1_1ReliefColor.html">QgsRelief::ReliefColor</a>( colorList.at( i - 1 ), minElevation, maxElevation ) );
<a name="l00675"></a>00675   }
<a name="l00676"></a>00676 
<a name="l00677"></a>00677   <span class="keywordflow">return</span> resultList;
<a name="l00678"></a>00678 }
<a name="l00679"></a>00679 
<a name="l00680"></a><a class="code" href="classQgsRelief.html#a2dd60be041d1a5e500ed4de0b506beee">00680</a> <span class="keywordtype">void</span> <a class="code" href="classQgsRelief.html#a2dd60be041d1a5e500ed4de0b506beee" title="Do one iteration of class break optimisation (algorithm from Garcia and Rodriguez)">QgsRelief::optimiseClassBreaks</a>( QList&lt;int&gt;&amp; breaks, <span class="keywordtype">double</span>* frequencies )
<a name="l00681"></a>00681 {
<a name="l00682"></a>00682   <span class="keywordtype">int</span> nClasses = breaks.size() - 1;
<a name="l00683"></a>00683   <span class="keywordtype">double</span>* a = <span class="keyword">new</span> <span class="keywordtype">double</span>[nClasses]; <span class="comment">//slopes</span>
<a name="l00684"></a>00684   <span class="keywordtype">double</span>* b = <span class="keyword">new</span> <span class="keywordtype">double</span>[nClasses]; <span class="comment">//y-offsets</span>
<a name="l00685"></a>00685 
<a name="l00686"></a>00686   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; nClasses; ++i )
<a name="l00687"></a>00687   {
<a name="l00688"></a>00688     <span class="comment">//get all the values between the class breaks into input</span>
<a name="l00689"></a>00689     QList&lt; QPair &lt; int, double &gt; &gt; regressionInput;
<a name="l00690"></a>00690     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = breaks.at( i ); j &lt; breaks.at( i + 1 ); ++j )
<a name="l00691"></a>00691     {
<a name="l00692"></a>00692       regressionInput.push_back( qMakePair( j, frequencies[j] ) );
<a name="l00693"></a>00693     }
<a name="l00694"></a>00694 
<a name="l00695"></a>00695     <span class="keywordtype">double</span> aParam, bParam;
<a name="l00696"></a>00696     <span class="keywordflow">if</span> ( regressionInput.size() &gt; 0 &amp;&amp; <a class="code" href="classQgsRelief.html#aa628c9392ada02817327c2ec5cf77928" title="Calculates coefficients a and b.">calculateRegression</a>( regressionInput, aParam, bParam ) )
<a name="l00697"></a>00697     {
<a name="l00698"></a>00698       a[i] = aParam;
<a name="l00699"></a>00699       b[i] = bParam;
<a name="l00700"></a>00700     }
<a name="l00701"></a>00701     <span class="keywordflow">else</span>
<a name="l00702"></a>00702     {
<a name="l00703"></a>00703       a[i] = 0;
<a name="l00704"></a>00704       b[i] = 0; <span class="comment">//better default value</span>
<a name="l00705"></a>00705     }
<a name="l00706"></a>00706   }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708   QList&lt;int&gt; classesToRemove;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710   <span class="comment">//shift class boundaries or eliminate classes which fall together</span>
<a name="l00711"></a>00711   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 1; i &lt; nClasses ; ++i )
<a name="l00712"></a>00712   {
<a name="l00713"></a>00713     <span class="keywordflow">if</span> ( breaks[i] == breaks[ i - 1 ] )
<a name="l00714"></a>00714     {
<a name="l00715"></a>00715       <span class="keywordflow">continue</span>;
<a name="l00716"></a>00716     }
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     <span class="keywordflow">if</span> ( <a class="code" href="qgis_8h.html#a14039c8aa54bda84192e28ecb298ed20">doubleNear</a>( a[i - 1 ], a[i] ) )
<a name="l00719"></a>00719     {
<a name="l00720"></a>00720       <span class="keywordflow">continue</span>;
<a name="l00721"></a>00721     }
<a name="l00722"></a>00722     <span class="keywordflow">else</span>
<a name="l00723"></a>00723     {
<a name="l00724"></a>00724       <span class="keywordtype">int</span> newX = ( b[i - 1] - b[ i ] ) / ( a[ i ] - a[ i - 1 ] );
<a name="l00725"></a>00725 
<a name="l00726"></a>00726       <span class="keywordflow">if</span> ( newX &lt;= breaks[i - 1] )
<a name="l00727"></a>00727       {
<a name="l00728"></a>00728         newX = breaks[i - 1];
<a name="l00729"></a>00729         <span class="comment">//  classesToRemove.push_back( i );//remove this class later as it falls together with the preceding one</span>
<a name="l00730"></a>00730       }
<a name="l00731"></a>00731       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( i &lt; nClasses - 1 &amp;&amp; newX &gt;= breaks[i + 1] )
<a name="l00732"></a>00732       {
<a name="l00733"></a>00733         newX = breaks[i + 1];
<a name="l00734"></a>00734         <span class="comment">//  classesToRemove.push_back( i );//remove this class later as it falls together with the next one</span>
<a name="l00735"></a>00735       }
<a name="l00736"></a>00736 
<a name="l00737"></a>00737       breaks[i] = newX;
<a name="l00738"></a>00738     }
<a name="l00739"></a>00739   }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = classesToRemove.size() - 1; i &gt;= 0; --i )
<a name="l00742"></a>00742   {
<a name="l00743"></a>00743     breaks.removeAt( classesToRemove.at( i ) );
<a name="l00744"></a>00744   }
<a name="l00745"></a>00745 
<a name="l00746"></a>00746   <span class="keyword">delete</span>[] a;
<a name="l00747"></a>00747   <span class="keyword">delete</span>[] b;
<a name="l00748"></a>00748 }
<a name="l00749"></a>00749 
<a name="l00750"></a><a class="code" href="classQgsRelief.html#a2a0f73669804a3d4edfa3308352f8e7f">00750</a> <span class="keywordtype">int</span> <a class="code" href="classQgsRelief.html#a2a0f73669804a3d4edfa3308352f8e7f" title="Returns class (0-255) for an elevation value.">QgsRelief::frequencyClassForElevation</a>( <span class="keywordtype">double</span> elevation, <span class="keywordtype">double</span> minElevation, <span class="keywordtype">double</span> elevationClassRange )
<a name="l00751"></a>00751 {
<a name="l00752"></a>00752   <span class="keywordflow">return</span> ( elevation - minElevation ) / elevationClassRange;
<a name="l00753"></a>00753 }
<a name="l00754"></a>00754 
<a name="l00755"></a><a class="code" href="classQgsRelief.html#aa628c9392ada02817327c2ec5cf77928">00755</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsRelief.html#aa628c9392ada02817327c2ec5cf77928" title="Calculates coefficients a and b.">QgsRelief::calculateRegression</a>( <span class="keyword">const</span> QList&lt; QPair &lt; int, double &gt; &gt;&amp; input, <span class="keywordtype">double</span>&amp; a, <span class="keywordtype">double</span>&amp; b )
<a name="l00756"></a>00756 {
<a name="l00757"></a>00757   <span class="keywordtype">double</span> xMean, yMean;
<a name="l00758"></a>00758   <span class="keywordtype">double</span> xSum = 0;
<a name="l00759"></a>00759   <span class="keywordtype">double</span> ySum = 0;
<a name="l00760"></a>00760   QList&lt; QPair &lt; int, double &gt; &gt;::const_iterator inputIt = input.constBegin();
<a name="l00761"></a>00761   <span class="keywordflow">for</span> ( ; inputIt != input.constEnd(); ++inputIt )
<a name="l00762"></a>00762   {
<a name="l00763"></a>00763     xSum += inputIt-&gt;first;
<a name="l00764"></a>00764     ySum += inputIt-&gt;second;
<a name="l00765"></a>00765   }
<a name="l00766"></a>00766   xMean = xSum / input.size();
<a name="l00767"></a>00767   yMean = ySum / input.size();
<a name="l00768"></a>00768 
<a name="l00769"></a>00769   <span class="keywordtype">double</span> sumCounter = 0;
<a name="l00770"></a>00770   <span class="keywordtype">double</span> sumDenominator = 0;
<a name="l00771"></a>00771   inputIt = input.constBegin();
<a name="l00772"></a>00772   <span class="keywordflow">for</span> ( ; inputIt != input.constEnd(); ++inputIt )
<a name="l00773"></a>00773   {
<a name="l00774"></a>00774     sumCounter += (( inputIt-&gt;first - xMean ) * ( inputIt-&gt;second - yMean ) );
<a name="l00775"></a>00775     sumDenominator += (( inputIt-&gt;first - xMean ) * ( inputIt-&gt;first - xMean ) );
<a name="l00776"></a>00776   }
<a name="l00777"></a>00777 
<a name="l00778"></a>00778   a = sumCounter / sumDenominator;
<a name="l00779"></a>00779   b = yMean - a * xMean;
<a name="l00780"></a>00780 
<a name="l00781"></a>00781   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00782"></a>00782 }
<a name="l00783"></a>00783 
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Tue Jun 19 2012 23:22:39 for Quantum GIS API Documentation by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
