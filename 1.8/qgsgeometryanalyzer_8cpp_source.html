<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Quantum GIS API Documentation: src/analysis/vector/qgsgeometryanalyzer.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Quantum GIS API Documentation
   &#160;<span id="projectnumber">1.8</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">src/analysis/vector/qgsgeometryanalyzer.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="qgsgeometryanalyzer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/***************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">    qgsgeometryanalyzer.cpp - QGIS Tools for vector geometry analysis</span>
<a name="l00003"></a>00003 <span class="comment">                             -------------------</span>
<a name="l00004"></a>00004 <span class="comment">    begin                : 19 March 2009</span>
<a name="l00005"></a>00005 <span class="comment">    copyright            : (C) Carson Farmer</span>
<a name="l00006"></a>00006 <span class="comment">    email                : carson.farmer@gmail.com</span>
<a name="l00007"></a>00007 <span class="comment"> ***************************************************************************/</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="comment">/***************************************************************************</span>
<a name="l00010"></a>00010 <span class="comment"> *                                                                         *</span>
<a name="l00011"></a>00011 <span class="comment"> *   This program is free software; you can redistribute it and/or modify  *</span>
<a name="l00012"></a>00012 <span class="comment"> *   it under the terms of the GNU General Public License as published by  *</span>
<a name="l00013"></a>00013 <span class="comment"> *   the Free Software Foundation; either version 2 of the License, or     *</span>
<a name="l00014"></a>00014 <span class="comment"> *   (at your option) any later version.                                   *</span>
<a name="l00015"></a>00015 <span class="comment"> *                                                                         *</span>
<a name="l00016"></a>00016 <span class="comment"> ***************************************************************************/</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="qgsgeometryanalyzer_8h.html">qgsgeometryanalyzer.h</a>&quot;</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="qgsapplication_8h.html">qgsapplication.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="qgsfield_8h.html">qgsfield.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="qgsfeature_8h.html">qgsfeature.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="qgslogger_8h.html">qgslogger.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="qgscoordinatereferencesystem_8h.html">qgscoordinatereferencesystem.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="qgsvectorfilewriter_8h.html">qgsvectorfilewriter.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="qgsvectordataprovider_8h.html">qgsvectordataprovider.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="qgsdistancearea_8h.html">qgsdistancearea.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;QProgressDialog&gt;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a><a class="code" href="classQgsGeometryAnalyzer.html#a6e7baa41f0e26dc35ba314c6b6b4dc23">00030</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsGeometryAnalyzer.html#a6e7baa41f0e26dc35ba314c6b6b4dc23" title="Simplify vector layer using (a modified) Douglas-Peucker algorithm and write it to a new shape file...">QgsGeometryAnalyzer::simplify</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* layer,
<a name="l00031"></a>00031                                     <span class="keyword">const</span> QString&amp; shapefileName,
<a name="l00032"></a>00032                                     <span class="keywordtype">double</span> tolerance,
<a name="l00033"></a>00033                                     <span class="keywordtype">bool</span> onlySelectedFeatures,
<a name="l00034"></a>00034                                     QProgressDialog *p )
<a name="l00035"></a>00035 {
<a name="l00036"></a>00036   <span class="keywordflow">if</span> ( !layer )
<a name="l00037"></a>00037   {
<a name="l00038"></a>00038     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00039"></a>00039   }
<a name="l00040"></a>00040 
<a name="l00041"></a>00041   <a class="code" href="classQgsVectorDataProvider.html" title="This is the base class for vector data providers.">QgsVectorDataProvider</a>* dp = layer-&gt;<a class="code" href="classQgsVectorLayer.html#ae3cfb88b9a03c1016e3ac1b79193e9eb" title="Returns the data provider.">dataProvider</a>();
<a name="l00042"></a>00042   <span class="keywordflow">if</span> ( !dp )
<a name="l00043"></a>00043   {
<a name="l00044"></a>00044     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00045"></a>00045   }
<a name="l00046"></a>00046 
<a name="l00047"></a>00047   <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7" title="Used for symbology operations.">QGis::WkbType</a> outputType = dp-&gt;<a class="code" href="classQgsVectorDataProvider.html#a2ec983a3d3ce9f67b2f3154d55c44a20" title="Get feature type.">geometryType</a>();
<a name="l00048"></a>00048   <span class="keyword">const</span> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> crs = layer-&gt;<a class="code" href="classQgsMapLayer.html#a40b79e2d6043f8ec316a28cb17febd6c" title="Returns layer&#39;s spatial reference system.">crs</a>();
<a name="l00049"></a>00049 
<a name="l00050"></a>00050   <a class="code" href="classQgsVectorFileWriter.html" title="A convenience class for writing vector files to disk.">QgsVectorFileWriter</a> vWriter( shapefileName, dp-&gt;<a class="code" href="classQgsVectorDataProvider.html#a628c5bd63c2bf0637ac4c676ecdb921e" title="Get encoding which is used for accessing data.">encoding</a>(), dp-&gt;<a class="code" href="classQgsVectorDataProvider.html#a920112de81372447a592c9c69ccec3af" title="Return a map of indexes with field names for this layer.">fields</a>(), outputType, &amp;crs );
<a name="l00051"></a>00051   <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a> currentFeature;
<a name="l00052"></a>00052 
<a name="l00053"></a>00053   <span class="comment">//take only selection</span>
<a name="l00054"></a>00054   <span class="keywordflow">if</span> ( onlySelectedFeatures )
<a name="l00055"></a>00055   {
<a name="l00056"></a>00056     <span class="comment">//use QgsVectorLayer::featureAtId</span>
<a name="l00057"></a>00057     <span class="keyword">const</span> <a class="code" href="qgsfeature_8h.html#a443917048a2ef75006fdeba30f1549f3">QgsFeatureIds</a> selection = layer-&gt;<a class="code" href="classQgsVectorLayer.html#a33968fa939503a9e3873c88e5f0ea439" title="Return reference to identifiers of selected features.">selectedFeaturesIds</a>();
<a name="l00058"></a>00058     <span class="keywordflow">if</span> ( p )
<a name="l00059"></a>00059     {
<a name="l00060"></a>00060       p-&gt;setMaximum( selection.size() );
<a name="l00061"></a>00061     }
<a name="l00062"></a>00062 
<a name="l00063"></a>00063     <span class="keywordtype">int</span> processedFeatures = 0;
<a name="l00064"></a>00064     QgsFeatureIds::const_iterator it = selection.constBegin();
<a name="l00065"></a>00065     <span class="keywordflow">for</span> ( ; it != selection.constEnd(); ++it )
<a name="l00066"></a>00066     {
<a name="l00067"></a>00067       <span class="keywordflow">if</span> ( p )
<a name="l00068"></a>00068       {
<a name="l00069"></a>00069         p-&gt;setValue( processedFeatures );
<a name="l00070"></a>00070       }
<a name="l00071"></a>00071 
<a name="l00072"></a>00072       <span class="keywordflow">if</span> ( p &amp;&amp; p-&gt;wasCanceled() )
<a name="l00073"></a>00073       {
<a name="l00074"></a>00074         <span class="keywordflow">break</span>;
<a name="l00075"></a>00075       }
<a name="l00076"></a>00076       <span class="keywordflow">if</span> ( !layer-&gt;<a class="code" href="classQgsVectorLayer.html#ad220999d6fd94bd84df8f2294cbbee8d" title="Gets the feature at the given feature id.">featureAtId</a>( *it, currentFeature, <span class="keyword">true</span>, <span class="keyword">true</span> ) )
<a name="l00077"></a>00077       {
<a name="l00078"></a>00078         <span class="keywordflow">continue</span>;
<a name="l00079"></a>00079       }
<a name="l00080"></a>00080       <a class="code" href="classQgsGeometryAnalyzer.html#a35080b76b5b8c691d65fd8cf5d5253d3" title="Helper function to simplify an individual feature.">simplifyFeature</a>( currentFeature, &amp;vWriter, tolerance );
<a name="l00081"></a>00081       ++processedFeatures;
<a name="l00082"></a>00082     }
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     <span class="keywordflow">if</span> ( p )
<a name="l00085"></a>00085     {
<a name="l00086"></a>00086       p-&gt;setValue( selection.size() );
<a name="l00087"></a>00087     }
<a name="l00088"></a>00088   }
<a name="l00089"></a>00089   <span class="comment">//take all features</span>
<a name="l00090"></a>00090   <span class="keywordflow">else</span>
<a name="l00091"></a>00091   {
<a name="l00092"></a>00092     layer-&gt;<a class="code" href="classQgsVectorLayer.html#aceacc5e071f1d1764dacc0b7fffbba05" title="Select features found within the search rectangle (in layer&#39;s coordinates)">select</a>( layer-&gt;<a class="code" href="classQgsVectorLayer.html#a34a108c859c2b36e1db810e44e66d3ee" title="returns list of attributes">pendingAllAttributesList</a>(), <a class="code" href="classQgsRectangle.html" title="A rectangle specified with double values.">QgsRectangle</a>(), <span class="keyword">true</span>, false );
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 
<a name="l00095"></a>00095     <span class="keywordtype">int</span> featureCount = layer-&gt;<a class="code" href="classQgsVectorLayer.html#a65286a9f1c393269cc392fbe539b37b0" title="Number of features in the layer.">featureCount</a>();
<a name="l00096"></a>00096     <span class="keywordflow">if</span> ( p )
<a name="l00097"></a>00097     {
<a name="l00098"></a>00098       p-&gt;setMaximum( featureCount );
<a name="l00099"></a>00099     }
<a name="l00100"></a>00100     <span class="keywordtype">int</span> processedFeatures = 0;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="keywordflow">while</span> ( layer-&gt;<a class="code" href="classQgsVectorLayer.html#a084f8ed91fb514b7424617f08ce3bd86" title="fetch a feature (after select)">nextFeature</a>( currentFeature ) )
<a name="l00103"></a>00103     {
<a name="l00104"></a>00104       <span class="keywordflow">if</span> ( p )
<a name="l00105"></a>00105       {
<a name="l00106"></a>00106         p-&gt;setValue( processedFeatures );
<a name="l00107"></a>00107       }
<a name="l00108"></a>00108       <span class="keywordflow">if</span> ( p &amp;&amp; p-&gt;wasCanceled() )
<a name="l00109"></a>00109       {
<a name="l00110"></a>00110         <span class="keywordflow">break</span>;
<a name="l00111"></a>00111       }
<a name="l00112"></a>00112       <a class="code" href="classQgsGeometryAnalyzer.html#a35080b76b5b8c691d65fd8cf5d5253d3" title="Helper function to simplify an individual feature.">simplifyFeature</a>( currentFeature, &amp;vWriter, tolerance );
<a name="l00113"></a>00113       ++processedFeatures;
<a name="l00114"></a>00114     }
<a name="l00115"></a>00115     <span class="keywordflow">if</span> ( p )
<a name="l00116"></a>00116     {
<a name="l00117"></a>00117       p-&gt;setValue( featureCount );
<a name="l00118"></a>00118     }
<a name="l00119"></a>00119   }
<a name="l00120"></a>00120 
<a name="l00121"></a>00121   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00122"></a>00122 }
<a name="l00123"></a>00123 
<a name="l00124"></a><a class="code" href="classQgsGeometryAnalyzer.html#a35080b76b5b8c691d65fd8cf5d5253d3">00124</a> <span class="keywordtype">void</span> <a class="code" href="classQgsGeometryAnalyzer.html#a35080b76b5b8c691d65fd8cf5d5253d3" title="Helper function to simplify an individual feature.">QgsGeometryAnalyzer::simplifyFeature</a>( <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a>&amp; f, <a class="code" href="classQgsVectorFileWriter.html" title="A convenience class for writing vector files to disk.">QgsVectorFileWriter</a>* vfw, <span class="keywordtype">double</span> tolerance )
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* featureGeometry = f.<a class="code" href="classQgsFeature.html#ab0a934a1b173ce5ad8d13363c20ef3c8" title="Get the geometry object associated with this feature.">geometry</a>();
<a name="l00127"></a>00127   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* tmpGeometry = 0;
<a name="l00128"></a>00128 
<a name="l00129"></a>00129   <span class="keywordflow">if</span> ( !featureGeometry )
<a name="l00130"></a>00130   {
<a name="l00131"></a>00131     <span class="keywordflow">return</span>;
<a name="l00132"></a>00132   }
<a name="l00133"></a>00133   <span class="comment">// simplify feature</span>
<a name="l00134"></a>00134   tmpGeometry = featureGeometry-&gt;<a class="code" href="classQgsGeometry.html#a6dea8a83050425a46ce1dd7126fdbcb6" title="Returns a simplified version of this geometry using a specified tolerance value.">simplify</a>( tolerance );
<a name="l00135"></a>00135 
<a name="l00136"></a>00136   <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a> newFeature;
<a name="l00137"></a>00137   newFeature.<a class="code" href="classQgsFeature.html#ad7755f8310da090b047025a1d58a93d8" title="Set this feature&#39;s geometry from another QgsGeometry object (deep copy)">setGeometry</a>( tmpGeometry );
<a name="l00138"></a>00138   newFeature.<a class="code" href="classQgsFeature.html#abdb279c388c10ec7d7b585f185a21da6" title="Sets all the attributes in one go.">setAttributeMap</a>( f.<a class="code" href="classQgsFeature.html#ad80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>() );
<a name="l00139"></a>00139 
<a name="l00140"></a>00140   <span class="comment">//add it to vector file writer</span>
<a name="l00141"></a>00141   <span class="keywordflow">if</span> ( vfw )
<a name="l00142"></a>00142   {
<a name="l00143"></a>00143     vfw-&gt;<a class="code" href="classQgsVectorFileWriter.html#a93e126f3ed1ddf9bc012d0c53b868a9c" title="add feature to the currently opened shapefile">addFeature</a>( newFeature );
<a name="l00144"></a>00144   }
<a name="l00145"></a>00145 }
<a name="l00146"></a>00146 
<a name="l00147"></a><a class="code" href="classQgsGeometryAnalyzer.html#ae0dd15048a6dc600d90ae89cb8ae0bf7">00147</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsGeometryAnalyzer.html#ae0dd15048a6dc600d90ae89cb8ae0bf7" title="Calculate the true centroids, or &#39;center of mass&#39; for a vector layer and write it to a new shape file...">QgsGeometryAnalyzer::centroids</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* layer, <span class="keyword">const</span> QString&amp; shapefileName,
<a name="l00148"></a>00148                                      <span class="keywordtype">bool</span> onlySelectedFeatures, QProgressDialog* p )
<a name="l00149"></a>00149 {
<a name="l00150"></a>00150   <span class="keywordflow">if</span> ( !layer )
<a name="l00151"></a>00151   {
<a name="l00152"></a>00152     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;No layer passed to centroids&quot;</span> );
<a name="l00153"></a>00153     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00154"></a>00154   }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156   <a class="code" href="classQgsVectorDataProvider.html" title="This is the base class for vector data providers.">QgsVectorDataProvider</a>* dp = layer-&gt;<a class="code" href="classQgsVectorLayer.html#ae3cfb88b9a03c1016e3ac1b79193e9eb" title="Returns the data provider.">dataProvider</a>();
<a name="l00157"></a>00157   <span class="keywordflow">if</span> ( !dp )
<a name="l00158"></a>00158   {
<a name="l00159"></a>00159     <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;No data provider for layer passed to centroids&quot;</span> );
<a name="l00160"></a>00160     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00161"></a>00161   }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163   <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7" title="Used for symbology operations.">QGis::WkbType</a> outputType = <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7a6157604e3e81d9220b734a552dc32123">QGis::WKBPoint</a>;
<a name="l00164"></a>00164   <span class="keyword">const</span> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> crs = layer-&gt;<a class="code" href="classQgsMapLayer.html#a40b79e2d6043f8ec316a28cb17febd6c" title="Returns layer&#39;s spatial reference system.">crs</a>();
<a name="l00165"></a>00165 
<a name="l00166"></a>00166   <a class="code" href="classQgsVectorFileWriter.html" title="A convenience class for writing vector files to disk.">QgsVectorFileWriter</a> vWriter( shapefileName, dp-&gt;<a class="code" href="classQgsVectorDataProvider.html#a628c5bd63c2bf0637ac4c676ecdb921e" title="Get encoding which is used for accessing data.">encoding</a>(), dp-&gt;<a class="code" href="classQgsVectorDataProvider.html#a920112de81372447a592c9c69ccec3af" title="Return a map of indexes with field names for this layer.">fields</a>(), outputType, &amp;crs );
<a name="l00167"></a>00167   <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a> currentFeature;
<a name="l00168"></a>00168 
<a name="l00169"></a>00169   <span class="comment">//take only selection</span>
<a name="l00170"></a>00170   <span class="keywordflow">if</span> ( onlySelectedFeatures )
<a name="l00171"></a>00171   {
<a name="l00172"></a>00172     <span class="comment">//use QgsVectorLayer::featureAtId</span>
<a name="l00173"></a>00173     <span class="keyword">const</span> <a class="code" href="qgsfeature_8h.html#a443917048a2ef75006fdeba30f1549f3">QgsFeatureIds</a> selection = layer-&gt;<a class="code" href="classQgsVectorLayer.html#a33968fa939503a9e3873c88e5f0ea439" title="Return reference to identifiers of selected features.">selectedFeaturesIds</a>();
<a name="l00174"></a>00174     <span class="keywordflow">if</span> ( p )
<a name="l00175"></a>00175     {
<a name="l00176"></a>00176       p-&gt;setMaximum( selection.size() );
<a name="l00177"></a>00177     }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     <span class="keywordtype">int</span> processedFeatures = 0;
<a name="l00180"></a>00180     QgsFeatureIds::const_iterator it = selection.constBegin();
<a name="l00181"></a>00181     <span class="keywordflow">for</span> ( ; it != selection.constEnd(); ++it )
<a name="l00182"></a>00182     {
<a name="l00183"></a>00183       <span class="keywordflow">if</span> ( p )
<a name="l00184"></a>00184       {
<a name="l00185"></a>00185         p-&gt;setValue( processedFeatures );
<a name="l00186"></a>00186       }
<a name="l00187"></a>00187 
<a name="l00188"></a>00188       <span class="keywordflow">if</span> ( p &amp;&amp; p-&gt;wasCanceled() )
<a name="l00189"></a>00189       {
<a name="l00190"></a>00190         <span class="keywordflow">break</span>;
<a name="l00191"></a>00191       }
<a name="l00192"></a>00192       <span class="keywordflow">if</span> ( !layer-&gt;<a class="code" href="classQgsVectorLayer.html#ad220999d6fd94bd84df8f2294cbbee8d" title="Gets the feature at the given feature id.">featureAtId</a>( *it, currentFeature, <span class="keyword">true</span>, <span class="keyword">true</span> ) )
<a name="l00193"></a>00193       {
<a name="l00194"></a>00194         <span class="keywordflow">continue</span>;
<a name="l00195"></a>00195       }
<a name="l00196"></a>00196       <a class="code" href="classQgsGeometryAnalyzer.html#a7fde56b73b2ff700294fbabd97384c8b" title="Helper function to get the cetroid of an individual feature.">centroidFeature</a>( currentFeature, &amp;vWriter );
<a name="l00197"></a>00197       ++processedFeatures;
<a name="l00198"></a>00198     }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     <span class="keywordflow">if</span> ( p )
<a name="l00201"></a>00201     {
<a name="l00202"></a>00202       p-&gt;setValue( selection.size() );
<a name="l00203"></a>00203     }
<a name="l00204"></a>00204   }
<a name="l00205"></a>00205   <span class="comment">//take all features</span>
<a name="l00206"></a>00206   <span class="keywordflow">else</span>
<a name="l00207"></a>00207   {
<a name="l00208"></a>00208     layer-&gt;<a class="code" href="classQgsVectorLayer.html#aceacc5e071f1d1764dacc0b7fffbba05" title="Select features found within the search rectangle (in layer&#39;s coordinates)">select</a>( layer-&gt;<a class="code" href="classQgsVectorLayer.html#a34a108c859c2b36e1db810e44e66d3ee" title="returns list of attributes">pendingAllAttributesList</a>(), <a class="code" href="classQgsRectangle.html" title="A rectangle specified with double values.">QgsRectangle</a>(), <span class="keyword">true</span>, false );
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="keywordtype">int</span> featureCount = layer-&gt;<a class="code" href="classQgsVectorLayer.html#a65286a9f1c393269cc392fbe539b37b0" title="Number of features in the layer.">featureCount</a>();
<a name="l00211"></a>00211     <span class="keywordflow">if</span> ( p )
<a name="l00212"></a>00212     {
<a name="l00213"></a>00213       p-&gt;setMaximum( featureCount );
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215     <span class="keywordtype">int</span> processedFeatures = 0;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     <span class="keywordflow">while</span> ( layer-&gt;<a class="code" href="classQgsVectorLayer.html#a084f8ed91fb514b7424617f08ce3bd86" title="fetch a feature (after select)">nextFeature</a>( currentFeature ) )
<a name="l00218"></a>00218     {
<a name="l00219"></a>00219       <span class="keywordflow">if</span> ( p )
<a name="l00220"></a>00220       {
<a name="l00221"></a>00221         p-&gt;setValue( processedFeatures );
<a name="l00222"></a>00222       }
<a name="l00223"></a>00223       <span class="keywordflow">if</span> ( p &amp;&amp; p-&gt;wasCanceled() )
<a name="l00224"></a>00224       {
<a name="l00225"></a>00225         <span class="keywordflow">break</span>;
<a name="l00226"></a>00226       }
<a name="l00227"></a>00227       <a class="code" href="classQgsGeometryAnalyzer.html#a7fde56b73b2ff700294fbabd97384c8b" title="Helper function to get the cetroid of an individual feature.">centroidFeature</a>( currentFeature, &amp;vWriter );
<a name="l00228"></a>00228       ++processedFeatures;
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230     <span class="keywordflow">if</span> ( p )
<a name="l00231"></a>00231     {
<a name="l00232"></a>00232       p-&gt;setValue( featureCount );
<a name="l00233"></a>00233     }
<a name="l00234"></a>00234   }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 
<a name="l00240"></a><a class="code" href="classQgsGeometryAnalyzer.html#a7fde56b73b2ff700294fbabd97384c8b">00240</a> <span class="keywordtype">void</span> <a class="code" href="classQgsGeometryAnalyzer.html#a7fde56b73b2ff700294fbabd97384c8b" title="Helper function to get the cetroid of an individual feature.">QgsGeometryAnalyzer::centroidFeature</a>( <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a>&amp; f, <a class="code" href="classQgsVectorFileWriter.html" title="A convenience class for writing vector files to disk.">QgsVectorFileWriter</a>* vfw )
<a name="l00241"></a>00241 {
<a name="l00242"></a>00242   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* featureGeometry = f.<a class="code" href="classQgsFeature.html#ab0a934a1b173ce5ad8d13363c20ef3c8" title="Get the geometry object associated with this feature.">geometry</a>();
<a name="l00243"></a>00243   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* tmpGeometry = 0;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245   <span class="keywordflow">if</span> ( !featureGeometry )
<a name="l00246"></a>00246   {
<a name="l00247"></a>00247     <span class="keywordflow">return</span>;
<a name="l00248"></a>00248   }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250   tmpGeometry = featureGeometry-&gt;<a class="code" href="classQgsGeometry.html#ab6724dc35795363a9e1e9bb2ea459612" title="Returns the center of mass of a geometry.">centroid</a>();
<a name="l00251"></a>00251 
<a name="l00252"></a>00252   <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a> newFeature;
<a name="l00253"></a>00253   newFeature.<a class="code" href="classQgsFeature.html#ad7755f8310da090b047025a1d58a93d8" title="Set this feature&#39;s geometry from another QgsGeometry object (deep copy)">setGeometry</a>( tmpGeometry );
<a name="l00254"></a>00254   newFeature.<a class="code" href="classQgsFeature.html#abdb279c388c10ec7d7b585f185a21da6" title="Sets all the attributes in one go.">setAttributeMap</a>( f.<a class="code" href="classQgsFeature.html#ad80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>() );
<a name="l00255"></a>00255 
<a name="l00256"></a>00256   <span class="comment">//add it to vector file writer</span>
<a name="l00257"></a>00257   <span class="keywordflow">if</span> ( vfw )
<a name="l00258"></a>00258   {
<a name="l00259"></a>00259     vfw-&gt;<a class="code" href="classQgsVectorFileWriter.html#a93e126f3ed1ddf9bc012d0c53b868a9c" title="add feature to the currently opened shapefile">addFeature</a>( newFeature );
<a name="l00260"></a>00260   }
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00263"></a><a class="code" href="classQgsGeometryAnalyzer.html#aa395cae71216d2b73c06124011462f4f">00263</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsGeometryAnalyzer.html#aa395cae71216d2b73c06124011462f4f" title="Create a polygon based on the extent of all (selected) features and write it to a new shape file...">QgsGeometryAnalyzer::extent</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* layer,
<a name="l00264"></a>00264                                   <span class="keyword">const</span> QString&amp; shapefileName,
<a name="l00265"></a>00265                                   <span class="keywordtype">bool</span> onlySelectedFeatures,
<a name="l00266"></a>00266                                   QProgressDialog * )
<a name="l00267"></a>00267 {
<a name="l00268"></a>00268   <span class="keywordflow">if</span> ( !layer )
<a name="l00269"></a>00269   {
<a name="l00270"></a>00270     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00271"></a>00271   }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273   <a class="code" href="classQgsVectorDataProvider.html" title="This is the base class for vector data providers.">QgsVectorDataProvider</a>* dp = layer-&gt;<a class="code" href="classQgsVectorLayer.html#ae3cfb88b9a03c1016e3ac1b79193e9eb" title="Returns the data provider.">dataProvider</a>();
<a name="l00274"></a>00274   <span class="keywordflow">if</span> ( !dp )
<a name="l00275"></a>00275   {
<a name="l00276"></a>00276     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00277"></a>00277   }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279   <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7" title="Used for symbology operations.">QGis::WkbType</a> outputType = <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7aa2ed4d1a4578480a4b49ac21e9eef851">QGis::WKBPolygon</a>;
<a name="l00280"></a>00280   <span class="keyword">const</span> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> crs = layer-&gt;<a class="code" href="classQgsMapLayer.html#a40b79e2d6043f8ec316a28cb17febd6c" title="Returns layer&#39;s spatial reference system.">crs</a>();
<a name="l00281"></a>00281 
<a name="l00282"></a>00282   <a class="code" href="qgsfield_8h.html#aacd5afec301c03ed9499abb2bad2554b">QgsFieldMap</a> fields;
<a name="l00283"></a>00283   fields.insert( 0 , <a class="code" href="classQgsField.html" title="Encapsulate a field in an attribute table or data source.">QgsField</a>( QString( <span class="stringliteral">&quot;MINX&quot;</span> ), QVariant::Double ) );
<a name="l00284"></a>00284   fields.insert( 1 , <a class="code" href="classQgsField.html" title="Encapsulate a field in an attribute table or data source.">QgsField</a>( QString( <span class="stringliteral">&quot;MINY&quot;</span> ), QVariant::Double ) );
<a name="l00285"></a>00285   fields.insert( 2 , <a class="code" href="classQgsField.html" title="Encapsulate a field in an attribute table or data source.">QgsField</a>( QString( <span class="stringliteral">&quot;MAXX&quot;</span> ), QVariant::Double ) );
<a name="l00286"></a>00286   fields.insert( 3 , <a class="code" href="classQgsField.html" title="Encapsulate a field in an attribute table or data source.">QgsField</a>( QString( <span class="stringliteral">&quot;MAXY&quot;</span> ), QVariant::Double ) );
<a name="l00287"></a>00287   fields.insert( 4 , <a class="code" href="classQgsField.html" title="Encapsulate a field in an attribute table or data source.">QgsField</a>( QString( <span class="stringliteral">&quot;CNTX&quot;</span> ), QVariant::Double ) );
<a name="l00288"></a>00288   fields.insert( 5 , <a class="code" href="classQgsField.html" title="Encapsulate a field in an attribute table or data source.">QgsField</a>( QString( <span class="stringliteral">&quot;CNTY&quot;</span> ), QVariant::Double ) );
<a name="l00289"></a>00289   fields.insert( 6 , <a class="code" href="classQgsField.html" title="Encapsulate a field in an attribute table or data source.">QgsField</a>( QString( <span class="stringliteral">&quot;AREA&quot;</span> ), QVariant::Double ) );
<a name="l00290"></a>00290   fields.insert( 7 , <a class="code" href="classQgsField.html" title="Encapsulate a field in an attribute table or data source.">QgsField</a>( QString( <span class="stringliteral">&quot;PERIM&quot;</span> ), QVariant::Double ) );
<a name="l00291"></a>00291   fields.insert( 8 , <a class="code" href="classQgsField.html" title="Encapsulate a field in an attribute table or data source.">QgsField</a>( QString( <span class="stringliteral">&quot;HEIGHT&quot;</span> ), QVariant::Double ) );
<a name="l00292"></a>00292   fields.insert( 9 , <a class="code" href="classQgsField.html" title="Encapsulate a field in an attribute table or data source.">QgsField</a>( QString( <span class="stringliteral">&quot;WIDTH&quot;</span> ), QVariant::Double ) );
<a name="l00293"></a>00293 
<a name="l00294"></a>00294   <a class="code" href="classQgsVectorFileWriter.html" title="A convenience class for writing vector files to disk.">QgsVectorFileWriter</a> vWriter( shapefileName, dp-&gt;<a class="code" href="classQgsVectorDataProvider.html#a628c5bd63c2bf0637ac4c676ecdb921e" title="Get encoding which is used for accessing data.">encoding</a>(), fields, outputType, &amp;crs );
<a name="l00295"></a>00295 
<a name="l00296"></a>00296   <a class="code" href="classQgsRectangle.html" title="A rectangle specified with double values.">QgsRectangle</a> rect;
<a name="l00297"></a>00297   <span class="keywordflow">if</span> ( onlySelectedFeatures )  <span class="comment">// take only selection</span>
<a name="l00298"></a>00298   {
<a name="l00299"></a>00299     rect = layer-&gt;<a class="code" href="classQgsVectorLayer.html#afab88de9cef9ee231092d394372317d2" title="Returns the bounding box of the selected features.">boundingBoxOfSelected</a>();
<a name="l00300"></a>00300   }
<a name="l00301"></a>00301   <span class="keywordflow">else</span>
<a name="l00302"></a>00302   {
<a name="l00303"></a>00303     rect = layer-&gt;<a class="code" href="classQgsMapLayer.html#afb7f38d9f0f67019476595295191e376" title="Return the extent of the layer as a QRect.">extent</a>();
<a name="l00304"></a>00304   }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306   <span class="keywordtype">double</span> minx = rect.<a class="code" href="classQgsRectangle.html#a949306e7574f826db80100bb3c6bcc18" title="Get the x minimum value (left side of rectangle)">xMinimum</a>();
<a name="l00307"></a>00307   <span class="keywordtype">double</span> miny = rect.yMinimum();
<a name="l00308"></a>00308   <span class="keywordtype">double</span> maxx = rect.xMaximum();
<a name="l00309"></a>00309   <span class="keywordtype">double</span> maxy = rect.yMaximum();
<a name="l00310"></a>00310   <span class="keywordtype">double</span> height = rect.height();
<a name="l00311"></a>00311   <span class="keywordtype">double</span> width = rect.width();
<a name="l00312"></a>00312   <span class="keywordtype">double</span> cntx = minx + ( width / 2.0 );
<a name="l00313"></a>00313   <span class="keywordtype">double</span> cnty = miny + ( height / 2.0 );
<a name="l00314"></a>00314   <span class="keywordtype">double</span> area = width * height;
<a name="l00315"></a>00315   <span class="keywordtype">double</span> perim = ( 2 * width ) + ( 2 * height );
<a name="l00316"></a>00316 
<a name="l00317"></a>00317   <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a> feat;
<a name="l00318"></a>00318   <a class="code" href="qgsfeature_8h.html#a54fb9a5ab4cfae301a0415ce490f08c8">QgsAttributeMap</a> map;
<a name="l00319"></a>00319   map.insert( 0 , QVariant( minx ) );
<a name="l00320"></a>00320   map.insert( 1 , QVariant( miny ) );
<a name="l00321"></a>00321   map.insert( 2 , QVariant( maxx ) );
<a name="l00322"></a>00322   map.insert( 3 , QVariant( maxy ) );
<a name="l00323"></a>00323   map.insert( 4 , QVariant( cntx ) );
<a name="l00324"></a>00324   map.insert( 5 , QVariant( cnty ) );
<a name="l00325"></a>00325   map.insert( 6 , QVariant( area ) );
<a name="l00326"></a>00326   map.insert( 7 , QVariant( perim ) );
<a name="l00327"></a>00327   map.insert( 8 , QVariant( height ) );
<a name="l00328"></a>00328   map.insert( 9 , QVariant( width ) );
<a name="l00329"></a>00329   feat.<a class="code" href="classQgsFeature.html#abdb279c388c10ec7d7b585f185a21da6" title="Sets all the attributes in one go.">setAttributeMap</a>( map );
<a name="l00330"></a>00330   feat.<a class="code" href="classQgsFeature.html#ad7755f8310da090b047025a1d58a93d8" title="Set this feature&#39;s geometry from another QgsGeometry object (deep copy)">setGeometry</a>( <a class="code" href="classQgsGeometry.html#a20a8cb3e1c114251f109fd472603b6e1" title="construct geometry from a rectangle">QgsGeometry::fromRect</a>( rect ) );
<a name="l00331"></a>00331   vWriter.addFeature( feat );
<a name="l00332"></a>00332   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00333"></a>00333 }
<a name="l00334"></a>00334 
<a name="l00335"></a><a class="code" href="classQgsGeometryAnalyzer.html#a32f39740f4de6a1426bd4dbd6f67252f">00335</a> QList&lt;double&gt; <a class="code" href="classQgsGeometryAnalyzer.html#a32f39740f4de6a1426bd4dbd6f67252f">QgsGeometryAnalyzer::simpleMeasure</a>( <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* mpGeometry )
<a name="l00336"></a>00336 {
<a name="l00337"></a>00337   QList&lt;double&gt; list;
<a name="l00338"></a>00338   <span class="keywordtype">double</span> perim;
<a name="l00339"></a>00339   <span class="keywordflow">if</span> ( mpGeometry-&gt;<a class="code" href="classQgsGeometry.html#a80c7ac7af6255e29ad492dbb14747cf8" title="Returns type of wkb (point / linestring / polygon etc.)">wkbType</a>() == <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7a6157604e3e81d9220b734a552dc32123">QGis::WKBPoint</a> )
<a name="l00340"></a>00340   {
<a name="l00341"></a>00341     <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> pt = mpGeometry-&gt;<a class="code" href="classQgsGeometry.html#aaa5c5bcb5113ebf7d25d6e858266b2de" title="return contents of the geometry as a point if wkbType is WKBPoint, otherwise returns [0...">asPoint</a>();
<a name="l00342"></a>00342     list.append( pt.<a class="code" href="classQgsPoint.html#a14cf4897a06313074760383398ee95d5">x</a>() );
<a name="l00343"></a>00343     list.append( pt.<a class="code" href="classQgsPoint.html#a07bd042b697bab243f4be31358d943ad">y</a>() );
<a name="l00344"></a>00344   }
<a name="l00345"></a>00345   <span class="keywordflow">else</span>
<a name="l00346"></a>00346   {
<a name="l00347"></a>00347     <a class="code" href="classQgsDistanceArea.html" title="General purpose distance and area calculator.">QgsDistanceArea</a> measure;
<a name="l00348"></a>00348     list.append( measure.<a class="code" href="classQgsDistanceArea.html#a43534b97b21240376398ff4116e599d2" title="general measurement (line distance or polygon area)">measure</a>( mpGeometry ) );
<a name="l00349"></a>00349     <span class="keywordflow">if</span> ( mpGeometry-&gt;<a class="code" href="classQgsGeometry.html#ad57348e8a59d162a8a24226aa319d7f6" title="Returns type of the vector.">type</a>() == <a class="code" href="classQGis.html#a09947eb19394302eeeed44d3e81dd74bab4c5ba16ad4d29832d3abbc6398d195b">QGis::Polygon</a> )
<a name="l00350"></a>00350     {
<a name="l00351"></a>00351       perim = <a class="code" href="classQgsGeometryAnalyzer.html#aff5f5712ced3185e691e603648f8e946">perimeterMeasure</a>( mpGeometry, measure );
<a name="l00352"></a>00352       list.append( perim );
<a name="l00353"></a>00353     }
<a name="l00354"></a>00354   }
<a name="l00355"></a>00355   <span class="keywordflow">return</span> list;
<a name="l00356"></a>00356 }
<a name="l00357"></a>00357 
<a name="l00358"></a><a class="code" href="classQgsGeometryAnalyzer.html#aff5f5712ced3185e691e603648f8e946">00358</a> <span class="keywordtype">double</span> <a class="code" href="classQgsGeometryAnalyzer.html#aff5f5712ced3185e691e603648f8e946">QgsGeometryAnalyzer::perimeterMeasure</a>( <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* geometry, <a class="code" href="classQgsDistanceArea.html" title="General purpose distance and area calculator.">QgsDistanceArea</a>&amp; measure )
<a name="l00359"></a>00359 {
<a name="l00360"></a>00360   <span class="keywordtype">double</span> value = 0.00;
<a name="l00361"></a>00361   <span class="keywordflow">if</span> ( geometry-&gt;<a class="code" href="classQgsGeometry.html#a5c8a7b96d8658e98c5ecf62c8369fcdc" title="Returns true if wkb of the geometry is of WKBMulti* type.">isMultipart</a>() )
<a name="l00362"></a>00362   {
<a name="l00363"></a>00363     <a class="code" href="qgsgeometry_8h.html#a69a3b9d8fd323f6bd99315f31fe492bc" title="a collection of QgsPolygons that share a common collection of attributes">QgsMultiPolygon</a> poly = geometry-&gt;<a class="code" href="classQgsGeometry.html#a512cd6713e09d9ce156f1d195c0a8521" title="return contents of the geometry as a multi polygon if wkbType is WKBMultiPolygon, otherwise an empty ...">asMultiPolygon</a>();
<a name="l00364"></a>00364     QgsMultiPolygon::iterator it;
<a name="l00365"></a>00365     QgsPolygon::iterator jt;
<a name="l00366"></a>00366     <span class="keywordflow">for</span> ( it = poly.begin(); it != poly.end(); ++it )
<a name="l00367"></a>00367     {
<a name="l00368"></a>00368       <span class="keywordflow">for</span> ( jt = it-&gt;begin(); jt != it-&gt;end(); ++jt )
<a name="l00369"></a>00369       {
<a name="l00370"></a>00370         value = value + measure.<a class="code" href="classQgsDistanceArea.html#a43534b97b21240376398ff4116e599d2" title="general measurement (line distance or polygon area)">measure</a>( <a class="code" href="classQgsGeometry.html#aaf37e56d2d11b652051048c86b8f41e7" title="construct geometry from a polyline">QgsGeometry::fromPolyline</a>( *jt ) );
<a name="l00371"></a>00371       }
<a name="l00372"></a>00372     }
<a name="l00373"></a>00373   }
<a name="l00374"></a>00374   <span class="keywordflow">else</span>
<a name="l00375"></a>00375   {
<a name="l00376"></a>00376     QgsPolygon::iterator jt;
<a name="l00377"></a>00377     <a class="code" href="qgsgeometry_8h.html#a43c20a08a2bcd6845d5c88898901f2a3" title="polygon: first item of the list is outer ring, inner rings (if any) start from second item...">QgsPolygon</a> poly = geometry-&gt;<a class="code" href="classQgsGeometry.html#aa0db69177f37e1c931be0292fb488908" title="return contents of the geometry as a polygon if wkbType is WKBPolygon, otherwise an empty list...">asPolygon</a>();
<a name="l00378"></a>00378     <span class="keywordflow">for</span> ( jt = poly.begin(); jt != poly.end(); ++jt )
<a name="l00379"></a>00379     {
<a name="l00380"></a>00380       value = value + measure.<a class="code" href="classQgsDistanceArea.html#a43534b97b21240376398ff4116e599d2" title="general measurement (line distance or polygon area)">measure</a>( <a class="code" href="classQgsGeometry.html#aaf37e56d2d11b652051048c86b8f41e7" title="construct geometry from a polyline">QgsGeometry::fromPolyline</a>( *jt ) );
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382   }
<a name="l00383"></a>00383   <span class="keywordflow">return</span> value;
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 
<a name="l00386"></a><a class="code" href="classQgsGeometryAnalyzer.html#a5f4aa2c48a03ed890f30f502dc450ad4">00386</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsGeometryAnalyzer.html#a5f4aa2c48a03ed890f30f502dc450ad4" title="Create convex hull(s) of a vector layer and write it to a new shape file.">QgsGeometryAnalyzer::convexHull</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* layer, <span class="keyword">const</span> QString&amp; shapefileName,
<a name="l00387"></a>00387                                       <span class="keywordtype">bool</span> onlySelectedFeatures, <span class="keywordtype">int</span> uniqueIdField, QProgressDialog* p )
<a name="l00388"></a>00388 {
<a name="l00389"></a>00389   <span class="keywordflow">if</span> ( !layer )
<a name="l00390"></a>00390   {
<a name="l00391"></a>00391     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00392"></a>00392   }
<a name="l00393"></a>00393   <a class="code" href="classQgsVectorDataProvider.html" title="This is the base class for vector data providers.">QgsVectorDataProvider</a>* dp = layer-&gt;<a class="code" href="classQgsVectorLayer.html#ae3cfb88b9a03c1016e3ac1b79193e9eb" title="Returns the data provider.">dataProvider</a>();
<a name="l00394"></a>00394   <span class="keywordflow">if</span> ( !dp )
<a name="l00395"></a>00395   {
<a name="l00396"></a>00396     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00397"></a>00397   }
<a name="l00398"></a>00398   <span class="keywordtype">bool</span> useField = <span class="keyword">false</span>;
<a name="l00399"></a>00399   <span class="keywordflow">if</span> ( uniqueIdField == -1 )
<a name="l00400"></a>00400   {
<a name="l00401"></a>00401     uniqueIdField = 0;
<a name="l00402"></a>00402   }
<a name="l00403"></a>00403   <span class="keywordflow">else</span>
<a name="l00404"></a>00404   {
<a name="l00405"></a>00405     useField = <span class="keyword">true</span>;
<a name="l00406"></a>00406   }
<a name="l00407"></a>00407   <a class="code" href="qgsfield_8h.html#aacd5afec301c03ed9499abb2bad2554b">QgsFieldMap</a> fields;
<a name="l00408"></a>00408   fields.insert( 0 , <a class="code" href="classQgsField.html" title="Encapsulate a field in an attribute table or data source.">QgsField</a>( QString( <span class="stringliteral">&quot;UID&quot;</span> ), QVariant::String ) );
<a name="l00409"></a>00409   fields.insert( 1 , <a class="code" href="classQgsField.html" title="Encapsulate a field in an attribute table or data source.">QgsField</a>( QString( <span class="stringliteral">&quot;AREA&quot;</span> ), QVariant::Double ) );
<a name="l00410"></a>00410   fields.insert( 2 , <a class="code" href="classQgsField.html" title="Encapsulate a field in an attribute table or data source.">QgsField</a>( QString( <span class="stringliteral">&quot;PERIM&quot;</span> ), QVariant::Double ) );
<a name="l00411"></a>00411 
<a name="l00412"></a>00412   <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7" title="Used for symbology operations.">QGis::WkbType</a> outputType = <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7aa2ed4d1a4578480a4b49ac21e9eef851">QGis::WKBPolygon</a>;
<a name="l00413"></a>00413   <span class="keyword">const</span> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> crs = layer-&gt;<a class="code" href="classQgsMapLayer.html#a40b79e2d6043f8ec316a28cb17febd6c" title="Returns layer&#39;s spatial reference system.">crs</a>();
<a name="l00414"></a>00414 
<a name="l00415"></a>00415   <a class="code" href="classQgsVectorFileWriter.html" title="A convenience class for writing vector files to disk.">QgsVectorFileWriter</a> vWriter( shapefileName, dp-&gt;<a class="code" href="classQgsVectorDataProvider.html#a628c5bd63c2bf0637ac4c676ecdb921e" title="Get encoding which is used for accessing data.">encoding</a>(), fields, outputType, &amp;crs );
<a name="l00416"></a>00416   <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a> currentFeature;
<a name="l00417"></a>00417   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* dissolveGeometry = 0; <span class="comment">//dissolve geometry</span>
<a name="l00418"></a>00418   QMultiMap&lt;QString, QgsFeatureId&gt; map;
<a name="l00419"></a>00419 
<a name="l00420"></a>00420   <span class="keywordflow">if</span> ( onlySelectedFeatures )
<a name="l00421"></a>00421   {
<a name="l00422"></a>00422     <span class="comment">//use QgsVectorLayer::featureAtId</span>
<a name="l00423"></a>00423     <span class="keyword">const</span> <a class="code" href="qgsfeature_8h.html#a443917048a2ef75006fdeba30f1549f3">QgsFeatureIds</a> selection = layer-&gt;<a class="code" href="classQgsVectorLayer.html#a33968fa939503a9e3873c88e5f0ea439" title="Return reference to identifiers of selected features.">selectedFeaturesIds</a>();
<a name="l00424"></a>00424     QgsFeatureIds::const_iterator it = selection.constBegin();
<a name="l00425"></a>00425     <span class="keywordflow">for</span> ( ; it != selection.constEnd(); ++it )
<a name="l00426"></a>00426     {
<a name="l00427"></a>00427 <span class="preprocessor">#if 0</span>
<a name="l00428"></a>00428 <span class="preprocessor"></span>      <span class="keywordflow">if</span> ( p )
<a name="l00429"></a>00429       {
<a name="l00430"></a>00430         p-&gt;setValue( processedFeatures );
<a name="l00431"></a>00431       }
<a name="l00432"></a>00432       <span class="keywordflow">if</span> ( p &amp;&amp; p-&gt;wasCanceled() )
<a name="l00433"></a>00433       {
<a name="l00434"></a>00434         <span class="comment">// break; // it may be better to do something else here?</span>
<a name="l00435"></a>00435         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00436"></a>00436       }
<a name="l00437"></a>00437 <span class="preprocessor">#endif</span>
<a name="l00438"></a>00438 <span class="preprocessor"></span>      <span class="keywordflow">if</span> ( !layer-&gt;<a class="code" href="classQgsVectorLayer.html#ad220999d6fd94bd84df8f2294cbbee8d" title="Gets the feature at the given feature id.">featureAtId</a>( *it, currentFeature, <span class="keyword">true</span>, <span class="keyword">true</span> ) )
<a name="l00439"></a>00439       {
<a name="l00440"></a>00440         <span class="keywordflow">continue</span>;
<a name="l00441"></a>00441       }
<a name="l00442"></a>00442       map.insert( currentFeature.attributeMap()[ uniqueIdField ].toString(), currentFeature.id() );
<a name="l00443"></a>00443     }
<a name="l00444"></a>00444   }
<a name="l00445"></a>00445   <span class="keywordflow">else</span>
<a name="l00446"></a>00446   {
<a name="l00447"></a>00447     layer-&gt;<a class="code" href="classQgsVectorLayer.html#aceacc5e071f1d1764dacc0b7fffbba05" title="Select features found within the search rectangle (in layer&#39;s coordinates)">select</a>( layer-&gt;<a class="code" href="classQgsVectorLayer.html#a34a108c859c2b36e1db810e44e66d3ee" title="returns list of attributes">pendingAllAttributesList</a>(), <a class="code" href="classQgsRectangle.html" title="A rectangle specified with double values.">QgsRectangle</a>(), <span class="keyword">true</span>, false );
<a name="l00448"></a>00448     <span class="keywordflow">while</span> ( layer-&gt;<a class="code" href="classQgsVectorLayer.html#a084f8ed91fb514b7424617f08ce3bd86" title="fetch a feature (after select)">nextFeature</a>( currentFeature ) )
<a name="l00449"></a>00449     {
<a name="l00450"></a>00450 <span class="preprocessor">#if 0</span>
<a name="l00451"></a>00451 <span class="preprocessor"></span>      <span class="keywordflow">if</span> ( p )
<a name="l00452"></a>00452       {
<a name="l00453"></a>00453         p-&gt;setValue( processedFeatures );
<a name="l00454"></a>00454       }
<a name="l00455"></a>00455       <span class="keywordflow">if</span> ( p &amp;&amp; p-&gt;wasCanceled() )
<a name="l00456"></a>00456       {
<a name="l00457"></a>00457         <span class="comment">// break; // it may be better to do something else here?</span>
<a name="l00458"></a>00458         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00459"></a>00459       }
<a name="l00460"></a>00460 <span class="preprocessor">#endif</span>
<a name="l00461"></a>00461 <span class="preprocessor"></span>      map.insert( currentFeature.attributeMap()[ uniqueIdField ].toString(), currentFeature.id() );
<a name="l00462"></a>00462     }
<a name="l00463"></a>00463   }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465   QMultiMap&lt;QString, QgsFeatureId&gt;::const_iterator jt = map.constBegin();
<a name="l00466"></a>00466   <span class="keywordflow">while</span> ( jt != map.constEnd() )
<a name="l00467"></a>00467   {
<a name="l00468"></a>00468     QString currentKey = jt.key();
<a name="l00469"></a>00469     <span class="keywordtype">int</span> processedFeatures = 0;
<a name="l00470"></a>00470     <span class="comment">//take only selection</span>
<a name="l00471"></a>00471     <span class="keywordflow">if</span> ( onlySelectedFeatures )
<a name="l00472"></a>00472     {
<a name="l00473"></a>00473       <span class="comment">//use QgsVectorLayer::featureAtId</span>
<a name="l00474"></a>00474       <span class="keyword">const</span> <a class="code" href="qgsfeature_8h.html#a443917048a2ef75006fdeba30f1549f3">QgsFeatureIds</a> selection = layer-&gt;<a class="code" href="classQgsVectorLayer.html#a33968fa939503a9e3873c88e5f0ea439" title="Return reference to identifiers of selected features.">selectedFeaturesIds</a>();
<a name="l00475"></a>00475       <span class="keywordflow">if</span> ( p )
<a name="l00476"></a>00476       {
<a name="l00477"></a>00477         p-&gt;setMaximum( selection.size() );
<a name="l00478"></a>00478       }
<a name="l00479"></a>00479       processedFeatures = 0;
<a name="l00480"></a>00480       <span class="keywordflow">while</span> ( jt != map.constEnd() &amp;&amp; ( jt.key() == currentKey || !useField ) )
<a name="l00481"></a>00481       {
<a name="l00482"></a>00482         <span class="keywordflow">if</span> ( p &amp;&amp; p-&gt;wasCanceled() )
<a name="l00483"></a>00483         {
<a name="l00484"></a>00484           <span class="keywordflow">break</span>;
<a name="l00485"></a>00485         }
<a name="l00486"></a>00486         <span class="keywordflow">if</span> ( selection.contains( jt.value() ) )
<a name="l00487"></a>00487         {
<a name="l00488"></a>00488           <span class="keywordflow">if</span> ( p )
<a name="l00489"></a>00489           {
<a name="l00490"></a>00490             p-&gt;setValue( processedFeatures );
<a name="l00491"></a>00491           }
<a name="l00492"></a>00492           <span class="keywordflow">if</span> ( !layer-&gt;<a class="code" href="classQgsVectorLayer.html#ad220999d6fd94bd84df8f2294cbbee8d" title="Gets the feature at the given feature id.">featureAtId</a>( jt.value(), currentFeature, <span class="keyword">true</span>, true ) )
<a name="l00493"></a>00493           {
<a name="l00494"></a>00494             <span class="keywordflow">continue</span>;
<a name="l00495"></a>00495           }
<a name="l00496"></a>00496           <a class="code" href="classQgsGeometryAnalyzer.html#a3e292184494052b5e7ab7b49470a57de" title="Helper function to get the convex hull of feature(s)">convexFeature</a>( currentFeature, processedFeatures, &amp;dissolveGeometry );
<a name="l00497"></a>00497           ++processedFeatures;
<a name="l00498"></a>00498         }
<a name="l00499"></a>00499         ++jt;
<a name="l00500"></a>00500       }
<a name="l00501"></a>00501       QList&lt;double&gt; values;
<a name="l00502"></a>00502       <span class="keywordflow">if</span> ( !dissolveGeometry )
<a name="l00503"></a>00503       {
<a name="l00504"></a>00504         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;no dissolved geometry - should not happen&quot;</span> );
<a name="l00505"></a>00505         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00506"></a>00506       }
<a name="l00507"></a>00507       dissolveGeometry = dissolveGeometry-&gt;<a class="code" href="classQgsGeometry.html#a0cf0d95366ae2a1fb305a59742c35e12" title="Returns the smallest convex polygon that contains all the points in the geometry.">convexHull</a>();
<a name="l00508"></a>00508       values = <a class="code" href="classQgsGeometryAnalyzer.html#a32f39740f4de6a1426bd4dbd6f67252f">simpleMeasure</a>( dissolveGeometry );
<a name="l00509"></a>00509       <a class="code" href="qgsfeature_8h.html#a54fb9a5ab4cfae301a0415ce490f08c8">QgsAttributeMap</a> attributeMap;
<a name="l00510"></a>00510       attributeMap.insert( 0 , QVariant( currentKey ) );
<a name="l00511"></a>00511       attributeMap.insert( 1 , values[ 0 ] );
<a name="l00512"></a>00512       attributeMap.insert( 2 , values[ 1 ] );
<a name="l00513"></a>00513       <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a> <a class="code" href="classQgsGeometryAnalyzer.html#a3d48458711e19ea1dba8cb0e305c09c0" title="Helper function to dissolve feature(s)">dissolveFeature</a>;
<a name="l00514"></a>00514       dissolveFeature.<a class="code" href="classQgsFeature.html#abdb279c388c10ec7d7b585f185a21da6" title="Sets all the attributes in one go.">setAttributeMap</a>( attributeMap );
<a name="l00515"></a>00515       dissolveFeature.<a class="code" href="classQgsFeature.html#ad7755f8310da090b047025a1d58a93d8" title="Set this feature&#39;s geometry from another QgsGeometry object (deep copy)">setGeometry</a>( dissolveGeometry );
<a name="l00516"></a>00516       vWriter.addFeature( dissolveFeature );
<a name="l00517"></a>00517     }
<a name="l00518"></a>00518     <span class="comment">//take all features</span>
<a name="l00519"></a>00519     <span class="keywordflow">else</span>
<a name="l00520"></a>00520     {
<a name="l00521"></a>00521       <span class="keywordtype">int</span> featureCount = layer-&gt;<a class="code" href="classQgsVectorLayer.html#a65286a9f1c393269cc392fbe539b37b0" title="Number of features in the layer.">featureCount</a>();
<a name="l00522"></a>00522       <span class="keywordflow">if</span> ( p )
<a name="l00523"></a>00523       {
<a name="l00524"></a>00524         p-&gt;setMaximum( featureCount );
<a name="l00525"></a>00525       }
<a name="l00526"></a>00526       processedFeatures = 0;
<a name="l00527"></a>00527       <span class="keywordflow">while</span> ( jt != map.constEnd() &amp;&amp; ( jt.key() == currentKey || !useField ) )
<a name="l00528"></a>00528       {
<a name="l00529"></a>00529         <span class="keywordflow">if</span> ( p )
<a name="l00530"></a>00530         {
<a name="l00531"></a>00531           p-&gt;setValue( processedFeatures );
<a name="l00532"></a>00532         }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534         <span class="keywordflow">if</span> ( p &amp;&amp; p-&gt;wasCanceled() )
<a name="l00535"></a>00535         {
<a name="l00536"></a>00536           <span class="keywordflow">break</span>;
<a name="l00537"></a>00537         }
<a name="l00538"></a>00538         <span class="keywordflow">if</span> ( !layer-&gt;<a class="code" href="classQgsVectorLayer.html#ad220999d6fd94bd84df8f2294cbbee8d" title="Gets the feature at the given feature id.">featureAtId</a>( jt.value(), currentFeature, <span class="keyword">true</span>, true ) )
<a name="l00539"></a>00539         {
<a name="l00540"></a>00540           <span class="keywordflow">continue</span>;
<a name="l00541"></a>00541         }
<a name="l00542"></a>00542         <a class="code" href="classQgsGeometryAnalyzer.html#a3e292184494052b5e7ab7b49470a57de" title="Helper function to get the convex hull of feature(s)">convexFeature</a>( currentFeature, processedFeatures, &amp;dissolveGeometry );
<a name="l00543"></a>00543         ++processedFeatures;
<a name="l00544"></a>00544         ++jt;
<a name="l00545"></a>00545       }
<a name="l00546"></a>00546       QList&lt;double&gt; values;
<a name="l00547"></a>00547       <span class="comment">// QgsGeometry* tmpGeometry = 0;</span>
<a name="l00548"></a>00548       <span class="keywordflow">if</span> ( !dissolveGeometry )
<a name="l00549"></a>00549       {
<a name="l00550"></a>00550         <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;no dissolved geometry - should not happen&quot;</span> );
<a name="l00551"></a>00551         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00552"></a>00552       }
<a name="l00553"></a>00553       dissolveGeometry = dissolveGeometry-&gt;<a class="code" href="classQgsGeometry.html#a0cf0d95366ae2a1fb305a59742c35e12" title="Returns the smallest convex polygon that contains all the points in the geometry.">convexHull</a>();
<a name="l00554"></a>00554       <span class="comment">// values = simpleMeasure( tmpGeometry );</span>
<a name="l00555"></a>00555       values = <a class="code" href="classQgsGeometryAnalyzer.html#a32f39740f4de6a1426bd4dbd6f67252f">simpleMeasure</a>( dissolveGeometry );
<a name="l00556"></a>00556       <a class="code" href="qgsfeature_8h.html#a54fb9a5ab4cfae301a0415ce490f08c8">QgsAttributeMap</a> attributeMap;
<a name="l00557"></a>00557       attributeMap.insert( 0 , QVariant( currentKey ) );
<a name="l00558"></a>00558       attributeMap.insert( 1 , QVariant( values[ 0 ] ) );
<a name="l00559"></a>00559       attributeMap.insert( 2 , QVariant( values[ 1 ] ) );
<a name="l00560"></a>00560       <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a> <a class="code" href="classQgsGeometryAnalyzer.html#a3d48458711e19ea1dba8cb0e305c09c0" title="Helper function to dissolve feature(s)">dissolveFeature</a>;
<a name="l00561"></a>00561       dissolveFeature.<a class="code" href="classQgsFeature.html#abdb279c388c10ec7d7b585f185a21da6" title="Sets all the attributes in one go.">setAttributeMap</a>( attributeMap );
<a name="l00562"></a>00562       dissolveFeature.<a class="code" href="classQgsFeature.html#ad7755f8310da090b047025a1d58a93d8" title="Set this feature&#39;s geometry from another QgsGeometry object (deep copy)">setGeometry</a>( dissolveGeometry );
<a name="l00563"></a>00563       vWriter.addFeature( dissolveFeature );
<a name="l00564"></a>00564     }
<a name="l00565"></a>00565   }
<a name="l00566"></a>00566   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00567"></a>00567 }
<a name="l00568"></a>00568 
<a name="l00569"></a>00569 
<a name="l00570"></a><a class="code" href="classQgsGeometryAnalyzer.html#a3e292184494052b5e7ab7b49470a57de">00570</a> <span class="keywordtype">void</span> <a class="code" href="classQgsGeometryAnalyzer.html#a3e292184494052b5e7ab7b49470a57de" title="Helper function to get the convex hull of feature(s)">QgsGeometryAnalyzer::convexFeature</a>( <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a>&amp; f, <span class="keywordtype">int</span> nProcessedFeatures, <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>** dissolveGeometry )
<a name="l00571"></a>00571 {
<a name="l00572"></a>00572   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* featureGeometry = f.<a class="code" href="classQgsFeature.html#ab0a934a1b173ce5ad8d13363c20ef3c8" title="Get the geometry object associated with this feature.">geometry</a>();
<a name="l00573"></a>00573   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* tmpGeometry = 0;
<a name="l00574"></a>00574   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* convexGeometry = 0;
<a name="l00575"></a>00575 
<a name="l00576"></a>00576   <span class="keywordflow">if</span> ( !featureGeometry )
<a name="l00577"></a>00577   {
<a name="l00578"></a>00578     <span class="keywordflow">return</span>;
<a name="l00579"></a>00579   }
<a name="l00580"></a>00580 
<a name="l00581"></a>00581   convexGeometry = featureGeometry-&gt;<a class="code" href="classQgsGeometry.html#a0cf0d95366ae2a1fb305a59742c35e12" title="Returns the smallest convex polygon that contains all the points in the geometry.">convexHull</a>();
<a name="l00582"></a>00582 
<a name="l00583"></a>00583   <span class="keywordflow">if</span> ( nProcessedFeatures == 0 )
<a name="l00584"></a>00584   {
<a name="l00585"></a>00585     *dissolveGeometry = convexGeometry;
<a name="l00586"></a>00586   }
<a name="l00587"></a>00587   <span class="keywordflow">else</span>
<a name="l00588"></a>00588   {
<a name="l00589"></a>00589     tmpGeometry = *dissolveGeometry;
<a name="l00590"></a>00590     *dissolveGeometry = ( *dissolveGeometry )-&gt;<a class="code" href="classQgsGeometry.html#a63244d3435cc99794b82a6cbd0af0eb5" title="Returns a geometry representing all the points in this geometry and other (a union geometry operation...">combine</a>( convexGeometry );
<a name="l00591"></a>00591     <span class="keyword">delete</span> tmpGeometry;
<a name="l00592"></a>00592     <span class="keyword">delete</span> convexGeometry;
<a name="l00593"></a>00593   }
<a name="l00594"></a>00594 }
<a name="l00595"></a>00595 
<a name="l00596"></a><a class="code" href="classQgsGeometryAnalyzer.html#a53d54803e5ce52c5147a8fc9640b8fc5">00596</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsGeometryAnalyzer.html#a53d54803e5ce52c5147a8fc9640b8fc5" title="Dissolve a vector layer and write it to a new shape file.">QgsGeometryAnalyzer::dissolve</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* layer, <span class="keyword">const</span> QString&amp; shapefileName,
<a name="l00597"></a>00597                                     <span class="keywordtype">bool</span> onlySelectedFeatures, <span class="keywordtype">int</span> uniqueIdField, QProgressDialog* p )
<a name="l00598"></a>00598 {
<a name="l00599"></a>00599   <span class="keywordflow">if</span> ( !layer )
<a name="l00600"></a>00600   {
<a name="l00601"></a>00601     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00602"></a>00602   }
<a name="l00603"></a>00603   <a class="code" href="classQgsVectorDataProvider.html" title="This is the base class for vector data providers.">QgsVectorDataProvider</a>* dp = layer-&gt;<a class="code" href="classQgsVectorLayer.html#ae3cfb88b9a03c1016e3ac1b79193e9eb" title="Returns the data provider.">dataProvider</a>();
<a name="l00604"></a>00604   <span class="keywordflow">if</span> ( !dp )
<a name="l00605"></a>00605   {
<a name="l00606"></a>00606     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00607"></a>00607   }
<a name="l00608"></a>00608   <span class="keywordtype">bool</span> useField = <span class="keyword">false</span>;
<a name="l00609"></a>00609   <span class="keywordflow">if</span> ( uniqueIdField == -1 )
<a name="l00610"></a>00610   {
<a name="l00611"></a>00611     uniqueIdField = 0;
<a name="l00612"></a>00612   }
<a name="l00613"></a>00613   <span class="keywordflow">else</span>
<a name="l00614"></a>00614   {
<a name="l00615"></a>00615     useField = <span class="keyword">true</span>;
<a name="l00616"></a>00616   }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618   <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7" title="Used for symbology operations.">QGis::WkbType</a> outputType = dp-&gt;<a class="code" href="classQgsVectorDataProvider.html#a2ec983a3d3ce9f67b2f3154d55c44a20" title="Get feature type.">geometryType</a>();
<a name="l00619"></a>00619   <span class="keyword">const</span> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> crs = layer-&gt;<a class="code" href="classQgsMapLayer.html#a40b79e2d6043f8ec316a28cb17febd6c" title="Returns layer&#39;s spatial reference system.">crs</a>();
<a name="l00620"></a>00620 
<a name="l00621"></a>00621   <a class="code" href="classQgsVectorFileWriter.html" title="A convenience class for writing vector files to disk.">QgsVectorFileWriter</a> vWriter( shapefileName, dp-&gt;<a class="code" href="classQgsVectorDataProvider.html#a628c5bd63c2bf0637ac4c676ecdb921e" title="Get encoding which is used for accessing data.">encoding</a>(), dp-&gt;<a class="code" href="classQgsVectorDataProvider.html#a920112de81372447a592c9c69ccec3af" title="Return a map of indexes with field names for this layer.">fields</a>(), outputType, &amp;crs );
<a name="l00622"></a>00622   <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a> currentFeature;
<a name="l00623"></a>00623   QMultiMap&lt;QString, QgsFeatureId&gt; map;
<a name="l00624"></a>00624 
<a name="l00625"></a>00625   <span class="keywordflow">if</span> ( onlySelectedFeatures )
<a name="l00626"></a>00626   {
<a name="l00627"></a>00627     <span class="comment">//use QgsVectorLayer::featureAtId</span>
<a name="l00628"></a>00628     <span class="keyword">const</span> <a class="code" href="qgsfeature_8h.html#a443917048a2ef75006fdeba30f1549f3">QgsFeatureIds</a> selection = layer-&gt;<a class="code" href="classQgsVectorLayer.html#a33968fa939503a9e3873c88e5f0ea439" title="Return reference to identifiers of selected features.">selectedFeaturesIds</a>();
<a name="l00629"></a>00629     QgsFeatureIds::const_iterator it = selection.constBegin();
<a name="l00630"></a>00630     <span class="keywordflow">for</span> ( ; it != selection.constEnd(); ++it )
<a name="l00631"></a>00631     {
<a name="l00632"></a>00632       <span class="keywordflow">if</span> ( !layer-&gt;<a class="code" href="classQgsVectorLayer.html#ad220999d6fd94bd84df8f2294cbbee8d" title="Gets the feature at the given feature id.">featureAtId</a>( *it, currentFeature, <span class="keyword">true</span>, <span class="keyword">true</span> ) )
<a name="l00633"></a>00633       {
<a name="l00634"></a>00634         <span class="keywordflow">continue</span>;
<a name="l00635"></a>00635       }
<a name="l00636"></a>00636       map.insert( currentFeature.attributeMap()[ uniqueIdField ].toString(), currentFeature.id() );
<a name="l00637"></a>00637     }
<a name="l00638"></a>00638   }
<a name="l00639"></a>00639   <span class="keywordflow">else</span>
<a name="l00640"></a>00640   {
<a name="l00641"></a>00641     layer-&gt;<a class="code" href="classQgsVectorLayer.html#aceacc5e071f1d1764dacc0b7fffbba05" title="Select features found within the search rectangle (in layer&#39;s coordinates)">select</a>( layer-&gt;<a class="code" href="classQgsVectorLayer.html#a34a108c859c2b36e1db810e44e66d3ee" title="returns list of attributes">pendingAllAttributesList</a>(), <a class="code" href="classQgsRectangle.html" title="A rectangle specified with double values.">QgsRectangle</a>(), <span class="keyword">true</span>, false );
<a name="l00642"></a>00642     <span class="keywordflow">while</span> ( layer-&gt;<a class="code" href="classQgsVectorLayer.html#a084f8ed91fb514b7424617f08ce3bd86" title="fetch a feature (after select)">nextFeature</a>( currentFeature ) )
<a name="l00643"></a>00643     {
<a name="l00644"></a>00644       map.insert( currentFeature.attributeMap()[ uniqueIdField ].toString(), currentFeature.id() );
<a name="l00645"></a>00645     }
<a name="l00646"></a>00646   }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a> *dissolveGeometry = 0; <span class="comment">//dissolve geometry</span>
<a name="l00649"></a>00649   QMultiMap&lt;QString, QgsFeatureId&gt;::const_iterator jt = map.constBegin();
<a name="l00650"></a>00650   <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a> outputFeature;
<a name="l00651"></a>00651   <span class="keywordflow">while</span> ( jt != map.constEnd() )
<a name="l00652"></a>00652   {
<a name="l00653"></a>00653     QString currentKey = jt.key();
<a name="l00654"></a>00654     <span class="keywordtype">int</span> processedFeatures = 0;
<a name="l00655"></a>00655     <span class="keywordtype">bool</span> first = <span class="keyword">true</span>;
<a name="l00656"></a>00656     <span class="comment">//take only selection</span>
<a name="l00657"></a>00657     <span class="keywordflow">if</span> ( onlySelectedFeatures )
<a name="l00658"></a>00658     {
<a name="l00659"></a>00659       <span class="comment">//use QgsVectorLayer::featureAtId</span>
<a name="l00660"></a>00660       <span class="keyword">const</span> <a class="code" href="qgsfeature_8h.html#a443917048a2ef75006fdeba30f1549f3">QgsFeatureIds</a> selection = layer-&gt;<a class="code" href="classQgsVectorLayer.html#a33968fa939503a9e3873c88e5f0ea439" title="Return reference to identifiers of selected features.">selectedFeaturesIds</a>();
<a name="l00661"></a>00661       <span class="keywordflow">if</span> ( p )
<a name="l00662"></a>00662       {
<a name="l00663"></a>00663         p-&gt;setMaximum( selection.size() );
<a name="l00664"></a>00664       }
<a name="l00665"></a>00665       <span class="keywordflow">while</span> ( jt != map.constEnd() &amp;&amp; ( jt.key() == currentKey || !useField ) )
<a name="l00666"></a>00666       {
<a name="l00667"></a>00667         <span class="keywordflow">if</span> ( p &amp;&amp; p-&gt;wasCanceled() )
<a name="l00668"></a>00668         {
<a name="l00669"></a>00669           <span class="keywordflow">break</span>;
<a name="l00670"></a>00670         }
<a name="l00671"></a>00671         <span class="keywordflow">if</span> ( selection.contains( jt.value() ) )
<a name="l00672"></a>00672         {
<a name="l00673"></a>00673           <span class="keywordflow">if</span> ( p )
<a name="l00674"></a>00674           {
<a name="l00675"></a>00675             p-&gt;setValue( processedFeatures );
<a name="l00676"></a>00676           }
<a name="l00677"></a>00677           <span class="keywordflow">if</span> ( !layer-&gt;<a class="code" href="classQgsVectorLayer.html#ad220999d6fd94bd84df8f2294cbbee8d" title="Gets the feature at the given feature id.">featureAtId</a>( jt.value(), currentFeature, <span class="keyword">true</span>, true ) )
<a name="l00678"></a>00678           {
<a name="l00679"></a>00679             <span class="keywordflow">continue</span>;
<a name="l00680"></a>00680           }
<a name="l00681"></a>00681           <span class="keywordflow">if</span> ( first )
<a name="l00682"></a>00682           {
<a name="l00683"></a>00683             outputFeature.<a class="code" href="classQgsFeature.html#abdb279c388c10ec7d7b585f185a21da6" title="Sets all the attributes in one go.">setAttributeMap</a>( currentFeature.attributeMap() );
<a name="l00684"></a>00684             first = <span class="keyword">false</span>;
<a name="l00685"></a>00685           }
<a name="l00686"></a>00686           <a class="code" href="classQgsGeometryAnalyzer.html#a3d48458711e19ea1dba8cb0e305c09c0" title="Helper function to dissolve feature(s)">dissolveFeature</a>( currentFeature, processedFeatures, &amp;dissolveGeometry );
<a name="l00687"></a>00687           ++processedFeatures;
<a name="l00688"></a>00688         }
<a name="l00689"></a>00689         ++jt;
<a name="l00690"></a>00690       }
<a name="l00691"></a>00691     }
<a name="l00692"></a>00692     <span class="comment">//take all features</span>
<a name="l00693"></a>00693     <span class="keywordflow">else</span>
<a name="l00694"></a>00694     {
<a name="l00695"></a>00695       <span class="keywordtype">int</span> featureCount = layer-&gt;<a class="code" href="classQgsVectorLayer.html#a65286a9f1c393269cc392fbe539b37b0" title="Number of features in the layer.">featureCount</a>();
<a name="l00696"></a>00696       <span class="keywordflow">if</span> ( p )
<a name="l00697"></a>00697       {
<a name="l00698"></a>00698         p-&gt;setMaximum( featureCount );
<a name="l00699"></a>00699       }
<a name="l00700"></a>00700       <span class="keywordflow">while</span> ( jt != map.constEnd() &amp;&amp; ( jt.key() == currentKey || !useField ) )
<a name="l00701"></a>00701       {
<a name="l00702"></a>00702         <span class="keywordflow">if</span> ( p )
<a name="l00703"></a>00703         {
<a name="l00704"></a>00704           p-&gt;setValue( processedFeatures );
<a name="l00705"></a>00705         }
<a name="l00706"></a>00706 
<a name="l00707"></a>00707         <span class="keywordflow">if</span> ( p &amp;&amp; p-&gt;wasCanceled() )
<a name="l00708"></a>00708         {
<a name="l00709"></a>00709           <span class="keywordflow">break</span>;
<a name="l00710"></a>00710         }
<a name="l00711"></a>00711         <span class="keywordflow">if</span> ( !layer-&gt;<a class="code" href="classQgsVectorLayer.html#ad220999d6fd94bd84df8f2294cbbee8d" title="Gets the feature at the given feature id.">featureAtId</a>( jt.value(), currentFeature, <span class="keyword">true</span>, true ) )
<a name="l00712"></a>00712         {
<a name="l00713"></a>00713           <span class="keywordflow">continue</span>;
<a name="l00714"></a>00714         }
<a name="l00715"></a>00715         {
<a name="l00716"></a>00716           outputFeature.<a class="code" href="classQgsFeature.html#abdb279c388c10ec7d7b585f185a21da6" title="Sets all the attributes in one go.">setAttributeMap</a>( currentFeature.attributeMap() );
<a name="l00717"></a>00717           first = <span class="keyword">false</span>;
<a name="l00718"></a>00718         }
<a name="l00719"></a>00719         <a class="code" href="classQgsGeometryAnalyzer.html#a3d48458711e19ea1dba8cb0e305c09c0" title="Helper function to dissolve feature(s)">dissolveFeature</a>( currentFeature, processedFeatures, &amp;dissolveGeometry );
<a name="l00720"></a>00720         ++processedFeatures;
<a name="l00721"></a>00721         ++jt;
<a name="l00722"></a>00722       }
<a name="l00723"></a>00723     }
<a name="l00724"></a>00724     outputFeature.<a class="code" href="classQgsFeature.html#ad7755f8310da090b047025a1d58a93d8" title="Set this feature&#39;s geometry from another QgsGeometry object (deep copy)">setGeometry</a>( dissolveGeometry );
<a name="l00725"></a>00725     vWriter.addFeature( outputFeature );
<a name="l00726"></a>00726   }
<a name="l00727"></a>00727   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00728"></a>00728 }
<a name="l00729"></a>00729 
<a name="l00730"></a><a class="code" href="classQgsGeometryAnalyzer.html#a3d48458711e19ea1dba8cb0e305c09c0">00730</a> <span class="keywordtype">void</span> <a class="code" href="classQgsGeometryAnalyzer.html#a3d48458711e19ea1dba8cb0e305c09c0" title="Helper function to dissolve feature(s)">QgsGeometryAnalyzer::dissolveFeature</a>( <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a>&amp; f, <span class="keywordtype">int</span> nProcessedFeatures, <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>** dissolveGeometry )
<a name="l00731"></a>00731 {
<a name="l00732"></a>00732   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* featureGeometry = f.<a class="code" href="classQgsFeature.html#ab0a934a1b173ce5ad8d13363c20ef3c8" title="Get the geometry object associated with this feature.">geometry</a>();
<a name="l00733"></a>00733 
<a name="l00734"></a>00734   <span class="keywordflow">if</span> ( !featureGeometry )
<a name="l00735"></a>00735   {
<a name="l00736"></a>00736     <span class="keywordflow">return</span>;
<a name="l00737"></a>00737   }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739   <span class="keywordflow">if</span> ( nProcessedFeatures == 0 )
<a name="l00740"></a>00740   {
<a name="l00741"></a>00741     <span class="keywordtype">int</span> geomSize = featureGeometry-&gt;<a class="code" href="classQgsGeometry.html#ae832c36a418ed870a60a913084172152" title="Returns the size of the WKB in asWkb().">wkbSize</a>();
<a name="l00742"></a>00742     *dissolveGeometry = <span class="keyword">new</span> <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>();
<a name="l00743"></a>00743     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* wkb = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[geomSize];
<a name="l00744"></a>00744     memcpy( wkb, featureGeometry-&gt;<a class="code" href="classQgsGeometry.html#a7b74272a8080f7560de58a23f0ea891a" title="Returns the buffer containing this geometry in WKB format.">asWkb</a>(), geomSize );
<a name="l00745"></a>00745     ( *dissolveGeometry )-&gt;fromWkb( wkb, geomSize );
<a name="l00746"></a>00746   }
<a name="l00747"></a>00747   <span class="keywordflow">else</span>
<a name="l00748"></a>00748   {
<a name="l00749"></a>00749     *dissolveGeometry = ( *dissolveGeometry )-&gt;<a class="code" href="classQgsGeometry.html#a63244d3435cc99794b82a6cbd0af0eb5" title="Returns a geometry representing all the points in this geometry and other (a union geometry operation...">combine</a>( featureGeometry );
<a name="l00750"></a>00750   }
<a name="l00751"></a>00751 }
<a name="l00752"></a>00752 
<a name="l00753"></a><a class="code" href="classQgsGeometryAnalyzer.html#a48d71b239adcd51a241d8c96fcf0bf26">00753</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsGeometryAnalyzer.html#a48d71b239adcd51a241d8c96fcf0bf26" title="Create buffers for a vector layer and write it to a new shape file.">QgsGeometryAnalyzer::buffer</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* layer, <span class="keyword">const</span> QString&amp; shapefileName, <span class="keywordtype">double</span> bufferDistance,
<a name="l00754"></a>00754                                   <span class="keywordtype">bool</span> onlySelectedFeatures, <span class="keywordtype">bool</span> dissolve, <span class="keywordtype">int</span> bufferDistanceField, QProgressDialog* p )
<a name="l00755"></a>00755 {
<a name="l00756"></a>00756   <span class="keywordflow">if</span> ( !layer )
<a name="l00757"></a>00757   {
<a name="l00758"></a>00758     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00759"></a>00759   }
<a name="l00760"></a>00760 
<a name="l00761"></a>00761   <a class="code" href="classQgsVectorDataProvider.html" title="This is the base class for vector data providers.">QgsVectorDataProvider</a>* dp = layer-&gt;<a class="code" href="classQgsVectorLayer.html#ae3cfb88b9a03c1016e3ac1b79193e9eb" title="Returns the data provider.">dataProvider</a>();
<a name="l00762"></a>00762   <span class="keywordflow">if</span> ( !dp )
<a name="l00763"></a>00763   {
<a name="l00764"></a>00764     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00765"></a>00765   }
<a name="l00766"></a>00766 
<a name="l00767"></a>00767   <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7" title="Used for symbology operations.">QGis::WkbType</a> outputType = <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7aa2ed4d1a4578480a4b49ac21e9eef851">QGis::WKBPolygon</a>;
<a name="l00768"></a>00768   <span class="keywordflow">if</span> ( dissolve )
<a name="l00769"></a>00769   {
<a name="l00770"></a>00770     outputType = <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7a25ecfcafc77567e147c86ac379efccf9">QGis::WKBMultiPolygon</a>;
<a name="l00771"></a>00771   }
<a name="l00772"></a>00772   <span class="keyword">const</span> <a class="code" href="classQgsCoordinateReferenceSystem.html" title="Class for storing a coordinate reference system (CRS)">QgsCoordinateReferenceSystem</a> crs = layer-&gt;<a class="code" href="classQgsMapLayer.html#a40b79e2d6043f8ec316a28cb17febd6c" title="Returns layer&#39;s spatial reference system.">crs</a>();
<a name="l00773"></a>00773 
<a name="l00774"></a>00774   <a class="code" href="classQgsVectorFileWriter.html" title="A convenience class for writing vector files to disk.">QgsVectorFileWriter</a> vWriter( shapefileName, dp-&gt;<a class="code" href="classQgsVectorDataProvider.html#a628c5bd63c2bf0637ac4c676ecdb921e" title="Get encoding which is used for accessing data.">encoding</a>(), dp-&gt;<a class="code" href="classQgsVectorDataProvider.html#a920112de81372447a592c9c69ccec3af" title="Return a map of indexes with field names for this layer.">fields</a>(), outputType, &amp;crs );
<a name="l00775"></a>00775   <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a> currentFeature;
<a name="l00776"></a>00776   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a> *dissolveGeometry = 0; <span class="comment">//dissolve geometry (if dissolve enabled)</span>
<a name="l00777"></a>00777 
<a name="l00778"></a>00778   <span class="comment">//take only selection</span>
<a name="l00779"></a>00779   <span class="keywordflow">if</span> ( onlySelectedFeatures )
<a name="l00780"></a>00780   {
<a name="l00781"></a>00781     <span class="comment">//use QgsVectorLayer::featureAtId</span>
<a name="l00782"></a>00782     <span class="keyword">const</span> <a class="code" href="qgsfeature_8h.html#a443917048a2ef75006fdeba30f1549f3">QgsFeatureIds</a> selection = layer-&gt;<a class="code" href="classQgsVectorLayer.html#a33968fa939503a9e3873c88e5f0ea439" title="Return reference to identifiers of selected features.">selectedFeaturesIds</a>();
<a name="l00783"></a>00783     <span class="keywordflow">if</span> ( p )
<a name="l00784"></a>00784     {
<a name="l00785"></a>00785       p-&gt;setMaximum( selection.size() );
<a name="l00786"></a>00786     }
<a name="l00787"></a>00787 
<a name="l00788"></a>00788     <span class="keywordtype">int</span> processedFeatures = 0;
<a name="l00789"></a>00789     QgsFeatureIds::const_iterator it = selection.constBegin();
<a name="l00790"></a>00790     <span class="keywordflow">for</span> ( ; it != selection.constEnd(); ++it )
<a name="l00791"></a>00791     {
<a name="l00792"></a>00792       <span class="keywordflow">if</span> ( p )
<a name="l00793"></a>00793       {
<a name="l00794"></a>00794         p-&gt;setValue( processedFeatures );
<a name="l00795"></a>00795       }
<a name="l00796"></a>00796 
<a name="l00797"></a>00797       <span class="keywordflow">if</span> ( p &amp;&amp; p-&gt;wasCanceled() )
<a name="l00798"></a>00798       {
<a name="l00799"></a>00799         <span class="keywordflow">break</span>;
<a name="l00800"></a>00800       }
<a name="l00801"></a>00801       <span class="keywordflow">if</span> ( !layer-&gt;<a class="code" href="classQgsVectorLayer.html#ad220999d6fd94bd84df8f2294cbbee8d" title="Gets the feature at the given feature id.">featureAtId</a>( *it, currentFeature, <span class="keyword">true</span>, <span class="keyword">true</span> ) )
<a name="l00802"></a>00802       {
<a name="l00803"></a>00803         <span class="keywordflow">continue</span>;
<a name="l00804"></a>00804       }
<a name="l00805"></a>00805       <a class="code" href="classQgsGeometryAnalyzer.html#a8598d911083e20d0ce1900049de21f73" title="Helper function to buffer an individual feature.">bufferFeature</a>( currentFeature, processedFeatures, &amp;vWriter, dissolve, &amp;dissolveGeometry, bufferDistance, bufferDistanceField );
<a name="l00806"></a>00806       ++processedFeatures;
<a name="l00807"></a>00807     }
<a name="l00808"></a>00808 
<a name="l00809"></a>00809     <span class="keywordflow">if</span> ( p )
<a name="l00810"></a>00810     {
<a name="l00811"></a>00811       p-&gt;setValue( selection.size() );
<a name="l00812"></a>00812     }
<a name="l00813"></a>00813   }
<a name="l00814"></a>00814   <span class="comment">//take all features</span>
<a name="l00815"></a>00815   <span class="keywordflow">else</span>
<a name="l00816"></a>00816   {
<a name="l00817"></a>00817     layer-&gt;<a class="code" href="classQgsVectorLayer.html#aceacc5e071f1d1764dacc0b7fffbba05" title="Select features found within the search rectangle (in layer&#39;s coordinates)">select</a>( layer-&gt;<a class="code" href="classQgsVectorLayer.html#a34a108c859c2b36e1db810e44e66d3ee" title="returns list of attributes">pendingAllAttributesList</a>(), <a class="code" href="classQgsRectangle.html" title="A rectangle specified with double values.">QgsRectangle</a>(), <span class="keyword">true</span>, false );
<a name="l00818"></a>00818 
<a name="l00819"></a>00819 
<a name="l00820"></a>00820     <span class="keywordtype">int</span> featureCount = layer-&gt;<a class="code" href="classQgsVectorLayer.html#a65286a9f1c393269cc392fbe539b37b0" title="Number of features in the layer.">featureCount</a>();
<a name="l00821"></a>00821     <span class="keywordflow">if</span> ( p )
<a name="l00822"></a>00822     {
<a name="l00823"></a>00823       p-&gt;setMaximum( featureCount );
<a name="l00824"></a>00824     }
<a name="l00825"></a>00825     <span class="keywordtype">int</span> processedFeatures = 0;
<a name="l00826"></a>00826 
<a name="l00827"></a>00827     <span class="keywordflow">while</span> ( layer-&gt;<a class="code" href="classQgsVectorLayer.html#a084f8ed91fb514b7424617f08ce3bd86" title="fetch a feature (after select)">nextFeature</a>( currentFeature ) )
<a name="l00828"></a>00828     {
<a name="l00829"></a>00829       <span class="keywordflow">if</span> ( p )
<a name="l00830"></a>00830       {
<a name="l00831"></a>00831         p-&gt;setValue( processedFeatures );
<a name="l00832"></a>00832       }
<a name="l00833"></a>00833       <span class="keywordflow">if</span> ( p &amp;&amp; p-&gt;wasCanceled() )
<a name="l00834"></a>00834       {
<a name="l00835"></a>00835         <span class="keywordflow">break</span>;
<a name="l00836"></a>00836       }
<a name="l00837"></a>00837       <a class="code" href="classQgsGeometryAnalyzer.html#a8598d911083e20d0ce1900049de21f73" title="Helper function to buffer an individual feature.">bufferFeature</a>( currentFeature, processedFeatures, &amp;vWriter, dissolve, &amp;dissolveGeometry, bufferDistance, bufferDistanceField );
<a name="l00838"></a>00838       ++processedFeatures;
<a name="l00839"></a>00839     }
<a name="l00840"></a>00840     <span class="keywordflow">if</span> ( p )
<a name="l00841"></a>00841     {
<a name="l00842"></a>00842       p-&gt;setValue( featureCount );
<a name="l00843"></a>00843     }
<a name="l00844"></a>00844   }
<a name="l00845"></a>00845 
<a name="l00846"></a>00846   <span class="keywordflow">if</span> ( dissolve )
<a name="l00847"></a>00847   {
<a name="l00848"></a>00848     <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a> <a class="code" href="classQgsGeometryAnalyzer.html#a3d48458711e19ea1dba8cb0e305c09c0" title="Helper function to dissolve feature(s)">dissolveFeature</a>;
<a name="l00849"></a>00849     <span class="keywordflow">if</span> ( !dissolveGeometry )
<a name="l00850"></a>00850     {
<a name="l00851"></a>00851       <a class="code" href="qgslogger_8h.html#ab273942cfb1b76ef0a5dafe6ed64fe23">QgsDebugMsg</a>( <span class="stringliteral">&quot;no dissolved geometry - should not happen&quot;</span> );
<a name="l00852"></a>00852       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00853"></a>00853     }
<a name="l00854"></a>00854     dissolveFeature.<a class="code" href="classQgsFeature.html#ad7755f8310da090b047025a1d58a93d8" title="Set this feature&#39;s geometry from another QgsGeometry object (deep copy)">setGeometry</a>( dissolveGeometry );
<a name="l00855"></a>00855     vWriter.addFeature( dissolveFeature );
<a name="l00856"></a>00856   }
<a name="l00857"></a>00857   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00858"></a>00858 }
<a name="l00859"></a>00859 
<a name="l00860"></a><a class="code" href="classQgsGeometryAnalyzer.html#a8598d911083e20d0ce1900049de21f73">00860</a> <span class="keywordtype">void</span> <a class="code" href="classQgsGeometryAnalyzer.html#a8598d911083e20d0ce1900049de21f73" title="Helper function to buffer an individual feature.">QgsGeometryAnalyzer::bufferFeature</a>( <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a>&amp; f, <span class="keywordtype">int</span> nProcessedFeatures, <a class="code" href="classQgsVectorFileWriter.html" title="A convenience class for writing vector files to disk.">QgsVectorFileWriter</a>* vfw, <span class="keywordtype">bool</span> dissolve,
<a name="l00861"></a>00861     <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>** dissolveGeometry, <span class="keywordtype">double</span> bufferDistance, <span class="keywordtype">int</span> bufferDistanceField )
<a name="l00862"></a>00862 {
<a name="l00863"></a>00863   <span class="keywordtype">double</span> currentBufferDistance;
<a name="l00864"></a>00864   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* featureGeometry = f.<a class="code" href="classQgsFeature.html#ab0a934a1b173ce5ad8d13363c20ef3c8" title="Get the geometry object associated with this feature.">geometry</a>();
<a name="l00865"></a>00865   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* tmpGeometry = 0;
<a name="l00866"></a>00866   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* bufferGeometry = 0;
<a name="l00867"></a>00867 
<a name="l00868"></a>00868   <span class="keywordflow">if</span> ( !featureGeometry )
<a name="l00869"></a>00869   {
<a name="l00870"></a>00870     <span class="keywordflow">return</span>;
<a name="l00871"></a>00871   }
<a name="l00872"></a>00872 
<a name="l00873"></a>00873   <span class="comment">//create buffer</span>
<a name="l00874"></a>00874   <span class="keywordflow">if</span> ( bufferDistanceField == -1 )
<a name="l00875"></a>00875   {
<a name="l00876"></a>00876     currentBufferDistance = bufferDistance;
<a name="l00877"></a>00877   }
<a name="l00878"></a>00878   <span class="keywordflow">else</span>
<a name="l00879"></a>00879   {
<a name="l00880"></a>00880     currentBufferDistance = f.<a class="code" href="classQgsFeature.html#ad80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>()[bufferDistanceField].toDouble();
<a name="l00881"></a>00881   }
<a name="l00882"></a>00882   bufferGeometry = featureGeometry-&gt;<a class="code" href="classQgsGeometry.html#a98208752e1beb1a5d3a7eedffbfdb2e4" title="Returns a buffer region around this geometry having the given width and with a specified number of se...">buffer</a>( currentBufferDistance, 5 );
<a name="l00883"></a>00883 
<a name="l00884"></a>00884   <span class="keywordflow">if</span> ( dissolve )
<a name="l00885"></a>00885   {
<a name="l00886"></a>00886     <span class="keywordflow">if</span> ( nProcessedFeatures == 0 )
<a name="l00887"></a>00887     {
<a name="l00888"></a>00888       *dissolveGeometry = bufferGeometry;
<a name="l00889"></a>00889     }
<a name="l00890"></a>00890     <span class="keywordflow">else</span>
<a name="l00891"></a>00891     {
<a name="l00892"></a>00892       tmpGeometry = *dissolveGeometry;
<a name="l00893"></a>00893       *dissolveGeometry = ( *dissolveGeometry )-&gt;<a class="code" href="classQgsGeometry.html#a63244d3435cc99794b82a6cbd0af0eb5" title="Returns a geometry representing all the points in this geometry and other (a union geometry operation...">combine</a>( bufferGeometry );
<a name="l00894"></a>00894       <span class="keyword">delete</span> tmpGeometry;
<a name="l00895"></a>00895       <span class="keyword">delete</span> bufferGeometry;
<a name="l00896"></a>00896     }
<a name="l00897"></a>00897   }
<a name="l00898"></a>00898   <span class="keywordflow">else</span> <span class="comment">//dissolve</span>
<a name="l00899"></a>00899   {
<a name="l00900"></a>00900     <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a> newFeature;
<a name="l00901"></a>00901     newFeature.<a class="code" href="classQgsFeature.html#ad7755f8310da090b047025a1d58a93d8" title="Set this feature&#39;s geometry from another QgsGeometry object (deep copy)">setGeometry</a>( bufferGeometry );
<a name="l00902"></a>00902     newFeature.<a class="code" href="classQgsFeature.html#abdb279c388c10ec7d7b585f185a21da6" title="Sets all the attributes in one go.">setAttributeMap</a>( f.<a class="code" href="classQgsFeature.html#ad80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>() );
<a name="l00903"></a>00903 
<a name="l00904"></a>00904     <span class="comment">//add it to vector file writer</span>
<a name="l00905"></a>00905     <span class="keywordflow">if</span> ( vfw )
<a name="l00906"></a>00906     {
<a name="l00907"></a>00907       vfw-&gt;<a class="code" href="classQgsVectorFileWriter.html#a93e126f3ed1ddf9bc012d0c53b868a9c" title="add feature to the currently opened shapefile">addFeature</a>( newFeature );
<a name="l00908"></a>00908     }
<a name="l00909"></a>00909   }
<a name="l00910"></a>00910 }
<a name="l00911"></a>00911 
<a name="l00912"></a><a class="code" href="classQgsGeometryAnalyzer.html#a9e75c9e9e4c4ab50602893860124d3de">00912</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsGeometryAnalyzer.html#a9e75c9e9e4c4ab50602893860124d3de" title="Creates an event layer (multipoint or multiline) by locating features from a (non-spatial) event tabl...">QgsGeometryAnalyzer::eventLayer</a>( <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* lineLayer, <a class="code" href="classQgsVectorLayer.html" title="Vector layer backed by a data source provider.">QgsVectorLayer</a>* eventLayer, <span class="keywordtype">int</span> lineField, <span class="keywordtype">int</span> eventField, QList&lt;int&gt;&amp; unlocatedFeatureIds, <span class="keyword">const</span> QString&amp; outputLayer,
<a name="l00913"></a>00913                                       <span class="keyword">const</span> QString&amp; outputFormat, <span class="keywordtype">int</span> locationField1, <span class="keywordtype">int</span> locationField2, <span class="keywordtype">int</span> offsetField, <span class="keywordtype">double</span> offsetScale,
<a name="l00914"></a>00914                                       <span class="keywordtype">bool</span> forceSingleGeometry, <a class="code" href="classQgsVectorDataProvider.html" title="This is the base class for vector data providers.">QgsVectorDataProvider</a>* memoryProvider, QProgressDialog* p )
<a name="l00915"></a>00915 {
<a name="l00916"></a>00916   <span class="keywordflow">if</span> ( !lineLayer || !eventLayer || !lineLayer-&gt;<a class="code" href="classQgsMapLayer.html#a305aeadbd18af135956a4893b472760f">isValid</a>() || !eventLayer-&gt;<a class="code" href="classQgsMapLayer.html#a305aeadbd18af135956a4893b472760f">isValid</a>() )
<a name="l00917"></a>00917   {
<a name="l00918"></a>00918     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00919"></a>00919   }
<a name="l00920"></a>00920 
<a name="l00921"></a>00921   <span class="comment">//create line field / id map for line layer</span>
<a name="l00922"></a>00922   QMultiHash&lt; QString, QgsFeatureId &gt; lineLayerIdMap; <span class="comment">//1:n possible (e.g. several linear reference geometries for one feature in the event layer)</span>
<a name="l00923"></a>00923   lineLayer-&gt;<a class="code" href="classQgsVectorLayer.html#aceacc5e071f1d1764dacc0b7fffbba05" title="Select features found within the search rectangle (in layer&#39;s coordinates)">select</a>( <a class="code" href="qgslabel_8h.html#a00f27df80eac3fb534923fefaed2181d">QgsAttributeList</a>() &lt;&lt; lineField,
<a name="l00924"></a>00924                      <a class="code" href="classQgsRectangle.html" title="A rectangle specified with double values.">QgsRectangle</a>(), <span class="keyword">false</span>, <span class="keyword">false</span> );
<a name="l00925"></a>00925   <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a> fet;
<a name="l00926"></a>00926   <span class="keywordflow">while</span> ( lineLayer-&gt;<a class="code" href="classQgsVectorLayer.html#a084f8ed91fb514b7424617f08ce3bd86" title="fetch a feature (after select)">nextFeature</a>( fet ) )
<a name="l00927"></a>00927   {
<a name="l00928"></a>00928     lineLayerIdMap.insert( fet.<a class="code" href="classQgsFeature.html#ad80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>()[lineField].toString(), fet.<a class="code" href="classQgsFeature.html#ab16e0aa72ae9904e5260f29816ac4fac" title="Get the feature id for this feature.">id</a>() );
<a name="l00929"></a>00929   }
<a name="l00930"></a>00930 
<a name="l00931"></a>00931   <span class="comment">//create output datasource or attributes in memory provider</span>
<a name="l00932"></a>00932   <a class="code" href="classQgsVectorFileWriter.html" title="A convenience class for writing vector files to disk.">QgsVectorFileWriter</a>* fileWriter = 0;
<a name="l00933"></a>00933   <a class="code" href="qgsfeature_8h.html#ae0f922f3469155bc17dfc96729f1c1cc">QgsFeatureList</a> memoryProviderFeatures;
<a name="l00934"></a>00934   <span class="keywordflow">if</span> ( !memoryProvider )
<a name="l00935"></a>00935   {
<a name="l00936"></a>00936     <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7" title="Used for symbology operations.">QGis::WkbType</a> memoryProviderType = <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7ac3ad4ed8d1df82b8ac2a0bf37bf9a077">QGis::WKBMultiLineString</a>;
<a name="l00937"></a>00937     <span class="keywordflow">if</span> ( locationField2 == -1 )
<a name="l00938"></a>00938     {
<a name="l00939"></a>00939       memoryProviderType = forceSingleGeometry ? <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7a6157604e3e81d9220b734a552dc32123">QGis::WKBPoint</a> : <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7ae142e5047d7008367f1346b9057703bc">QGis::WKBMultiPoint</a>;
<a name="l00940"></a>00940     }
<a name="l00941"></a>00941     <span class="keywordflow">else</span>
<a name="l00942"></a>00942     {
<a name="l00943"></a>00943       memoryProviderType = forceSingleGeometry ? <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7a8e1fa365c39db5323fbcd20c68075f72">QGis::WKBLineString</a> : <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7ac3ad4ed8d1df82b8ac2a0bf37bf9a077">QGis::WKBMultiLineString</a>;
<a name="l00944"></a>00944     }
<a name="l00945"></a>00945     fileWriter = <span class="keyword">new</span> <a class="code" href="classQgsVectorFileWriter.html" title="A convenience class for writing vector files to disk.">QgsVectorFileWriter</a>( outputLayer,
<a name="l00946"></a>00946                                           eventLayer-&gt;<a class="code" href="classQgsVectorLayer.html#ae3cfb88b9a03c1016e3ac1b79193e9eb" title="Returns the data provider.">dataProvider</a>()-&gt;<a class="code" href="classQgsVectorDataProvider.html#a628c5bd63c2bf0637ac4c676ecdb921e" title="Get encoding which is used for accessing data.">encoding</a>(),
<a name="l00947"></a>00947                                           eventLayer-&gt;<a class="code" href="classQgsVectorLayer.html#ad7fab6c5b64e1657edafadc11d64b13f" title="returns field list in the to-be-committed state">pendingFields</a>(),
<a name="l00948"></a>00948                                           memoryProviderType,
<a name="l00949"></a>00949                                           &amp;( lineLayer-&gt;<a class="code" href="classQgsMapLayer.html#a40b79e2d6043f8ec316a28cb17febd6c" title="Returns layer&#39;s spatial reference system.">crs</a>() ),
<a name="l00950"></a>00950                                           outputFormat );
<a name="l00951"></a>00951   }
<a name="l00952"></a>00952   <span class="keywordflow">else</span>
<a name="l00953"></a>00953   {
<a name="l00954"></a>00954     memoryProvider-&gt;<a class="code" href="classQgsVectorDataProvider.html#ac3d0927cff569c3b19b8be56cf1541c6" title="Adds new attributes.">addAttributes</a>( eventLayer-&gt;<a class="code" href="classQgsVectorLayer.html#ad7fab6c5b64e1657edafadc11d64b13f" title="returns field list in the to-be-committed state">pendingFields</a>().values() );
<a name="l00955"></a>00955   }
<a name="l00956"></a>00956 
<a name="l00957"></a>00957   <span class="comment">//iterate over eventLayer and write new features to output file or layer</span>
<a name="l00958"></a>00958   eventLayer-&gt;<a class="code" href="classQgsVectorLayer.html#aceacc5e071f1d1764dacc0b7fffbba05" title="Select features found within the search rectangle (in layer&#39;s coordinates)">select</a>( eventLayer-&gt;<a class="code" href="classQgsVectorLayer.html#a34a108c859c2b36e1db810e44e66d3ee" title="returns list of attributes">pendingAllAttributesList</a>(), <a class="code" href="classQgsRectangle.html" title="A rectangle specified with double values.">QgsRectangle</a>(), <span class="keyword">false</span>, false );
<a name="l00959"></a>00959   <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* lrsGeom = 0;
<a name="l00960"></a>00960   <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a> lineFeature;
<a name="l00961"></a>00961   <span class="keywordtype">double</span> measure1, measure2;
<a name="l00962"></a>00962 
<a name="l00963"></a>00963   <span class="keywordtype">int</span> nEventFeatures = eventLayer-&gt;<a class="code" href="classQgsVectorLayer.html#afb9d1680ca210bab48e000ee9e32fda4" title="returns feature count after commit">pendingFeatureCount</a>();
<a name="l00964"></a>00964   <span class="keywordtype">int</span> featureCounter = 0;
<a name="l00965"></a>00965   <span class="keywordtype">int</span> nOutputFeatures = 0; <span class="comment">//number of output features for the current event feature</span>
<a name="l00966"></a>00966   <span class="keywordflow">if</span> ( p )
<a name="l00967"></a>00967   {
<a name="l00968"></a>00968     p-&gt;setWindowModality( Qt::WindowModal );
<a name="l00969"></a>00969     p-&gt;setMinimum( 0 );
<a name="l00970"></a>00970     p-&gt;setMaximum( nEventFeatures );
<a name="l00971"></a>00971     p-&gt;show();
<a name="l00972"></a>00972   }
<a name="l00973"></a>00973 
<a name="l00974"></a>00974   <span class="keywordflow">while</span> ( eventLayer-&gt;<a class="code" href="classQgsVectorLayer.html#a084f8ed91fb514b7424617f08ce3bd86" title="fetch a feature (after select)">nextFeature</a>( fet ) )
<a name="l00975"></a>00975   {
<a name="l00976"></a>00976     nOutputFeatures = 0;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978     <span class="comment">//update progress dialog</span>
<a name="l00979"></a>00979     <span class="keywordflow">if</span> ( p )
<a name="l00980"></a>00980     {
<a name="l00981"></a>00981       <span class="keywordflow">if</span> ( p-&gt;wasCanceled() )
<a name="l00982"></a>00982       {
<a name="l00983"></a>00983         <span class="keywordflow">break</span>;
<a name="l00984"></a>00984       }
<a name="l00985"></a>00985       p-&gt;setValue( featureCounter );
<a name="l00986"></a>00986       ++featureCounter;
<a name="l00987"></a>00987     }
<a name="l00988"></a>00988 
<a name="l00989"></a>00989     measure1 = fet.<a class="code" href="classQgsFeature.html#ad80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>()[locationField1].toDouble();
<a name="l00990"></a>00990     <span class="keywordflow">if</span> ( locationField2 != -1 )
<a name="l00991"></a>00991     {
<a name="l00992"></a>00992       measure2 = fet.<a class="code" href="classQgsFeature.html#ad80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>()[locationField2].toDouble();
<a name="l00993"></a>00993     }
<a name="l00994"></a>00994 
<a name="l00995"></a>00995     QList&lt;QgsFeatureId&gt; featureIdList = lineLayerIdMap.values( fet.<a class="code" href="classQgsFeature.html#ad80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>()[eventField].toString() );
<a name="l00996"></a>00996     QList&lt;QgsFeatureId&gt;::const_iterator featureIdIt = featureIdList.constBegin();
<a name="l00997"></a>00997     <span class="keywordflow">for</span> ( ; featureIdIt != featureIdList.constEnd(); ++featureIdIt )
<a name="l00998"></a>00998     {
<a name="l00999"></a>00999       <span class="keywordflow">if</span> ( !lineLayer-&gt;<a class="code" href="classQgsVectorLayer.html#ad220999d6fd94bd84df8f2294cbbee8d" title="Gets the feature at the given feature id.">featureAtId</a>( *featureIdIt, lineFeature, <span class="keyword">true</span>, <span class="keyword">false</span> ) )
<a name="l01000"></a>01000       {
<a name="l01001"></a>01001         <span class="keywordflow">continue</span>;
<a name="l01002"></a>01002       }
<a name="l01003"></a>01003 
<a name="l01004"></a>01004       <span class="keywordflow">if</span> ( locationField2 == -1 )
<a name="l01005"></a>01005       {
<a name="l01006"></a>01006         lrsGeom = <a class="code" href="classQgsGeometryAnalyzer.html#a939d7d45a26cb530524d62c09e13877c" title="Returns linear reference geometry.">locateAlongMeasure</a>( measure1, lineFeature.<a class="code" href="classQgsFeature.html#ab0a934a1b173ce5ad8d13363c20ef3c8" title="Get the geometry object associated with this feature.">geometry</a>() );
<a name="l01007"></a>01007       }
<a name="l01008"></a>01008       <span class="keywordflow">else</span>
<a name="l01009"></a>01009       {
<a name="l01010"></a>01010         lrsGeom = <a class="code" href="classQgsGeometryAnalyzer.html#a248c5b567da381651ac74740fe9cf499" title="Returns linear reference geometry as a multiline (or 0 if no match).">locateBetweenMeasures</a>( measure1, measure2, lineFeature.<a class="code" href="classQgsFeature.html#ab0a934a1b173ce5ad8d13363c20ef3c8" title="Get the geometry object associated with this feature.">geometry</a>() );
<a name="l01011"></a>01011       }
<a name="l01012"></a>01012 
<a name="l01013"></a>01013       <span class="keywordflow">if</span> ( lrsGeom )
<a name="l01014"></a>01014       {
<a name="l01015"></a>01015         ++nOutputFeatures;
<a name="l01016"></a>01016         <a class="code" href="classQgsGeometryAnalyzer.html#a7f571e647cd70da23de29821a231f1e5">addEventLayerFeature</a>( fet, lrsGeom, lineFeature.<a class="code" href="classQgsFeature.html#ab0a934a1b173ce5ad8d13363c20ef3c8" title="Get the geometry object associated with this feature.">geometry</a>(), fileWriter, memoryProviderFeatures, offsetField, offsetScale, forceSingleGeometry );
<a name="l01017"></a>01017       }
<a name="l01018"></a>01018     }
<a name="l01019"></a>01019     <span class="keywordflow">if</span> ( nOutputFeatures &lt; 1 )
<a name="l01020"></a>01020     {
<a name="l01021"></a>01021       unlocatedFeatureIds.push_back( fet.<a class="code" href="classQgsFeature.html#ab16e0aa72ae9904e5260f29816ac4fac" title="Get the feature id for this feature.">id</a>() );
<a name="l01022"></a>01022     }
<a name="l01023"></a>01023   }
<a name="l01024"></a>01024 
<a name="l01025"></a>01025   <span class="keywordflow">if</span> ( p )
<a name="l01026"></a>01026   {
<a name="l01027"></a>01027     p-&gt;setValue( nEventFeatures );
<a name="l01028"></a>01028   }
<a name="l01029"></a>01029 
<a name="l01030"></a>01030   <span class="keywordflow">if</span> ( memoryProvider )
<a name="l01031"></a>01031   {
<a name="l01032"></a>01032     memoryProvider-&gt;<a class="code" href="classQgsVectorDataProvider.html#accda0e225ac3501ae134e9aea3786029" title="Adds a list of features.">addFeatures</a>( memoryProviderFeatures );
<a name="l01033"></a>01033   }
<a name="l01034"></a>01034   <span class="keyword">delete</span> fileWriter;
<a name="l01035"></a>01035   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01036"></a>01036 }
<a name="l01037"></a>01037 
<a name="l01038"></a><a class="code" href="classQgsGeometryAnalyzer.html#a7f571e647cd70da23de29821a231f1e5">01038</a> <span class="keywordtype">void</span> <a class="code" href="classQgsGeometryAnalyzer.html#a7f571e647cd70da23de29821a231f1e5">QgsGeometryAnalyzer::addEventLayerFeature</a>( <a class="code" href="classQgsFeature.html" title="The feature class encapsulates a single feature including its id, geometry and a list of field/values...">QgsFeature</a>&amp; feature, <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* geom, <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* lineGeom, <a class="code" href="classQgsVectorFileWriter.html" title="A convenience class for writing vector files to disk.">QgsVectorFileWriter</a>* fileWriter, <a class="code" href="qgsfeature_8h.html#ae0f922f3469155bc17dfc96729f1c1cc">QgsFeatureList</a>&amp; memoryFeatures,
<a name="l01039"></a>01039     <span class="keywordtype">int</span> offsetField, <span class="keywordtype">double</span> offsetScale, <span class="keywordtype">bool</span> forceSingleType )
<a name="l01040"></a>01040 {
<a name="l01041"></a>01041   <span class="keywordflow">if</span> ( !geom )
<a name="l01042"></a>01042   {
<a name="l01043"></a>01043     <span class="keywordflow">return</span>;
<a name="l01044"></a>01044   }
<a name="l01045"></a>01045 
<a name="l01046"></a>01046   QList&lt;QgsGeometry*&gt; geomList;
<a name="l01047"></a>01047   <span class="keywordflow">if</span> ( forceSingleType )
<a name="l01048"></a>01048   {
<a name="l01049"></a>01049     geomList = geom-&gt;<a class="code" href="classQgsGeometry.html#af8d10d936f220d0de96775aa2ba9dbd5" title="return contents of the geometry as a list of geometries">asGeometryCollection</a>();
<a name="l01050"></a>01050   }
<a name="l01051"></a>01051   <span class="keywordflow">else</span>
<a name="l01052"></a>01052   {
<a name="l01053"></a>01053     geomList.push_back( geom );
<a name="l01054"></a>01054   }
<a name="l01055"></a>01055 
<a name="l01056"></a>01056   QList&lt;QgsGeometry*&gt;::iterator geomIt = geomList.begin();
<a name="l01057"></a>01057   <span class="keywordflow">for</span> ( ; geomIt != geomList.end(); ++geomIt )
<a name="l01058"></a>01058   {
<a name="l01059"></a>01059     <span class="comment">//consider offset</span>
<a name="l01060"></a>01060     <span class="keywordflow">if</span> ( offsetField &gt;= 0 )
<a name="l01061"></a>01061     {
<a name="l01062"></a>01062       <span class="keywordtype">double</span> offsetVal = feature.<a class="code" href="classQgsFeature.html#ad80bca974bc7faa416f4e6ca29f7c3d0" title="Get the attributes for this feature.">attributeMap</a>()[offsetField].toDouble();
<a name="l01063"></a>01063       offsetVal *= offsetScale;
<a name="l01064"></a>01064       <a class="code" href="classQgsGeometryAnalyzer.html#a19a0935695dd04fdbe79f1b516ceb213" title="Create geometry offset relative to line geometry.">createOffsetGeometry</a>( *geomIt, lineGeom, offsetVal );
<a name="l01065"></a>01065     }
<a name="l01066"></a>01066 
<a name="l01067"></a>01067     feature.<a class="code" href="classQgsFeature.html#ad7755f8310da090b047025a1d58a93d8" title="Set this feature&#39;s geometry from another QgsGeometry object (deep copy)">setGeometry</a>( *geomIt );
<a name="l01068"></a>01068     <span class="keywordflow">if</span> ( fileWriter )
<a name="l01069"></a>01069     {
<a name="l01070"></a>01070       fileWriter-&gt;<a class="code" href="classQgsVectorFileWriter.html#a93e126f3ed1ddf9bc012d0c53b868a9c" title="add feature to the currently opened shapefile">addFeature</a>( feature );
<a name="l01071"></a>01071     }
<a name="l01072"></a>01072     <span class="keywordflow">else</span>
<a name="l01073"></a>01073     {
<a name="l01074"></a>01074       memoryFeatures &lt;&lt; feature;
<a name="l01075"></a>01075     }
<a name="l01076"></a>01076   }
<a name="l01077"></a>01077 
<a name="l01078"></a>01078   <span class="keywordflow">if</span> ( forceSingleType )
<a name="l01079"></a>01079   {
<a name="l01080"></a>01080     <span class="keyword">delete</span> geom;
<a name="l01081"></a>01081   }
<a name="l01082"></a>01082 }
<a name="l01083"></a>01083 
<a name="l01084"></a><a class="code" href="classQgsGeometryAnalyzer.html#a19a0935695dd04fdbe79f1b516ceb213">01084</a> <span class="keywordtype">void</span> <a class="code" href="classQgsGeometryAnalyzer.html#a19a0935695dd04fdbe79f1b516ceb213" title="Create geometry offset relative to line geometry.">QgsGeometryAnalyzer::createOffsetGeometry</a>( <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* geom, <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* lineGeom, <span class="keywordtype">double</span> offset )
<a name="l01085"></a>01085 {
<a name="l01086"></a>01086   <span class="keywordflow">if</span> ( !geom || !lineGeom )
<a name="l01087"></a>01087   {
<a name="l01088"></a>01088     <span class="keywordflow">return</span>;
<a name="l01089"></a>01089   }
<a name="l01090"></a>01090 
<a name="l01091"></a>01091   QList&lt;QgsGeometry*&gt; inputGeomList;
<a name="l01092"></a>01092 
<a name="l01093"></a>01093   <span class="keywordflow">if</span> ( geom-&gt;<a class="code" href="classQgsGeometry.html#a5c8a7b96d8658e98c5ecf62c8369fcdc" title="Returns true if wkb of the geometry is of WKBMulti* type.">isMultipart</a>() )
<a name="l01094"></a>01094   {
<a name="l01095"></a>01095     inputGeomList = geom-&gt;<a class="code" href="classQgsGeometry.html#af8d10d936f220d0de96775aa2ba9dbd5" title="return contents of the geometry as a list of geometries">asGeometryCollection</a>();
<a name="l01096"></a>01096   }
<a name="l01097"></a>01097   <span class="keywordflow">else</span>
<a name="l01098"></a>01098   {
<a name="l01099"></a>01099     inputGeomList.push_back( geom );
<a name="l01100"></a>01100   }
<a name="l01101"></a>01101 
<a name="l01102"></a>01102   QList&lt;GEOSGeometry*&gt; outputGeomList;
<a name="l01103"></a>01103   QList&lt;QgsGeometry*&gt;::const_iterator inputGeomIt = inputGeomList.constBegin();
<a name="l01104"></a>01104   <span class="keywordflow">for</span> ( ; inputGeomIt != inputGeomList.constEnd(); ++inputGeomIt )
<a name="l01105"></a>01105   {
<a name="l01106"></a>01106     <span class="keywordflow">if</span> ( geom-&gt;<a class="code" href="classQgsGeometry.html#ad57348e8a59d162a8a24226aa319d7f6" title="Returns type of the vector.">type</a>() == <a class="code" href="classQGis.html#a09947eb19394302eeeed44d3e81dd74ba84e19f581d8cf4e8855821b21bff0714">QGis::Line</a> )
<a name="l01107"></a>01107     {
<a name="l01108"></a>01108       <span class="comment">//geos 3.3 needed for line offsets</span>
<a name="l01109"></a>01109 <span class="preprocessor">#if defined(GEOS_VERSION_MAJOR) &amp;&amp; defined(GEOS_VERSION_MINOR) &amp;&amp; \</span>
<a name="l01110"></a>01110 <span class="preprocessor">      ((GEOS_VERSION_MAJOR&gt;3) || ((GEOS_VERSION_MAJOR==3) &amp;&amp; (GEOS_VERSION_MINOR&gt;=3)))</span>
<a name="l01111"></a>01111 <span class="preprocessor"></span>      outputGeomList.push_back( GEOSOffsetCurve(( *inputGeomIt )-&gt;asGeos(), -offset, 8 <span class="comment">/*quadSegments*/</span>, 0 <span class="comment">/*joinStyle*/</span>, 5.0 <span class="comment">/*mitreLimit*/</span> ) );
<a name="l01112"></a>01112 <span class="preprocessor">#else</span>
<a name="l01113"></a>01113 <span class="preprocessor"></span>      outputGeomList.push_back( GEOSGeom_clone(( *inputGeomIt )-&gt;asGeos() ) );
<a name="l01114"></a>01114 <span class="preprocessor">#endif</span>
<a name="l01115"></a>01115 <span class="preprocessor"></span>    }
<a name="l01116"></a>01116     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( geom-&gt;<a class="code" href="classQgsGeometry.html#ad57348e8a59d162a8a24226aa319d7f6" title="Returns type of the vector.">type</a>() == <a class="code" href="classQGis.html#a09947eb19394302eeeed44d3e81dd74ba2c6376a16e5f3dc830ffd0a72597c276">QGis::Point</a> )
<a name="l01117"></a>01117     {
<a name="l01118"></a>01118       <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> p = ( *inputGeomIt )-&gt;asPoint();
<a name="l01119"></a>01119       p = <a class="code" href="classQgsGeometryAnalyzer.html#af4fd906eb9e6815b8f3e2056c54edc66">createPointOffset</a>( p.<a class="code" href="classQgsPoint.html#a14cf4897a06313074760383398ee95d5">x</a>(), p.<a class="code" href="classQgsPoint.html#a07bd042b697bab243f4be31358d943ad">y</a>(), offset, lineGeom );
<a name="l01120"></a>01120       GEOSCoordSequence* ptSeq = GEOSCoordSeq_create( 1, 2 );
<a name="l01121"></a>01121       GEOSCoordSeq_setX( ptSeq, 0, p.<a class="code" href="classQgsPoint.html#a14cf4897a06313074760383398ee95d5">x</a>() );
<a name="l01122"></a>01122       GEOSCoordSeq_setY( ptSeq, 0, p.<a class="code" href="classQgsPoint.html#a07bd042b697bab243f4be31358d943ad">y</a>() );
<a name="l01123"></a>01123       GEOSGeometry* geosPt = GEOSGeom_createPoint( ptSeq );
<a name="l01124"></a>01124       outputGeomList.push_back( geosPt );
<a name="l01125"></a>01125     }
<a name="l01126"></a>01126   }
<a name="l01127"></a>01127 
<a name="l01128"></a>01128   <span class="keywordflow">if</span> ( !geom-&gt;<a class="code" href="classQgsGeometry.html#a5c8a7b96d8658e98c5ecf62c8369fcdc" title="Returns true if wkb of the geometry is of WKBMulti* type.">isMultipart</a>() )
<a name="l01129"></a>01129   {
<a name="l01130"></a>01130     GEOSGeometry* outputGeom = outputGeomList.at( 0 );
<a name="l01131"></a>01131     <span class="keywordflow">if</span> ( outputGeom )
<a name="l01132"></a>01132     {
<a name="l01133"></a>01133       geom-&gt;<a class="code" href="classQgsGeometry.html#a70a20005fcf345e7765a42e18a274445" title="Set the geometry, feeding in a geometry in GEOS format.">fromGeos</a>( outputGeom );
<a name="l01134"></a>01134     }
<a name="l01135"></a>01135   }
<a name="l01136"></a>01136   <span class="keywordflow">else</span>
<a name="l01137"></a>01137   {
<a name="l01138"></a>01138     GEOSGeometry** geomArray = <span class="keyword">new</span> GEOSGeometry*[outputGeomList.size()];
<a name="l01139"></a>01139     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; outputGeomList.size(); ++i )
<a name="l01140"></a>01140     {
<a name="l01141"></a>01141       geomArray[i] = outputGeomList.at( i );
<a name="l01142"></a>01142     }
<a name="l01143"></a>01143     GEOSGeometry* collection = 0;
<a name="l01144"></a>01144     <span class="keywordflow">if</span> ( geom-&gt;<a class="code" href="classQgsGeometry.html#ad57348e8a59d162a8a24226aa319d7f6" title="Returns type of the vector.">type</a>() == <a class="code" href="classQGis.html#a09947eb19394302eeeed44d3e81dd74ba2c6376a16e5f3dc830ffd0a72597c276">QGis::Point</a> )
<a name="l01145"></a>01145     {
<a name="l01146"></a>01146       collection = GEOSGeom_createCollection( GEOS_MULTIPOINT, geomArray, outputGeomList.size() );
<a name="l01147"></a>01147     }
<a name="l01148"></a>01148     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( geom-&gt;<a class="code" href="classQgsGeometry.html#ad57348e8a59d162a8a24226aa319d7f6" title="Returns type of the vector.">type</a>() == <a class="code" href="classQGis.html#a09947eb19394302eeeed44d3e81dd74ba84e19f581d8cf4e8855821b21bff0714">QGis::Line</a> )
<a name="l01149"></a>01149     {
<a name="l01150"></a>01150       collection = GEOSGeom_createCollection( GEOS_MULTILINESTRING, geomArray, outputGeomList.size() );
<a name="l01151"></a>01151     }
<a name="l01152"></a>01152     geom-&gt;<a class="code" href="classQgsGeometry.html#a70a20005fcf345e7765a42e18a274445" title="Set the geometry, feeding in a geometry in GEOS format.">fromGeos</a>( collection );
<a name="l01153"></a>01153     <span class="keyword">delete</span>[] geomArray;
<a name="l01154"></a>01154   }
<a name="l01155"></a>01155 }
<a name="l01156"></a>01156 
<a name="l01157"></a><a class="code" href="classQgsGeometryAnalyzer.html#af4fd906eb9e6815b8f3e2056c54edc66">01157</a> <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> <a class="code" href="classQgsGeometryAnalyzer.html#af4fd906eb9e6815b8f3e2056c54edc66">QgsGeometryAnalyzer::createPointOffset</a>( <span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y, <span class="keywordtype">double</span> dist, <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* lineGeom )<span class="keyword"> const</span>
<a name="l01158"></a>01158 <span class="keyword"></span>{
<a name="l01159"></a>01159   <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> p( x, y );
<a name="l01160"></a>01160   <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> minDistPoint;
<a name="l01161"></a>01161   <span class="keywordtype">int</span> afterVertexNr;
<a name="l01162"></a>01162   lineGeom-&gt;<a class="code" href="classQgsGeometry.html#a211e43704c073ab7bbabdd1b86bb9fe2" title="Searches for the closest segment of geometry to the given point.">closestSegmentWithContext</a>( p, minDistPoint, afterVertexNr );
<a name="l01163"></a>01163 
<a name="l01164"></a>01164   <span class="keywordtype">int</span> beforeVertexNr = afterVertexNr - 1;
<a name="l01165"></a>01165   <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> beforeVertex = lineGeom-&gt;<a class="code" href="classQgsGeometry.html#aa092e53c340962cec3a0d2baaa2b2341" title="Returns coordinates of a vertex.">vertexAt</a>( beforeVertexNr );
<a name="l01166"></a>01166   <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> afterVertex = lineGeom-&gt;<a class="code" href="classQgsGeometry.html#aa092e53c340962cec3a0d2baaa2b2341" title="Returns coordinates of a vertex.">vertexAt</a>( afterVertexNr );
<a name="l01167"></a>01167 
<a name="l01168"></a>01168   <span class="comment">//get normal vector</span>
<a name="l01169"></a>01169   <span class="keywordtype">double</span> dx = afterVertex.<a class="code" href="classQgsPoint.html#a14cf4897a06313074760383398ee95d5">x</a>() - beforeVertex.<a class="code" href="classQgsPoint.html#a14cf4897a06313074760383398ee95d5">x</a>();
<a name="l01170"></a>01170   <span class="keywordtype">double</span> dy = afterVertex.<a class="code" href="classQgsPoint.html#a07bd042b697bab243f4be31358d943ad">y</a>() - beforeVertex.<a class="code" href="classQgsPoint.html#a07bd042b697bab243f4be31358d943ad">y</a>();
<a name="l01171"></a>01171   <span class="keywordtype">double</span> normalX = -dy;
<a name="l01172"></a>01172   <span class="keywordtype">double</span> normalY = dx;
<a name="l01173"></a>01173   <span class="keywordtype">double</span> normalLength = sqrt( normalX * normalX + normalY * normalY );
<a name="l01174"></a>01174   normalX *= ( dist / normalLength );
<a name="l01175"></a>01175   normalY *= ( dist / normalLength );
<a name="l01176"></a>01176 
<a name="l01177"></a>01177   <span class="keywordtype">double</span> debugLength = sqrt( normalX * normalX + normalY * normalY ); <span class="comment">//control</span>
<a name="l01178"></a>01178   Q_UNUSED( debugLength );
<a name="l01179"></a>01179   <span class="keywordflow">return</span> <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a>( x - normalX, y - normalY ); <span class="comment">//negative values -&gt; left side, positive values -&gt; right side</span>
<a name="l01180"></a>01180 }
<a name="l01181"></a>01181 
<a name="l01182"></a><a class="code" href="classQgsGeometryAnalyzer.html#a248c5b567da381651ac74740fe9cf499">01182</a> <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* <a class="code" href="classQgsGeometryAnalyzer.html#a248c5b567da381651ac74740fe9cf499" title="Returns linear reference geometry as a multiline (or 0 if no match).">QgsGeometryAnalyzer::locateBetweenMeasures</a>( <span class="keywordtype">double</span> fromMeasure, <span class="keywordtype">double</span> toMeasure, <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* lineGeom )
<a name="l01183"></a>01183 {
<a name="l01184"></a>01184   <span class="keywordflow">if</span> ( !lineGeom )
<a name="l01185"></a>01185   {
<a name="l01186"></a>01186     <span class="keywordflow">return</span> 0;
<a name="l01187"></a>01187   }
<a name="l01188"></a>01188 
<a name="l01189"></a>01189   <a class="code" href="qgsgeometry_8h.html#aa8e9bcf48cb77976f92f3735c3d7b57b" title="a collection of QgsPolylines that share a common collection of attributes">QgsMultiPolyline</a> resultGeom;
<a name="l01190"></a>01190 
<a name="l01191"></a>01191   <span class="comment">//need to go with WKB and z coordinate until QgsGeometry supports M values</span>
<a name="l01192"></a>01192   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* lineWkb = lineGeom-&gt;<a class="code" href="classQgsGeometry.html#a7b74272a8080f7560de58a23f0ea891a" title="Returns the buffer containing this geometry in WKB format.">asWkb</a>();
<a name="l01193"></a>01193 
<a name="l01194"></a>01194   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* ptr = lineWkb + 1;
<a name="l01195"></a>01195   <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7" title="Used for symbology operations.">QGis::WkbType</a> wkbType;
<a name="l01196"></a>01196   memcpy( &amp;wkbType, ptr, <span class="keyword">sizeof</span>( wkbType ) );
<a name="l01197"></a>01197   ptr += <span class="keyword">sizeof</span>( wkbType );
<a name="l01198"></a>01198 
<a name="l01199"></a>01199   <span class="keywordflow">if</span> ( wkbType != <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7a700aa62f20128a44fc7516de8f3b4e97">QGis::WKBLineString25D</a> &amp;&amp; wkbType != <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7add9db8e4072e1def08ec96998f009de3">QGis::WKBMultiLineString25D</a> )
<a name="l01200"></a>01200   {
<a name="l01201"></a>01201     <span class="keywordflow">return</span> 0;
<a name="l01202"></a>01202   }
<a name="l01203"></a>01203 
<a name="l01204"></a>01204   <span class="keywordflow">if</span> ( wkbType == <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7a700aa62f20128a44fc7516de8f3b4e97">QGis::WKBLineString25D</a> )
<a name="l01205"></a>01205   {
<a name="l01206"></a>01206     <a class="code" href="classQgsGeometryAnalyzer.html#a639432b1ac4b431d34b8f09319e1361c">locateBetweenWkbString</a>( ptr, resultGeom, fromMeasure, toMeasure );
<a name="l01207"></a>01207   }
<a name="l01208"></a>01208   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( wkbType == <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7add9db8e4072e1def08ec96998f009de3">QGis::WKBMultiLineString25D</a> )
<a name="l01209"></a>01209   {
<a name="l01210"></a>01210     <span class="keywordtype">int</span>* nLines = ( <span class="keywordtype">int</span>* )ptr;
<a name="l01211"></a>01211     ptr += <span class="keyword">sizeof</span>( int );
<a name="l01212"></a>01212     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; *nLines; ++i )
<a name="l01213"></a>01213     {
<a name="l01214"></a>01214       ptr += ( 1 + <span class="keyword">sizeof</span>( wkbType ) );
<a name="l01215"></a>01215       ptr = <a class="code" href="classQgsGeometryAnalyzer.html#a639432b1ac4b431d34b8f09319e1361c">locateBetweenWkbString</a>( ptr, resultGeom, fromMeasure, toMeasure );
<a name="l01216"></a>01216     }
<a name="l01217"></a>01217   }
<a name="l01218"></a>01218 
<a name="l01219"></a>01219   <span class="keywordflow">if</span> ( resultGeom.size() &lt; 1 )
<a name="l01220"></a>01220   {
<a name="l01221"></a>01221     <span class="keywordflow">return</span> 0;
<a name="l01222"></a>01222   }
<a name="l01223"></a>01223   <span class="keywordflow">return</span> <a class="code" href="classQgsGeometry.html#a6d3e92aef802d90ab4d601f295741205" title="construct geometry from a multipolyline">QgsGeometry::fromMultiPolyline</a>( resultGeom );
<a name="l01224"></a>01224 }
<a name="l01225"></a>01225 
<a name="l01226"></a><a class="code" href="classQgsGeometryAnalyzer.html#a939d7d45a26cb530524d62c09e13877c">01226</a> <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* <a class="code" href="classQgsGeometryAnalyzer.html#a939d7d45a26cb530524d62c09e13877c" title="Returns linear reference geometry.">QgsGeometryAnalyzer::locateAlongMeasure</a>( <span class="keywordtype">double</span> measure, <a class="code" href="classQgsGeometry.html" title="A geometry is the spatial representation of a feature.">QgsGeometry</a>* lineGeom )
<a name="l01227"></a>01227 {
<a name="l01228"></a>01228   <span class="keywordflow">if</span> ( !lineGeom )
<a name="l01229"></a>01229   {
<a name="l01230"></a>01230     <span class="keywordflow">return</span> 0;
<a name="l01231"></a>01231   }
<a name="l01232"></a>01232 
<a name="l01233"></a>01233   <a class="code" href="qgsgeometry_8h.html#aa0d99800139665330697ab955cb122b8" title="a collection of QgsPoints that share a common collection of attributes">QgsMultiPoint</a> resultGeom;
<a name="l01234"></a>01234 
<a name="l01235"></a>01235   <span class="comment">//need to go with WKB and z coordinate until QgsGeometry supports M values</span>
<a name="l01236"></a>01236   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* lineWkb = lineGeom-&gt;<a class="code" href="classQgsGeometry.html#a7b74272a8080f7560de58a23f0ea891a" title="Returns the buffer containing this geometry in WKB format.">asWkb</a>();
<a name="l01237"></a>01237 
<a name="l01238"></a>01238   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* ptr = lineWkb + 1;
<a name="l01239"></a>01239   <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7" title="Used for symbology operations.">QGis::WkbType</a> wkbType;
<a name="l01240"></a>01240   memcpy( &amp;wkbType, ptr, <span class="keyword">sizeof</span>( wkbType ) );
<a name="l01241"></a>01241   ptr += <span class="keyword">sizeof</span>( wkbType );
<a name="l01242"></a>01242 
<a name="l01243"></a>01243   <span class="keywordflow">if</span> ( wkbType != <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7a700aa62f20128a44fc7516de8f3b4e97">QGis::WKBLineString25D</a> &amp;&amp; wkbType != <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7add9db8e4072e1def08ec96998f009de3">QGis::WKBMultiLineString25D</a> )
<a name="l01244"></a>01244   {
<a name="l01245"></a>01245     <span class="keywordflow">return</span> 0;
<a name="l01246"></a>01246   }
<a name="l01247"></a>01247 
<a name="l01248"></a>01248   <span class="keywordflow">if</span> ( wkbType == <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7a700aa62f20128a44fc7516de8f3b4e97">QGis::WKBLineString25D</a> )
<a name="l01249"></a>01249   {
<a name="l01250"></a>01250     <a class="code" href="classQgsGeometryAnalyzer.html#a221de5f95022b8b8782ca2dbe45c9748">locateAlongWkbString</a>( ptr, resultGeom, measure );
<a name="l01251"></a>01251   }
<a name="l01252"></a>01252   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( wkbType == <a class="code" href="classQGis.html#a8da456870e1caec209d8ba7502cceff7add9db8e4072e1def08ec96998f009de3">QGis::WKBMultiLineString25D</a> )
<a name="l01253"></a>01253   {
<a name="l01254"></a>01254     <span class="keywordtype">int</span>* nLines = ( <span class="keywordtype">int</span>* )ptr;
<a name="l01255"></a>01255     ptr += <span class="keyword">sizeof</span>( int );
<a name="l01256"></a>01256     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; *nLines; ++i )
<a name="l01257"></a>01257     {
<a name="l01258"></a>01258       ptr += ( 1 + <span class="keyword">sizeof</span>( wkbType ) );
<a name="l01259"></a>01259       ptr = <a class="code" href="classQgsGeometryAnalyzer.html#a221de5f95022b8b8782ca2dbe45c9748">locateAlongWkbString</a>( ptr, resultGeom, measure );
<a name="l01260"></a>01260     }
<a name="l01261"></a>01261   }
<a name="l01262"></a>01262 
<a name="l01263"></a>01263   <span class="keywordflow">if</span> ( resultGeom.size() &lt; 1 )
<a name="l01264"></a>01264   {
<a name="l01265"></a>01265     <span class="keywordflow">return</span> 0;
<a name="l01266"></a>01266   }
<a name="l01267"></a>01267   <span class="keywordflow">return</span> <a class="code" href="classQgsGeometry.html#ad1f5802678bec7ae66a9d5f1189ba371" title="construct geometry from a multipoint">QgsGeometry::fromMultiPoint</a>( resultGeom );
<a name="l01268"></a>01268 }
<a name="l01269"></a>01269 
<a name="l01270"></a><a class="code" href="classQgsGeometryAnalyzer.html#a639432b1ac4b431d34b8f09319e1361c">01270</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* <a class="code" href="classQgsGeometryAnalyzer.html#a639432b1ac4b431d34b8f09319e1361c">QgsGeometryAnalyzer::locateBetweenWkbString</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* ptr, <a class="code" href="qgsgeometry_8h.html#aa8e9bcf48cb77976f92f3735c3d7b57b" title="a collection of QgsPolylines that share a common collection of attributes">QgsMultiPolyline</a>&amp; result, <span class="keywordtype">double</span> fromMeasure, <span class="keywordtype">double</span> toMeasure )
<a name="l01271"></a>01271 {
<a name="l01272"></a>01272   <span class="keywordtype">int</span>* nPoints = ( <span class="keywordtype">int</span>* ) ptr;
<a name="l01273"></a>01273   ptr += <span class="keyword">sizeof</span>( int );
<a name="l01274"></a>01274   <span class="keywordtype">double</span> prevx, prevy, prevz;
<a name="l01275"></a>01275   <span class="keywordtype">double</span> *x, *y, *z;
<a name="l01276"></a>01276   <a class="code" href="qgsgeometry_8h.html#ae40bfa8c4815c0ea40009f8a13deae52" title="polyline is represented as a vector of points">QgsPolyline</a> currentLine;
<a name="l01277"></a>01277 
<a name="l01278"></a>01278   <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> pt1, pt2;
<a name="l01279"></a>01279   <span class="keywordtype">bool</span> measureInSegment; <span class="comment">//true if measure is contained in the segment</span>
<a name="l01280"></a>01280   <span class="keywordtype">bool</span> secondPointClipped; <span class="comment">//true if second point is != segment endpoint</span>
<a name="l01281"></a>01281 
<a name="l01282"></a>01282 
<a name="l01283"></a>01283   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; *nPoints; ++i )
<a name="l01284"></a>01284   {
<a name="l01285"></a>01285     x = ( <span class="keywordtype">double</span>* )ptr;
<a name="l01286"></a>01286     ptr += <span class="keyword">sizeof</span>( double );
<a name="l01287"></a>01287     y = ( <span class="keywordtype">double</span>* )ptr;
<a name="l01288"></a>01288     ptr += <span class="keyword">sizeof</span>( double );
<a name="l01289"></a>01289     z = ( <span class="keywordtype">double</span>* ) ptr;
<a name="l01290"></a>01290     ptr += <span class="keyword">sizeof</span>( double );
<a name="l01291"></a>01291 
<a name="l01292"></a>01292     <span class="keywordflow">if</span> ( i &gt; 0 )
<a name="l01293"></a>01293     {
<a name="l01294"></a>01294       measureInSegment = <a class="code" href="classQgsGeometryAnalyzer.html#a29252238f95ebcf392b0bc64887deecf">clipSegmentByRange</a>( prevx, prevy, prevz, *x, *y, *z, fromMeasure, toMeasure, pt1, pt2, secondPointClipped );
<a name="l01295"></a>01295       <span class="keywordflow">if</span> ( measureInSegment )
<a name="l01296"></a>01296       {
<a name="l01297"></a>01297         <span class="keywordflow">if</span> ( currentLine.size() &lt; 1 ) <span class="comment">//no points collected yet, so the first point needs to be added to the line</span>
<a name="l01298"></a>01298         {
<a name="l01299"></a>01299           currentLine.append( pt1 );
<a name="l01300"></a>01300         }
<a name="l01301"></a>01301 
<a name="l01302"></a>01302         <span class="keywordflow">if</span> ( pt1 != pt2 ) <span class="comment">//avoid duplicated entry if measure value equals m-value of vertex</span>
<a name="l01303"></a>01303         {
<a name="l01304"></a>01304           currentLine.append( pt2 );
<a name="l01305"></a>01305         }
<a name="l01306"></a>01306 
<a name="l01307"></a>01307         <span class="keywordflow">if</span> ( secondPointClipped || i == *nPoints - 1 ) <span class="comment">//close current segment</span>
<a name="l01308"></a>01308         {
<a name="l01309"></a>01309           <span class="keywordflow">if</span> ( currentLine.size() &gt; 1 )
<a name="l01310"></a>01310           {
<a name="l01311"></a>01311             result.append( currentLine );
<a name="l01312"></a>01312           }
<a name="l01313"></a>01313           currentLine.clear();
<a name="l01314"></a>01314         }
<a name="l01315"></a>01315       }
<a name="l01316"></a>01316     }
<a name="l01317"></a>01317     prevx = *x; prevy = *y; prevz = *z;
<a name="l01318"></a>01318   }
<a name="l01319"></a>01319   <span class="keywordflow">return</span> ptr;
<a name="l01320"></a>01320 }
<a name="l01321"></a>01321 
<a name="l01322"></a><a class="code" href="classQgsGeometryAnalyzer.html#a221de5f95022b8b8782ca2dbe45c9748">01322</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* <a class="code" href="classQgsGeometryAnalyzer.html#a221de5f95022b8b8782ca2dbe45c9748">QgsGeometryAnalyzer::locateAlongWkbString</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* ptr, <a class="code" href="qgsgeometry_8h.html#aa0d99800139665330697ab955cb122b8" title="a collection of QgsPoints that share a common collection of attributes">QgsMultiPoint</a>&amp; result, <span class="keywordtype">double</span> measure )
<a name="l01323"></a>01323 {
<a name="l01324"></a>01324   <span class="keywordtype">int</span>* nPoints = ( <span class="keywordtype">int</span>* ) ptr;
<a name="l01325"></a>01325   ptr += <span class="keyword">sizeof</span>( int );
<a name="l01326"></a>01326   <span class="keywordtype">double</span> prevx, prevy, prevz;
<a name="l01327"></a>01327   <span class="keywordtype">double</span> *x, *y, *z;
<a name="l01328"></a>01328 
<a name="l01329"></a>01329   <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> pt1, pt2;
<a name="l01330"></a>01330   <span class="keywordtype">bool</span> pt1Ok, pt2Ok;
<a name="l01331"></a>01331 
<a name="l01332"></a>01332   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; *nPoints; ++i )
<a name="l01333"></a>01333   {
<a name="l01334"></a>01334     x = ( <span class="keywordtype">double</span>* )ptr;
<a name="l01335"></a>01335     ptr += <span class="keyword">sizeof</span>( double );
<a name="l01336"></a>01336     y = ( <span class="keywordtype">double</span>* )ptr;
<a name="l01337"></a>01337     ptr += <span class="keyword">sizeof</span>( double );
<a name="l01338"></a>01338     z = ( <span class="keywordtype">double</span>* ) ptr;
<a name="l01339"></a>01339     ptr += <span class="keyword">sizeof</span>( double );
<a name="l01340"></a>01340 
<a name="l01341"></a>01341     <span class="keywordflow">if</span> ( i &gt; 0 )
<a name="l01342"></a>01342     {
<a name="l01343"></a>01343       <a class="code" href="classQgsGeometryAnalyzer.html#aa8f5e5be5820c11121827f5116ebd5fc">locateAlongSegment</a>( prevx, prevy, prevz, *x, *y, *z, measure, pt1Ok, pt1, pt2Ok, pt2 );
<a name="l01344"></a>01344       <span class="keywordflow">if</span> ( pt1Ok )
<a name="l01345"></a>01345       {
<a name="l01346"></a>01346         result.append( pt1 );
<a name="l01347"></a>01347       }
<a name="l01348"></a>01348       <span class="keywordflow">if</span> ( pt2Ok &amp;&amp; ( i == ( *nPoints - 1 ) ) )
<a name="l01349"></a>01349       {
<a name="l01350"></a>01350         result.append( pt2 );
<a name="l01351"></a>01351       }
<a name="l01352"></a>01352     }
<a name="l01353"></a>01353     prevx = *x; prevy = *y; prevz = *z;
<a name="l01354"></a>01354   }
<a name="l01355"></a>01355   <span class="keywordflow">return</span> ptr;
<a name="l01356"></a>01356 }
<a name="l01357"></a>01357 
<a name="l01358"></a><a class="code" href="classQgsGeometryAnalyzer.html#a29252238f95ebcf392b0bc64887deecf">01358</a> <span class="keywordtype">bool</span> <a class="code" href="classQgsGeometryAnalyzer.html#a29252238f95ebcf392b0bc64887deecf">QgsGeometryAnalyzer::clipSegmentByRange</a>( <span class="keywordtype">double</span> x1, <span class="keywordtype">double</span> y1, <span class="keywordtype">double</span> m1, <span class="keywordtype">double</span> x2, <span class="keywordtype">double</span> y2, <span class="keywordtype">double</span> m2, <span class="keywordtype">double</span> range1, <span class="keywordtype">double</span> range2, <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a>&amp; pt1,
<a name="l01359"></a>01359     <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a>&amp; pt2, <span class="keywordtype">bool</span>&amp; secondPointClipped )
<a name="l01360"></a>01360 {
<a name="l01361"></a>01361   <span class="keywordtype">bool</span> reversed = m1 &gt; m2;
<a name="l01362"></a>01362   <span class="keywordtype">double</span> tmp;
<a name="l01363"></a>01363 
<a name="l01364"></a>01364   <span class="comment">//reverse m1, m2 if necessary (and consequently also x1,x2 / y1, y2)</span>
<a name="l01365"></a>01365   <span class="keywordflow">if</span> ( reversed )
<a name="l01366"></a>01366   {
<a name="l01367"></a>01367     tmp = m1;
<a name="l01368"></a>01368     m1 = m2;
<a name="l01369"></a>01369     m2 = tmp;
<a name="l01370"></a>01370 
<a name="l01371"></a>01371     tmp = x1;
<a name="l01372"></a>01372     x1 = x2;
<a name="l01373"></a>01373     x2 = tmp;
<a name="l01374"></a>01374 
<a name="l01375"></a>01375     tmp = y1;
<a name="l01376"></a>01376     y1 = y2;
<a name="l01377"></a>01377     y2 = tmp;
<a name="l01378"></a>01378   }
<a name="l01379"></a>01379 
<a name="l01380"></a>01380   <span class="comment">//reverse range1, range2 if necessary</span>
<a name="l01381"></a>01381   <span class="keywordflow">if</span> ( range1 &gt; range2 )
<a name="l01382"></a>01382   {
<a name="l01383"></a>01383     tmp = range1;
<a name="l01384"></a>01384     range1 = range2;
<a name="l01385"></a>01385     range2 = tmp;
<a name="l01386"></a>01386   }
<a name="l01387"></a>01387 
<a name="l01388"></a>01388   <span class="comment">//segment completely outside of range</span>
<a name="l01389"></a>01389   <span class="keywordflow">if</span> ( m2 &lt; range1 || m1 &gt; range2 )
<a name="l01390"></a>01390   {
<a name="l01391"></a>01391     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01392"></a>01392   }
<a name="l01393"></a>01393 
<a name="l01394"></a>01394   <span class="comment">//segment completely inside of range</span>
<a name="l01395"></a>01395   <span class="keywordflow">if</span> ( m2 &lt;= range2 &amp;&amp; m1 &gt;= range1 )
<a name="l01396"></a>01396   {
<a name="l01397"></a>01397     <span class="keywordflow">if</span> ( reversed )
<a name="l01398"></a>01398     {
<a name="l01399"></a>01399       pt1.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x2 ); pt1.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y2 );
<a name="l01400"></a>01400       pt2.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x1 ); pt2.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y1 );
<a name="l01401"></a>01401     }
<a name="l01402"></a>01402     <span class="keywordflow">else</span>
<a name="l01403"></a>01403     {
<a name="l01404"></a>01404       pt1.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x1 ); pt1.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y1 );
<a name="l01405"></a>01405       pt2.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x2 ); pt2.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y2 );
<a name="l01406"></a>01406     }
<a name="l01407"></a>01407     secondPointClipped = <span class="keyword">false</span>;
<a name="l01408"></a>01408     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01409"></a>01409   }
<a name="l01410"></a>01410 
<a name="l01411"></a>01411   <span class="comment">//m1 inside and m2 not</span>
<a name="l01412"></a>01412   <span class="keywordflow">if</span> ( m1 &gt;= range1 &amp;&amp; m1 &lt;= range2 )
<a name="l01413"></a>01413   {
<a name="l01414"></a>01414     pt1.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x1 ); pt1.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y1 );
<a name="l01415"></a>01415     <span class="keywordtype">double</span> dist = ( range2 - m1 ) / ( m2 - m1 );
<a name="l01416"></a>01416     pt2.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x1 + ( x2 - x1 ) * dist );
<a name="l01417"></a>01417     pt2.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y1 + ( y2 - y1 ) * dist );
<a name="l01418"></a>01418     secondPointClipped = !reversed;
<a name="l01419"></a>01419   }
<a name="l01420"></a>01420 
<a name="l01421"></a>01421   <span class="comment">//m2 inside and m1 not</span>
<a name="l01422"></a>01422   <span class="keywordflow">if</span> ( m2 &gt;= range1 &amp;&amp; m2 &lt;= range2 )
<a name="l01423"></a>01423   {
<a name="l01424"></a>01424     pt2.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x2 ); pt2.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y2 );
<a name="l01425"></a>01425     <span class="keywordtype">double</span> dist = ( m2 - range1 ) / ( m2 - m1 );
<a name="l01426"></a>01426     pt1.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x2 - ( x2 - x1 ) * dist );
<a name="l01427"></a>01427     pt1.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y2 - ( y2 - y1 ) * dist );
<a name="l01428"></a>01428     secondPointClipped = reversed;
<a name="l01429"></a>01429   }
<a name="l01430"></a>01430 
<a name="l01431"></a>01431   <span class="comment">//range1 and range 2 both inside the segment</span>
<a name="l01432"></a>01432   <span class="keywordflow">if</span> ( range1 &gt;= m1 &amp;&amp; range2 &lt;= m2 )
<a name="l01433"></a>01433   {
<a name="l01434"></a>01434     <span class="keywordtype">double</span> dist1 = ( range1 - m1 ) / ( m2 - m1 );
<a name="l01435"></a>01435     <span class="keywordtype">double</span> dist2 = ( range2 - m1 ) / ( m2 - m1 );
<a name="l01436"></a>01436     pt1.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x1 + ( x2 - x1 ) * dist1 );
<a name="l01437"></a>01437     pt1.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y1 + ( y2 - y1 ) * dist1 );
<a name="l01438"></a>01438     pt2.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x1 + ( x2 - x1 ) * dist2 );
<a name="l01439"></a>01439     pt2.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y1 + ( y2 - y1 ) * dist2 );
<a name="l01440"></a>01440     secondPointClipped = <span class="keyword">true</span>;
<a name="l01441"></a>01441   }
<a name="l01442"></a>01442 
<a name="l01443"></a>01443   <span class="keywordflow">if</span> ( reversed ) <span class="comment">//switch p1 and p2</span>
<a name="l01444"></a>01444   {
<a name="l01445"></a>01445     <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a> tmpPt = pt1;
<a name="l01446"></a>01446     pt1 = pt2;
<a name="l01447"></a>01447     pt2 = tmpPt;
<a name="l01448"></a>01448   }
<a name="l01449"></a>01449 
<a name="l01450"></a>01450   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01451"></a>01451 }
<a name="l01452"></a>01452 
<a name="l01453"></a><a class="code" href="classQgsGeometryAnalyzer.html#aa8f5e5be5820c11121827f5116ebd5fc">01453</a> <span class="keywordtype">void</span> <a class="code" href="classQgsGeometryAnalyzer.html#aa8f5e5be5820c11121827f5116ebd5fc">QgsGeometryAnalyzer::locateAlongSegment</a>( <span class="keywordtype">double</span> x1, <span class="keywordtype">double</span> y1, <span class="keywordtype">double</span> m1, <span class="keywordtype">double</span> x2, <span class="keywordtype">double</span> y2, <span class="keywordtype">double</span> m2, <span class="keywordtype">double</span> measure, <span class="keywordtype">bool</span>&amp; pt1Ok, <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a>&amp; pt1, <span class="keywordtype">bool</span>&amp; pt2Ok, <a class="code" href="classQgsPoint.html" title="A class to represent a point geometry.">QgsPoint</a>&amp; pt2 )
<a name="l01454"></a>01454 {
<a name="l01455"></a>01455   <span class="keywordtype">bool</span> reversed = <span class="keyword">false</span>;
<a name="l01456"></a>01456   pt1Ok = <span class="keyword">false</span>;
<a name="l01457"></a>01457   pt2Ok = <span class="keyword">false</span>;
<a name="l01458"></a>01458   <span class="keywordtype">double</span> tolerance = 0.000001; <span class="comment">//work with a small tolerance to catch e.g. locations at endpoints</span>
<a name="l01459"></a>01459 
<a name="l01460"></a>01460   <span class="keywordflow">if</span> ( m1 &gt; m2 )
<a name="l01461"></a>01461   {
<a name="l01462"></a>01462     <span class="keywordtype">double</span> tmp = m1;
<a name="l01463"></a>01463     m1 = m2;
<a name="l01464"></a>01464     m2 = tmp;
<a name="l01465"></a>01465     reversed = <span class="keyword">true</span>;
<a name="l01466"></a>01466   }
<a name="l01467"></a>01467 
<a name="l01468"></a>01468   <span class="comment">//segment does not match</span>
<a name="l01469"></a>01469   <span class="keywordflow">if</span> (( m1 - measure ) &gt; tolerance || ( measure - m2 ) &gt; tolerance )
<a name="l01470"></a>01470   {
<a name="l01471"></a>01471     pt1Ok = <span class="keyword">false</span>;
<a name="l01472"></a>01472     pt2Ok = <span class="keyword">false</span>;
<a name="l01473"></a>01473     <span class="keywordflow">return</span>;
<a name="l01474"></a>01474   }
<a name="l01475"></a>01475 
<a name="l01476"></a>01476   <span class="comment">//match with vertex1</span>
<a name="l01477"></a>01477   <span class="keywordflow">if</span> ( <a class="code" href="qgis_8h.html#a14039c8aa54bda84192e28ecb298ed20">doubleNear</a>( m1, measure, tolerance ) )
<a name="l01478"></a>01478   {
<a name="l01479"></a>01479     <span class="keywordflow">if</span> ( reversed )
<a name="l01480"></a>01480     {
<a name="l01481"></a>01481       pt2Ok = <span class="keyword">true</span>;
<a name="l01482"></a>01482       pt2.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x2 ); pt2.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y2 );
<a name="l01483"></a>01483     }
<a name="l01484"></a>01484     <span class="keywordflow">else</span>
<a name="l01485"></a>01485     {
<a name="l01486"></a>01486       pt1Ok = <span class="keyword">true</span>;
<a name="l01487"></a>01487       pt1.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x1 ); pt1.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y1 );
<a name="l01488"></a>01488     }
<a name="l01489"></a>01489   }
<a name="l01490"></a>01490 
<a name="l01491"></a>01491   <span class="comment">//match with vertex2</span>
<a name="l01492"></a>01492   <span class="keywordflow">if</span> ( <a class="code" href="qgis_8h.html#a14039c8aa54bda84192e28ecb298ed20">doubleNear</a>( m2, measure, tolerance ) )
<a name="l01493"></a>01493   {
<a name="l01494"></a>01494     <span class="keywordflow">if</span> ( reversed )
<a name="l01495"></a>01495     {
<a name="l01496"></a>01496       pt1Ok = <span class="keyword">true</span>;
<a name="l01497"></a>01497       pt1.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x1 ); pt1.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y1 );
<a name="l01498"></a>01498     }
<a name="l01499"></a>01499     <span class="keywordflow">else</span>
<a name="l01500"></a>01500     {
<a name="l01501"></a>01501       pt2Ok = <span class="keyword">true</span>;
<a name="l01502"></a>01502       pt2.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x2 ); pt2.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y2 );
<a name="l01503"></a>01503     }
<a name="l01504"></a>01504   }
<a name="l01505"></a>01505 
<a name="l01506"></a>01506 
<a name="l01507"></a>01507   <span class="keywordflow">if</span> ( pt1Ok || pt2Ok )
<a name="l01508"></a>01508   {
<a name="l01509"></a>01509     <span class="keywordflow">return</span>;
<a name="l01510"></a>01510   }
<a name="l01511"></a>01511 
<a name="l01512"></a>01512   <span class="comment">//match between the vertices</span>
<a name="l01513"></a>01513   <span class="keywordflow">if</span> ( <a class="code" href="qgis_8h.html#a14039c8aa54bda84192e28ecb298ed20">doubleNear</a>( m1, m2 ) )
<a name="l01514"></a>01514   {
<a name="l01515"></a>01515     pt1.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x1 );
<a name="l01516"></a>01516     pt1.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y1 );
<a name="l01517"></a>01517     pt1Ok = <span class="keyword">true</span>;
<a name="l01518"></a>01518     <span class="keywordflow">return</span>;
<a name="l01519"></a>01519   }
<a name="l01520"></a>01520   <span class="keywordtype">double</span> dist = ( measure - m1 ) / ( m2 - m1 );
<a name="l01521"></a>01521   <span class="keywordflow">if</span> ( reversed )
<a name="l01522"></a>01522   {
<a name="l01523"></a>01523     dist = 1 - dist;
<a name="l01524"></a>01524   }
<a name="l01525"></a>01525 
<a name="l01526"></a>01526   pt1.<a class="code" href="classQgsPoint.html#a4faeb4afb2807bd99fa4ac9ff519d832">setX</a>( x1 + dist * ( x2 - x1 ) );
<a name="l01527"></a>01527   pt1.<a class="code" href="classQgsPoint.html#a06c93b509ad9ffc1ad8a2b0e8ef77bc3">setY</a>( y1 + dist * ( y2 - y1 ) );
<a name="l01528"></a>01528   pt1Ok = <span class="keyword">true</span>;
<a name="l01529"></a>01529 }
</pre></div></div><!-- contents -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Tue Jun 19 2012 23:22:39 for Quantum GIS API Documentation by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
